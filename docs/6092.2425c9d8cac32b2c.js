(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6092],{5083:(cu,yr,ge)=>{"use strict";ge.d(yr,{E_:()=>xr,F3:()=>br,I9:()=>Ut});var K=ge(467);typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"&&global;var lt=function(ne){return ne.Unimplemented="UNIMPLEMENTED",ne.Unavailable="UNAVAILABLE",ne}(lt||{});class Ut extends Error{constructor(z,Y,ce){super(z),this.message=z,this.code=Y,this.data=ce}}const Ma=ne=>{var z,Y,ce,pe,se;const De=ne.CapacitorCustomPlatform||null,ve=ne.Capacitor||{},tt=ve.Plugins=ve.Plugins||{},Be=ne.CapacitorPlatforms,Pn=(null===(z=null==Be?void 0:Be.currentPlatform)||void 0===z?void 0:z.getPlatform)||(()=>null!==De?De.name:(ne=>{var z,Y;return null!=ne&&ne.androidBridge?"android":null!==(Y=null===(z=null==ne?void 0:ne.webkit)||void 0===z?void 0:z.messageHandlers)&&void 0!==Y&&Y.bridge?"ios":"web"})(ne)),za=(null===(Y=null==Be?void 0:Be.currentPlatform)||void 0===Y?void 0:Y.isNativePlatform)||(()=>"web"!==Pn()),Ha=(null===(ce=null==Be?void 0:Be.currentPlatform)||void 0===ce?void 0:ce.isPluginAvailable)||(We=>{const He=wr.get(We);return!!(null!=He&&He.platforms.has(Pn())||Fo(We))}),Fo=(null===(pe=null==Be?void 0:Be.currentPlatform)||void 0===pe?void 0:pe.getPluginHeader)||(We=>{var He;return null===(He=ve.PluginHeaders)||void 0===He?void 0:He.find(er=>er.name===We)}),wr=new Map,Zn=(null===(se=null==Be?void 0:Be.currentPlatform)||void 0===se?void 0:se.registerPlugin)||((We,He={})=>{const er=wr.get(We);if(er)return console.warn(`Capacitor plugin "${We}" already registered. Cannot register plugins twice.`),er.proxy;const Vt=Pn(),vn=Fo(We);let Gt;const Ao=function(){var Ye=(0,K.A)(function*(){return!Gt&&Vt in He?Gt=Gt="function"==typeof He[Vt]?yield He[Vt]():He[Vt]:null!==De&&!Gt&&"web"in He&&(Gt=Gt="function"==typeof He.web?yield He.web():He.web),Gt});return function(){return Ye.apply(this,arguments)}}(),Q=Ye=>{let qe;const mt=(...zt)=>{const Qt=Ao().then(Ct=>{const Zt=((Ye,qe)=>{var mt,zt;if(!vn){if(Ye)return null===(zt=Ye[qe])||void 0===zt?void 0:zt.bind(Ye);throw new Ut(`"${We}" plugin is not implemented on ${Vt}`,lt.Unimplemented)}{const Qt=null==vn?void 0:vn.methods.find(Ct=>qe===Ct.name);if(Qt)return"promise"===Qt.rtype?Ct=>ve.nativePromise(We,qe.toString(),Ct):(Ct,Zt)=>ve.nativeCallback(We,qe.toString(),Ct,Zt);if(Ye)return null===(mt=Ye[qe])||void 0===mt?void 0:mt.bind(Ye)}})(Ct,Ye);if(Zt){const _r=Zt(...zt);return qe=null==_r?void 0:_r.remove,_r}throw new Ut(`"${We}.${Ye}()" is not implemented on ${Vt}`,lt.Unimplemented)});return"addListener"===Ye&&(Qt.remove=(0,K.A)(function*(){return qe()})),Qt};return mt.toString=()=>`${Ye.toString()}() { [capacitor code] }`,Object.defineProperty(mt,"name",{value:Ye,writable:!1,configurable:!1}),mt},ee=Q("addListener"),Do=Q("removeListener"),Xa=(Ye,qe)=>{const mt=ee({eventName:Ye},qe),zt=function(){var Ct=(0,K.A)(function*(){const Zt=yield mt;Do({eventName:Ye,callbackId:Zt},qe)});return function(){return Ct.apply(this,arguments)}}(),Qt=new Promise(Ct=>mt.then(()=>Ct({remove:zt})));return Qt.remove=(0,K.A)(function*(){console.warn("Using addListener() without 'await' is deprecated."),yield zt()}),Qt},O=new Proxy({},{get(Ye,qe){switch(qe){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return vn?Xa:ee;case"removeListener":return Do;default:return Q(qe)}}});return tt[We]=O,wr.set(We,{name:We,proxy:O,platforms:new Set([...Object.keys(He),...vn?[Vt]:[]])}),O});return ve.convertFileSrc||(ve.convertFileSrc=We=>We),ve.getPlatform=Pn,ve.handleError=We=>ne.console.error(We),ve.isNativePlatform=za,ve.isPluginAvailable=Ha,ve.pluginMethodNoop=(We,He,er)=>Promise.reject(`${er} does not have an implementation of "${He}".`),ve.registerPlugin=Zn,ve.Exception=Ut,ve.DEBUG=!!ve.DEBUG,ve.isLoggingEnabled=!!ve.isLoggingEnabled,ve.platform=ve.getPlatform(),ve.isNative=ve.isNativePlatform(),ve},Tn=(ne=>ne.Capacitor=Ma(ne))(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),br=Tn.registerPlugin;class xr{constructor(z){this.listeners={},this.retainedEventArguments={},this.windowListeners={},z&&(console.warn(`Capacitor WebPlugin "${z.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=z)}addListener(z,Y){var ce=this;let pe=!1;this.listeners[z]||(this.listeners[z]=[],pe=!0),this.listeners[z].push(Y);const De=this.windowListeners[z];De&&!De.registered&&this.addWindowListener(De),pe&&this.sendRetainedArgumentsForEvent(z);const ve=function(){var Be=(0,K.A)(function*(){return ce.removeListener(z,Y)});return function(){return Be.apply(this,arguments)}}();return Promise.resolve({remove:ve})}removeAllListeners(){var z=this;return(0,K.A)(function*(){z.listeners={};for(const Y in z.windowListeners)z.removeWindowListener(z.windowListeners[Y]);z.windowListeners={}})()}notifyListeners(z,Y,ce){const pe=this.listeners[z];if(pe)pe.forEach(se=>se(Y));else if(ce){let se=this.retainedEventArguments[z];se||(se=[]),se.push(Y),this.retainedEventArguments[z]=se}}hasListeners(z){return!!this.listeners[z].length}registerWindowListener(z,Y){this.windowListeners[Y]={registered:!1,windowEventName:z,pluginEventName:Y,handler:ce=>{this.notifyListeners(Y,ce)}}}unimplemented(z="not implemented"){return new Tn.Exception(z,lt.Unimplemented)}unavailable(z="not available"){return new Tn.Exception(z,lt.Unavailable)}removeListener(z,Y){var ce=this;return(0,K.A)(function*(){const pe=ce.listeners[z];if(!pe)return;const se=pe.indexOf(Y);ce.listeners[z].splice(se,1),ce.listeners[z].length||ce.removeWindowListener(ce.windowListeners[z])})()}addWindowListener(z){window.addEventListener(z.windowEventName,z.handler),z.registered=!0}removeWindowListener(z){z&&(window.removeEventListener(z.windowEventName,z.handler),z.registered=!1)}sendRetainedArgumentsForEvent(z){const Y=this.retainedEventArguments[z];Y&&(delete this.retainedEventArguments[z],Y.forEach(ce=>{this.notifyListeners(z,ce)}))}}const ko=ne=>encodeURIComponent(ne).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Io=ne=>ne.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Ba extends xr{getCookies(){return(0,K.A)(function*(){const z=document.cookie,Y={};return z.split(";").forEach(ce=>{if(ce.length<=0)return;let[pe,se]=ce.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");pe=Io(pe).trim(),se=Io(se).trim(),Y[pe]=se}),Y})()}setCookie(z){return(0,K.A)(function*(){try{const Y=ko(z.key),ce=ko(z.value),pe=`; expires=${(z.expires||"").replace("expires=","")}`,se=(z.path||"/").replace("path=",""),De=null!=z.url&&z.url.length>0?`domain=${z.url}`:"";document.cookie=`${Y}=${ce||""}${pe}; path=${se}; ${De};`}catch(Y){return Promise.reject(Y)}})()}deleteCookie(z){return(0,K.A)(function*(){try{document.cookie=`${z.key}=; Max-Age=0`}catch(Y){return Promise.reject(Y)}})()}clearCookies(){return(0,K.A)(function*(){try{const z=document.cookie.split(";")||[];for(const Y of z)document.cookie=Y.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(z){return Promise.reject(z)}})()}clearAllCookies(){var z=this;return(0,K.A)(function*(){try{yield z.clearCookies()}catch(Y){return Promise.reject(Y)}})()}}br("CapacitorCookies",{web:()=>new Ba});const La=function(){var ne=(0,K.A)(function*(z){return new Promise((Y,ce)=>{const pe=new FileReader;pe.onload=()=>{const se=pe.result;Y(se.indexOf(",")>=0?se.split(",")[1]:se)},pe.onerror=se=>ce(se),pe.readAsDataURL(z)})});return function(Y){return ne.apply(this,arguments)}}();class Ga extends xr{request(z){return(0,K.A)(function*(){const Y=((ne,z={})=>{const Y=Object.assign({method:ne.method||"GET",headers:ne.headers},z),pe=((ne={})=>{const z=Object.keys(ne);return Object.keys(ne).map(pe=>pe.toLocaleLowerCase()).reduce((pe,se,De)=>(pe[se]=ne[z[De]],pe),{})})(ne.headers)["content-type"]||"";if("string"==typeof ne.data)Y.body=ne.data;else if(pe.includes("application/x-www-form-urlencoded")){const se=new URLSearchParams;for(const[De,ve]of Object.entries(ne.data||{}))se.set(De,ve);Y.body=se.toString()}else if(pe.includes("multipart/form-data")||ne.data instanceof FormData){const se=new FormData;if(ne.data instanceof FormData)ne.data.forEach((ve,tt)=>{se.append(tt,ve)});else for(const ve of Object.keys(ne.data))se.append(ve,ne.data[ve]);Y.body=se;const De=new Headers(Y.headers);De.delete("content-type"),Y.headers=De}else(pe.includes("application/json")||"object"==typeof ne.data)&&(Y.body=JSON.stringify(ne.data));return Y})(z,z.webFetchExtra),ce=((ne,z=!0)=>ne?Object.entries(ne).reduce((ce,pe)=>{const[se,De]=pe;let ve,tt;return Array.isArray(De)?(tt="",De.forEach(Be=>{ve=z?encodeURIComponent(Be):Be,tt+=`${se}=${ve}&`}),tt.slice(0,-1)):(ve=z?encodeURIComponent(De):De,tt=`${se}=${ve}`),`${ce}&${tt}`},"").substr(1):null)(z.params,z.shouldEncodeUrlParams),pe=ce?`${z.url}?${ce}`:z.url,se=yield fetch(pe,Y),De=se.headers.get("content-type")||"";let tt,Be,{responseType:ve="text"}=se.ok?z:{};switch(De.includes("application/json")&&(ve="json"),ve){case"arraybuffer":case"blob":Be=yield se.blob(),tt=yield La(Be);break;case"json":tt=yield se.json();break;default:tt=yield se.text()}const Nn={};return se.headers.forEach((Pn,Xr)=>{Nn[Xr]=Pn}),{data:tt,headers:Nn,status:se.status,url:se.url}})()}get(z){var Y=this;return(0,K.A)(function*(){return Y.request(Object.assign(Object.assign({},z),{method:"GET"}))})()}post(z){var Y=this;return(0,K.A)(function*(){return Y.request(Object.assign(Object.assign({},z),{method:"POST"}))})()}put(z){var Y=this;return(0,K.A)(function*(){return Y.request(Object.assign(Object.assign({},z),{method:"PUT"}))})()}patch(z){var Y=this;return(0,K.A)(function*(){return Y.request(Object.assign(Object.assign({},z),{method:"PATCH"}))})()}delete(z){var Y=this;return(0,K.A)(function*(){return Y.request(Object.assign(Object.assign({},z),{method:"DELETE"}))})()}}br("CapacitorHttp",{web:()=>new Ga})},6092:(cu,yr,ge)=>{"use strict";ge.r(yr),ge.d(yr,{FormPage:()=>gb});var K=ge(467),Ne=ge(177),le=ge(4341),ct=ge(2902),V=ge(4742),v=ge(4438),It=ge(4843),lt=function(r){return r[r.Saida=0]="Saida",r[r.Retorno=1]="Retorno",r}(lt||{}),Ut=ge(5079),Dn=ge(5873);function Ma(r,n){if(1&r&&v.nrm(0,"ion-icon",3),2&r){const e=v.XpG();v.Y8G("name","primary"===e.color?"add-circle":"trash-outline")}}function lu(r,n){if(1&r&&(v.j41(0,"ion-label"),v.EFF(1),v.k0s()),2&r){const e=v.XpG();v.R7$(),v.JRh(e.text)}}let Tn=(()=>{var r;class n{constructor(){this.color="primary",this.text="",this.disabled=!1,this.slot="end",this.buttonClick=new v.bkB,(0,Ut.a)({addCircle:Dn.YH_,trashOutline:Dn.P1A})}onClick(){this.disabled||this.buttonClick.emit()}}return(r=n).\u0275fac=function(t){return new(t||r)},r.\u0275cmp=v.VBU({type:r,selectors:[["app-button-add-remove"]],inputs:{color:"color",text:"text",disabled:"disabled",slot:"slot"},outputs:{buttonClick:"buttonClick"},standalone:!0,features:[v.aNF],decls:3,vars:5,consts:[[3,"click","color","disabled","slot"],["slot","icon-only",3,"name",4,"ngIf"],[4,"ngIf"],["slot","icon-only",3,"name"]],template:function(t,o){1&t&&(v.j41(0,"ion-button",0),v.bIt("click",function(){return o.onClick()}),v.DNE(1,Ma,1,1,"ion-icon",1)(2,lu,2,1,"ion-label",2),v.k0s()),2&t&&(v.Y8G("color",o.color)("disabled",o.disabled)("slot",o.slot),v.R7$(),v.Y8G("ngIf",!o.text),v.R7$(),v.Y8G("ngIf",o.text))},dependencies:[Ne.MD,Ne.bT,V.bv,V.Jm,V.iq,V.he]}),n})();var br=ge(2705),Oa=ge(9684);let hu=(()=>{var r;class n{constructor(t){this.baseApiService=t,this.endpoint="api/AcompanhanteFrota"}getAll(t,o){return this.baseApiService.get(`${this.endpoint}/GetAll/${t}/${o}`)}save(t){return this.baseApiService.post(`${this.endpoint}/AddMultiple`,t)}update(t,o,a){return this.baseApiService.put(`${this.endpoint}/Update`,{frotaId:t,tipo:o,model:a})}}return(r=n).\u0275fac=function(t){return new(t||r)(v.KVO(Oa.v))},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})();const xr=r=>({"ion-hide":r});function fu(r,n){1&r&&v.eu8(0)}function ko(r,n){1&r&&v.eu8(0)}function Io(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-item",8),v.bIt("click",function(){const o=v.eBV(e).$implicit,a=v.XpG(3);return v.Njj(a.adicionarAcompanhante(o))}),v.EFF(1),v.k0s()}if(2&r){const e=n.$implicit;v.R7$(),v.SpI(" ",e.name," ")}}function Ba(r,n){if(1&r&&(v.j41(0,"ion-list"),v.DNE(1,Io,2,1,"ion-item",14),v.k0s()),2&r){const e=v.XpG(2);v.R7$(),v.Y8G("ngForOf",e.acompanhantesFiltrados)}}function du(r,n){1&r&&v.eu8(0)}function La(r,n){1&r&&v.eu8(0)}function Wa(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",7)(3,"ion-button",8),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.isOpen=!1)}),v.EFF(4,"Voltar"),v.k0s()(),v.j41(5,"ion-buttons",9)(6,"ion-button",10),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.isOpen=!1)}),v.EFF(7," Salvar "),v.k0s()()()(),v.j41(8,"ion-content",11)(9,"ion-item")(10,"ion-searchbar",12),v.mxI("ngModelChange",function(o){v.eBV(e);const a=v.XpG();return v.DH7(a.acompanhanteBusca,o)||(a.acompanhanteBusca=o),v.Njj(o)}),v.bIt("ionInput",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.buscarAcompanhantes())}),v.k0s()(),v.DNE(11,Ba,2,1,"ion-list",13)(12,du,1,0,"ng-container",5)(13,La,1,0,"ng-container",5),v.k0s()}if(2&r){const e=v.XpG(),t=v.sdS(11),o=v.sdS(13);v.R7$(6),v.Y8G("strong",!0),v.R7$(4),v.R50("ngModel",e.acompanhanteBusca),v.R7$(),v.Y8G("ngIf",e.acompanhantesFiltrados.length>0&&e.acompanhanteBusca),v.R7$(),v.Y8G("ngTemplateOutlet",t),v.R7$(),v.Y8G("ngTemplateOutlet",o)}}function Ua(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-item")(1,"ion-label"),v.EFF(2),v.k0s(),v.nrm(3,"ion-input",3),v.j41(4,"app-button-add-remove",16),v.bIt("buttonClick",function(){const o=v.eBV(e).$implicit,a=v.XpG(2);return v.Njj(a.removerAcompanhante(o))}),v.k0s()()}if(2&r){const e=n.$implicit,t=v.XpG(2);v.R7$(2),v.JRh(e.name),v.R7$(),v.Y8G("disabled",!0),v.R7$(),v.Y8G("ngClass",v.eq3(3,xr,t.isFinished))}}function Va(r,n){if(1&r&&(v.j41(0,"ion-list"),v.DNE(1,Ua,5,5,"ion-item",15),v.k0s()),2&r){const e=v.XpG();v.R7$(),v.Y8G("ngForOf",e.acompanhantesSelecionados)}}function Ga(r,n){1&r&&(v.j41(0,"p",18)(1,"strong"),v.EFF(2,"Nenhum acompanhante selecionado."),v.k0s()())}function pu(r,n){if(1&r&&v.DNE(0,Ga,3,0,"p",17),2&r){const e=v.XpG();v.Y8G("ngIf",e.acompanhantesSelecionados.length<1)}}let ne=(()=>{var r;class n{constructor(t,o){this.funcionarioService=t,this.acompanhanteFrotaSrv=o,this.isOpen=!1,this.acompanhantes=[],this.acompanhanteBusca="",this.acompanhantesFiltrados=[],this.acompanhantesSelecionados=[],this.tipoAcompanhanteRetorno=!1,this.isFinished=!1,this.statusSaveAcompanhanteFrota=new v.bkB}ngOnInit(){var t=this;return(0,K.A)(function*(){yield t.carregarAcompanhantes()})()}ngOnChanges(t){var o=this;return(0,K.A)(function*(){if(t.saveAcompanhanteFrota){const a=t.saveAcompanhanteFrota.currentValue;a&&(yield o.submitFrotaAcompanhante(a))}t.idFrota&&o.idFrota&&(yield o.carregarAcompanhantesSelecionados(o.idFrota)),t.tipoAcompanhanteRetorno&&o.idFrota&&(yield o.carregarAcompanhantesSelecionados(o.idFrota))})()}carregarAcompanhantesSelecionados(t){var o=this;return(0,K.A)(function*(){try{let i;i=o.isFinished&&o.tipoAcompanhanteRetorno?yield(0,It._)(o.acompanhanteFrotaSrv.getAll(t,lt.Retorno)):yield(0,It._)(o.acompanhanteFrotaSrv.getAll(t,lt.Saida)),yield o.carregarAcompanhantes();const s=o.acompanhantes;console.log(s),o.acompanhantesSelecionados=i.map(u=>s.find(c=>c.id===u.funcCod)).filter(u=>null!=u),console.log(o.acompanhantesSelecionados)}catch(i){console.error("Erro ao carregar acompanhantes selecionados:",i)}})()}carregarAcompanhantes(){var t=this;return(0,K.A)(function*(){const o=t.funcionarioService.getCachedFuncionarios();if(o&&0!==o.length)t.acompanhantes=o;else{const a=yield(0,It._)(t.funcionarioService.getAll());t.acompanhantes=a}})()}buscarAcompanhantes(){const t=this.acompanhanteBusca.toLowerCase();this.acompanhantesFiltrados=this.acompanhantes.filter(o=>o.name.toLowerCase().includes(t)&&!this.acompanhantesSelecionados.some(a=>a.id===o.id))}adicionarAcompanhante(t){this.acompanhantesSelecionados.push(t),this.acompanhanteBusca="",this.acompanhantesFiltrados=[]}removerAcompanhante(t){this.acompanhantesSelecionados=this.acompanhantesSelecionados.filter(o=>o.id!==t.id)}submitFrotaAcompanhante(t){var o=this;return(0,K.A)(function*(){const a=o.tipoAcompanhanteRetorno?lt.Retorno:lt.Saida,i=o.acompanhantesSelecionados.map(s=>({frotaSeq:t,tipo:a,funcCod:s.id}));o.idFrota&&!o.tipoAcompanhanteRetorno?o.acompanhanteFrotaSrv.update(o.idFrota,lt.Saida,i).subscribe({next:()=>{o.statusSaveAcompanhanteFrota.emit(!0)},error:s=>{o.statusSaveAcompanhanteFrota.emit(!1)}}):o.acompanhanteFrotaSrv.save(i).subscribe({next:()=>{o.statusSaveAcompanhanteFrota.emit(!0)},error:s=>{o.statusSaveAcompanhanteFrota.emit(!1)}})})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(br.r),v.rXU(hu))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-acompanhantes"]],inputs:{tipoAcompanhanteRetorno:"tipoAcompanhanteRetorno",saveAcompanhanteFrota:"saveAcompanhanteFrota",idFrota:"idFrota",isFinished:"isFinished"},outputs:{statusSaveAcompanhanteFrota:"statusSaveAcompanhanteFrota"},standalone:!0,features:[v.OA$,v.aNF],decls:14,vars:7,consts:[["listaAcompanhantesSelecionados",""],["mensagensAcompanhantes",""],[1,"ion-justify-content-center","ion-align-items-center"],[2,"width","0","height","0",3,"disabled"],["color","primary",3,"buttonClick","ngClass"],[4,"ngTemplateOutlet"],[3,"isOpen"],["slot","start"],[3,"click"],["slot","end"],[3,"click","strong"],[1,"ion-padding"],["placeholder","Buscar Acompanhante",3,"ngModelChange","ionInput","ngModel"],[4,"ngIf"],[3,"click",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["color","danger",3,"buttonClick","ngClass"],["class","ion-text-center",4,"ngIf"],[1,"ion-text-center"]],template:function(t,o){if(1&t){const a=v.RV6();v.j41(0,"ion-list")(1,"ion-item",2)(2,"ion-label"),v.EFF(3,"Acompanhante(s) selecionado(s)"),v.k0s(),v.nrm(4,"ion-input",3),v.j41(5,"app-button-add-remove",4),v.bIt("buttonClick",function(){return v.eBV(a),v.Njj(o.isOpen=!0)}),v.k0s()(),v.DNE(6,fu,1,0,"ng-container",5)(7,ko,1,0,"ng-container",5),v.k0s(),v.j41(8,"ion-modal",6),v.DNE(9,Wa,14,5,"ng-template"),v.k0s(),v.DNE(10,Va,2,1,"ng-template",null,0,v.C5r)(12,pu,1,1,"ng-template",null,1,v.C5r)}if(2&t){const a=v.sdS(11),i=v.sdS(13);v.R7$(4),v.Y8G("disabled",!0),v.R7$(),v.Y8G("ngClass",v.eq3(5,xr,o.isFinished)),v.R7$(),v.Y8G("ngTemplateOutlet",a),v.R7$(),v.Y8G("ngTemplateOutlet",i),v.R7$(),v.Y8G("isOpen",o.isOpen)}},dependencies:[Ne.MD,Ne.YU,Ne.Sq,Ne.bT,Ne.T3,V.bv,V.Jm,V.QW,V.W9,V.eU,V.$w,V.uz,V.he,V.nf,V.S1,V.ai,V.Sb,V.Gw,ct.iI,le.YN,le.BC,le.vS,Tn]}),n})();function z(r,n){if(1&r&&(v.j41(0,"ion-select-option",5),v.EFF(1),v.k0s()),2&r){const e=n.$implicit,t=v.XpG();v.Y8G("value",e[t.idKey]),v.R7$(),v.SpI(" ",e[t.descricaoKey]||""," ")}}function Y(r,n){if(1&r){const e=v.RV6();v.qex(0),v.j41(1,"ion-button",6),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.add())}),v.nrm(2,"ion-icon",7),v.k0s(),v.bVm()}}let ce=(()=>{var r;class n{constructor(){this.data=[],this.control=new le.MJ,this.placeholder="Selecione um motivo",this.label="Motivo",this.idKey="id",this.descricaoKey="descricao",this.showAddButton=!0,this.itemAdd=new v.bkB,(0,Ut.a)({addCircle:Dn.YH_})}add(){this.itemAdd.emit()}}return(r=n).\u0275fac=function(t){return new(t||r)},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-select"]],inputs:{data:"data",control:"control",placeholder:"placeholder",label:"label",idKey:"idKey",descricaoKey:"descricaoKey",showAddButton:"showAddButton"},outputs:{itemAdd:"itemAdd"},standalone:!0,features:[v.aNF],decls:6,vars:5,consts:[[1,"ion-justify-content-center","ion-align-items-center"],["position","floating"],[3,"formControl","placeholder"],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],[3,"value"],["slot","end","color","primary",3,"click"],["name","add-circle"]],template:function(t,o){1&t&&(v.j41(0,"ion-item",0)(1,"ion-label",1),v.EFF(2),v.k0s(),v.j41(3,"ion-select",2),v.DNE(4,z,2,2,"ion-select-option",3),v.k0s(),v.DNE(5,Y,3,0,"ng-container",4),v.k0s()),2&t&&(v.R7$(2),v.JRh(o.label),v.R7$(),v.Y8G("formControl",o.control)("placeholder",o.placeholder),v.R7$(),v.Y8G("ngForOf",o.data),v.R7$(),v.Y8G("ngIf",o.showAddButton))},dependencies:[Ne.MD,Ne.Sq,Ne.bT,V.bv,V.Jm,V.iq,V.uz,V.he,V.Nm,V.Ip,V.Je,ct.iI,le.X1,le.BC,le.l_]}),n})();function pe(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1)(3,"ion-button",2),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.botaoCancelarModal())}),v.EFF(4,"Voltar"),v.k0s()(),v.j41(5,"ion-buttons",3)(6,"ion-button",4),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.botaoConfirmar())}),v.EFF(7," Confirmar "),v.k0s()()()(),v.j41(8,"ion-content",5)(9,"ion-item")(10,"ion-row")(11,"ion-col",6),v.nrm(12,"ion-textarea",7),v.EFF(13),v.k0s()()()()}if(2&r){const e=v.XpG();v.R7$(6),v.Y8G("disabled",!e.descricaoControl.value)("strong",!0),v.R7$(6),v.Y8G("formControl",e.descricaoControl)("placeholder",e.placeholder),v.R7$(),v.SpI(" ",e.descricaoControl.value," ")}}let se=(()=>{var r;class n{constructor(){this.isOpen=!1,this.placeholder="Descri\xe7\xe3o",this.descricaoControl=new le.MJ(""),this.cancelar=new v.bkB,this.confirmar=new v.bkB}botaoCancelarModal(){this.cancelar.emit()}botaoConfirmar(){this.confirmar.emit()}}return(r=n).\u0275fac=function(t){return new(t||r)},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-basic-modal"]],inputs:{isOpen:"isOpen",placeholder:"placeholder",descricaoControl:"descricaoControl"},outputs:{cancelar:"cancelar",confirmar:"confirmar"},standalone:!0,features:[v.aNF],decls:2,vars:1,consts:[[3,"isOpen"],["slot","start"],[3,"click"],["slot","end"],[3,"click","disabled","strong"],[1,"ion-padding"],["size","12"],["rows","3","fill","outline",3,"formControl","placeholder"]],template:function(t,o){1&t&&(v.j41(0,"ion-modal",0),v.DNE(1,pe,14,5,"ng-template"),v.k0s()),2&t&&v.Y8G("isOpen",o.isOpen)},dependencies:[Ne.MD,V.bv,V.Jm,V.QW,V.hU,V.W9,V.eU,V.uz,V.ln,V.nc,V.ai,V.Sb,V.Gw,ct.iI,le.X1,le.BC,le.l_]}),n})();var De=ge(3207),ve=ge(8313);let tt=(()=>{var r;class n{constructor(t,o,a){this.service=t,this.loadingCtrl=o,this.alertCtrl=a,this.modalOpen=!1,this.control=new le.MJ(""),this.descricao=new le.MJ(""),this.data=[]}loadingData(){var t=this;return(0,K.A)(function*(){try{const o=yield(0,De.s)(t.service.getAll());t.data=o}catch(o){throw console.error("Erro ao carregar:",o.message),o}})()}addItem(){this.modalOpen=!0,console.log("Adicionar motivo clicado!")}onModalCancel(){this.modalOpen=!1}onModalConfirm(){var t=this;return(0,K.A)(function*(){var o;yield(0,ve.h)(t.loadingCtrl,t.alertCtrl,{mainAction:(o=(0,K.A)(function*(){yield(0,De.s)(t.service.save({descricao:t.descricao.value})),yield t.loadingData(),t.modalOpen=!1}),function(){return o.apply(this,arguments)}),onError:o=>{console.error("Erro ao executar a\xe7\xe3o no modal:",o.message)}})})()}}return(r=n).\u0275fac=function(t){v.QTQ()},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"any"}),n})();var Be=ge(3103),Nn=ge(9795);let Pn=(()=>{var r;class n extends tt{constructor(t,o,a){super(t,o,a)}ngOnInit(){var t=this;return(0,K.A)(function*(){yield t.loadingData()})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(Be.i),v.rXU(Nn.Xi),v.rXU(V.hG))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-motivo"]],inputs:{control:"control"},standalone:!0,features:[v.Vt3,v.aNF],decls:2,vars:4,consts:[["placeholder","Escolha um motivo","label","Sele\xe7\xe3o de Motivo",3,"itemAdd","data","control"],["placeholder","Digite aqui o motivo",3,"cancelar","confirmar","isOpen","descricaoControl"]],template:function(t,o){1&t&&(v.j41(0,"app-frota-select",0),v.bIt("itemAdd",function(){return o.addItem()}),v.k0s(),v.j41(1,"app-frota-basic-modal",1),v.bIt("cancelar",function(){return o.onModalCancel()})("confirmar",function(){return o.onModalConfirm()}),v.k0s()),2&t&&(v.Y8G("data",o.data)("control",o.control),v.R7$(),v.Y8G("isOpen",o.modalOpen)("descricaoControl",o.descricao))},dependencies:[Ne.MD,V.bv,ct.iI,le.X1,ce,se]}),n})();var Xr=ge(2553);let za=(()=>{var r;class n extends tt{constructor(t,o,a){super(t,o,a)}ngOnInit(){var t=this;return(0,K.A)(function*(){yield t.loadingData()})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(Xr.G),v.rXU(V.Xi),v.rXU(V.hG))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-destino"]],inputs:{control:"control"},standalone:!0,features:[v.Vt3,v.aNF],decls:2,vars:4,consts:[["placeholder","Escolha um destino","label","Sele\xe7\xe3o de Destino",3,"itemAdd","data","control"],["placeholder","Digite aqui o destino",3,"cancelar","confirmar","isOpen","descricaoControl"]],template:function(t,o){1&t&&(v.j41(0,"app-frota-select",0),v.bIt("itemAdd",function(){return o.addItem()}),v.k0s(),v.j41(1,"app-frota-basic-modal",1),v.bIt("cancelar",function(){return o.onModalCancel()})("confirmar",function(){return o.onModalConfirm()}),v.k0s()),2&t&&(v.Y8G("data",o.data)("control",o.control),v.R7$(),v.Y8G("isOpen",o.modalOpen)("descricaoControl",o.descricao))},dependencies:[Ne.MD,V.bv,ct.iI,le.X1,ce,se]}),n})();var ja=ge(7106);let Ha=(()=>{var r;class n extends tt{constructor(t,o,a){super(t,o,a),this.withoutRoutesOpen=!0}ngOnInit(){var t=this;return(0,K.A)(function*(){t.withoutRoutesOpen?yield t.loadingDataWithoutRoutesOpen():yield t.loadingData()})()}loadingDataWithoutRoutesOpen(){var t=this;return(0,K.A)(function*(){try{const o=yield(0,De.s)(t.service.getAllWithoutRoutesOpen());t.data=o}catch(o){throw console.error("Erro ao carregar veiculos:",o.message),o}})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(ja.T),v.rXU(V.Xi),v.rXU(Nn.hG))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-veiculo"]],inputs:{control:"control",withoutRoutesOpen:"withoutRoutesOpen"},standalone:!0,features:[v.Vt3,v.aNF],decls:1,vars:3,consts:[["placeholder","Escolha um ve\xedculo","label","Sele\xe7\xe3o de ve\xedculo",3,"itemAdd","data","control","showAddButton"]],template:function(t,o){1&t&&(v.j41(0,"app-frota-select",0),v.bIt("itemAdd",function(){return o.addItem()}),v.k0s()),2&t&&v.Y8G("data",o.data)("control",o.control)("showAddButton",!1)},dependencies:[Ne.MD,V.bv,ct.iI,le.X1,ce]}),n})();var qa=ge(5964),Fo=ge(5784),Mn=ge(5083);const On=(0,Mn.F3)("CameraPreview",{web:()=>ge.e(2606).then(ge.bind(ge,2606)).then(r=>new r.CameraPreviewWeb)});let wr=(()=>{var r;class n{constructor(t){this.baseApiService=t,this.endpoint="api/IdentificacaoFuncionario"}getImage(t){var o=this;return(0,K.A)(function*(){const a=yield(0,De.s)(o.baseApiService.get(`${o.endpoint}/GetImageFunc/${t}`,void 0,"blob"));return a?URL.createObjectURL(a):null})()}getAll(){return this.baseApiService.get(`${this.endpoint}/GetAll`)}save(t){return this.baseApiService.post(`${this.endpoint}/Save`,t)}}return(r=n).\u0275fac=function(t){return new(t||r)(v.KVO(Oa.v))},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})();var Bn=function(r){return r.Prompt="PROMPT",r.Camera="CAMERA",r.Photos="PHOTOS",r}(Bn||{}),Zn=function(r){return r.Rear="REAR",r.Front="FRONT",r}(Zn||{}),We=function(r){return r.Uri="uri",r.Base64="base64",r.DataUrl="dataUrl",r}(We||{});class He extends Mn.E_{getPhoto(n){var e=this;return(0,K.A)(function*(){return new Promise(function(){var t=(0,K.A)(function*(o,a){if(n.webUseInput||n.source===Bn.Photos)e.fileInputExperience(n,o,a);else if(n.source===Bn.Prompt){let i=document.querySelector("pwa-action-sheet");i||(i=document.createElement("pwa-action-sheet"),document.body.appendChild(i)),i.header=n.promptLabelHeader||"Photo",i.cancelable=!1,i.options=[{title:n.promptLabelPhoto||"From Photos"},{title:n.promptLabelPicture||"Take Picture"}],i.addEventListener("onSelection",function(){var s=(0,K.A)(function*(u){0===u.detail?e.fileInputExperience(n,o,a):e.cameraExperience(n,o,a)});return function(u){return s.apply(this,arguments)}}())}else e.cameraExperience(n,o,a)});return function(o,a){return t.apply(this,arguments)}}())})()}pickImages(n){var e=this;return(0,K.A)(function*(){return new Promise(function(){var t=(0,K.A)(function*(o,a){e.multipleFileInputExperience(o,a)});return function(o,a){return t.apply(this,arguments)}}())})()}cameraExperience(n,e,t){var o=this;return(0,K.A)(function*(){if(customElements.get("pwa-camera-modal")){const a=document.createElement("pwa-camera-modal");a.facingMode=n.direction===Zn.Front?"user":"environment",document.body.appendChild(a);try{yield a.componentOnReady(),a.addEventListener("onPhoto",function(){var i=(0,K.A)(function*(s){const u=s.detail;null===u?t(new Mn.I9("User cancelled photos app")):u instanceof Error?t(u):e(yield o._getCameraPhoto(u,n)),a.dismiss(),document.body.removeChild(a)});return function(s){return i.apply(this,arguments)}}()),a.present()}catch{o.fileInputExperience(n,e,t)}}else console.error("Unable to load PWA Element 'pwa-camera-modal'. See the docs: https://capacitorjs.com/docs/web/pwa-elements."),o.fileInputExperience(n,e,t)})()}fileInputExperience(n,e,t){let o=document.querySelector("#_capacitor-camera-input");const a=()=>{var i;null===(i=o.parentNode)||void 0===i||i.removeChild(o)};o||(o=document.createElement("input"),o.id="_capacitor-camera-input",o.type="file",o.hidden=!0,document.body.appendChild(o),o.addEventListener("change",i=>{const s=o.files[0];let u="jpeg";if("image/png"===s.type?u="png":"image/gif"===s.type&&(u="gif"),"dataUrl"===n.resultType||"base64"===n.resultType){const c=new FileReader;c.addEventListener("load",()=>{if("dataUrl"===n.resultType)e({dataUrl:c.result,format:u});else if("base64"===n.resultType){const l=c.result.split(",")[1];e({base64String:l,format:u})}a()}),c.readAsDataURL(s)}else e({webPath:URL.createObjectURL(s),format:u}),a()}),o.addEventListener("cancel",i=>{t(new Mn.I9("User cancelled photos app")),a()})),o.accept="image/*",o.capture=!0,n.source===Bn.Photos||n.source===Bn.Prompt?o.removeAttribute("capture"):n.direction===Zn.Front?o.capture="user":n.direction===Zn.Rear&&(o.capture="environment"),o.click()}multipleFileInputExperience(n,e){let t=document.querySelector("#_capacitor-camera-input-multiple");const o=()=>{var a;null===(a=t.parentNode)||void 0===a||a.removeChild(t)};t||(t=document.createElement("input"),t.id="_capacitor-camera-input-multiple",t.type="file",t.hidden=!0,t.multiple=!0,document.body.appendChild(t),t.addEventListener("change",a=>{const i=[];for(let s=0;s<t.files.length;s++){const u=t.files[s];let c="jpeg";"image/png"===u.type?c="png":"image/gif"===u.type&&(c="gif"),i.push({webPath:URL.createObjectURL(u),format:c})}n({photos:i}),o()}),t.addEventListener("cancel",a=>{e(new Mn.I9("User cancelled photos app")),o()})),t.accept="image/*",t.click()}_getCameraPhoto(n,e){return new Promise((t,o)=>{const a=new FileReader,i=n.type.split("/")[1];"uri"===e.resultType?t({webPath:URL.createObjectURL(n),format:i,saved:!1}):(a.readAsDataURL(n),a.onloadend=()=>{const s=a.result;t("dataUrl"===e.resultType?{dataUrl:s,format:i,saved:!1}:{base64String:s.split(",")[1],format:i,saved:!1})},a.onerror=s=>{o(s)})})}checkPermissions(){var n=this;return(0,K.A)(function*(){if(typeof navigator>"u"||!navigator.permissions)throw n.unavailable("Permissions API not available in this browser");try{return{camera:(yield window.navigator.permissions.query({name:"camera"})).state,photos:"granted"}}catch{throw n.unavailable("Camera permissions are not available in this browser")}})()}requestPermissions(){var n=this;return(0,K.A)(function*(){throw n.unimplemented("Not implemented on web.")})()}pickLimitedLibraryPhotos(){var n=this;return(0,K.A)(function*(){throw n.unavailable("Not implemented on web.")})()}getLimitedLibraryPhotos(){var n=this;return(0,K.A)(function*(){throw n.unavailable("Not implemented on web.")})()}}new He;const Vt=(0,Mn.F3)("Camera",{web:()=>new He});var vn=ge(8880);let Gt=(()=>{var r;class n{constructor(t,o){this.navCtrl=t,this.alertCtrl=o}getCamera(t=!0,o=!1){var a=this;return(0,K.A)(function*(){if(typeof navigator<"u"&&navigator.permissions){const i=yield Vt.checkPermissions();(!i.camera||!i.photos)&&(yield Vt.requestPermissions({permissions:["photos","camera"]}))}try{return yield Vt.getPhoto({quality:60,allowEditing:!1,direction:Zn.Rear,source:Bn.Camera,resultType:t?We.DataUrl:We.Uri,width:1024,height:1024})}catch(i){throw console.log({err:i}),o&&a.navCtrl.back({animated:!1}),new Error(i.message)}})()}getBlob(t){return new Promise((o,a)=>{const i=new XMLHttpRequest;i.onload=()=>{o(i.response)},i.onerror=()=>{a(new Error("uriToBlob failed"))},i.responseType="blob",i.open("GET",t,!0),i.send(null)})}}return(r=n).\u0275fac=function(t){return new(t||r)(v.KVO(vn.q9),v.KVO(V.hG))},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})();var Ao=function(r,n){return(Ao=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(r,n)};function Ft(r,n){function e(){this.constructor=r}Ao(r,n),r.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}function Q(r,n,e,t){return new(e||(e=Promise))(function(o,a){function i(c){try{u(t.next(c))}catch(l){a(l)}}function s(c){try{u(t.throw(c))}catch(l){a(l)}}function u(c){c.done?o(c.value):new e(function(l){l(c.value)}).then(i,s)}u((t=t.apply(r,n||[])).next())})}function ee(r,n){var e,t,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(u){return function(c){return function(l){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,t&&(o=2&l[0]?t.return:l[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,l[1])).done)return o;switch(t=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,t=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(6===l[0]&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=n.call(r,i)}catch(h){l=[6,h],t=0}finally{e=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([u,c])}}}var Do=function(){function r(n){this.global=n,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return r.prototype.setPlatform=function(n,e){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+e+"."),this.platformName=n,this.platform=e},r.prototype.registerFlag=function(n,e,t){if(this.flagRegistry[n]={evaluationFn:e,setHook:t},null!=this.urlFlags[n]){var o=this.urlFlags[n];console.warn("Setting feature override from URL "+n+": "+o+"."),this.set(n,o)}},r.prototype.get=function(n){return n in this.flags||(this.flags[n]=this.evaluateFlag(n)),this.flags[n]},r.prototype.getNumber=function(n){return this.get(n)},r.prototype.getBool=function(n){return this.get(n)},r.prototype.getFlags=function(){return this.flags},Object.defineProperty(r.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),r.prototype.set=function(n,e){if(null==this.flagRegistry[n])throw new Error("Cannot set flag "+n+" as it has not been registered.");this.flags[n]=e,null!=this.flagRegistry[n].setHook&&this.flagRegistry[n].setHook(e)},r.prototype.evaluateFlag=function(n){if(null==this.flagRegistry[n])throw new Error("Cannot evaluate flag '"+n+"': no evaluation function found.");return this.flagRegistry[n].evaluationFn()},r.prototype.setFlags=function(n){this.flags=Object.assign({},n)},r.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},r.prototype.populateURLFlags=function(){var n=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var t,o=(t={},this.global.location.search.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(a){for(var i=[],s=1;s<arguments.length;s++)i[s-1]=arguments[s];return function Xa(r,n,e){r[decodeURIComponent(n)]=decodeURIComponent(e||"")}(t,i[0],i[1]),i.join("=")}),t);"tfjsflags"in o&&o.tfjsflags.split(",").forEach(function(a){var i=a.split(":"),s=i[0];n.urlFlags[s]=function(c,l){if("true"===(l=l.toLowerCase())||"false"===l)return"true"===l;if(""+ +l===l)return+l;throw new Error("Could not parse value flag value "+l+" for flag "+c+".")}(s,i[1])})}},r}();function O(){return Ye}var Ye=null,qe=new Map,mt=new Map;function zt(r,n){var e=Ka(r,n);return qe.get(e)}function Ct(r){for(var n=qe.entries(),e=[];;){var t=n.next(),a=t.value;if(t.done)break;var s=a[1];a[0].split("_")[0]===r&&e.push(s)}return e}function Zt(r){var n=r.kernelName,e=r.backendName,t=Ka(n,e);if(qe.has(t))throw new Error("The kernel '"+n+"' for backend '"+e+"' is already registered");qe.set(t,r)}function _r(r){var n=r.kernelName;mt.has(n)&&console.warn("Overriding the gradient for '"+n+"'"),mt.set(n,r)}function Ka(r,n){return n+"_"+r}function vu(r){for(var n=r.length,e=0,t=0;n>0;)t=Math.random()*n|0,e=r[--n],r[n]=r[t],r[t]=e}function To(r,n,e){return Math.max(r,Math.min(n,e))}function Ya(r){return r%2==0?r:r+1}function mu(r){for(var n=0,e=0;e<r.length;e++)n+=r[e];return n}function R(r,n){if(!r)throw new Error("string"==typeof n?n:n())}function Re(r,n,e){void 0===e&&(e=""),R(Je(r,n),function(){return e+" Shapes "+r+" and "+n+" must match"})}function tr(r){R(null!=r,function(){return"The input to the tensor constructor must be a non-null value."})}function mn(r,n,e){if(void 0===n&&(n=[]),void 0===e&&(e=!1),null==n&&(n=[]),Array.isArray(r)||ht(r)&&!e)for(var t=0;t<r.length;++t)mn(r[t],n,e);else n.push(r);return n}function re(r){if(0===r.length)return 1;for(var n=r[0],e=1;e<r.length;e++)n*=r[e];return n}function Je(r,n){if(r===n)return!0;if(null==r||null==n||r.length!==n.length)return!1;for(var e=0;e<r.length;e++)if(r[e]!==n[e])return!1;return!0}function Ve(r){return r%1==0}function gu(r){if(null!=Math.tanh)return Math.tanh(r);if(r===1/0)return 1;if(r===-1/0)return-1;var n=Math.exp(2*r);return(n-1)/(n+1)}function No(r){var n=Math.ceil(Math.sqrt(r));return[n,Math.ceil(r/n)]}function nr(r,n){return n<=r.length?r:r+" ".repeat(n-r.length)}function $a(r,n,e){return void 0===n&&(n=function(t){return 0}),new Promise(function(t,o){var a=0,i=function(){if(r())t();else{a++;var s=n(a);null!=e&&a>=e?o():setTimeout(i,s)}};i()})}function yu(r,n){for(var e=1,t=-1,o=0;o<r.length;++o)if(r[o]>=0)e*=r[o];else if(-1===r[o]){if(-1!==t)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+t+" and dim "+o);t=o}else if(r[o]<0)throw Error("Shapes can not be < 0. Found "+r[o]+" at dim "+o);if(-1===t){if(n>0&&n!==e)throw Error("Size("+n+") must match the product of shape "+r);return r}if(0===e)throw Error("Cannot infer the missing size in ["+r+"] when there are 0 elements");if(n%e!=0)throw Error("The implicit shape can't be a fractional number. Got "+n+" / "+e);var a=r.slice();return a[t]=n/e,a}function Qe(r,n){var e=n.length;return R((r=null==r?n.map(function(t,o){return o}):[].concat(r)).every(function(t){return t>=-e&&t<e}),function(){return"All values in axis param must be in range [-"+e+", "+e+") but got axis "+r}),R(r.every(function(t){return Ve(t)}),function(){return"All values in axis param must be integers but got axis "+r}),r.map(function(t){return t<0?e+t:t})}function Ln(r,n){for(var e=[],t=[],o=null!=n&&Array.isArray(n)&&0===n.length,a=null==n||o?null:Qe(n,r).sort(),i=0,s=0;s<r.length;++s){if(null!=a){if(a[i]===s&&1!==r[s])throw new Error("Can't squeeze axis "+s+" since its dim '"+r[s]+"' is not 1");(null==a[i]||a[i]>s)&&1===r[s]&&(e.push(r[s]),t.push(s)),a[i]<=s&&i++}1!==r[s]&&(e.push(r[s]),t.push(s))}return{newShape:e,keptDims:t}}function Cr(r,n){var e=null;if(null==r||"float32"===r)e=new Float32Array(n);else if("int32"===r)e=new Int32Array(n);else{if("bool"!==r)throw new Error("Unknown data type "+r);e=new Uint8Array(n)}return e}function Kr(r,n){var e=null;if(null==r||"float32"===r)e=new Float32Array(n);else if("int32"===r)e=new Int32Array(n);else if("bool"===r)e=new Uint8Array(n);else{if("string"!==r)throw new Error("Unknown data type "+r);e=new Array(n)}return e}function bu(r,n){for(var e=0;e<r.length;e++){var t=r[e];if(isNaN(t)||!isFinite(t))throw Error("A tensor of type "+n+" being uploaded contains "+t+".")}}function xu(r){return"bool"===r||"complex64"===r||"float32"===r||"int32"===r||"string"===r}function wu(r,n){return!("complex64"===n||"float32"===n&&"complex64"!==r||"int32"===n&&"float32"!==r&&"complex64"!==r||"bool"===n&&"bool"===r)}function ht(r){return r instanceof Float32Array||r instanceof Int32Array||r instanceof Uint8Array}function Ja(r){if("float32"===r||"int32"===r)return 4;if("complex64"===r)return 8;if("bool"===r)return 1;throw new Error("Unknown dtype "+r)}function _u(r){if(null==r)return 0;var n=0;return r.forEach(function(e){return n+=e.length}),n}function Wn(r){return"string"==typeof r||r instanceof String}function Cu(r){return"boolean"==typeof r}function Eu(r){return"number"==typeof r}function Er(r){return Array.isArray(r)?Er(r[0]):r instanceof Float32Array?"float32":r instanceof Int32Array||r instanceof Uint8Array?"int32":Eu(r)?"float32":Wn(r)?"string":Cu(r)?"bool":"float32"}function Un(r){return!!(r&&r.constructor&&r.call&&r.apply)}function Po(r,n){for(var e=n;e<r;++e)if(r%e==0)return e;return r}function jt(r){var n=r.length;if(n<2)return[];var e=new Array(n-1);e[n-2]=r[n-1];for(var t=n-3;t>=0;--t)e[t]=e[t+1]*r[t+1];return e}function Qa(r,n,e){if("string"===n)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(r)&&(r=mn(r)),e&&bu(r,n),i=n,(a=r)instanceof Float32Array&&"float32"===i||a instanceof Int32Array&&"int32"===i||a instanceof Uint8Array&&"bool"===i)return r;var a,i;if(null==n||"float32"===n||"complex64"===n)return new Float32Array(r);if("int32"===n)return new Int32Array(r);if("bool"===n){for(var t=new Uint8Array(r.length),o=0;o<t.length;++o)0!==Math.round(r[o])&&(t[o]=1);return t}throw new Error("Unknown data type "+n)}function Za(r,n){if(0===r.length)return n[0];var e=r.reduce(function(t,o){return t*o});if(0===e)return[];if(e!==n.length)throw new Error("["+r+"] does not match the input size.");return function t(o,a,i){var s=new Array;if(1===a.length)for(var u=a[0],c=0;c<u;c++)s[c]=i[o+c];else{u=a[0];var l=a.slice(1),h=l.reduce(function(f,d){return f*d});for(c=0;c<u;c++)s[c]=t(o+c*h,l,i)}return s}(0,r,n)}function ei(r,n){for(var e=Rr(r,n),t=0;t<e.length;t++)e[t]=1;return e}function Rr(r,n){if(null==n||"float32"===n||"complex64"===n)return new Float32Array(r);if("int32"===n)return new Int32Array(r);if("bool"===n)return new Uint8Array(r);throw new Error("Unknown data type "+n)}function Ht(){return O().platform.now()}function ti(r){r.forEach(function(n){R(Number.isInteger(n)&&n>=0,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+r+"]."})})}function Ru(r,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",O().platform.encode(r,n)}function Yr(r,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",O().platform.decode(r,n)}function ni(r,n,e){if(0===n)return 0;if(1===n)return r[0];for(var t=r[r.length-1],o=0;o<r.length-1;++o)t+=e[o]*r[o];return t}function Su(r,n,e){if(0===n)return[];if(1===n)return[r];for(var t=new Array(n),o=0;o<t.length-1;++o)t[o]=Math.floor(r/e[o]),r-=t[o]*e[o];return t[t.length-1]=r,t}Object.freeze({shuffle:vu,clamp:To,nearestLargerEven:Ya,sum:mu,randUniform:function(r,n){var e=Math.random();return n*e+(1-e)*r},distSquared:function(r,n){for(var e=0,t=0;t<r.length;t++){var o=Number(r[t])-Number(n[t]);e+=o*o}return e},assert:R,assertShapesMatch:Re,assertNonNull:tr,flatten:mn,sizeFromShape:re,isScalarShape:function(r){return 0===r.length},arraysEqual:Je,isInt:Ve,tanh:gu,sizeToSquarishShape:No,createShuffledIndices:function(r){for(var n=new Uint32Array(r),e=0;e<r;++e)n[e]=e;return vu(n),n},rightPad:nr,repeatedTry:$a,inferFromImplicitShape:yu,parseAxisParam:Qe,squeezeShape:Ln,getTypedArrayFromDType:Cr,getArrayFromDType:Kr,checkConversionForErrors:bu,isValidDtype:xu,hasEncodingLoss:wu,isTypedArray:ht,bytesPerElement:Ja,bytesFromStringArray:_u,isString:Wn,isBoolean:Cu,isNumber:Eu,inferDtype:Er,isFunction:Un,nearestDivisor:Po,computeStrides:jt,toTypedArray:Qa,toNestedArray:Za,makeOnesTypedArray:ei,makeZerosTypedArray:Rr,now:Ht,assertNonNegativeIntegerDimensions:ti,fetch:function(r,n){return O().platform.fetch(r,n)},encodeString:Ru,decodeString:Yr,locToIndex:ni,indexToLoc:Su});var Sf=function(){function r(n,e){this.backendTimer=n,this.logger=e,null==e&&(this.logger=new kf)}return r.prototype.profileKernel=function(n,e,t){var o,a=this,i=this.backendTimer.time(function(){o=t()});return o.forEach(function(s){s.data().then(function(u){(function(c,l,h){if("float32"!==l)return!1;for(var f=0;f<c.length;f++){var d=c[f];if(isNaN(d)||!isFinite(d))return console.warn("Found "+d+" in the result of '"+h+"'"),!0}})(u,s.dtype,n),i.then(function(c){var l="";null!=c.getExtraProfileInfo&&(l=c.getExtraProfileInfo()),a.logger.logKernelProfile(n,s,u,c.kernelMs,e,l)})})}),o},r}(),kf=function(){function r(){}return r.prototype.logKernelProfile=function(n,e,t,o,a,i){var s="number"==typeof o?nr(o+"ms",9):o.error,u=nr(n,25),c=e.rank,l=e.size,h=nr(e.shape.toString(),14),f="";for(var d in a){var p=a[d].shape||e.shape,g=p.length;f+=d+": "+g+"D "+(g>0?p:"")+" "}console.log("%c"+u+"\t%c"+s+"\t%c"+c+"D "+h+"\t%c"+l+"\t%c"+f+"\t%c"+i,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},r}();function Jr(r,n,e){return nr(Array.isArray(r)?parseFloat(r[0].toFixed(7))+" + "+parseFloat(r[1].toFixed(7))+"j":Wn(r)?"'"+r+"'":"bool"===e?Iu(r):parseFloat(r.toFixed(7)).toString(),n)}function Iu(r){return 0===r?"false":"true"}function Qr(r){for(var n=[],e=0;e<r.length;e+=2)n.push([r[e],r[e+1]]);return n}var Zr=function(){function r(n,e,t){var o=this;if(this.dtype=e,this.shape=n.slice(),this.size=re(n),null!=t){var a=t.length;R(a===this.size,function(){return"Length of values '"+a+"' does not match the size inferred by the shape '"+o.size+"'."})}if("complex64"===e)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=t||Kr(e,this.size),this.strides=jt(n)}return r.prototype.set=function(n){for(var e=this,t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];0===t.length&&(t=[0]),R(t.length===this.rank,function(){return"The number of provided coordinates ("+t.length+") must match the rank ("+e.rank+")"});var a=this.locToIndex(t);this.values[a]=n},r.prototype.get=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];0===n.length&&(n=[0]);for(var t=0,o=0,a=n;o<a.length;o++){var i=a[o];if(i<0||i>=this.shape[t])throw new Error("Requested out of range element at "+n+".   Buffer shape="+this.shape);t++}for(var u=n[n.length-1],c=0;c<n.length-1;++c)u+=this.strides[c]*n[c];return this.values[u]},r.prototype.locToIndex=function(n){if(0===this.rank)return 0;if(1===this.rank)return n[0];for(var e=n[n.length-1],t=0;t<n.length-1;++t)e+=this.strides[t]*n[t];return e},r.prototype.indexToLoc=function(n){if(0===this.rank)return[];if(1===this.rank)return[n];for(var e=new Array(this.shape.length),t=0;t<e.length-1;++t)e[t]=Math.floor(n/this.strides[t]),n-=e[t]*this.strides[t];return e[e.length-1]=n,e},Object.defineProperty(r.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),r.prototype.toTensor=function(){return en().makeTensor(this.values,this.shape,this.dtype)},r}(),en=null,M=null,Fu=null,Me=function(){function r(n,e,t,o){this.kept=!1,this.isDisposedInternal=!1,this.shape=n.slice(),this.dtype=e||"float32",this.size=re(n),this.strides=jt(n),this.dataId=t,this.id=o,this.rankType=this.rank<5?this.rank.toString():"higher"}return r.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},r.prototype.asScalar=function(){return this.throwIfDisposed(),R(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},r.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},r.prototype.as2D=function(n,e){return this.throwIfDisposed(),this.reshape([n,e])},r.prototype.as3D=function(n,e,t){return this.throwIfDisposed(),this.reshape([n,e,t])},r.prototype.as4D=function(n,e,t,o){return this.throwIfDisposed(),this.reshape([n,e,t,o])},r.prototype.as5D=function(n,e,t,o,a){return this.throwIfDisposed(),this.reshape([n,e,t,o,a])},r.prototype.asType=function(n){return this.throwIfDisposed(),M.cast(this,n)},Object.defineProperty(r.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),r.prototype.buffer=function(){return Q(this,void 0,void 0,function(){var n;return ee(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return n=e.sent(),[2,M.buffer(this.shape,this.dtype,n)]}})})},r.prototype.bufferSync=function(){return M.buffer(this.shape,this.dtype,this.dataSync())},r.prototype.array=function(){return Q(this,void 0,void 0,function(){var n;return ee(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return n=e.sent(),[2,Za(this.shape,n)]}})})},r.prototype.arraySync=function(){return Za(this.shape,this.dataSync())},r.prototype.data=function(){return Q(this,void 0,void 0,function(){var n,e;return ee(this,function(t){switch(t.label){case 0:return this.throwIfDisposed(),n=en().read(this.dataId),"string"!==this.dtype?[3,2]:[4,n];case 1:e=t.sent();try{return[2,e.map(function(o){return Yr(o)})]}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}t.label=2;case 2:return[2,n]}})})},r.prototype.dataSync=function(){this.throwIfDisposed();var n=en().readSync(this.dataId);if("string"===this.dtype)try{return n.map(function(e){return Yr(e)})}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return n},r.prototype.bytes=function(){return Q(this,void 0,void 0,function(){var n;return ee(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),[4,en().read(this.dataId)];case 1:return n=e.sent(),"string"===this.dtype?[2,n]:[2,new Uint8Array(n.buffer)]}})})},r.prototype.dispose=function(){this.isDisposed||(en().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(r.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),r.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},r.prototype.toFloat=function(){return this.asType("float32")},r.prototype.toInt=function(){return this.asType("int32")},r.prototype.toBool=function(){return this.asType("bool")},r.prototype.print=function(n){return void 0===n&&(n=!1),M.print(this,n)},r.prototype.reshape=function(n){return this.throwIfDisposed(),M.reshape(this,n)},r.prototype.reshapeAs=function(n){return this.throwIfDisposed(),this.reshape(n.shape)},r.prototype.expandDims=function(n){return void 0===n&&(n=0),M.expandDims(this,n)},r.prototype.cumsum=function(n,e,t){return void 0===n&&(n=0),void 0===e&&(e=!1),void 0===t&&(t=!1),M.cumsum(this,n,e,t)},r.prototype.squeeze=function(n){return this.throwIfDisposed(),M.squeeze(this,n)},r.prototype.clone=function(){return this.throwIfDisposed(),M.clone(this)},r.prototype.oneHot=function(n,e,t){return this.throwIfDisposed(),M.oneHot(this,n,e,t)},r.prototype.toString=function(n){return void 0===n&&(n=!1),function If(r,n,e,t){var o=jt(n),a=function(c,l,h,f){var d=re(l),p=f[f.length-1],g=new Array(p).fill(0),m=l.length,y="complex64"===h?Qr(c):c;if(m>1)for(var x=0;x<d/p;x++)for(var w=x*p,b=0;b<p;b++)g[b]=Math.max(g[b],Jr(y[w+b],0,h).length);return g}(r,n,e,o),i=n.length,s=function c(l,h,f,d,p,g){void 0===g&&(g=!0);var m="complex64"===f?2:1,y=h[0],x=h.length;if(0===x)return"complex64"===f?[Jr(Qr(l)[0],0,f)]:"bool"===f?[Iu(l[0])]:[l[0].toString()];if(1===x){if(y>20){var b=Array.from(l.slice(0,3*m)),_=Array.from(l.slice((y-3)*m,y*m));return"complex64"===f&&(b=Qr(b),_=Qr(_)),["["+b.map(function(L,H){return Jr(L,p[H],f)}).join(", ")+", ..., "+_.map(function(L,H){return Jr(L,p[y-3+H],f)}).join(", ")+"]"]}return["["+("complex64"===f?Qr(l):Array.from(l)).map(function(L,H){return Jr(L,p[H],f)}).join(", ")+"]"]}var E=h.slice(1),F=d.slice(1),I=d[0]*m,S=[];if(y>20){for(var k=0;k<3;k++){var N=(T=k*I)+I;S.push.apply(S,c(l.slice(T,N),E,f,F,p,!1))}for(S.push("..."),k=y-3;k<y;k++)N=(T=k*I)+I,S.push.apply(S,c(l.slice(T,N),E,f,F,p,k===y-1))}else for(k=0;k<y;k++){var T;N=(T=k*I)+I,S.push.apply(S,c(l.slice(T,N),E,f,F,p,k===y-1))}var W=2===x?",":"";for(S[0]="["+S[0]+W,k=1;k<S.length-1;k++)S[k]=" "+S[k]+W;var B=",\n";for(k=2;k<x;k++)B+="\n";return S[S.length-1]=" "+S[S.length-1]+"]"+(g?"":B),S}(r,n,e,o,a),u=["Tensor"];return t&&(u.push("  dtype: "+e),u.push("  rank: "+i),u.push("  shape: ["+n+"]"),u.push("  values:")),u.push(s.map(function(c){return"    "+c}).join("\n")),u.join("\n")}(this.dataSync(),this.shape,this.dtype,n)},r.prototype.tile=function(n){return this.throwIfDisposed(),M.tile(this,n)},r.prototype.gather=function(n,e){return void 0===e&&(e=0),this.throwIfDisposed(),M.gather(this,n,e)},r.prototype.matMul=function(n,e,t){return void 0===e&&(e=!1),void 0===t&&(t=!1),this.throwIfDisposed(),M.matMul(this,n,e,t)},r.prototype.dot=function(n){return this.throwIfDisposed(),M.dot(this,n)},r.prototype.norm=function(n,e,t){return void 0===n&&(n="euclidean"),void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),M.norm(this,n,e,t)},r.prototype.slice=function(n,e){return this.throwIfDisposed(),M.slice(this,n,e)},r.prototype.reverse=function(n){return this.throwIfDisposed(),M.reverse(this,n)},r.prototype.concat=function(n,e){return void 0===e&&(e=0),this.throwIfDisposed(),n instanceof r&&(n=[n]),M.concat([this].concat(n),e)},r.prototype.split=function(n,e){return void 0===e&&(e=0),this.throwIfDisposed(),M.split(this,n,e)},r.prototype.stack=function(n,e){return void 0===e&&(e=0),M.stack([this,n],e)},r.prototype.unstack=function(n){return void 0===n&&(n=0),M.unstack(this,n)},r.prototype.pad=function(n,e){return void 0===e&&(e=0),M.pad(this,n,e)},r.prototype.batchNormalization=function(n,e,t,o,a){return void 0===t&&(t=.001),Fu("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(n,e,a,o,t)},r.prototype.batchNorm=function(n,e,t,o,a){return void 0===a&&(a=.001),this.throwIfDisposed(),M.batchNorm(this,n,e,t,o,a)},r.prototype.all=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.all(this,n,e)},r.prototype.any=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.any(this,n,e)},r.prototype.logSumExp=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.logSumExp(this,n,e)},r.prototype.sum=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.sum(this,n,e)},r.prototype.prod=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.prod(this,n,e)},r.prototype.mean=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.mean(this,n,e)},r.prototype.min=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.min(this,n,e)},r.prototype.max=function(n,e){return void 0===n&&(n=null),void 0===e&&(e=!1),this.throwIfDisposed(),M.max(this,n,e)},r.prototype.argMin=function(n){return void 0===n&&(n=null),this.throwIfDisposed(),M.argMin(this,n)},r.prototype.argMax=function(n){return void 0===n&&(n=null),this.throwIfDisposed(),M.argMax(this,n)},r.prototype.cast=function(n){return this.throwIfDisposed(),M.cast(this,n)},r.prototype.add=function(n){return this.throwIfDisposed(),M.add(this,n)},r.prototype.addStrict=function(n){return this.throwIfDisposed(),M.addStrict(this,n)},r.prototype.atan2=function(n){return this.throwIfDisposed(),M.atan2(this,n)},r.prototype.sub=function(n){return this.throwIfDisposed(),M.sub(this,n)},r.prototype.subStrict=function(n){return this.throwIfDisposed(),M.subStrict(this,n)},r.prototype.pow=function(n){return this.throwIfDisposed(),M.pow(this,n)},r.prototype.powStrict=function(n){return this.throwIfDisposed(),M.powStrict(this,n)},r.prototype.mul=function(n){return this.throwIfDisposed(),M.mul(this,n)},r.prototype.mulStrict=function(n){return this.throwIfDisposed(),M.mulStrict(this,n)},r.prototype.div=function(n){return this.throwIfDisposed(),M.div(this,n)},r.prototype.divNoNan=function(n){return this.throwIfDisposed(),M.divNoNan(this,n)},r.prototype.floorDiv=function(n){return this.throwIfDisposed(),M.floorDiv(this,n)},r.prototype.divStrict=function(n){return this.throwIfDisposed(),M.divStrict(this,n)},r.prototype.minimum=function(n){return this.throwIfDisposed(),M.minimum(this,n)},r.prototype.minimumStrict=function(n){return this.throwIfDisposed(),M.minimumStrict(this,n)},r.prototype.maximum=function(n){return this.throwIfDisposed(),M.maximum(this,n)},r.prototype.maximumStrict=function(n){return this.throwIfDisposed(),M.maximumStrict(this,n)},r.prototype.mod=function(n){return this.throwIfDisposed(),M.mod(this,n)},r.prototype.modStrict=function(n){return this.throwIfDisposed(),M.modStrict(this,n)},r.prototype.squaredDifferenceStrict=function(n){return this.throwIfDisposed(),M.squaredDifferenceStrict(this,n)},r.prototype.transpose=function(n){return this.throwIfDisposed(),M.transpose(this,n)},r.prototype.notEqual=function(n){return this.throwIfDisposed(),M.notEqual(this,n)},r.prototype.notEqualStrict=function(n){return this.throwIfDisposed(),M.notEqualStrict(this,n)},r.prototype.less=function(n){return this.throwIfDisposed(),M.less(this,n)},r.prototype.lessStrict=function(n){return this.throwIfDisposed(),M.lessStrict(this,n)},r.prototype.equal=function(n){return this.throwIfDisposed(),M.equal(this,n)},r.prototype.equalStrict=function(n){return this.throwIfDisposed(),M.equalStrict(this,n)},r.prototype.lessEqual=function(n){return this.throwIfDisposed(),M.lessEqual(this,n)},r.prototype.lessEqualStrict=function(n){return this.throwIfDisposed(),M.lessEqualStrict(this,n)},r.prototype.greater=function(n){return this.throwIfDisposed(),M.greater(this,n)},r.prototype.greaterStrict=function(n){return this.throwIfDisposed(),M.greaterStrict(this,n)},r.prototype.greaterEqual=function(n){return this.throwIfDisposed(),M.greaterEqual(this,n)},r.prototype.greaterEqualStrict=function(n){return this.throwIfDisposed(),M.greaterEqualStrict(this,n)},r.prototype.logicalAnd=function(n){return this.throwIfDisposed(),M.logicalAnd(this,n)},r.prototype.logicalOr=function(n){return this.throwIfDisposed(),M.logicalOr(this,n)},r.prototype.logicalNot=function(){return this.throwIfDisposed(),M.logicalNot(this)},r.prototype.logicalXor=function(n){return this.throwIfDisposed(),M.logicalXor(this,n)},r.prototype.where=function(n,e){return this.throwIfDisposed(),M.where(n,this,e)},r.prototype.neg=function(){return this.throwIfDisposed(),M.neg(this)},r.prototype.ceil=function(){return this.throwIfDisposed(),M.ceil(this)},r.prototype.floor=function(){return this.throwIfDisposed(),M.floor(this)},r.prototype.sign=function(){return this.throwIfDisposed(),M.sign(this)},r.prototype.isNaN=function(){return this.throwIfDisposed(),M.isNaN(this)},r.prototype.isInf=function(){return this.throwIfDisposed(),M.isInf(this)},r.prototype.isFinite=function(){return this.throwIfDisposed(),M.isFinite(this)},r.prototype.exp=function(){return this.throwIfDisposed(),M.exp(this)},r.prototype.expm1=function(){return this.throwIfDisposed(),M.expm1(this)},r.prototype.log=function(){return this.throwIfDisposed(),M.log(this)},r.prototype.log1p=function(){return this.throwIfDisposed(),M.log1p(this)},r.prototype.sqrt=function(){return this.throwIfDisposed(),M.sqrt(this)},r.prototype.rsqrt=function(){return this.throwIfDisposed(),M.rsqrt(this)},r.prototype.square=function(){return this.throwIfDisposed(),M.square(this)},r.prototype.reciprocal=function(){return this.throwIfDisposed(),M.reciprocal(this)},r.prototype.abs=function(){return this.throwIfDisposed(),M.abs(this)},r.prototype.clipByValue=function(n,e){return this.throwIfDisposed(),M.clipByValue(this,n,e)},r.prototype.relu=function(){return this.throwIfDisposed(),M.relu(this)},r.prototype.relu6=function(){return this.throwIfDisposed(),M.relu6(this)},r.prototype.elu=function(){return this.throwIfDisposed(),M.elu(this)},r.prototype.selu=function(){return this.throwIfDisposed(),M.selu(this)},r.prototype.leakyRelu=function(n){return void 0===n&&(n=.2),this.throwIfDisposed(),M.leakyRelu(this,n)},r.prototype.prelu=function(n){return this.throwIfDisposed(),M.prelu(this,n)},r.prototype.sigmoid=function(){return this.throwIfDisposed(),M.sigmoid(this)},r.prototype.logSigmoid=function(){return this.throwIfDisposed(),M.logSigmoid(this)},r.prototype.softplus=function(){return this.throwIfDisposed(),M.softplus(this)},r.prototype.zerosLike=function(){return this.throwIfDisposed(),M.zerosLike(this)},r.prototype.onesLike=function(){return this.throwIfDisposed(),M.onesLike(this)},r.prototype.sin=function(){return this.throwIfDisposed(),M.sin(this)},r.prototype.cos=function(){return this.throwIfDisposed(),M.cos(this)},r.prototype.tan=function(){return this.throwIfDisposed(),M.tan(this)},r.prototype.asin=function(){return this.throwIfDisposed(),M.asin(this)},r.prototype.acos=function(){return this.throwIfDisposed(),M.acos(this)},r.prototype.atan=function(){return this.throwIfDisposed(),M.atan(this)},r.prototype.sinh=function(){return this.throwIfDisposed(),M.sinh(this)},r.prototype.cosh=function(){return this.throwIfDisposed(),M.cosh(this)},r.prototype.tanh=function(){return this.throwIfDisposed(),M.tanh(this)},r.prototype.asinh=function(){return this.throwIfDisposed(),M.asinh(this)},r.prototype.acosh=function(){return this.throwIfDisposed(),M.acosh(this)},r.prototype.atanh=function(){return this.throwIfDisposed(),M.atanh(this)},r.prototype.erf=function(){return this.throwIfDisposed(),M.erf(this)},r.prototype.round=function(){return this.throwIfDisposed(),M.round(this)},r.prototype.step=function(n){return void 0===n&&(n=0),this.throwIfDisposed(),M.step(this,n)},r.prototype.softmax=function(n){return void 0===n&&(n=-1),this.throwIfDisposed(),M.softmax(this,n)},r.prototype.logSoftmax=function(n){return void 0===n&&(n=-1),this.throwIfDisposed(),M.logSoftmax(this,n)},r.prototype.resizeBilinear=function(n,e){return void 0===e&&(e=!1),this.throwIfDisposed(),M.image.resizeBilinear(this,n,e)},r.prototype.resizeNearestNeighbor=function(n,e){return void 0===e&&(e=!1),this.throwIfDisposed(),M.image.resizeNearestNeighbor(this,n,e)},r.prototype.conv1d=function(n,e,t,o,a,i){return void 0===o&&(o="NWC"),void 0===a&&(a=1),this.throwIfDisposed(),M.conv1d(this,n,e,t,o,a,i)},r.prototype.conv2d=function(n,e,t,o,a,i){return void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]),this.throwIfDisposed(),M.conv2d(this,n,e,t,o,a,i)},r.prototype.conv2dTranspose=function(n,e,t,o,a){return this.throwIfDisposed(),M.conv2dTranspose(this,n,e,t,o,a)},r.prototype.depthwiseConv2D=function(n,e,t,o,a,i){return void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]),this.throwIfDisposed(),M.depthwiseConv2d(this,n,e,t,o,a,i)},r.prototype.separableConv2d=function(n,e,t,o,a,i){return void 0===a&&(a=[1,1]),void 0===i&&(i="NHWC"),this.throwIfDisposed(),M.separableConv2d(this,n,e,t,o,a,i)},r.prototype.avgPool=function(n,e,t,o){return this.throwIfDisposed(),M.avgPool(this,n,e,t,o)},r.prototype.maxPool=function(n,e,t,o){return this.throwIfDisposed(),M.maxPool(this,n,e,t,o)},r.prototype.localResponseNormalization=function(n,e,t,o){return void 0===n&&(n=5),void 0===e&&(e=1),void 0===t&&(t=1),void 0===o&&(o=.5),M.localResponseNormalization(this,n,e,t,o)},r.prototype.pool=function(n,e,t,o,a){return this.throwIfDisposed(),M.pool(this,n,e,t,o,a)},r.prototype.variable=function(n,e,t){return void 0===n&&(n=!0),this.throwIfDisposed(),en().makeVariable(this,n,e,t)},r.prototype.unsortedSegmentSum=function(n,e){return this.throwIfDisposed(),M.unsortedSegmentSum(this,n,e)},r.prototype.batchToSpaceND=function(n,e){return this.throwIfDisposed(),M.batchToSpaceND(this,n,e)},r.prototype.spaceToBatchND=function(n,e){return this.throwIfDisposed(),M.spaceToBatchND(this,n,e)},r.prototype.topk=function(n,e){return void 0===n&&(n=1),void 0===e&&(e=!0),this.throwIfDisposed(),M.topk(this,n,e)},r.prototype.stridedSlice=function(n,e,t,o,a,i,s,u){return void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===u&&(u=0),this.throwIfDisposed(),M.stridedSlice(this,n,e,t,o,a,i,s,u)},r.prototype.depthToSpace=function(n,e){return this.throwIfDisposed(),M.depthToSpace(this,n,e)},r.prototype.fft=function(){return this.throwIfDisposed(),M.spectral.fft(this)},r.prototype.ifft=function(){return this.throwIfDisposed(),M.spectral.ifft(this)},r.prototype.rfft=function(){return this.throwIfDisposed(),M.spectral.rfft(this)},r.prototype.irfft=function(){return this.throwIfDisposed(),M.spectral.irfft(this)},r}();Object.defineProperty(Me,Symbol.hasInstance,{value:function(r){return!!r&&null!=r.dataId&&null!=r.shape&&null!=r.dtype}});var Au,oi,ai,ii,si,r,Sr=function(r){function n(e,t,o,a){var i=r.call(this,e.shape,e.dtype,e.dataId,a)||this;return i.trainable=t,i.name=o,i}return Ft(n,r),n.prototype.assign=function(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!Je(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");en().disposeTensor(this),this.dataId=e.dataId,en().incRef(this,null)},n.prototype.dispose=function(){en().disposeVariable(this),this.isDisposedInternal=!0},n}(Me);Object.defineProperty(Sr,Symbol.hasInstance,{value:function(r){return r instanceof Me&&null!=r.assign&&r.assign instanceof Function}}),(r=Au||(Au={})).R0="R0",r.R1="R1",r.R2="R2",r.R3="R3",r.R4="R4",r.R5="R5",r.R6="R6",function(r){r.float32="float32",r.int32="int32",r.bool="int32",r.complex64="complex64"}(oi||(oi={})),function(r){r.float32="float32",r.int32="int32",r.bool="bool",r.complex64="complex64"}(ai||(ai={})),function(r){r.float32="float32",r.int32="float32",r.bool="float32",r.complex64="complex64"}(ii||(ii={})),function(r){r.float32="complex64",r.int32="complex64",r.bool="complex64",r.complex64="complex64"}(si||(si={}));var Ff={float32:ii,int32:oi,bool:ai,complex64:si};function it(r,n){if("string"===r||"string"===n){if("string"===r&&"string"===n)return"string";throw new Error("Can not upcast "+r+" with "+n)}return Ff[r][n]}function ui(r){return it(r,"int32")}function Ue(r,n){if(r.dtype===n.dtype)return[r,n];var e=it(r.dtype,n.dtype);return[r.cast(e),n.cast(e)]}function Du(r,n){R(r.dtype===n.dtype,function(){return"The dtypes of the first("+r.dtype+") and second("+n.dtype+") input must match"})}function ci(r){var n=[];return function e(t,o,a){if(null!=t){if(t instanceof Me)return void o.push(t);if(i=t,Array.isArray(i)||"object"==typeof i){var i,s=t;for(var u in s){var c=s[u];a.has(c)||(a.add(c),e(c,o,a))}}}}(r,n,new Set),n}Object.freeze({makeTypesMatch:Ue,assertTypesMatch:Du,isTensorInList:function(r,n){return n.some(function(e){return e.id===r.id})},getTensorsInContainer:ci});var li,Tu=function(){function r(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return r.prototype.dispose=function(){for(var n in this.registeredVariables)this.registeredVariables[n].dispose()},r}(),Af=function(){function r(n){this.ENV=n,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new Tu}return r.prototype.ready=function(){return Q(this,void 0,void 0,function(){var n,e,t;return ee(this,function(o){switch(o.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];n=this.getSortedBackends(),e=0,o.label=1;case 1:return e<n.length?[4,this.initializeBackend(t=n[e]).success]:[3,5];case 2:return o.sent()?[4,this.setBackend(t)]:[3,4];case 3:return o.sent(),[2];case 4:return e++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(r.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var n=this.initializeBackendsAndReturnBest(),e=n.name;if(n.asyncInit)throw new Error("The highest priority backend '"+e+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(e)}return this.backendInstance},enumerable:!0,configurable:!0}),r.prototype.backendNames=function(){return Object.keys(this.registryFactory)},r.prototype.findBackend=function(n){return n in this.registry||n in this.registryFactory&&!this.initializeBackend(n).asyncInit?this.registry[n]:null},r.prototype.findBackendFactory=function(n){return n in this.registryFactory?this.registryFactory[n].factory:null},r.prototype.registerBackend=function(n,e,t){return void 0===t&&(t=1),n in this.registryFactory?(console.warn(n+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[n]={factory:e,priority:t},!0)},r.prototype.setBackend=function(n){return Q(this,void 0,void 0,function(){var e,t,o;return ee(this,function(a){switch(a.label){case 0:if(null==this.registryFactory[n])throw new Error("Backend name '"+n+"' not found in registry");return this.backendName=n,null!=this.registry[n]?[3,4]:(this.backendInstance=null,e=this.initializeBackend(n),t=e.success,e.asyncInit?[4,t]:[3,2]);case 1:return o=a.sent(),[3,3];case 2:o=t,a.label=3;case 3:if(!o)return[2,!1];a.label=4;case 4:return this.backendInstance=this.registry[n],this.setupRegisteredKernels(),this.profiler=new Sf(this.backendInstance),[2,!0]}})})},r.prototype.setupRegisteredKernels=function(){var n=this;Ct(this.backendName).forEach(function(e){null!=e.setupFunc&&e.setupFunc(n.backendInstance)})},r.prototype.disposeRegisteredKernels=function(n){var e=this;Ct(n).forEach(function(t){null!=t.disposeFunc&&t.disposeFunc(e.registry[n])})},r.prototype.initializeBackend=function(n){var e=this,t=this.registryFactory[n];if(null==t)throw new Error("Cannot initialize backend "+n+", no registration found.");try{var o=t.factory();if(Promise.resolve(o)===o){var a=++this.pendingBackendInitId,i=o.then(function(s){return!(a<e.pendingBackendInitId||(e.registry[n]=s,e.pendingBackendInit=null,0))}).catch(function(s){return!(a<e.pendingBackendInitId||(e.pendingBackendInit=null,console.warn("Initialization of backend "+n+" failed"),console.warn(s.stack||s.message),1))});return this.pendingBackendInit=i,{success:i,asyncInit:!0}}return this.registry[n]=o,{success:!0,asyncInit:!1}}catch(s){return console.warn("Initialization of backend "+n+" failed"),console.warn(s.stack||s.message),{success:!1,asyncInit:!1}}},r.prototype.removeBackend=function(n){if(!(n in this.registryFactory))throw new Error(n+" backend not found in registry");this.backendName===n&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,n in this.registry&&(this.disposeRegisteredKernels(n),this.registry[n].dispose(),delete this.registry[n]),delete this.registryFactory[n],this.backendName===n&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},r.prototype.getSortedBackends=function(){var n=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(e,t){return n.registryFactory[t].priority-n.registryFactory[e].priority})},r.prototype.initializeBackendsAndReturnBest=function(){for(var n=this.getSortedBackends(),e=0;e<n.length;e++){var t=n[e],o=this.initializeBackend(t),i=o.asyncInit;if(i||o.success)return{name:t,asyncInit:i}}throw new Error("Could not initialize any backends, all backend initializations failed.")},r.prototype.moveData=function(n,e){var t=this.state.tensorInfo.get(e),o=t.backend,a=this.readSync(e);o.disposeData(e),t.backend=n,n.move(e,a,t.shape,t.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},r.prototype.tidy=function(n,e){var t,o=this,a=null;if(null==e){if("function"!=typeof n)throw new Error("Please provide a function to tidy()");e=n}else{if("string"!=typeof n&&!(n instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof e)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");a=n}return this.scopedRun(function(){return o.startScope(a)},function(){return o.endScope(t)},function(){return(t=e())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),t})},r.prototype.scopedRun=function(n,e,t){n();try{var o=t();return e(),o}catch(a){throw e(),a}},r.prototype.nextTensorId=function(){return r.nextTensorId++},r.prototype.nextVariableId=function(){return r.nextVariableId++},r.prototype.clone=function(n){var e=this.makeTensorFromDataId(n.dataId,n.shape,n.dtype);return this.addTapeNode(this.state.activeScope.name,{x:n},[e],function(o){return{x:function(){return o.toFloat()}}},[]),e},r.prototype.runKernel=function(n,e,t,o,a){return this.runKernelFunc(null,e,null,n,t,o,a)},r.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},r.prototype.checkKernelForMemLeak=function(n,e,t){var o=this.backend.numDataIds(),a=0;t.forEach(function(u){a+="complex64"===u.dtype?3:1});var s=o-e-a-this.state.numDataMovesStack[this.state.numDataMovesStack.length-1];if(s>0)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+s+" data ids) after running '"+n+"'")},r.prototype.runKernelFunc=function(n,e,t,o,a,i,s){var u,c=this;void 0===i&&(i=[]),void 0===s&&(s=[]);var l=[],h=this.isTapeOn();null==o&&(o=null!=this.state.activeScope?this.state.activeScope.name:"");var f,d=function(x){h&&(l=x.map(function(w){return c.keep(c.clone(w))}))},p=this.state.numBytes,g=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var m,y=zt(o,this.backendName);return f=null!=y?function(){var x=c.backend.numDataIds();m=y.kernelFunc({inputs:e,attrs:a,backend:c.backend});var w=Array.isArray(m)?m:[m];c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(o,x,w);var b=w.map(function(E){return c.makeTensorFromDataId(E.dataId,E.shape,E.dtype)}),_=b.filter(function(E,F){return s[F]});return d((i||[]).slice().concat(_)),b}:function(){var x=c.backend.numDataIds();m=c.tidy(function(){return n(c.backend,d)});var w=Array.isArray(m)?m:[m];return c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(o,x,w),w},this.scopedRun(function(){return c.state.kernelDepth++},function(){return c.state.kernelDepth--},function(){u=c.ENV.getBool("DEBUG")?c.profiler.profileKernel(o,e,function(){return f()}):f()}),h&&this.addTapeNode(o,e,u,t,l),this.state.profiling&&this.state.activeProfile.kernels.push({name:o,bytesAdded:this.state.numBytes-p,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-g,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(e).map(function(x){return e[x].shape}),outputShapes:u.map(function(x){return x.shape})}),Array.isArray(m)?u:u[0]},r.prototype.makeTensor=function(n,e,t,o){if(null==n)throw new Error("Values passed to engine.makeTensor() are null");o=o||this.backend;var a=n;"string"===(t=t||"float32")&&Wn(n[0])&&(a=n.map(function(l){return Ru(l)}));var i=o.write(a,e,t),s=new Me(e,t,i,this.nextTensorId());if(this.incRef(s,o),"string"===t){var u=this.state.tensorInfo.get(i),c=_u(a);this.state.numBytes+=c-u.bytes,u.bytes=c}return s},r.prototype.makeTensorFromDataId=function(n,e,t,o){var a=new Me(e,t=t||"float32",n,this.nextTensorId());return this.incRef(a,o),a},r.prototype.makeVariable=function(n,e,t,o){void 0===e&&(e=!0),t=t||this.nextVariableId().toString(),null!=o&&o!==n.dtype&&(n=n.asType(o));var a=new Sr(n,e,t,this.nextTensorId());if(null!=this.state.registeredVariables[a.name])throw new Error("Variable with name "+a.name+" was already registered");return this.state.registeredVariables[a.name]=a,this.incRef(a,this.backend),a},r.prototype.incRef=function(n,e){var t=this.state.tensorInfo.has(n.dataId)?this.state.tensorInfo.get(n.dataId).refCount:0;if(this.state.numTensors++,"string"===n.dtype&&this.state.numStringTensors++,0===t){this.state.numDataBuffers++;var o=0;"complex64"!==n.dtype&&"string"!==n.dtype&&(o=n.size*Ja(n.dtype)),this.state.tensorInfo.set(n.dataId,{backend:e||this.backend,dtype:n.dtype,shape:n.shape,bytes:o,refCount:0}),this.state.numBytes+=o}this.state.tensorInfo.get(n.dataId).refCount++,n instanceof Sr||this.track(n)},r.prototype.disposeTensor=function(n){if(this.state.tensorInfo.has(n.dataId)){this.state.numTensors--,"string"===n.dtype&&this.state.numStringTensors--;var e=this.state.tensorInfo.get(n.dataId);e.refCount<=1?("complex64"!==n.dtype&&(this.state.numBytes-=e.bytes),this.state.numDataBuffers--,e.backend.disposeData(n.dataId),this.state.tensorInfo.delete(n.dataId)):this.state.tensorInfo.get(n.dataId).refCount--}},r.prototype.disposeVariables=function(){for(var n in this.state.registeredVariables)this.disposeVariable(this.state.registeredVariables[n])},r.prototype.disposeVariable=function(n){this.disposeTensor(n),null!=this.state.registeredVariables[n.name]&&delete this.state.registeredVariables[n.name]},r.prototype.memory=function(){var n=this.backend.memory();return n.numTensors=this.state.numTensors,n.numDataBuffers=this.state.numDataBuffers,n.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(n.unreliable=!0,null==n.reasons&&(n.reasons=[]),n.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),n},r.prototype.profile=function(n){return Q(this,void 0,void 0,function(){var e,t;return ee(this,function(o){return this.state.profiling=!0,e=this.state.numBytes,t=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=n(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(a){return a.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-e,this.state.activeProfile.newTensors=this.state.numTensors-t,[2,this.state.activeProfile]})})},r.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&0===this.state.kernelDepth},r.prototype.addTapeNode=function(n,e,t,o,a){var i=this,s={id:this.state.nextTapeNodeId++,kernelName:n,inputs:e,outputs:t,saved:a},u=function Qt(r){return mt.get(r)}(n);null!=u&&(o=u.gradFunc),null!=o&&(s.gradient=function(c){return c=c.map(function(l,h){if(null==l){var f=t[h],d=Rr(f.size,f.dtype);return i.makeTensor(d,f.shape,f.dtype)}return l}),o(c.length>1?c:c[0],a)}),this.state.activeTape.push(s)},r.prototype.keep=function(n){return n.kept=!0,n},r.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},r.prototype.endTape=function(){this.state.gradientDepth--},r.prototype.startScope=function(n){var e={track:[],name:"unnamed scope",id:this.state.nextScopeId++};n&&(e.name=n),this.state.scopeStack.push(e),this.state.activeScope=e},r.prototype.endScope=function(n){for(var e=this,t=ci(n),o=new Set(t.map(function(u){return u.id})),a=0;a<this.state.activeScope.track.length;a++){var i=this.state.activeScope.track[a];i.kept||o.has(i.id)||i.dispose()}var s=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],t.forEach(function(u){u.kept||u.scopeId!==s.id||e.track(u)})},r.prototype.gradients=function(n,e,t,o){var a=this;if(void 0===o&&(o=!1),R(e.length>0,function(){return"gradients() received an empty list of xs."}),null!=t&&"float32"!==t.dtype)throw new Error("dy must have 'float32' dtype, but has '"+t.dtype+"'");var i=this.scopedRun(function(){return a.startTape()},function(){return a.endTape()},function(){return a.tidy("forward",n)});R(i instanceof Me,function(){return"The result y returned by f() must be a tensor."});var s=function(u,c,l){for(var h={},f={},d=0;d<c.length;d++)h[c[d].id]=!0;for(d=0;d<u.length;d++){var p=(E=u[d]).inputs;for(var g in p){for(var m=p[g],y=!1,x=0;x<c.length;x++)if(h[m.id]){E.outputs.forEach(function(k){return h[k.id]=!0}),y=!0,f[E.id]=!0;break}if(y)break}}var w={};w[l.id]=!0;var b={};for(d=u.length-1;d>=0;d--)for(p=(E=u[d]).inputs,x=0;x<E.outputs.length;x++)if(w[E.outputs[x].id]){for(var g in p)w[p[g].id]=!0,b[E.id]=!0;break}var _=[];for(d=0;d<u.length;d++){var E;if(f[(E=u[d]).id]&&b[E.id]){var F={};for(var g in E.inputs){var I=E.inputs[g];h[I.id]&&(F[g]=I)}var S=Object.assign({},E);S.inputs=F,S.outputs=E.outputs,_.push(S)}}return _}(this.state.activeTape,e,i);if(!o&&0===s.length&&e.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var u,c,l={};l[i.id]=null==t?(c=ei(re(u=i.shape),"float32"),A.makeTensor(c,u,"float32")):t,function(f,d){for(var g=function(y){var x=d[y],w=[];if(x.outputs.forEach(function(F){var I=f[F.id];w.push(null!=I?I:null)}),null==x.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+x.kernelName+".");var b=x.gradient(w),_=function(F){if(!(F in b))throw new Error("Cannot backprop through input "+F+". Available gradients found: "+Object.keys(b)+".");var I=a.tidy(function(){return b[F]()});if("float32"!==I.dtype)throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input "+F+" must have 'float32' dtype, but has '"+I.dtype+"'");var S=x.inputs[F];if(!Je(I.shape,S.shape))throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input '"+F+"' has shape '"+I.shape+"', which does not match the shape of the input '"+S.shape+"'");if(null==f[S.id])f[S.id]=I;else{var k=f[S.id];f[S.id]=k.add(I),k.dispose()}};for(var E in x.inputs)_(E)},m=d.length-1;m>=0;m--)g(m)}(l,s);var h=e.map(function(f){return l[f.id]});return 0===a.state.gradientDepth&&(a.state.activeTape.forEach(function(f){for(var d=0,p=f.saved;d<p.length;d++)p[d].dispose()}),a.state.activeTape=null),{value:i,grads:h}})},r.prototype.customGrad=function(n){var e=this;return R(Un(n),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var t,o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];R(o.every(function(s){return s instanceof Me}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var i={};return o.forEach(function(s,u){i[u]=s}),e.runKernelFunc(function(s,u){return R((t=n.apply(void 0,o.concat([u]))).value instanceof Me,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),R(Un(t.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),t.value},i,function(s,u){var c=t.gradFunc(s,u),l=Array.isArray(c)?c:[c];R(l.length===o.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),R(l.every(function(f){return f instanceof Me}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var h={};return l.forEach(function(f,d){h[d]=function(){return f}}),h})}},r.prototype.readSync=function(n){return this.state.tensorInfo.get(n).backend.readSync(n)},r.prototype.read=function(n){return this.state.tensorInfo.get(n).backend.read(n)},r.prototype.time=function(n){return Q(this,void 0,void 0,function(){var e,t;return ee(this,function(o){switch(o.label){case 0:return e=Ht(),[4,this.backend.time(n)];case 1:return(t=o.sent()).wallMs=Ht()-e,[2,t]}})})},r.prototype.track=function(n){return null!=this.state.activeScope&&(n.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(n)),n},Object.defineProperty(r.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),r.prototype.reset=function(){for(var n in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new Tu,this.registry)this.disposeRegisteredKernels(n),this.registry[n].dispose(),delete this.registry[n];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},r.nextTensorId=0,r.nextVariableId=0,r}(),A=function(){var r=function(){if(null==li){var e=void 0;if(typeof window<"u")e=window;else if(typeof global<"u")e=global;else if(typeof process<"u")e=process;else{if(typeof self>"u")throw new Error("Could not find a global object");e=self}li=e}return li}();if(null==r._tfengine){var n=new Do(r);r._tfengine=new Af(n)}return Ye=r._tfengine.ENV,en=function(){return r._tfengine},r._tfengine}();function Nu(){return typeof window<"u"&&null!=window.document||typeof WorkerGlobalScope<"u"}var gn=O();gn.registerFlag("DEBUG",function(){return!1},function(r){r&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),gn.registerFlag("IS_BROWSER",function(){return Nu()}),gn.registerFlag("IS_NODE",function(){return typeof process<"u"&&void 0!==process.versions&&void 0!==process.versions.node}),gn.registerFlag("IS_CHROME",function(){return typeof navigator<"u"&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),gn.registerFlag("PROD",function(){return!1}),gn.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return gn.getBool("DEBUG")}),gn.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),gn.registerFlag("IS_TEST",function(){return!1});var eo,At,Dt,rr={},hi={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function Pu(r,n){rr[r]=n}function tn(r){r in rr||(rr[r]=function(e){if(1!==e&&2!==e)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var t=function(o){if(typeof OffscreenCanvas<"u"&&2===o)return new OffscreenCanvas(300,150);if(typeof document<"u")return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}(e);return t.addEventListener("webglcontextlost",function(o){o.preventDefault(),delete rr[e]},!1),1===e?t.getContext("webgl",hi)||t.getContext("experimental-webgl",hi):t.getContext("webgl2",hi)}(r));var n=rr[r];return n.isContextLost()?(delete rr[r],tn(r)):(n.disable(n.DEPTH_TEST),n.disable(n.STENCIL_TEST),n.disable(n.BLEND),n.disable(n.DITHER),n.disable(n.POLYGON_OFFSET_FILL),n.disable(n.SAMPLE_COVERAGE),n.enable(n.SCISSOR_TEST),n.enable(n.CULL_FACE),n.cullFace(n.BACK),rr[r])}function Mo(r,n){return[n,r]}function to(r){var n=re(r);return No(Math.ceil(n/4))}function no(r,n){return[Math.max(1,Math.ceil(n/2)),Math.max(1,Math.ceil(r/2))]}function fi(r,n){var e,t,o,a,i,s,u,c,l,h=r;return 2===O().getNumber("WEBGL_VERSION")?(e=h.R32F,t=h.R16F,o=h.RGBA16F,a=h.RGBA32F,i=h.RED,s=4,u=1,c=h.HALF_FLOAT,l=h.FLOAT):(e=r.RGBA,t=r.RGBA,o=r.RGBA,a=h.RGBA,i=r.RGBA,s=4,u=4,c=null!=n?n.HALF_FLOAT_OES:null,l=r.FLOAT),{internalFormatFloat:e,internalFormatHalfFloat:t,internalFormatPackedHalfFloat:o,internalFormatPackedFloat:a,textureFormatFloat:i,downloadTextureFormat:r.RGBA,downloadUnpackNumChannels:s,defaultNumChannels:u,textureTypeHalfFloat:c,textureTypeFloat:l}}function te(r,n,e){var t=e();return n&&function(o){var a=o.getError();if(a!==o.NO_ERROR)throw new Error("WebGL Error: "+Ou(o,a))}(r),t}function Mu(r){return!!(O().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===r||5.96e-8<Math.abs(r)&&Math.abs(r)<65504)}function Ou(r,n){switch(n){case r.NO_ERROR:return"NO_ERROR";case r.INVALID_ENUM:return"INVALID_ENUM";case r.INVALID_VALUE:return"INVALID_VALUE";case r.INVALID_OPERATION:return"INVALID_OPERATION";case r.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case r.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case r.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+n}}function ro(r,n,e){return yn(r,n,function(){return r.getExtension(e)},'Extension "'+e+'" not supported on this browser.')}function Bu(r,n,e){var t=yn(r,n,function(){return r.createShader(r.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(te(r,n,function(){return r.shaderSource(t,e)}),te(r,n,function(){return r.compileShader(t)}),!1===r.getShaderParameter(t,r.COMPILE_STATUS))throw console.log(r.getShaderInfoLog(t)),new Error("Failed to compile vertex shader.");return t}function Lu(r,n,e){var t=yn(r,n,function(){return r.createShader(r.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(te(r,n,function(){return r.shaderSource(t,e)}),te(r,n,function(){return r.compileShader(t)}),!1===r.getShaderParameter(t,r.COMPILE_STATUS))throw function(o,a){var i=Nf.exec(a);if(null==i)return console.log("Couldn't parse line number in error: "+a),void console.log(o);for(var s=+i[1],u=o.split("\n"),c=u.length.toString().length+2,l=u.map(function(m,y){return nr((y+1).toString(),c)+m}),h=0,f=0;f<l.length;f++)h=Math.max(l[f].length,h);var d=l.slice(0,s-1),p=l.slice(s-1,s),g=l.slice(s);console.log(d.join("\n")),console.log(a.split("\n")[0]),console.log("%c "+nr(p[0],h),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(g.join("\n"))}(e,r.getShaderInfoLog(t)),new Error("Failed to compile fragment shader.");return t}(function(r){r[r.DENSE=0]="DENSE",r[r.SHARED_BATCH=1]="SHARED_BATCH"})(eo||(eo={})),function(r){r[r.RENDER=0]="RENDER",r[r.UPLOAD=1]="UPLOAD",r[r.PIXELS=2]="PIXELS",r[r.DOWNLOAD=3]="DOWNLOAD"}(At||(At={})),function(r){r[r.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",r[r.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",r[r.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",r[r.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",r[r.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(Dt||(Dt={}));var Oo,Bo,Nf=/ERROR: [0-9]+:([0-9]+):/g;function Wu(r,n){return yn(r,n,function(){return r.createProgram()},"Unable to create WebGLProgram.")}function Uu(r,n,e){if(te(r,n,function(){return r.linkProgram(e)}),!1===r.getProgramParameter(e,r.LINK_STATUS))throw console.log(r.getProgramInfoLog(e)),new Error("Failed to link vertex and fragment shaders.")}function Lo(r,n,e){if(te(r,n,function(){return r.validateProgram(e)}),!1===r.getProgramParameter(e,r.VALIDATE_STATUS))throw console.log(r.getProgramInfoLog(e)),new Error("Shader program validation failed.")}function Vu(r,n,e){var t=yn(r,n,function(){return r.createBuffer()},"Unable to create WebGLBuffer");return te(r,n,function(){return r.bindBuffer(r.ARRAY_BUFFER,t)}),te(r,n,function(){return r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW)}),t}function Gu(r,n,e){var t=yn(r,n,function(){return r.createBuffer()},"Unable to create WebGLBuffer");return te(r,n,function(){return r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t)}),te(r,n,function(){return r.bufferData(r.ELEMENT_ARRAY_BUFFER,e,r.STATIC_DRAW)}),t}function zu(r,n){return yn(r,n,function(){return r.createTexture()},"Unable to create WebGLTexture.")}function ju(r,n){var e=O().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(r<=0||n<=0){var t="["+r+"x"+n+"]";throw new Error("Requested texture size "+t+" is invalid.")}if(r>e||n>e)throw t="["+r+"x"+n+"]",new Error("Requested texture size "+t+" greater than WebGL maximum on this browser / GPU ["+e+"x"+e+"].")}function Hu(r,n){return yn(r,n,function(){return r.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function di(r,n,e,t,o,a,i,s){var u=r.getAttribLocation(e,t);return-1!==u&&(te(r,n,function(){return r.bindBuffer(r.ARRAY_BUFFER,o)}),te(r,n,function(){return r.vertexAttribPointer(u,a,r.FLOAT,!1,i,s)}),te(r,n,function(){return r.enableVertexAttribArray(u)}),!0)}function qu(r,n,e,t){Ju(r,t),te(r,n,function(){return r.activeTexture(r.TEXTURE0+t)}),te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,e)})}function Xu(r,n,e,t){return yn(r,n,function(){return r.getUniformLocation(e,t)},'uniform "'+t+'" not present in program.')}function Ku(r,n,e){return r.getUniformLocation(n,e)}function Yu(r,n,e,t,o,a){te(r,n,function(){return qu(r,n,t,a)}),te(r,n,function(){return r.uniform1i(o,a)})}function Wo(r,n,e,t){te(r,n,function(){return r.bindFramebuffer(r.FRAMEBUFFER,t)}),te(r,n,function(){return r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0)})}function pi(r,n,e){te(r,n,function(){return r.bindFramebuffer(r.FRAMEBUFFER,e)}),te(r,n,function(){return r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,null,0)})}function oo(r){var n=r.checkFramebufferStatus(r.FRAMEBUFFER);if(n!==r.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+$u(r,n))}function $u(r,n){switch(n){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case r.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+n}}function yn(r,n,e,t){var o=te(r,n,function(){return e()});if(null==o)throw new Error(t);return o}function Ju(r,n){var e=r.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,t=n+r.TEXTURE0;if(t<r.TEXTURE0||t>e)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+e+"].")}function ao(r,n){return void 0===n&&(n=2),re(r.slice(0,r.length-n))}function io(r){if(0===r.length)throw Error("Cannot get rows and columns of an empty shape array.");return[r.length>1?r[r.length-2]:1,r[r.length-1]]}function Uo(r){var n=[1,1,1];return 0===r.length||1===r.length&&1===r[0]||(n=[ao(r)].concat(io(r))),n}function Qu(r,n){var e;void 0===n&&(n=!1);var t=O().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(n&&(t*=2,1===(r=r.map(function(c,l){return l>=r.length-2?Ya(r[l]):r[l]})).length&&(r=[2,r[0]])),2!==r.length){var o=Ln(r);r=o.newShape}var a=re(r);if(r.length<=1&&a<=t)return[1,a];if(2===r.length&&r[0]<=t&&r[1]<=t)return r;if(3===r.length&&r[0]*r[1]<=t&&r[2]<=t)return[r[0]*r[1],r[2]];if(3===r.length&&r[0]<=t&&r[1]*r[2]<=t)return[r[0],r[1]*r[2]];if(4===r.length&&r[0]*r[1]*r[2]<=t&&r[3]<=t)return[r[0]*r[1]*r[2],r[3]];if(4===r.length&&r[0]<=t&&r[1]*r[2]*r[3]<=t)return[r[0],r[1]*r[2]*r[3]];if(n){var i=ao(r),s=2,u=2;return r.length&&(s=(e=io(r))[0],u=e[1]),No(a=i*(s/2)*(u/2)).map(function(c){return 2*c})}return No(a)}function Vo(r){return r%2==0}function so(r,n){if(Je(r=r.slice(-2),n=n.slice(-2))||!r.length||!n.length||0===r[0]||0===r[1]||0===n[0]||0===n[1])return!0;if(r.length!==n.length){var e=r.slice(-1)[0],t=n.slice(-1)[0];if(e===t||Vo(e)&&Vo(t)&&(1===r[0]||1===n[0]))return!0}return r[1]===n[1]&&Vo(r[0])&&Vo(n[0])}function Zu(r){if(null==Oo){var n=tn(r);Oo=n.getParameter(n.MAX_TEXTURE_SIZE)}return Oo}function ec(r){if(null==Bo){var n=tn(r);Bo=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,Bo)}function tc(r){if(0===r)return 0;var n=tn(r);return Tt(n,"EXT_disjoint_timer_query_webgl2")&&2===r?2:Tt(n,"EXT_disjoint_timer_query")?1:0}function Tt(r,n){return null!=r.getExtension(n)}function vi(r){try{if(null!=tn(r))return!0}catch{return!1}return!1}function nc(r){if(0===r)return!1;var n=tn(r);if(1===r){if(!Tt(n,"OES_texture_float"))return!1}else if(!Tt(n,"EXT_color_buffer_float"))return!1;return mi(n)}function rc(r){if(0===r)return!1;var n=tn(r);if(1!==r){if(Tt(n,"EXT_color_buffer_float"))return mi(n);if(Tt(n,"EXT_color_buffer_half_float")){var e=n.getExtension("EXT_color_buffer_half_float");return function(t,o){var a=fi(t,o),i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,a.internalFormatHalfFloat,1,1,0,a.textureFormatFloat,a.textureTypeHalfFloat,null);var s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);var u=t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE;return t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteTexture(i),t.deleteFramebuffer(s),u}(n,e)}return!1}return!!Tt(n,"OES_texture_float")&&!!Tt(n,"WEBGL_color_buffer_float")&&mi(n)}function mi(r){var n=fi(r),e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e),r.texImage2D(r.TEXTURE_2D,0,n.internalFormatFloat,1,1,0,n.textureFormatFloat,n.textureTypeFloat,null);var t=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,t),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0);var o=r.checkFramebufferStatus(r.FRAMEBUFFER)===r.FRAMEBUFFER_COMPLETE;return r.bindTexture(r.TEXTURE_2D,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteTexture(e),r.deleteFramebuffer(t),o}function oc(r){return 2===r&&null!=tn(r).fenceSync}var Pf=Object.freeze({callAndCheck:te,canBeRepresented:Mu,getWebGLErrorMessage:Ou,getExtensionOrThrow:ro,createVertexShader:Bu,createFragmentShader:Lu,createProgram:Wu,linkProgram:Uu,validateProgram:Lo,createStaticVertexBuffer:Vu,createStaticIndexBuffer:Gu,getNumChannels:function(){return 2===O().getNumber("WEBGL_VERSION")?1:4},createTexture:zu,validateTextureSize:ju,createFramebuffer:Hu,bindVertexBufferToProgramAttribute:di,bindTextureUnit:qu,unbindTextureUnit:function(r,n,e){Ju(r,e),te(r,n,function(){return r.activeTexture(r.TEXTURE0+e)}),te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:Xu,getProgramUniformLocation:Ku,bindTextureToProgramUniformSampler:Yu,bindCanvasToFramebuffer:function(r,n){te(r,n,function(){return r.bindFramebuffer(r.FRAMEBUFFER,null)}),te(r,n,function(){return r.viewport(0,0,r.canvas.width,r.canvas.height)}),te(r,n,function(){return r.scissor(0,0,r.canvas.width,r.canvas.height)})},bindColorTextureToFramebuffer:Wo,unbindColorTextureFromFramebuffer:pi,validateFramebuffer:oo,getFramebufferErrorMessage:$u,getBatchDim:ao,getRowsCols:io,getShapeAs3D:Uo,getTextureShapeFromLogicalShape:Qu,isReshapeFree:so,getWebGLMaxTextureSize:Zu,resetMaxTextureSize:function(){Oo=null},resetMaxTexturesInShader:function(){Bo=null},getMaxTexturesInShader:ec,getWebGLDisjointQueryTimerVersion:tc,hasExtension:Tt,isWebGLVersionEnabled:vi,isCapableOfRenderingToFloatTexture:nc,isDownloadFloatTextureEnabled:rc,isWebGLFenceEnabled:oc}),he=O();function ac(r){O().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(r+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function Z(r,n){return A.tidy(r,n)}function Et(r){ci(r).forEach(function(n){return n.dispose()})}function Go(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];O().getBool("IS_TEST")||console.warn.apply(console,r)}function nn(r,n){var e=r;if(ht(r))return"string"===n?[]:[r.length];if(!Array.isArray(r))return[];for(var t=[];Array.isArray(e)||ht(e)&&"string"!==n;)t.push(e.length),e=e[0];return Array.isArray(r)&&O().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function o(a,i,s){if(s=s||[],Array.isArray(a)||ht(a)){R(i.length>0,function(){return"Element arr["+s.join("][")+"] should be a primitive, but is an array of "+a.length+" elements"}),R(a.length===i[0],function(){return"Element arr["+s.join("][")+"] should have "+i[0]+" elements, but has "+a.length+" elements"});for(var u=i.slice(1),c=0;c<a.length;++c)o(a[c],u,s.concat(c))}else R(0===i.length,function(){return"Element arr["+s.join("][")+"] is a primitive, but should be an array/TypedArray of "+i[0]+" elements"})}(r,t,[]),t}function ic(r,n,e,t){if(null!=r&&("numeric"!==r&&r!==n||"numeric"===r&&"string"===n))throw new Error("Argument '"+e+"' passed to '"+t+"' must be "+r+" tensor, but got "+n+" tensor")}function C(r,n,e,t){if(void 0===t&&(t="numeric"),r instanceof Me)return ic(t,r.dtype,n,e),r;var o=Er(r);if("string"!==o&&["bool","int32","float32"].indexOf(t)>=0&&(o=t),ic(t,o,n,e),null==r||!ht(r)&&!Array.isArray(r)&&"number"!=typeof r&&"boolean"!=typeof r&&"string"!=typeof r)throw new Error("Argument '"+n+"' passed to '"+e+"' must be a Tensor or TensorLike, but got '"+(null==r?"null":r.constructor.name)+"'");var i=nn(r,o);ht(r)||Array.isArray(r)||(r=[r]);var s="string"!==o?Qa(r,o,O().getBool("DEBUG")):mn(r,[],!0);return A.makeTensor(s,i,o)}function uo(r,n,e,t){if(void 0===t&&(t="numeric"),!Array.isArray(r))throw new Error("Argument "+n+" passed to "+e+" must be a `Tensor[]` or `TensorLike[]`");return r.map(function(o,a){return C(o,n+"["+a+"]",e)},t)}function gi(r,n){for(var e=0;e<r.length;++e)if(r[r.length-e-1]!==n-1-e)return!1;return!0}function sc(r,n,e){for(var t=r.length+n.length,o=[],a=0,i=0,s=0;s<t;s++)-1===e.indexOf(s)?o.push(r[a++]):o.push(n[i++]);return o}function ft(r,n){for(var e=[],t=r.length,o=0;o<t;o++)-1===n.indexOf(o)&&e.push(r[o]);return[e,n.map(function(a){return r[a]})]}function wt(r,n){return sc(r,n.map(function(e){return 1}),n)}function Rt(r,n,e){R(gi(n,e),function(){return r+" supports only inner-most axes for now. Got axes "+n+" and rank-"+e+" input."})}function qt(r,n){if(gi(r,n))return null;for(var e=[],t=0;t<n;++t)-1===r.indexOf(t)&&e.push(t);return r.forEach(function(o){return e.push(o)}),e}function zo(r){return r.map(function(n,e){return[e,n]}).sort(function(n,e){return n[1]-e[1]}).map(function(n){return n[0]})}function Xt(r,n){for(var e=[],t=n-r;t<n;++t)e.push(t);return e}function uc(r,n){var e=r[0].length;r.forEach(function(o,a){R(o.length===e,function(){return"Error in concat"+e+"D: rank of tensors["+a+"] must be the same as the rank of the rest ("+e+")"})}),R(n>=0&&n<e,function(){return"Error in concat"+e+"D: axis must be between 0 and "+(e-1)+"."});var t=r[0];r.forEach(function(o,a){for(var i=0;i<e;i++)R(i===n||o[i]===t[i],function(){return"Error in concat"+e+"D: Shape of tensors["+a+"] ("+o+") does not match the shape of the rest ("+t+") along the non-concatenated axis "+a+"."})})}function or(r,n){for(var e=r[0].slice(),t=1;t<r.length;t++)e[n]+=r[t][n];return e}function D(r){var n=Object.keys(r);if(1!==n.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+n.length+" keys.");var e=n[0],t=r[e];e.endsWith("_")&&(e=e.substring(0,e.length-1));var o=function(){for(var a=[],i=0;i<arguments.length;i++)a[i]=arguments[i];A.startScope(e);try{var s=t.apply(void 0,a);return s instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),A.endScope(s),s}catch(u){throw A.endScope(null),u}};return Object.defineProperty(o,"name",{value:e,configurable:!0}),o}he.registerFlag("HAS_WEBGL",function(){return he.getNumber("WEBGL_VERSION")>0}),he.registerFlag("WEBGL_VERSION",function(){return vi(2)?2:vi(1)?1:0}),he.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===he.get("WEBGL_VERSION")}),he.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),he.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),he.registerFlag("WEBGL_PACK",function(){return he.getBool("HAS_WEBGL")}),he.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_CLIP",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),he.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_PACK_REDUCE",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_LAZILY_UNPACK",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_CONV_IM2COL",function(){return he.getBool("WEBGL_PACK")}),he.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return Zu(he.getNumber("WEBGL_VERSION"))}),he.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return ec(he.getNumber("WEBGL_VERSION"))}),he.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var r=he.getNumber("WEBGL_VERSION");return 0===r?0:tc(r)}),he.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return he.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&(r=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(r)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(r.substr(0,4))));var r}),he.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return nc(he.getNumber("WEBGL_VERSION"))}),he.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!he.getBool("WEBGL_FORCE_F16_TEXTURES")&&he.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),he.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return rc(he.getNumber("WEBGL_VERSION"))}),he.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return oc(he.getNumber("WEBGL_VERSION"))}),he.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return he.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),Fu=ac;var dt=D({complex_:function(r,n){var e=C(r,"real","complex"),t=C(n,"imag","complex");return Re(e.shape,t.shape,"real and imag shapes, "+e.shape+" and "+t.shape+", must match in call to tf.complex()."),A.runKernelFunc(function(o){return o.complex(e,t)},{$real:e,$imag:t})}}),Bt=D({real_:function(r){var n=C(r,"input","real");return A.runKernelFunc(function(e){return e.real(n)},{$input:n})}}),rn=D({imag_:function(r){var n=C(r,"input","imag");return A.runKernelFunc(function(e){return e.imag(n)},{$input:n})}});function pt(r,n,e){return Vn(r,n,nn(r,e),e)}function Vn(r,n,e,t){if(null==t&&(t=Er(r)),"complex64"===t)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!ht(r)&&!Array.isArray(r)&&"number"!=typeof r&&"boolean"!=typeof r&&"string"!=typeof r)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=n){ti(n);var o=re(n),a=re(e);R(o===a,function(){return"Based on the provided shape, ["+n+"], the tensor should have "+o+" values but has "+a});for(var i=0;i<e.length;++i){var u=i!==e.length-1||e[i]!==re(n.slice(i));R(e[i]===n[i]||!u,function(){return"Error creating a new Tensor. Inferred shape ("+e+") does not match the provided shape ("+n+"). "})}}return ht(r)||Array.isArray(r)||(r=[r]),n=n||e,r="string"!==t?Qa(r,t,O().getBool("DEBUG")):mn(r,[],!0),A.makeTensor(r,n,t)}function $(r,n){if((ht(r)&&"string"!==n||Array.isArray(r))&&"complex64"!==n)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===n&&ht(r)&&!(r instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return Vn(r,[],[],n)}function Ze(r,n){tr(r);var e=nn(r,n);if(1!==e.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return Vn(r,null,e,n)}function Gn(r,n,e){if(tr(r),null!=n&&2!==n.length)throw new Error("tensor2d() requires shape to have two numbers");var t=nn(r,e);if(2!==t.length&&1!==t.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===t.length&&null==n)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return Vn(r,n,t,e)}function yi(r,n,e){if(tr(r),null!=n&&3!==n.length)throw new Error("tensor3d() requires shape to have three numbers");var t=nn(r,e);if(3!==t.length&&1!==t.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===t.length&&null==n)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return Vn(r,n,t,e)}function St(r,n,e){if(tr(r),null!=n&&4!==n.length)throw new Error("tensor4d() requires shape to have four numbers");var t=nn(r,e);if(4!==t.length&&1!==t.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===t.length&&null==n)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return Vn(r,n,t,e)}function kr(r,n){if(void 0===n&&(n="float32"),"complex64"===n){var e=kr(r,"float32"),t=Le(r,"float32");return dt(e,t)}var o=ei(re(r),n);return A.makeTensor(o,r,n)}function Le(r,n){if(void 0===n&&(n="float32"),"complex64"===n){var e=Le(r,"float32"),t=Le(r,"float32");return dt(e,t)}var o=Rr(re(r),n);return A.makeTensor(o,r,n)}function on(r,n,e){return A.runKernelFunc(function(t){return t.fill(r,n,e)},{})}function jo(r,n,e,t){if(void 0===e&&(e=1),void 0===t&&(t="float32"),0===e)throw new Error("Cannot have a step of zero");if(r===n||r<n&&e<0||n<r&&e>1)return Le([0],t);var o=Rr(Math.abs(Math.ceil((n-r)/e)),t);n<r&&1===e&&(e=-1),o[0]=r;for(var a=1;a<o.length;a++)o[a]=o[a-1]+e;return Ze(o,t)}var cc=D({onesLike_:function(r){var n=C(r,"x","onesLike");if("complex64"===n.dtype){var e=cc(Bt(n)),t=Se(rn(n));return dt(e,t)}return A.runKernelFunc(function(o){return o.onesLike(n)},{$x:n},function(o,a){return{$x:function(){return Se(o)}}})}}),Se=D({zerosLike_:function(r){var n=C(r,"x","zerosLike");return A.runKernelFunc(function(e){return e.zerosLike(n)},{$x:n},function(e,t){return{$x:function(){return Se(e)}}})}}),nt=D({concat_:function(r,n){void 0===n&&(n=0),R(r.length>=1,function(){return"Pass at least one tensor to concat"});var e=uo(r,"tensors","concat");"complex64"===e[0].dtype&&e.forEach(function(s){if("complex64"!==s.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+s.dtype+". ")}),n=Qe(n,e[0].shape)[0];var t=or(e.map(function(s){return s.shape}),n);if(0===re(t))return pt([],t);if(1===(e=e.filter(function(s){return s.size>0})).length)return e[0];var o=e.map(function(s){return s.shape});return uc(o,n),A.runKernelFunc(function(s){return s.concat(e,n)},e,function(s){var u=o.map(function(c){return c[n]});return bi(s,u,n).map(function(c){return function(){return c}})},"Concat",{axis:n})}}),Uf=D({concat1d_:function(r){return nt(r,0)}}),Vf=D({concat2d_:function(r,n){return nt(r,n)}}),Gf=D({concat3d_:function(r,n){return nt(r,n)}}),zf=D({concat4d_:function(r,n){return nt(r,n)}}),bi=D({split_:function(r,n,e){void 0===e&&(e=0);var t,o=C(r,"x","split");return e=Qe(e,o.shape)[0],"number"==typeof n?(R(o.shape[e]%n==0,function(){return"Number of splits must evenly divide the axis."}),t=new Array(n).fill(o.shape[e]/n)):(R(o.shape[e]===n.reduce(function(a,i){return a+i}),function(){return"The sum of sizes must match the size of the axis dimension."}),t=n),A.runKernelFunc(function(a){return a.split(o,t,e)},{$x:o},function(a){return{$x:function(){return nt(a,e)}}})}});function ar(r,n){return r(n={exports:{}},n.exports),n.exports}typeof globalThis<"u"||typeof window<"u"||typeof global<"u"&&global;var jf=ar(function(r){!function(n,e){function o(s){var u,c=this,l=(u=4022871197,function(h){h=h.toString();for(var f=0;f<h.length;f++){var d=.02519603282416938*(u+=h.charCodeAt(f));d-=u=d>>>0,u=(d*=u)>>>0,u+=4294967296*(d-=u)}return 2.3283064365386963e-10*(u>>>0)});c.next=function(){var h=2091639*c.s0+2.3283064365386963e-10*c.c;return c.s0=c.s1,c.s1=c.s2,c.s2=h-(c.c=0|h)},c.c=1,c.s0=l(" "),c.s1=l(" "),c.s2=l(" "),c.s0-=l(s),c.s0<0&&(c.s0+=1),c.s1-=l(s),c.s1<0&&(c.s1+=1),c.s2-=l(s),c.s2<0&&(c.s2+=1),l=null}function a(s,u){return u.c=s.c,u.s0=s.s0,u.s1=s.s1,u.s2=s.s2,u}function i(s,u){var c=new o(s),l=u&&u.state,h=c.next;return h.int32=function(){return 4294967296*c.next()|0},h.double=function(){return h()+11102230246251565e-32*(2097152*h()|0)},h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.alea=i}(0,r)}),Hf=ar(function(r){!function(n,e){function o(s){var u=this,c="";u.x=0,u.y=0,u.z=0,u.w=0,u.next=function(){var h=u.x^u.x<<11;return u.x=u.y,u.y=u.z,u.z=u.w,u.w^=u.w>>>19^h^h>>>8},s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),u.next()}function a(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xor128=i}(0,r)}),qf=ar(function(r){!function(n,e){function o(s){var u=this,c="";u.next=function(){var h=u.x^u.x>>>2;return u.x=u.y,u.y=u.z,u.z=u.w,u.w=u.v,(u.d=u.d+362437|0)+(u.v=u.v^u.v<<4^h^h<<1)|0},u.x=0,u.y=0,u.z=0,u.w=0,u.v=0,s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),l==c.length&&(u.d=u.x<<10^u.x>>>4),u.next()}function a(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u.v=s.v,u.d=s.d,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xorwow=i}(0,r)}),Xf=ar(function(r){!function(n,e){function o(s){var u=this;u.next=function(){var c,l,h=u.x,f=u.i;return c=h[f],l=(c^=c>>>7)^c<<24,l^=(c=h[f+1&7])^c>>>10,l^=(c=h[f+3&7])^c>>>3,l^=(c=h[f+4&7])^c<<7,c=h[f+7&7],l^=(c^=c<<13)^c<<9,h[f]=l,u.i=f+1&7,l},function(c,l){var h,f=[];if(l===(0|l))f[0]=l;else for(l=""+l,h=0;h<l.length;++h)f[7&h]=f[7&h]<<15^l.charCodeAt(h)+f[h+1&7]<<13;for(;f.length<8;)f.push(0);for(h=0;h<8&&0===f[h];++h);for(8==h&&(f[7]=-1),c.x=f,c.i=0,h=256;h>0;--h)c.next()}(u,s)}function a(s,u){return u.x=s.x.slice(),u.i=s.i,u}function i(s,u){null==s&&(s=+new Date);var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&(l.x&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xorshift7=i}(0,r)}),Kf=ar(function(r){!function(n,e){function o(s){var u=this;u.next=function(){var c,l,h=u.w,f=u.X,d=u.i;return u.w=h=h+1640531527|0,l=f[d+34&127],c=f[d=d+1&127],l^=l<<13,c^=c<<17,l=f[d]=(l^=l>>>15)^(c^=c>>>12),u.i=d,l+(h^h>>>16)|0},function(c,l){var h,f,d,p,g,m=[],y=128;for(l===(0|l)?(f=l,l=null):(l+="\0",f=0,y=Math.max(y,l.length)),d=0,p=-32;p<y;++p)l&&(f^=l.charCodeAt((p+32)%l.length)),0===p&&(g=f),f^=f<<10,f^=f>>>15,f^=f<<4,f^=f>>>13,p>=0&&(d=0==(h=m[127&p]^=f+(g=g+1640531527|0))?d+1:0);for(d>=128&&(m[127&(l&&l.length||0)]=-1),d=127,p=512;p>0;--p)f=m[d+34&127],h=m[d=d+1&127],f^=f<<13,h^=h<<17,m[d]=(f^=f>>>15)^(h^=h>>>12);c.w=g,c.X=m,c.i=d}(u,s)}function a(s,u){return u.i=s.i,u.w=s.w,u.X=s.X.slice(),u}function i(s,u){null==s&&(s=+new Date);var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&(l.X&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xor4096=i}(0,r)}),Yf=ar(function(r){!function(n,e){function o(s){var u=this,c="";u.next=function(){var h=u.b,f=u.c,d=u.d,p=u.a;return h=h<<25^h>>>7^f,f=f-d|0,d=d<<24^d>>>8^p,p=p-h|0,u.b=h=h<<20^h>>>12^f,u.c=f=f-d|0,u.d=d<<16^f>>>16^p,u.a=p-h|0},u.a=0,u.b=0,u.c=-1640531527,u.d=1367130551,s===Math.floor(s)?(u.a=s/4294967296|0,u.b=0|s):c+=s;for(var l=0;l<c.length+20;l++)u.b^=0|c.charCodeAt(l),u.next()}function a(s,u){return u.a=s.a,u.b=s.b,u.c=s.c,u.d=s.d,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.tychei=i}(0,r)}),ir=ar(function(r){!function(n,e){var t,o=this,a=256,s="random",u=e.pow(a,6),c=e.pow(2,52),l=2*c,h=a-1;function f(y,x,w){var b=[],_=g(function I(S,k){var N,T=[],W=typeof S;if(k&&"object"==W)for(N in S)try{T.push(I(S[N],k-1))}catch{}return T.length?T:"string"==W?S:S+"\0"}((x=1==x?{entropy:!0}:x||{}).entropy?[y,m(n)]:null==y?function(){try{var I;return t&&(I=t.randomBytes)?I=I(a):(I=new Uint8Array(a),(o.crypto||o.msCrypto).getRandomValues(I)),m(I)}catch{var S=o.navigator,k=S&&S.plugins;return[+new Date,o,k,o.screen,m(n)]}}():y,3),b),E=new d(b),F=function(){for(var I=E.g(6),S=u,k=0;I<c;)I=(I+k)*a,S*=a,k=E.g(1);for(;I>=l;)I/=2,S/=2,k>>>=1;return(I+k)/S};return F.int32=function(){return 0|E.g(4)},F.quick=function(){return E.g(4)/4294967296},F.double=F,g(m(E.S),n),(x.pass||w||function(I,S,k,N){return N&&(N.S&&p(N,E),I.state=function(){return p(E,{})}),k?(e[s]=I,S):I})(F,_,"global"in x?x.global:this==e,x.state)}function d(y){var x,w=y.length,b=this,_=0,E=b.i=b.j=0,F=b.S=[];for(w||(y=[w++]);_<a;)F[_]=_++;for(_=0;_<a;_++)F[_]=F[E=h&E+y[_%w]+(x=F[_])],F[E]=x;(b.g=function(I){for(var S,k=0,N=b.i,T=b.j,W=b.S;I--;)S=W[N=h&N+1],k=k*a+W[h&(W[N]=W[T=h&T+S])+(W[T]=S)];return b.i=N,b.j=T,k})(a)}function p(y,x){return x.i=y.i,x.j=y.j,x.S=y.S.slice(),x}function g(y,x){for(var w,b=y+"",_=0;_<b.length;)x[h&_]=h&(w^=19*x[h&_])+b.charCodeAt(_++);return m(x)}function m(y){return String.fromCharCode.apply(0,y)}if(e["seed"+s]=f,g(e.random(),n),r.exports){r.exports=f;try{t=ge(8082)}catch{}}}([],Math)});ir.alea=jf,ir.xor128=Hf,ir.xorwow=qf,ir.xorshift7=Xf,ir.xor4096=Kf,ir.tychei=Yf;var Ho=ir.alea,xi=function(){function r(n,e,t,o,a){this.mean=n,this.stdDev=e,this.dtype=t,this.nextVal=NaN,this.truncated=o,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var i=a||Math.random();this.random=Ho(i.toString())}return r.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var n=this.nextVal;return this.nextVal=NaN,n}for(var e,t,o=!1;!o;){var a=void 0,i=void 0,s=void 0;do{s=(a=2*this.random()-1)*a+(i=2*this.random()-1)*i}while(s>=1||0===s);var u=Math.sqrt(-2*Math.log(s)/s);e=this.mean+this.stdDev*a*u,t=this.mean+this.stdDev*i*u,this.truncated&&!this.isValidTruncated(e)||(o=!0)}return this.truncated&&!this.isValidTruncated(t)||(this.nextVal=this.convertValue(t)),this.convertValue(e)},r.prototype.convertValue=function(n){return null==this.dtype||"float32"===this.dtype?n:Math.round(n)},r.prototype.isValidTruncated=function(n){return n<=this.upper&&n>=this.lower},r}(),$f=function(){function r(n,e,t,o){this.alpha=n,this.beta=1/e,this.dtype=t;var a=o||Math.random();this.randu=Ho(a.toString()),this.randn=new xi(0,1,t,!1,this.randu()),this.d=n<1?n+2/3:n-1/3,this.c=1/Math.sqrt(9*this.d)}return r.prototype.nextValue=function(){for(var n,e,t,o,a,i;;){do{o=this.randn.nextValue(),i=1+this.c*o}while(i<=0);if(e=1-.331*(n=o*o)*n,t=.5*n+this.d*(1-(i*=i*i)+Math.log(i)),(a=this.randu())<e||Math.log(a)<t)break}return i*=1/this.beta*this.d,this.alpha<1&&(i*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(i)},r.prototype.convertValue=function(n){return"float32"===this.dtype?n:Math.round(n)},r}(),Jf=function(){function r(n,e,t,o){var a=this;if(void 0===n&&(n=0),void 0===e&&(e=1),this.canReturnFloat=function(){return null==a.dtype||"float32"===a.dtype},this.min=n,this.range=e-n,this.dtype=t,null==o&&(o=Math.random()),"number"==typeof o&&(o=o.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+n+" - "+e+" <= 1 and dtype is not float");this.random=Ho(o)}return r.prototype.convertValue=function(n){return this.canReturnFloat()?n:Math.round(n)},r.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},r}();function de(r,n,e){return void 0===n&&(n="float32"),n=n||"float32",ti(r),new Zr(r,n,e)}var lc=D({batchToSpaceND_:function(r,n,e){var t=C(r,"x","batchToSpaceND"),o=n.reduce(function(a,i){return a*i});return R(t.rank>=1+n.length,function(){return"input rank is "+t.rank+" but should be > than blockShape.length "+n.length}),R(e.length===n.length,function(){return"crops.length is "+e.length+" but should be equal to blockShape.length  "+n.length}),R(t.shape[0]%o==0,function(){return"input tensor batch is "+t.shape[0]+" but is not divisible by the product of the elements of blockShape "+n.join(" * ")+" === "+o}),A.runKernelFunc(function(a){return a.batchToSpaceND(t,n,e)},{$x:t},function(a){return{$x:function(){return a.spaceToBatchND(n,e)}}})}}),Zf=D({broadcastTo_:function(r,n){var e=C(r,"broadcastTo","x"),t=e.shape;if(n.some(function(u){return!(u>0)||u%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+n+"].");if(n.length<e.rank)throw new Error("broadcastTo(): shape.length="+n.length+" < input.rank="+e.rank+".");if(n.length>e.rank){for(var o=e.shape.slice();o.length<n.length;)o.unshift(1);e=e.reshape(o)}for(var a=Array.from(n),i=n.length-1;i>=0;i--)if(e.shape[i]===n[i])a[i]=1;else if(1!==e.shape[i])throw new Error("broadcastTo(): ["+t+"] cannot be broadcast to ["+n+"].");var s=a.map(function(u,c){return u>1?c:-1}).filter(function(u){return u>=0});return 0===s.length?e.clone():A.runKernelFunc(function(u){return u.tile(e,a)},{input:e},function(u){return{input:function(){return u.sum(s,!0)}}})}}),ed=D({cast_:function(r,n){var e=C(r,"x","cast");if(!xu(n))throw new Error("Failed to cast to unknown dtype "+n);if("string"===n&&"string"!==e.dtype||"string"!==n&&"string"===e.dtype)throw new Error("Only strings can be casted to strings");return A.runKernelFunc(function(o){return o.cast(e,n)},{x:e},function(o){return{x:function(){return o.clone()}}},"Cast",{dtype:n})}}),td=D({clone_:function(r){var n=C(r,"x","clone",null);return A.runKernelFunc(function(){return A.makeTensorFromDataId(n.dataId,n.shape,n.dtype)},{$x:n},function(e){return{$x:function(){return e.toFloat()}}})}}),nd=D({cumsum_:function(r,n,e,t){void 0===n&&(n=0),void 0===e&&(e=!1),void 0===t&&(t=!1);var o=C(r,"x","cumsum"),a=qt([n|=0],o.rank),i=o;null!=a&&(i=o.transpose(a));var s=Xt(1,o.rank)[0],u=A.runKernelFunc(function(c){return c.cumsum(i,s,e,t)},{permutedX:i},function(c){return{permutedX:function(){return c.cumsum(n,e,!t)}}});return null!=a&&(u=u.transpose(a)),u}}),rd=D({depthToSpace_:function(r,n,e){void 0===e&&(e="NHWC");var t=C(r,"x","depthToSpace"),o="NHWC"===e?t.shape[1]:t.shape[2],a="NHWC"===e?t.shape[2]:t.shape[3],i="NHWC"===e?t.shape[3]:t.shape[1];return R(o*n>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+o+" and "+n+"  for depthToSpace with input shape\n      "+t.shape}),R(a*n>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+a+" and "+n+" for depthToSpace with input shape\n          "+t.shape}),R(i%(n*n)==0,function(){return"Dimension size must be evenly divisible by "+n*n+" but is "+i+" for depthToSpace with input shape "+t.shape}),A.runKernelFunc(function(s){return s.depthToSpace(t,n,e)},{$x:t})}}),Lt=D({expandDims_:function(r,n){void 0===n&&(n=0);var e=C(r,"x","expandDims",null);R(n<=e.rank,function(){return"Axis must be <= rank of the tensor"});var t=e.shape.slice();return n<0&&(R(-(e.rank+1)<=n,function(){return"Axis must be in the interval ["+-(e.rank+1)+", "+e.rank+"]"}),n=e.rank+n+1),t.splice(n,0,1),Kt(e,t)}}),hc=D({eye_:function(r,n,e,t){void 0===t&&(t="float32"),null==n&&(n=r);for(var o=de([r,n],t),a=r<=n?r:n,i=0;i<a;++i)o.set(1,i,i);var s=o.toTensor().as2D(r,n);if(null==e)return s;if(1===e.length)return Ir(Lt(s,0),[e[0],1,1]);if(2===e.length)return Ir(Lt(Lt(s,0),0),[e[0],e[1],1,1]);if(3===e.length)return Ir(Lt(Lt(Lt(s,0),0),0),[e[0],e[1],e[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+e.length+"D.")}}),od=D({multinomial_:function(r,n,e,t){void 0===t&&(t=!1);var o=C(r,"logits","multinomial"),a=o.size,i=o.rank;if(a<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+a+".");if(i>2)throw new Error("Rank of probabilities must be 1 or 2, but is "+i);e=e||Math.random();var s=1===i?o.as2D(1,-1):o,u=A.runKernelFunc(function(c){return c.multinomial(s,t,n,e)},{logits2D:s});return 1===i?u.as1D():u}}),wi=D({oneHot_:function(r,n,e,t){if(void 0===e&&(e=1),void 0===t&&(t=0),n<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+n);var o=C(r,"indices","oneHot","int32"),a=o.shape.concat([n]);return o=o.flatten(),A.runKernelFunc(function(i){return i.oneHot(o,n,e,t)},{$indices:o},function(i){return{$indices:function(){return Le(o.shape,"float32")}}}).reshape(a)}}),sr=D({pad_:function(r,n,e){void 0===e&&(e=0);var t=C(r,"x","pad");if(0===t.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");return A.runKernelFunc(function(a){return a.pad(t,n,e)},{x:t},function(a){var i=n.map(function(s){return s[0]});return{x:function(){return a.slice(i,t.shape)}}},"PadV2",{paddings:n,constantValue:e})}}),ad=D({pad1d_:function(r,n,e){return void 0===e&&(e=0),R(2===n.length,function(){return"Invalid number of paddings. Must be length of 2."}),sr(r,[n],e)}}),id=D({pad2d_:function(r,n,e){return void 0===e&&(e=0),R(2===n.length&&2===n[0].length&&2===n[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),sr(r,n,e)}}),sd=D({pad3d_:function(r,n,e){return void 0===e&&(e=0),R(3===n.length&&2===n[0].length&&2===n[1].length&&2===n[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),sr(r,n,e)}}),ud=D({pad4d_:function(r,n,e){return void 0===e&&(e=0),R(4===n.length&&2===n[0].length&&2===n[1].length&&2===n[2].length&&2===n[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),sr(r,n,e)}}),cd=D({rand_:function(r,n,e){var t=re(r),o=null;if(null==e||"float32"===e)o=new Float32Array(t);else if("int32"===e)o=new Int32Array(t);else{if("bool"!==e)throw new Error("Unknown data type "+e);o=new Uint8Array(t)}for(var a=0;a<t;a++)o[a]=n();return A.makeTensor(o,r,e)}}),ld=D({randomNormal_:function(r,n,e,t,o){if(void 0===n&&(n=0),void 0===e&&(e=1),null!=t&&"bool"===t)throw new Error("Unsupported data type "+t);for(var a=new xi(n,e,t,!1,o),i=de(r,t),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),hd=D({randomGamma_:function(r,n,e,t,o){if(void 0===e&&(e=1),void 0===t&&(t="float32"),null==e&&(e=1),null==t&&(t="float32"),"float32"!==t&&"int32"!==t)throw new Error("Unsupported data type "+t);for(var a=new $f(n,e,t,o),i=de(r,t),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),fc=D({randomUniform_:function(r,n,e,t,o){void 0===n&&(n=0),void 0===e&&(e=1),void 0===t&&(t="float32");for(var a=de(r,t),i=new Jf(n,e,null,o),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),Kt=D({reshape_:function(r,n){var e=C(r,"x","reshape",null);return n=yu(n,e.size),R(e.size===re(n),function(){return"new shape and old shape must have the same number of elements."}),A.runKernelFunc(function(o){return o.reshape(e,n)},{x:e},function(o){return{x:function(){return o.reshape(e.shape)}}},"Reshape",{shape:n})}}),dc=D({spaceToBatchND_:function(r,n,e){var t=C(r,"x","spaceToBatchND");return R(t.rank>=1+n.length,function(){return"input rank "+t.rank+" should be > than [blockShape] "+n.length}),R(e.length===n.length,function(){return"paddings.shape[0] "+e.length+" must be equal to [blockShape] "+n.length}),R(t.shape.reduce(function(o,a,i){return i>0&&i<=n.length?o&&(a+e[i-1][0]+e[i-1][1])%n[i-1]==0:o},!0),function(){return"input spatial dimensions "+t.shape.slice(1)+" with paddings "+e.toString()+" must be divisible by blockShapes "+n.toString()}),A.runKernelFunc(function(o){return o.spaceToBatchND(t,n,e)},{$x:t},function(o){return{$x:function(){return o.batchToSpaceND(n,e)}}})}}),pc=D({squeeze_:function(r,n){var e=C(r,"x","squeeze");return Kt(e,Ln(e.shape,n).newShape)}}),Nt=D({stack_:function(r,n){void 0===n&&(n=0);var e=uo(r,"tensors","stack");if(R(e.length>=1,function(){return"Pass at least one tensor to tf.stack"}),1===e.length)return e[0].expandDims(n);var o=e[0].shape,a=e[0].dtype;R(n<=e[0].rank,function(){return"Axis must be <= rank of the tensor"}),e.forEach(function(s){Re(o,s.shape,"All tensors passed to stack must have matching shapes")}),e.forEach(function(s){R(a===s.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var i=e.map(function(s){return s.expandDims(n)});return nt(i,n)}}),Ir=D({tile_:function(r,n){var e=C(r,"x","tile",null);return R(e.rank===n.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of reps "+n+"."}),A.runKernelFunc(function(a,i){var s=a.tile(e,n);return i([e]),s},{x:e},function(a,i){var s=i[0];return{x:function(){var u=Se(s);if(1===s.rank)for(var c=0;c<n[0];++c)u=u.add(a.slice([c*s.shape[0]],[s.shape[0]]));else if(2===s.rank)for(c=0;c<n[0];++c)for(var l=0;l<n[1];++l)u=u.add(a.slice([c*s.shape[0],l*s.shape[1]],[s.shape[0],s.shape[1]]));else if(3===s.rank)for(c=0;c<n[0];++c)for(l=0;l<n[1];++l)for(var h=0;h<n[2];++h)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2]],[s.shape[0],s.shape[1],s.shape[2]]));else{if(4!==s.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+s.rank+" tensors yet.");for(c=0;c<n[0];++c)for(l=0;l<n[1];++l)for(h=0;h<n[2];++h)for(var f=0;f<n[3];++f)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2],f*s.shape[3]],[s.shape[0],s.shape[1],s.shape[2],s.shape[3]]))}return u}}},"Tile",{reps:n},[e])}}),fd=D({truncatedNormal_:function(r,n,e,t,o){if(void 0===n&&(n=0),void 0===e&&(e=1),null!=t&&"bool"===t)throw new Error("Unsupported data type "+t);for(var a=new xi(n,e,t,!0,o),i=de(r,t),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),rt=D({unstack_:function(r,n){void 0===n&&(n=0),n=n||0;var e=C(r,"x","unstack");return R(n>=-e.shape.length&&n<e.shape.length,function(){return"Axis = "+n+" is not in [-"+e.shape.length+", "+e.shape.length+")"}),n<0&&(n+=e.shape.length),A.runKernelFunc(function(o){return o.unstack(e,n)},{x:e},function(o){return{x:function(){return Nt(o,n)}}},"Unpack",{axis:n})}});function qo(r,n,e,t){void 0===t&&(t=!0);var o=[];if(t)(o=o.concat(n.slice(0))).push(r[0]/e),o=o.concat(r.slice(1));else{o=o.concat(r[0]);for(var a=n.length,i=0;i<a;++i)o=o.concat([r[i+1]/n[i],n[i]]);o=o.concat(r.slice(a+1))}return o}function Xo(r,n,e){void 0===e&&(e=!0);var t=[];if(e){t.push(n);for(var o=n+1;o<r;++o)o<=2*n?(t.push(o),t.push(o-(n+1))):t.push(o)}else{var a=[],i=[];for(o=1;o<r;++o)o>=2*n+1||o%2==1?i.push(o):a.push(o);t.push.apply(t,a),t.push(0),t.push.apply(t,i)}return t}function Ko(r,n,e,t){void 0===t&&(t=!0);var o=[];o.push(t?r[0]/e:r[0]*e);for(var a=1;a<r.length;++a)o.push(a<=n.length?t?n[a-1]*r[a]:r[a]/n[a-1]:r[a]);return o}function vc(r,n){for(var e=[0],t=0;t<n;++t)e.push(r[t][0]);return e}function mc(r,n,e){for(var t=r.slice(0,1),o=0;o<e;++o)t.push(r[o+1]-n[o][0]-n[o][1]);return t}function _i(r,n){if(r.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+r.rank+".");if(n.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+n.rank+".");if("int32"!==n.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+n.dtype+".");if(n.shape[n.rank-1]>r.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+n.shape[n.rank-1]+" vs. "+r.rank);if(0===r.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+r.shape+".");for(var e=n.shape,t=e[e.length-1],o=1,a=0;a<e.length-1;++a)o*=e[a];var i=r.shape,s=e.slice();s.pop();var u=1;for(a=t;a<r.rank;++a)u*=i[a],s.push(i[a]);var c=jt(r.shape).map(function(l){return l/u}).concat([1]).slice(0,t);return[s,o,u,c]}function Yo(r){return r<=30?r:Po(r,Math.floor(Math.sqrt(r)))}function gc(r,n,e){var t=n.rank>1?n.shape[n.rank-1]:1,o=n.rank>1?n.rank-1:1,a="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+e.shape+", indices.shape: "+n.shape+", shape: "+r+", sliceDim: "+t+", and batchDim: "+o+".";if(e.rank<o)throw new Error(a+" update.rank < "+o+". ");if(r.length<t+(e.rank-o))throw new Error(a+" Output shape length < "+(t+(e.rank-o)));if(e.rank!==o+r.length-t)throw new Error(a+" update.rank != "+(o+r.length-t));for(var i=0;i<o;++i)if(e.shape[i]!==n.shape[i])throw new Error(a+" updates.shape["+i+"] ("+e.shape[i]+") != indices.shape["+i+"] ("+n.shape[i]+").");for(i=0;i<e.rank-o;++i)if(e.shape[i+o]!==r[i+t])throw new Error(a+" updates.shape["+(i+o)+"] ("+e.shape[i+o]+") != shape["+(i+o)+"] ("+r[i+o]+")")}function yc(r,n,e){if(n.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+n.rank+".");if(r.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+r.rank+".");if("int32"!==n.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+n.dtype);if(e.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+e);if(0===e.length){if(0===n.size)throw new Error("Indices specified for empty output. indices shape: "+n.shape);if(0===r.size)throw new Error("Updates specified for empty output. updates shape: "+r.shape)}gc(e,n,r)}function co(r,n,e){for(var t=n.shape.length,o=t>1?n.shape[t-1]:1,a=e.length,i=1,s=o;s<a;++s)i*=e[s];var u=o<1?1:o;return{sliceRank:o,numUpdates:re(n.shape)/u,sliceSize:i,strides:jt(e.slice(0,o)).concat([1]),outputSize:re(e)}}function bc(r,n,e){R(r.rank===n.length,function(){return"Error in slice"+r.rank+"D: Length of begin "+n+" must match the rank of the array ("+r.rank+")."}),R(r.rank===e.length,function(){return"Error in slice"+r.rank+"D: Length of size "+e+" must match the rank of the array ("+r.rank+")."});for(var t=function(a){R(n[a]+e[a]<=r.shape[a],function(){return"Error in slice"+r.rank+"D: begin["+a+"] + size["+a+"] ("+(n[a]+e[a])+") would overflow input.shape["+a+"] ("+r.shape[a]+")"})},o=0;o<r.rank;++o)t(o)}function Ei(r){for(var n=[],e=0;r>0;)1&r&&n.push(e),r/=2,e++;return n}function $o(r,n,e){for(var t=[],o=0;o<r.length;o++)t[o]=Math.ceil((n[o]-r[o])/e[o]);return t}function xc(r,n,e,t,o){var a=n[o];(r&1<<o||null==a)&&(a=(e[o]||1)>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var s=t[o];return a<0&&(a+=s),To(0,a,s-1)}function wc(r,n,e,t,o){var a=n[o],i=e[o]||1;(r&1<<o||null==a)&&(a=i>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var s=t[o];return a<0&&(a+=s),i>0?To(0,a,s):To(-1,a,s-1)}function Ri(r,n,e){for(var t=e.length,o=0;o<e.length;o++)if(e[o]>1){t=o;break}for(o=t+1;o<e.length;o++)if(n[o]>0||e[o]!==r[o])return!1;return!0}function Si(r,n){for(var e=r.length>0?r[r.length-1]:1,t=0;t<r.length-1;t++)e+=r[t]*n[t];return e}function Jo(r){return A.customGrad(r)}Object.freeze({prepareAndValidate:_i}),Object.freeze({validateUpdateShape:gc,validateInput:yc,calculateShapes:co}),Object.freeze({assertParamsValid:bc,maskToAxes:Ei,computeOutShape:$o,startForAxis:xc,stopForAxis:wc,isSliceContinous:Ri,computeFlatOffset:Si});var bn=D({softmax_:function(r,n){void 0===n&&(n=-1);var e=C(r,"logits","softmax","float32");if(-1===n&&(n=e.rank-1),n!==e.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and dim was "+n);return A.runKernelFunc(function(t,o){var a=t.softmax(e,n);return o([a]),a},{logits:e},function(t,o){var a=o[0],i=t.mul(a);return{logits:function(){return i.sub(i.sum([n],!0).mul(a))}}},"Softmax",{dim:n},[],[!0])}}),vd=D({logSoftmax_:function(r,n){void 0===n&&(n=-1);var e=C(r,"logits","logSoftmax");if(-1===n&&(n=e.rank-1),n!==e.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and axis was "+n);return Jo(function(t,o){var a=t.max(n,!0),i=t.sub(a),s=i.toFloat().sub(i.exp().sum(n,!0).log());return o([s]),{value:s,gradFunc:function(u,c){var l=c[0].exp();return u.sub(u.sum(n,!0).mul(l))}}})(e)}}),_c=function(){function r(n,e){this.backend=n,this.dataMover=e,this.data=new WeakMap,this.dataIdsCount=0}return r.prototype.get=function(n){return this.data.has(n)||this.dataMover.moveData(this.backend,n),this.data.get(n)},r.prototype.set=function(n,e){this.dataIdsCount++,this.data.set(n,e)},r.prototype.has=function(n){return this.data.has(n)},r.prototype.delete=function(n){return this.dataIdsCount--,this.data.delete(n)},r.prototype.numDataIds=function(){return this.dataIdsCount},r}(),Cc=function(){function r(){}return r.prototype.time=function(n){return P("time")},r.prototype.read=function(n){return P("read")},r.prototype.readSync=function(n){return P("readSync")},r.prototype.numDataIds=function(){return P("numDataIds")},r.prototype.disposeData=function(n){return P("disposeData")},r.prototype.write=function(n,e,t){return P("write")},r.prototype.move=function(n,e,t,o){return P("move")},r.prototype.memory=function(){return P("memory")},r.prototype.floatPrecision=function(){return P("floatPrecision")},r.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},r.prototype.batchMatMul=function(n,e,t,o){return P("batchMatMul")},r.prototype.fusedBatchMatMul=function(n){return P("fusedBatchMatMul")},r.prototype.slice=function(n,e,t){return P("slice")},r.prototype.stridedSlice=function(n,e,t,o){return P("stridedSlice")},r.prototype.unstack=function(n,e){return P("unstack")},r.prototype.reverse=function(n,e){return P("reverse")},r.prototype.concat=function(n,e){return P("concat")},r.prototype.neg=function(n){return P("neg")},r.prototype.add=function(n,e){return P("add")},r.prototype.addN=function(n){return P("addN")},r.prototype.subtract=function(n,e){return P("subtract")},r.prototype.multiply=function(n,e){return P("multiply")},r.prototype.realDivide=function(n,e){return P("realDivide")},r.prototype.floorDiv=function(n,e){return P("floorDiv")},r.prototype.sum=function(n,e){return P("sum")},r.prototype.prod=function(n,e){return P("prod")},r.prototype.unsortedSegmentSum=function(n,e,t){return P("unsortedSegmentSum")},r.prototype.argMin=function(n,e){return P("argMin")},r.prototype.argMax=function(n,e){return P("argMax")},r.prototype.equal=function(n,e){return P("equal")},r.prototype.notEqual=function(n,e){return P("notEqual")},r.prototype.less=function(n,e){return P("less")},r.prototype.lessEqual=function(n,e){return P("lessEqual")},r.prototype.greater=function(n,e){return P("greater")},r.prototype.greaterEqual=function(n,e){return P("greaterEqual")},r.prototype.logicalNot=function(n){return P("logicalNot")},r.prototype.logicalAnd=function(n,e){return P("logicalAnd")},r.prototype.logicalOr=function(n,e){return P("logicalOr")},r.prototype.where=function(n){return P("where")},r.prototype.select=function(n,e,t){return P("select")},r.prototype.topk=function(n,e,t){return P("topk")},r.prototype.min=function(n,e){return P("min")},r.prototype.minimum=function(n,e){return P("minimum")},r.prototype.mod=function(n,e){return P("mod")},r.prototype.max=function(n,e){return P("max")},r.prototype.maximum=function(n,e){return P("maximum")},r.prototype.all=function(n,e){return P("all")},r.prototype.any=function(n,e){return P("any")},r.prototype.squaredDifference=function(n,e){return P("squaredDifference")},r.prototype.ceil=function(n){return P("ceil")},r.prototype.floor=function(n){return P("floor")},r.prototype.round=function(n){return P("round")},r.prototype.sign=function(n){return P("sign")},r.prototype.isNaN=function(n){return P("isNaN")},r.prototype.isInf=function(n){return P("isInf")},r.prototype.isFinite=function(n){return P("isFinite")},r.prototype.pow=function(n,e){return P("pow")},r.prototype.exp=function(n){return P("exp")},r.prototype.expm1=function(n){return P("expm1")},r.prototype.softmax=function(n,e){return P("softmax")},r.prototype.log=function(n){return P("log")},r.prototype.log1p=function(n){return P("log1p")},r.prototype.sqrt=function(n){return P("sqrt")},r.prototype.rsqrt=function(n){return P("rsqrt")},r.prototype.square=function(n){return P("square")},r.prototype.reciprocal=function(n){return P("reciprocal")},r.prototype.relu=function(n){return P("relu")},r.prototype.relu6=function(n){return P("relu6")},r.prototype.prelu=function(n,e){return P("prelu")},r.prototype.elu=function(n){return P("elu")},r.prototype.eluDer=function(n,e){return P("eluDer")},r.prototype.selu=function(n){return P("selu")},r.prototype.int=function(n){return P("int")},r.prototype.clip=function(n,e,t){return P("clip")},r.prototype.abs=function(n){return P("abs")},r.prototype.complexAbs=function(n){return P("complexAbs")},r.prototype.sigmoid=function(n){return P("sigmoid")},r.prototype.softplus=function(n){return P("softplus")},r.prototype.sin=function(n){return P("sin")},r.prototype.cos=function(n){return P("cos")},r.prototype.tan=function(n){return P("tan")},r.prototype.asin=function(n){return P("asin")},r.prototype.acos=function(n){return P("acos")},r.prototype.atan=function(n){return P("atan")},r.prototype.atan2=function(n,e){return P("atan2")},r.prototype.sinh=function(n){return P("sinh")},r.prototype.cosh=function(n){return P("cosh")},r.prototype.tanh=function(n){return P("tanh")},r.prototype.asinh=function(n){return P("asinh")},r.prototype.acosh=function(n){return P("acosh")},r.prototype.atanh=function(n){return P("atanh")},r.prototype.erf=function(n){return P("erf")},r.prototype.step=function(n,e){return P("step")},r.prototype.fusedConv2d=function(n){return P("fusedConv2d")},r.prototype.conv2d=function(n,e,t){return P("conv2d")},r.prototype.conv2dDerInput=function(n,e,t){return P("conv2dDerInput")},r.prototype.conv2dDerFilter=function(n,e,t){return P("conv2dDerFilter")},r.prototype.fusedDepthwiseConv2D=function(n){return P("fusedDepthwiseConv2D")},r.prototype.depthwiseConv2D=function(n,e,t){return P("depthwiseConv2D")},r.prototype.depthwiseConv2DDerInput=function(n,e,t){return P("depthwiseConv2DDerInput")},r.prototype.depthwiseConv2DDerFilter=function(n,e,t){return P("depthwiseConv2DDerFilter")},r.prototype.conv3d=function(n,e,t){return P("conv3d")},r.prototype.conv3dDerInput=function(n,e,t){return P("conv3dDerInput")},r.prototype.conv3dDerFilter=function(n,e,t){return P("conv3dDerFilter")},r.prototype.maxPool=function(n,e){return P("maxPool")},r.prototype.maxPoolBackprop=function(n,e,t,o){return P("maxPoolBackprop")},r.prototype.avgPool=function(n,e){return P("avgPool")},r.prototype.avgPoolBackprop=function(n,e,t){return P("avgPoolBackprop")},r.prototype.avgPool3d=function(n,e){return P("avgPool3d")},r.prototype.avgPool3dBackprop=function(n,e,t){return P("avgPool3dBackprop")},r.prototype.maxPool3d=function(n,e){return P("maxPool3d")},r.prototype.maxPool3dBackprop=function(n,e,t,o){return P("maxPool3dBackprop")},r.prototype.reshape=function(n,e){return P("reshape")},r.prototype.cast=function(n,e){return P("cast")},r.prototype.tile=function(n,e){return P("tile")},r.prototype.pad=function(n,e,t){return P("pad")},r.prototype.transpose=function(n,e){return P("transpose")},r.prototype.gather=function(n,e,t){return P("gather")},r.prototype.gatherND=function(n,e){return P("gatherND")},r.prototype.scatterND=function(n,e,t){return P("scatterND")},r.prototype.batchToSpaceND=function(n,e,t){return P("batchToSpaceND")},r.prototype.spaceToBatchND=function(n,e,t){return P("spaceToBatchND")},r.prototype.resizeBilinear=function(n,e,t,o){return P("resizeBilinear")},r.prototype.resizeBilinearBackprop=function(n,e,t){return P("resizeBilinearBackprop")},r.prototype.resizeNearestNeighbor=function(n,e,t,o){return P("resizeNearestNeighbor")},r.prototype.resizeNearestNeighborBackprop=function(n,e,t){return P("resizeNearestNeighborBackprop")},r.prototype.batchNormalization=function(n,e,t,o,a,i){return P("batchNormalization")},r.prototype.localResponseNormalization4D=function(n,e,t,o,a){return P("localResponseNormalization4D")},r.prototype.LRNGrad=function(n,e,t,o,a,i,s){return P("LRNGrad")},r.prototype.multinomial=function(n,e,t,o){return P("multinomial")},r.prototype.oneHot=function(n,e,t,o){return P("oneHot")},r.prototype.cumsum=function(n,e,t,o){return P("cumsum")},r.prototype.nonMaxSuppression=function(n,e,t,o,a){return P("nonMaxSuppression")},r.prototype.fft=function(n){return P("fft")},r.prototype.ifft=function(n){return P("ifft")},r.prototype.complex=function(n,e){return P("complex")},r.prototype.real=function(n){return P("real")},r.prototype.imag=function(n){return P("imag")},r.prototype.cropAndResize=function(n,e,t,o,a,i){return P("cropAndResize")},r.prototype.depthToSpace=function(n,e,t){return P("depthToSpace")},r.prototype.split=function(n,e,t){return P("split")},r.prototype.sparseToDense=function(n,e,t,o){return P("sparseToDense")},r.prototype.diag=function(n){return P("diag")},r.prototype.fill=function(n,e,t){return P("fill")},r.prototype.onesLike=function(n){return P("onesLike")},r.prototype.zerosLike=function(n){return P("zerosLike")},r.prototype.linspace=function(n,e,t){return P("linspace")},r.prototype.dispose=function(){return P("dispose")},r}();function P(r){throw new Error("'"+r+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function xn(r,n){for(var e=r.length,t=[],o=0;o<e;o++){var a=e-1-o;(n[n.length-1-o]||1)>1&&1===(r[a]||1)&&t.unshift(a)}return t}function et(r,n){for(var e=[],t=0;t<n.length;t++){var o=r[r.length-t-1],a=n.length-t-1;(null==o||1===o&&n[a]>1)&&e.unshift(a)}return e}function xe(r,n){for(var e=[],t=Math.max(r.length,n.length),o=0;o<t;o++){var a=r[r.length-o-1];null==a&&(a=1);var i=n[n.length-o-1];if(null==i&&(i=1),1===a)e.unshift(i);else if(1===i)e.unshift(a);else{if(a!==i)throw Error("Operands could not be broadcast together with shapes "+r+" and "+n+".");e.unshift(a)}}return e}function Fr(r,n,e,t,o,a,i){void 0===i&&(i="channelsLast");var s,u=Zo(n),c=u[0],l=u[1];if("channelsLast"===i)s=[c,l,r[3],r[3]];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);s=[c,l,r[1],r[1]]}return zn(r,s,e,t,o,a,!1,i)}function lo(r,n,e,t,o,a,i){void 0===i&&(i="NDHWC");var s,u,c=Ii(n),l=c[0],h=c[1],f=c[2];if("NDHWC"===i)u="channelsLast",s=[l,h,f,r[4],r[4]];else{if("NCDHW"!==i)throw new Error("Unknown dataFormat "+i);u="channelsFirst",s=[l,h,f,r[1],r[1]]}return ho(r,s,e,t,o,!1,u,a)}function zn(r,n,e,t,o,a,i,s){void 0===i&&(i=!1),void 0===s&&(s="channelsLast");var u=[-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3];if("channelsLast"===s)c=r[0],l=r[1],h=r[2],f=r[3];else{if("channelsFirst"!==s)throw new Error("Unknown dataFormat "+s);c=r[0],f=r[1],l=r[2],h=r[3]}var d,p=n[0],g=n[1],m=n[3],y=Zo(e),x=y[0],w=y[1],b=Zo(t),_=b[0],E=b[1],F=Ar(p,_),I=Ar(g,E),S=function(B,L,H,G,U,q,X,J){var ie,ue,ye;if("number"==typeof B){ie={top:B,bottom:B,left:B,right:B,type:0===B?"VALID":"NUMBER"};var be=function(Ee,Pe,Ae,Ke,ze){null==Ke&&(Ke=ki(Ee,Pe,Ae));var fn=Ee[1],dn=fo((Ee[0]-Pe+2*Ke)/Ae+1,ze);R(Ve(dn),function(){return"The output # of rows ("+dn+") must be an integer. Change the stride and/or zero pad parameters"});var Ot=fo((fn-Pe+2*Ke)/Ae+1,ze);return R(Ve(Ot),function(){return"The output # of columns ("+Ot+") must be an integer. Change the stride and/or zero pad parameters"}),[dn,Ot]}([L,H],q,G,B,J);ue=be[0],ye=be[1]}else if("same"===B){ue=Math.ceil(L/G),ye=Math.ceil(H/U);var _e=Math.max(0,(ue-1)*G+q-L),ke=Math.max(0,(ye-1)*U+X-H),Ce=Math.floor(_e/2),Ie=_e-Ce,$e=Math.floor(ke/2);ie={top:Ce,bottom:Ie,left:$e,right:ke-$e,type:"SAME"}}else{if("valid"!==B)throw Error("Unknown padding parameter: "+B);ie={top:0,bottom:0,left:0,right:0,type:"VALID"},ue=Math.ceil((L-q+1)/G),ye=Math.ceil((H-X+1)/U)}return{padInfo:ie,outHeight:ue,outWidth:ye}}(o,l,h,x,w,F,I,a),N=S.outHeight,T=S.outWidth,W=i?m*f:m;return"channelsFirst"===s?d=[c,W,N,T]:"channelsLast"===s&&(d=[c,N,T,W]),{batchSize:c,dataFormat:s,inHeight:l,inWidth:h,inChannels:f,outHeight:N,outWidth:T,outChannels:W,padInfo:S.padInfo,strideHeight:x,strideWidth:w,filterHeight:p,filterWidth:g,effectiveFilterHeight:F,effectiveFilterWidth:I,dilationHeight:_,dilationWidth:E,inShape:r,outShape:d,filterShape:n}}function ho(r,n,e,t,o,a,i,s){void 0===a&&(a=!1),void 0===i&&(i="channelsLast");var u=[-1,-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3],d=u[4];if("channelsLast"===i)c=r[0],l=r[1],h=r[2],f=r[3],d=r[4];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);c=r[0],d=r[1],l=r[2],h=r[3],f=r[4]}var p,g=n[0],m=n[1],y=n[2],x=n[4],w=Ii(e),b=w[0],_=w[1],E=w[2],F=Ii(t),I=F[0],S=F[1],k=F[2],N=Ar(g,I),T=Ar(m,S),W=Ar(y,k),B=function(X,J,ie,ue,ye,be,_e,ke,Ce,Ie,$e){var Ee,Pe,Ae,Ke;if("number"==typeof X){Ee={top:X,bottom:X,left:X,right:X,front:X,back:X,type:0===X?"VALID":"NUMBER"};var ze=function(Hr,An,ou,qr,pn,au){null==pn&&(pn=ki(Hr,An,qr));var bb=Hr[1],xb=Hr[2],iu=fo((Hr[0]-An+2*pn)/qr+1,au);R(Ve(iu),function(){return"The output # of depths ("+iu+") must be an integer. Change the stride and/or zero pad parameters"});var su=fo((bb-An+2*pn)/qr+1,au);R(Ve(su),function(){return"The output # of rows ("+su+") must be an integer. Change the stride and/or zero pad parameters"});var uu=fo((xb-An+2*pn)/qr+1,au);return R(Ve(uu),function(){return"The output # of columns ("+uu+") must be an integer. Change the stride and/or zero pad parameters"}),[iu,su,uu,1]}([J,ie,ue,1],ke,0,ye,X,$e);Pe=ze[0],Ae=ze[1],Ke=ze[2]}else if("same"===X){var je=((Pe=Math.ceil(J/ye))-1)*ye+ke-J,fn=((Ae=Math.ceil(ie/be))-1)*be+Ce-ie,dn=((Ke=Math.ceil(ue/_e))-1)*_e+Ie-ue,Ot=Math.floor(je/2),jr=je-Ot,In=Math.floor(fn/2),Qn=fn-In,Fn=Math.floor(dn/2);Ee={top:In,bottom:Qn,left:Fn,right:dn-Fn,front:Ot,back:jr,type:"SAME"}}else{if("valid"!==X)throw Error("Unknown padding parameter: "+X);Ee={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},Pe=Math.ceil((J-ke+1)/ye),Ae=Math.ceil((ie-Ce+1)/be),Ke=Math.ceil((ue-Ie+1)/_e)}return{padInfo:Ee,outDepth:Pe,outHeight:Ae,outWidth:Ke}}(o,l,h,f,b,_,E,N,T,W,s),H=B.outDepth,G=B.outHeight,U=B.outWidth,q=a?x*d:x;return"channelsFirst"===i?p=[c,q,H,G,U]:"channelsLast"===i&&(p=[c,H,G,U,q]),{batchSize:c,dataFormat:i,inDepth:l,inHeight:h,inWidth:f,inChannels:d,outDepth:H,outHeight:G,outWidth:U,outChannels:q,padInfo:B.padInfo,strideDepth:b,strideHeight:_,strideWidth:E,filterDepth:g,filterHeight:m,filterWidth:y,effectiveFilterDepth:N,effectiveFilterHeight:T,effectiveFilterWidth:W,dilationDepth:I,dilationHeight:S,dilationWidth:k,inShape:r,outShape:p,filterShape:n}}function ki(r,n,e,t){void 0===t&&(t=1);var o=Ar(n,t);return Math.floor((r[0]*(e-1)-e+o)/2)}function Zo(r){return"number"==typeof r?[r,r,r]:2===r.length?[r[0],r[1],1]:r}function Ii(r){return"number"==typeof r?[r,r,r]:r}function Ar(r,n){return n<=1?r:r+(r-1)*(n-1)}function fo(r,n){if(!n)return r;switch(n){case"round":return Math.round(r);case"ceil":return Math.ceil(r);case"floor":return Math.floor(r);default:throw new Error("Unknown roundingMode "+n)}}function ur(r){var n=Zo(r);return 1===n[0]&&1===n[1]&&1===n[2]}function _t(r,n){return ur(r)||ur(n)}function ea(r){if("NHWC"===r)return"channelsLast";if("NCHW"===r)return"channelsFirst";throw new Error("Unknown dataFormat "+r)}function Fi(r,n,e){if("complex64"===n){if("complex64"===r.dtype)return r.clone();var t=Le(r.shape),o=r.toFloat(),a=e.complex(o,t);return t.dispose(),o.dispose(),a}if(!wu(r.dtype,n))return A.makeTensorFromDataId(r.dataId,r.shape,n);if("complex64"===r.dtype){var i=e.real(r);return a=i.cast(n),i.dispose(),a}if("int32"===n)return e.int(r);if("bool"===n){var s=$(0,r.dtype);return a=e.notEqual(r,s),s.dispose(),a}throw new Error("Error in Cast: failed to cast "+r.dtype+" to "+n)}function ta(r,n){return A.makeTensorFromDataId(r.dataId,n,r.dtype)}function Ai(r,n,e){var t=(n-r)/(e-1),o=Rr(e,"float32");o[0]=r;for(var a=1;a<o.length;a++)o[a]=o[a-1]+t;return Ze(o,"float32")}function Di(r,n){if(r.length!==n.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+r.length+", imag: "+n.length+".");for(var e=new Float32Array(2*r.length),t=0;t<e.length;t+=2)e[t]=r[t/2],e[t+1]=n[t/2];return e}function Ec(r,n){return{real:r[2*n],imag:r[2*n+1]}}function md(r,n,e,t){r[2*t]=n,r[2*t+1]=e}function gd(r,n,e){var t=(e?2:-2)*Math.PI*(r/n);return{real:Math.cos(t),imag:Math.sin(t)}}function yd(r,n,e){var t=function(u,c,l){for(var h=0,f=u.length,d=0,p=!1;h<f;){var g=l(c,u[d=h+(f-h>>>1)]);g>0?h=d+1:(f=d,p=!g)}return p?h:-h-1}(r,n,e||bd);r.splice(t<0?-(t+1):t,0,n)}function bd(r,n){return r>n?1:r<n?-1:0}function Ti(r,n,e,t,o){return Rc(r,n,e,t,o,0).selectedIndices}function Ni(r,n,e,t,o,a){var i=Rc(r,n,e,t,o,a,!0);return i.numValidOutputs.dispose(),{selectedIndices:i.selectedIndices,selectedScores:i.selectedScores}}function Rc(r,n,e,t,o,a,i,s){void 0===i&&(i=!1),void 0===s&&(s=!1);for(var u=Array.from(n).map(function(b,_){return{score:b,boxIndex:_,suppressBeginIndex:0}}).filter(function(b){return b.score>o}).sort(Sc),c=a>0?-.5/a:0,l=[],h=[];l.length<e&&u.length>0;){var f=u.pop(),d=f.score,p=f.boxIndex,g=f.suppressBeginIndex;if(d<o)break;for(var m=!1,y=l.length-1;y>=g;--y){var x=xd(r,p,l[y]);if(x>=t){m=!0;break}if(f.score=f.score*wd(t,c,x),f.score<=o)break}f.suppressBeginIndex=l.length,m||(f.score===d?(l.push(p),h.push(f.score)):f.score>o&&yd(u,f,Sc))}var w=l.length;return s&&(l.fill(0,w),h.fill(0,w)),{selectedIndices:Ze(l,"int32"),selectedScores:Ze(h,"float32"),numValidOutputs:$(w,"int32")}}function xd(r,n,e){var t=r.subarray(4*n,4*n+4),o=r.subarray(4*e,4*e+4),a=Math.min(t[0],t[2]),i=Math.min(t[1],t[3]),s=Math.max(t[0],t[2]),u=Math.max(t[1],t[3]),c=Math.min(o[0],o[2]),l=Math.min(o[1],o[3]),h=Math.max(o[0],o[2]),f=Math.max(o[1],o[3]),d=(s-a)*(u-i),p=(h-c)*(f-l);if(d<=0||p<=0)return 0;var g=Math.max(a,c),m=Math.max(i,l),y=Math.min(s,h),x=Math.min(u,f),w=Math.max(y-g,0)*Math.max(x-m,0);return w/(d+p-w)}function wd(r,n,e){var t=Math.exp(n*e*e);return e<=r?t:0}function Sc(r,n){return r.score-n.score||r.score===n.score&&n.boxIndex-r.boxIndex}function kc(r,n,e){var t=new Array(r.rank).fill(0),o=r.shape.slice();return n.map(function(a){o[e]=a;var i=r.slice(t,o);return t[e]+=a,i})}function Ic(r,n){for(var e=new Array(r.rank),t=0;t<e.length;t++)e[t]=r.shape[t]*n[t];var o=de(e,r.dtype);for(t=0;t<o.values.length;++t){for(var a=o.indexToLoc(t),i=new Array(r.rank),s=0;s<i.length;s++)i[s]=a[s]%r.shape[s];var u=r.locToIndex(i);o.values[t]=r.values[u]}return o.toTensor()}function Fc(r,n,e,t,o){for(var a=n[n.length-1],i=[r.length/a,a],s=i[0],u=i[1],c=Cr(e,s*t),l=Cr("int32",s*t),h=0;h<s;h++){for(var f=h*u,d=r.subarray(f,f+u),p=[],g=0;g<d.length;g++)p.push({value:d[g],index:g});p.sort(function(b,_){return _.value-b.value});var m=h*t,y=c.subarray(m,m+t),x=l.subarray(m,m+t);for(g=0;g<t;g++)y[g]=p[g].value,x[g]=p[g].index}var w=n.slice();return w[w.length-1]=t,[pt(c,w,e),pt(l,w,"int32")]}function Pi(r,n){for(var e=[],t=0;t<n.length;t++)n[t]&&e.push(t);var o=de(r,"int32"),a=de([e.length,r.length],"int32");for(t=0;t<e.length;t++){var i=o.indexToLoc(e[t]);a.values.set(i,t*r.length)}return a.toTensor()}Object.freeze({castTensor:Fi,reshapeTensor:ta,linspaceImpl:Ai,upcastType:it,axesAreInnerMostDims:gi,combineLocations:sc,computeOutAndReduceShapes:ft,expandShapeToKeepDim:wt,assertAxesAreInnerMostDims:Rt,getAxesPermutation:qt,getUndoAxesPermutation:zo,getInnerMostAxes:Xt,getBroadcastDims:xn,getReductionAxes:et,assertAndGetBroadcastShape:xe,assertParamsConsistent:uc,computeOutShape:or,computePool2DInfo:Fr,computePool3DInfo:lo,computeConv2DInfo:zn,computeConv3DInfo:ho,computeDefaultPad:ki,tupleValuesAreOne:ur,eitherStridesOrDilationsAreOne:_t,convertConv2DDataFormat:ea,PARALLELIZE_THRESHOLD:30,computeOptimalWindowSize:Yo});var _d=function(r,n){this.outputShape=[],this.outputShape=r,this.variableNames=n.map(function(o,a){return"T"+a});var e=[];this.variableNames.forEach(function(o){e.push("float v"+o+" = get"+o+"AtOutCoords();")});var t=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+e.join("\n        ")+"\n\n        float result = "+t+";\n        setOutput(result);\n      }\n    "},Cd=function(r,n){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r,this.variableNames=n.map(function(o,a){return"T"+a});var e=[];this.variableNames.forEach(function(o){e.push("vec4 v"+o+" = get"+o+"AtOutCoords();")});var t=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+e.join("\n        ")+"\n\n        vec4 result = "+t+";\n        setOutput(result);\n      }\n    "},Ed=function(r,n,e){this.variableNames=["A"];var t=r.windowSize,o=r.batchSize,i=Math.ceil(r.inSize/t);e||this.variableNames.push("bestIndicesA"),this.outputShape=[o,i],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+t+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+t+"; i++) {\n          int inIdx = "+(e?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===n?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};function Ac(r,n){return["x","y","z","w","u","v"].slice(0,n).map(function(e){return r+"."+e})}function kt(r,n){return 1===n?[r]:Ac(r,n)}function gt(){var r,n,e,t,o,a,i,s,u,c;return 2===O().getNumber("WEBGL_VERSION")?(r="#version 300 es",n="in",e="out",t="in",o="texture",a="outputColor",i="out vec4 outputColor;",s="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",u="",c="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(r="",n="attribute",e="varying",t="varying",o="texture2D",a="gl_FragColor",i="",s="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",u="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",c="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:r,attribute:n,varyingVs:e,varyingFs:t,texture2D:o,output:a,defineOutput:i,defineSpecialNaN:s,defineSpecialInf:u,defineRound:c}}function cr(r,n,e){void 0===e&&(e="index");var t=jt(n);return t.map(function(o,a){return"int "+r[a]+" = "+e+" / "+o+"; "+(a===t.length-1?"int "+r[a+1]+" = "+e+" - "+r[a]+" * "+o:"index -= "+r[a]+" * "+o)+";"}).join("")}function Mi(r){var n=jt(r).map(function(e){return e.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+n[0]+" + coords.y * "+n[1]+" + coords.z;\n  }\n"}var Dc="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function Rd(r,n,e,t){var o=[];r.forEach(function(d){var p=re(d.shapeInfo.logicalShape);d.shapeInfo.isUniform?o.push("uniform float "+d.name+(p>1?"["+p+"]":"")+";"):(o.push("uniform sampler2D "+d.name+";"),o.push("uniform int offset"+d.name+";"))});var a,i,d,s=o.join("\n"),u=r.map(function(d){return function(p,g,m){void 0===m&&(m=!1);var y="";return y+=m?Tc(p):Dr(p),p.shapeInfo.logicalShape.length<=g.logicalShape.length&&(y+=m?function(b,_){var E,H,F=b.name,I=F.charAt(0).toUpperCase()+F.slice(1),S="get"+I+"AtOutCoords",k=b.shapeInfo.logicalShape.length,N=_.logicalShape.length,T=xn(b.shapeInfo.logicalShape,_.logicalShape),W=Oe(N),B=N-k,L=["x","y","z","w","u","v"];E=0===k?"":N<2&&T.length>=1?"coords = 0;":T.map(function(ie){return"coords."+L[ie+B]+" = 0;"}).join("\n"),H=N<2&&k>0?"coords":b.shapeInfo.logicalShape.map(function(ie,ue){return"coords."+L[ue+B]}).join(", ");var G="return outputValue;",U=1===re(b.shapeInfo.logicalShape),q=1===re(_.logicalShape);if(1!==k||U||q){if(U&&!q)G=1===N?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(T.length){var X=k-2,J=k-1;T.indexOf(X)>-1&&T.indexOf(J)>-1?G="return vec4(outputValue.x);":T.indexOf(X)>-1?G="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":T.indexOf(J)>-1&&(G="return vec4(outputValue.xx, outputValue.zz);")}}else G="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+S+"() {\n      "+W+" coords = getOutputCoords();\n      "+E+"\n      vec4 outputValue = get"+I+"("+H+");\n      "+G+"\n    }\n  "}(p,g):function(b,_){var E=b.name,F=E.charAt(0).toUpperCase()+E.slice(1),I="get"+F+"AtOutCoords",N=b.shapeInfo.logicalShape.length,T=_.logicalShape.length;if(!b.shapeInfo.isUniform&&N===T&&null==b.shapeInfo.flatOffset&&Je(b.shapeInfo.texShape,_.texShape))return"\n      float "+I+"() {\n        return sampleTexture("+E+", resultUV);\n      }\n    ";var B=Oe(T),L=xn(b.shapeInfo.logicalShape,_.logicalShape),H=T-N,G=["x","y","z","w","u","v"];return"\n    float "+I+"() {\n      "+B+" coords = getOutputCoords();\n      "+(0===N?"":T<2&&L.length>=1?"coords = 0;":L.map(function(q){return"coords."+G[q+H]+" = 0;"}).join("\n"))+"\n      return get"+F+"("+(T<2&&N>0?"coords":b.shapeInfo.logicalShape.map(function(q,X){return"coords."+G[X+H]}).join(", "))+");\n    }\n  "}(p,g)),y}(d,n,t)}).join("\n"),c=n.texShape,l=gt(),h="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+l.texture2D+"(textureSampler, uv).r;\n    }\n  ",f=(d=l).version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+d.varyingFs+" vec2 resultUV;\n    "+d.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+d.defineSpecialNaN+"\n    "+d.defineSpecialInf+"\n    "+d.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+Sd+"\n    "+kd+"\n    "+Id+"\n  ";return n.isPacked?(a=function(d,p){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return _=p,1===(E=[Math.ceil(_[0]/2),Math.ceil(_[1]/2)])[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+E[1]+".0);\n      }\n    ":1===E[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+E[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+E[0]+", "+E[1]+"));\n      return 2 * (resTexRC.x * "+E[1]+" + resTexRC.y);\n    }\n  ";case 2:return function(b,_){var E=[Math.ceil(_[0]/2),Math.ceil(_[1]/2)];if(Je(b,_))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+E[0]+", "+E[1]+"));\n      }\n    ";var F=Math.ceil(b[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+E[0]+", "+E[1]+"));\n\n      int index = resTexRC.x * "+E[1]+" + resTexRC.y;\n      int r = 2 * (index / "+F+");\n      int c = imod(index, "+F+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(d,p);case 3:return g=d,m=p,y=[Math.ceil(m[0]/2),Math.ceil(m[1]/2)],w=(x=Math.ceil(g[2]/2))*Math.ceil(g[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+y[0]+", "+y[1]+"));\n      int index = resTexRC.x * "+y[1]+" + resTexRC.y;\n\n      int b = index / "+w+";\n      index -= b * "+w+";\n\n      int r = 2 * (index / "+x+");\n      int c = imod(index, "+x+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(b,_){for(var E=[Math.ceil(_[0]/2),Math.ceil(_[1]/2)],F=Math.ceil(b[b.length-1]/2),I=F*Math.ceil(b[b.length-2]/2),S=I,k="",N="b, r, c",T=2;T<b.length-1;T++)k="\n      int b"+T+" = index / "+(S*=b[b.length-T-1])+";\n      index -= b"+T+" * "+S+";\n    "+k,N="b"+T+", "+N;return"\n    ivec"+b.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+E[0]+", "+E[1]+"));\n      int index = resTexRC.x * "+E[1]+" + resTexRC.y;\n\n      "+k+"\n\n      int b = index / "+I+";\n      index -= b * "+I+";\n\n      int r = 2 * (index / "+F+");\n      int c = imod(index, "+F+") * 2;\n\n      return ivec"+b.length+"("+N+");\n    }\n  "}(d,p)}var _,E,g,m,y,x,w}(n.logicalShape,c),i=function(d){return"\n    void setOutput(vec4 val) {\n      "+d.output+" = val;\n    }\n  "}(l)):(a=function(d,p){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(x=p)[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+x[1]+".0);\n      }\n    ":1===x[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+x[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+x[0]+", "+x[1]+"));\n      return resTexRC.x * "+x[1]+" + resTexRC.y;\n    }\n  ";case 2:return function(y,x){return Je(y,x)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+x[0]+", "+x[1]+"));\n      }\n    ":1===y[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+x[0]+", "+x[1]+"));\n        int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===y[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+x[0]+", "+x[1]+"));\n        int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n      int r = index / "+y[1]+";\n      int c = index - r * "+y[1]+";\n      return ivec2(r, c);\n    }\n  "}(d,p);case 3:return g=p,m=cr(["r","c","d"],d),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+g[0]+", "+g[1]+"));\n      int index = resTexRC.x * "+g[1]+" + resTexRC.y;\n      "+m+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return function(y,x){var w=cr(["r","c","d","d2"],y);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n      "+w+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(d,p);case 5:return function(y,x){var w=cr(["r","c","d","d2","d3"],y);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+x[0]+",\n                             "+x[1]+"));\n\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n\n      "+w+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(d,p);case 6:return function(y,x){var w=cr(["r","c","d","d2","d3","d4"],y);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n\n      "+w+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(d,p);default:throw new Error(d.length+"-D output sampling is not yet supported")}var x,g,m}(n.logicalShape,c),i=function(d){return"\n    void setOutput(float val) {\n      "+d.output+" = vec4(val, 0, 0, 0);\n    }\n  "}(l)),t&&(f+=Fd),[f,h,i,s,a,u,e].join("\n")}function Dr(r){var n=r.shapeInfo.logicalShape;switch(n.length){case 0:return function(e){var t=e.name,o="get"+t.charAt(0).toUpperCase()+t.slice(1);if(e.shapeInfo.isUniform)return"float "+o+"() {return "+t+";}";var a=e.shapeInfo.texShape;if(1===a[0]&&1===a[1])return"\n      float "+o+"() {\n        return sampleTexture("+t+", halfCR);\n      }\n    ";var u=e.shapeInfo.texShape;return"\n    float "+o+"() {\n      vec2 uv = uvFromFlat("+u[0]+", "+u[1]+", "+lr(t)+");\n      return sampleTexture("+t+", uv);\n    }\n  "}(r);case 1:return function(e){var t=e.name,o="get"+t.charAt(0).toUpperCase()+t.slice(1);if(e.shapeInfo.isUniform)return"\n      float "+o+"(int index) {\n        "+Tr(e)+"\n      }\n    ";var a=e.shapeInfo.texShape,i=a[0],s=a[1];if(1===s&&1===i)return"\n      float "+o+"(int index) {\n        return sampleTexture("+t+", halfCR);\n      }\n    ";var u=lr(t);return 1===s?"\n      float "+o+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+u+") + 0.5) / "+i+".0);\n        return sampleTexture("+t+", uv);\n      }\n    ":1===i?"\n      float "+o+"(int index) {\n        vec2 uv = vec2((float(index + "+u+") + 0.5) / "+s+".0, 0.5);\n        return sampleTexture("+t+", uv);\n      }\n    ":"\n    float "+o+"(int index) {\n      vec2 uv = uvFromFlat("+i+", "+s+", index + "+u+");\n      return sampleTexture("+t+", uv);\n    }\n  "}(r);case 2:return function(e){var t=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=e.shapeInfo.texShape;if(null!=i&&Je(t,i))return"\n    float "+a+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+i[1]+".0, "+i[0]+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ";var c=Ln(t),l=c.newShape,h=c.keptDims;if(l.length<t.length)return"\n      "+Dr(Nr(e,l))+"\n      float "+a+"(int row, int col) {\n        return "+a+"("+Pr(["row","col"],h)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+t[1]+", 1)));\n        "+Tr(e)+"\n      }\n    ";var p=i[0],g=i[1],m=lr(o);return 1===g?"\n    float "+a+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+t[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+p+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ":1===p?"\n    float "+a+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+t[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+g+".0, 0.5);\n      return sampleTexture("+o+", uv);\n    }\n  ":"\n  float "+a+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+t[1]+" + col + "+m+";\n    vec2 uv = uvFromFlat("+p+", "+g+", index);\n    return sampleTexture("+o+", uv);\n  }\n"}(r);case 3:return function(e){var t=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=t[1]*t[2],s=t[2],u=Ln(t),c=u.newShape,l=u.keptDims;if(c.length<t.length)return"\n        "+Dr(Nr(e,c))+"\n        float "+a+"(int row, int col, int depth) {\n          return "+a+"("+Pr(["row","col","depth"],l)+");\n        }\n      ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+i+", "+s+", 1)));\n        "+Tr(e)+"\n      }\n    ";var d=e.shapeInfo.texShape,p=d[0],g=d[1],m=e.shapeInfo.flatOffset;return g===i&&null==m?"\n        float "+a+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+s+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+g+".0, "+p+".0);\n          return sampleTexture("+o+", uv);\n        }\n      ":g===s&&null==m?"\n    float "+a+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+t[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+g+".0, "+p+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ":"\n      float "+a+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+i+" + col * "+s+" + depth + "+lr(o)+";\n        vec2 uv = uvFromFlat("+p+", "+g+", index);\n        return sampleTexture("+o+", uv);\n      }\n  "}(r);case 4:return function(e){var t=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=t[3],s=t[2]*i,u=t[1]*s,c=Ln(t),l=c.newShape,h=c.keptDims;if(l.length<t.length)return"\n      "+Dr(Nr(e,l))+"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        return "+a+"("+Pr(["row","col","depth","depth2"],h)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+u+", "+s+", "+i+", 1)));\n        "+Tr(e)+"\n      }\n    ";var d=e.shapeInfo.flatOffset,p=e.shapeInfo.texShape,g=p[0],m=p[1];return m===u&&null==d?"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+s+", "+i+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+m+".0, "+g+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":m===i&&null==d?"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+t[1]*t[2]+", "+t[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+m+".0, "+g+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+u+" + col * "+s+" +\n          depth * "+i+" + depth2;\n      vec2 uv = uvFromFlat("+g+", "+m+", index + "+lr(o)+");\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);case 5:return function(e){var t=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=t[4],s=t[3]*i,u=t[2]*s,c=t[1]*u,l=Ln(t),h=l.newShape,f=l.keptDims;if(h.length<t.length)return"\n      "+Dr(Nr(e,h))+"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+a+"("+Pr(["row","col","depth","depth2","depth3"],f)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+c+", "+u+", "+s+", "+i+")) +\n          depth3;\n        "+Tr(e)+"\n      }\n    ";var p=e.shapeInfo.flatOffset,g=e.shapeInfo.texShape,m=g[0],y=g[1];return y===c&&null==p?"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+u+", "+s+", "+i+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+y+".0, "+m+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":y===i&&null==p?"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+t[1]*t[2]*t[3]+",\n               "+t[2]*t[3]+", "+t[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+y+".0, "+m+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+c+" + col * "+u+" + depth * "+s+" +\n          depth2 * "+i+" + depth3 + "+lr(o)+";\n      vec2 uv = uvFromFlat("+m+", "+y+", index);\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);case 6:return function(e){var t=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=Ln(t),s=i.newShape,u=i.keptDims;if(s.length<t.length)return"\n      "+Dr(Nr(e,s))+"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+a+"("+Pr(["row","col","depth","depth2","depth3","depth4"],u)+");\n      }\n    ";var l=t[5],h=t[4]*l,f=t[3]*h,d=t[2]*f,p=t[1]*d;if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+p+", "+d+", "+f+", "+h+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+l+", 1)));\n        "+Tr(e)+"\n      }\n    ";var g=e.shapeInfo.flatOffset,m=e.shapeInfo.texShape,y=m[0],x=m[1];return x===p&&null==g?"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+d+", "+f+", "+h+", "+l+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+x+".0, "+y+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":x===l&&null==g?"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+t[1]*t[2]*t[3]*t[4]+",\n               "+t[2]*t[3]*t[4]+",\n               "+t[3]*t[4]+",\n               "+t[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+x+".0, "+y+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+p+" + col * "+d+" + depth * "+f+" +\n          depth2 * "+h+" + depth3 * "+l+" + depth4 + "+lr(o)+";\n      vec2 uv = uvFromFlat("+y+", "+x+", index);\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);default:throw new Error(n.length+"-D input sampling is not yet supported")}}function Tc(r){var n,o,a,i,s,u,c;switch(r.shapeInfo.logicalShape.length){case 0:return"\n    vec4 get"+(n=r.name).charAt(0).toUpperCase()+n.slice(1)+"() {\n      return "+gt().texture2D+"("+n+", halfCR);\n    }\n  ";case 1:return i="get"+(a=(o=r).name).charAt(0).toUpperCase()+a.slice(1),s=o.shapeInfo.texShape,u=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)],c=gt(),"\n    vec4 "+i+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+u[0]+", "+u[1]+", index);\n      return "+c.texture2D+"("+a+", uv);\n    }\n  ";case 2:return function(o){var a=o.shapeInfo.logicalShape,i=o.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),u=o.shapeInfo.texShape,c=u[0],l=u[1],h=gt();if(null!=u&&Je(a,u))return"\n      vec4 "+s+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+l+".0, "+c+".0);\n\n        return "+h.texture2D+"("+i+", uv);\n      }\n    ";var f=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)];return"\n    vec4 "+s+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(a[1]/2)+", "+f[0]+", "+f[1]+", row, col);\n      return "+h.texture2D+"("+i+", uv);\n    }\n  "}(r);case 3:return function(o){var a=o.shapeInfo.logicalShape,i=o.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),u=o.shapeInfo.texShape,c=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)];if(1===a[0])return"\n        "+Tc(Nr(o,a.slice(1)))+"\n        vec4 "+s+"(int b, int row, int col) {\n          return "+s+"("+Pr(["b","row","col"],[1,2])+");\n        }\n      ";var f=c[0],d=c[1],p=Math.ceil(a[2]/2);return"\n    vec4 "+s+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+f+", "+d+", "+p*Math.ceil(a[1]/2)+", "+p+", b, row, col);\n      return "+gt().texture2D+"("+i+", uv);\n    }\n  "}(r);default:return function(o){for(var a=o.shapeInfo.logicalShape,i=a.length,s=o.name,u="get"+s.charAt(0).toUpperCase()+s.slice(1),c=o.shapeInfo.texShape,l=[Math.ceil(c[0]/2),Math.ceil(c[1]/2)],h=l[0],f=l[1],d=Math.ceil(a[i-1]/2),p=d*Math.ceil(a[i-2]/2),g="int b, int row, int col",m="b * "+p+" + (row / 2) * "+d+" + (col / 2)",y=2;y<i-1;y++)g="int b"+y+", "+g,m="b"+y+" * "+(p*=a[i-y-1])+" + "+m;return"\n    vec4 "+u+"("+g+") {\n      int index = "+m+";\n      int texR = index / "+f+";\n      int texC = index - texR * "+f+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+f+", "+h+");\n      return "+gt().texture2D+"("+s+", uv);\n    }\n  "}(r)}}var Sd="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",kd="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",Id="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",Fd="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function lr(r){return"offset"+r}function Tr(r){var n=r.name,e=re(r.shapeInfo.logicalShape);return e<2?"return "+n+";":"\n    for (int i = 0; i < "+e+"; i++) {\n      if (i == index) {\n        return "+n+"[i];\n      }\n    }\n  "}function Oe(r){if(r<=1)return"int";if(2===r)return"ivec2";if(3===r)return"ivec3";if(4===r)return"ivec4";if(5===r)return"ivec5";if(6===r)return"ivec6";throw Error("GPU for rank "+r+" is not yet supported")}function Nr(r,n){var e=JSON.parse(JSON.stringify(r));return e.shapeInfo.logicalShape=n,e}function Pr(r,n){return n.map(function(e){return r[e]}).join(", ")}var Ad=function(r,n,e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,R(r.length>2,function(){return"Packed arg"+(e.charAt(0).toUpperCase()+e.slice(1))+" supports only inputs with rank above 2."});var a=Math.ceil(r[r.length-1]/n);this.outputShape=r.slice(0,-1),a>1&&this.outputShape.push(a),t||this.variableNames.push("bestIndicesA");var i,s,u=this.outputShape,c=u.length,l=Oe(c),h=kt("coords",c);if(1===a){var f=Oe(s=c+1);i="\n        "+f+" sourceLocR = "+f+"("+h.join()+", 0);\n        ++"+h[c-1]+";\n        "+f+" sourceLocG = "+f+"("+h.join()+", 0);\n        ++"+h[c-2]+";\n        "+f+" sourceLocA = "+f+"("+h.join()+", 0);\n        --"+h[c-1]+";\n        "+f+" sourceLocB = "+f+"("+h.join()+", 0);\n        --"+h[c-2]+";"}else s=c,i="\n        "+l+" sourceLocR = coords;\n        ++"+h[c-1]+";\n        "+l+" sourceLocG = coords;\n        ++"+h[c-2]+";\n        "+l+" sourceLocA = coords;\n        --"+h[c-1]+";\n        "+l+" sourceLocB = coords;\n        --"+h[c-2]+";";var d=["x","y","z","w","u","v"].slice(0,s),p="."+d[s-1],g=d.map(function(I){return"int "+I}),m=kt("sourceLocR",s-1).concat("inIdx.r"),y=kt("sourceLocG",s-1).concat("inIdx.g"),x=kt("sourceLocB",s-1).concat("inIdx.b"),w=kt("sourceLocA",s-1).concat("inIdx.a"),b="max"===e?"greaterThan":"lessThan",_=t?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+m.join()+"),\n                             getBestIndicesAChannel("+y.join()+"),\n                             getBestIndicesAChannel("+x.join()+"),\n                             getBestIndicesAChannel("+w.join()+")));",E="vec4(\n            getAChannel("+m.join()+"),\n            hasNextCol ? getAChannel("+y.join()+") : 0.,\n            hasNextRow ? getAChannel("+x.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+w.join()+") : 0.)",F=t?"":"\n      float getBestIndicesAChannel("+g.join()+") {\n        return getChannel(getBestIndicesA("+d.join()+"),\n                                          vec2("+d.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+g.join()+") {\n        return getChannel(getA("+d.join()+"),\n                               vec2("+d.slice(-2).join()+"));\n      }\n      "+F+"\n      void main() {\n        "+l+" coords = getOutputCoords();\n        bool hasNextCol = "+h[c-1]+" < "+(u[c-1]-1)+";\n        bool hasNextRow = "+h[c-2]+" < "+(u[c-2]-1)+";\n        "+i+"\n        ivec4 srcIdx = ivec4(sourceLocR"+p+", sourceLocG"+p+",\n          sourceLocB"+p+", sourceLocA"+p+") * "+n+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+E+";\n\n        for (int i = 0; i < "+n+"; i++) {\n          inIdx = srcIdx;\n          "+_+"\n          vec4 candidate = "+E+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+b+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "},Dd=function(r){this.variableNames=["dy"],this.outputShape=r.inShape;var s=r.effectiveFilterHeight,u=r.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(s-1-r.padInfo.top)+", "+(u-1-r.padInfo.left)+");\n      const float avgMultiplier = float("+1/(r.filterHeight*r.filterWidth)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+s+";\n            wR += "+r.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+u+";\n            wC+= "+r.dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Td=function(r){this.variableNames=["dy"],this.outputShape=r.inShape;var l=r.effectiveFilterDepth,h=r.effectiveFilterHeight,f=r.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(l-1-r.padInfo.front)+", "+(h-1-r.padInfo.top)+", "+(f-1-r.padInfo.left)+");\n      const float avgMultiplier = float("+1/(r.filterDepth*r.filterHeight*r.filterWidth)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+r.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+r.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+r.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+h+";\n              wR += "+r.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+f+";\n                wC += "+r.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Nd=function(r,n,e,t,o,a){this.outputShape=[],this.variableNames=["x","mean","variance"],xe(r,n),xe(r,e);var i="0.0";null!=t&&(xe(r,t),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="1.0";null!=o&&(xe(r,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=r,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+i+";\n        float scale = "+s+";\n        float inv = scale * inversesqrt(variance + float("+a+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "},Pd=function(r,n,e,t,o,a){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],xe(r,n),xe(r,e);var i="vec4(0.0)";null!=t&&(xe(r,t),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="vec4(1.0)";null!=o&&(xe(r,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=r,this.userCode="\n      void main() {\n        vec4 offset = "+i+";\n        vec4 scale = "+s+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+a+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "},Nc=function(r,n,e){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=xe(n,e),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+r+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "},Oi="return a + b;",Bi="return a - b;",Pc="return a * b;",Mc="return (a < 0.) ? b * a : a;",Xe=function(r,n,e){this.variableNames=["A","B"],this.outputShape=xe(n,e),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+r+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "},Oc="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",wn=function(r,n,e,t){void 0===t&&(t=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=xe(n,e);var o=this.outputShape.length,a="";if(t)if(0===o||1===re(this.outputShape))a="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(a="\n          "+Oe(o)+" coords = getOutputCoords();\n        ",1===o)a+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var i=kt("coords",o);a+="\n            bool nextRowOutOfBounds =\n              ("+i[o-2]+" + 1) >= "+this.outputShape[o-2]+";\n            bool nextColOutOfBounds =\n              ("+i[o-1]+" + 1) >= "+this.outputShape[o-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+r+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+a+"\n\n        setOutput(result);\n      }\n    "},Bd=function(){function r(n){this.variableNames=["A"],this.outputShape=n,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n,e){var t=this;return function(o,a){null==t.minLoc&&(t.minLoc=o.getUniformLocationNoThrow(a,"minVal"),t.maxLoc=o.getUniformLocationNoThrow(a,"maxVal")),o.gl.uniform1f(t.minLoc,n),o.gl.uniform1f(t.maxLoc,e)}},r}(),Ld=function(){function r(n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n,e){var t=this;return function(o,a){null==t.minLoc&&(t.minLoc=o.getUniformLocationNoThrow(a,"minVal"),t.maxLoc=o.getUniformLocationNoThrow(a,"maxVal")),o.gl.uniform1f(t.minLoc,n),o.gl.uniform1f(t.maxLoc,e)}},r}(),Wd=function(r){this.variableNames=["real","imag"],this.outputShape=r,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "},Ud=function(r){this.outputShape=[],this.outputShape=or(r,1),this.variableNames=r.map(function(s,u){return"T"+u});var n=new Array(r.length-1);n[0]=r[0][1];for(var e=1;e<n.length;e++)n[e]=n[e-1]+r[e][1];var t=["if (yC < "+n[0]+") setOutput(getT0(yR, yC));"];for(e=1;e<n.length;e++)t.push("else if (yC < "+n[e]+") setOutput(getT"+e+"(yR, yC-"+n[e-1]+"));");t.push("else setOutput(getT"+n.length+"(yR, yC-"+n[n.length-1]+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+t.join("\n        ")+"\n      }\n    "},Vd=function(r,n){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=or(r,n);var e=this.outputShape,t=e.length,o=Oe(t),a=kt("coords",t),i=["x","y","z","w","u","v"].slice(0,t);this.variableNames=r.map(function(m,y){return"T"+y});var s=new Array(r.length-1);s[0]=r[0][n];for(var u=1;u<s.length;u++)s[u]=s[u-1]+r[u][n];var c=i[n],l=i.slice(-2),h=i.join(),f="if ("+c+" < "+s[0]+") {\n        return getChannel(\n            getT0("+h+"), vec2("+l.join()+"));\n        }";for(u=1;u<s.length;u++){var d=s[u-1];f+="\n        if ("+c+" < "+s[u]+"  && "+c+" >= "+s[u-1]+") {\n          return getChannel(\n            getT"+u+"("+na(i,c,d)+"),\n            vec2("+na(l,c,d)+"));\n        }"}var g=s[s.length-1];f+="\n        return getChannel(\n          getT"+s.length+"("+na(i,c,g)+"),\n          vec2("+na(l,c,g)+"));",this.userCode="\n      float getValue("+i.map(function(m){return"int "+m})+") {\n        "+f+"\n      }\n\n      void main() {\n        "+o+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+a+"), 0., 0., 0.);\n\n        "+a[t-1]+" = "+a[t-1]+" + 1;\n        if ("+a[t-1]+" < "+e[t-1]+") {\n          result.g = getValue("+a+");\n        }\n\n        "+a[t-2]+" = "+a[t-2]+" + 1;\n        if ("+a[t-2]+" < "+e[t-2]+") {\n          result.a = getValue("+a+");\n        }\n\n        "+a[t-1]+" = "+a[t-1]+" - 1;\n        if ("+a[t-2]+" < "+e[t-2]+" &&\n            "+a[t-1]+" < "+e[t-1]+") {\n          result.b = getValue("+a+");\n        }\n        setOutput(result);\n      }\n    "};function na(r,n,e){var t=r.indexOf(n);return r.map(function(o,a){return a===t?o+" - "+e:o}).join()}var Gd=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n            int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n              int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              if ("+("channelsLast"===r.dataFormat)+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},zd=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var n=r.filterHeight,e=r.filterWidth,a="channelsLast"===r.dataFormat;this.userCode="\n      const ivec2 pads = ivec2("+(n-1-r.padInfo.top)+", "+(e-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(a?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(a?1:2)+"], coords["+(a?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+n+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+n+" - 1 - wR;\n\n          for (int wC = 0; wC < "+e+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+e+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+r.outChannels+"; d2++) {\n\n              if ("+a+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},jd=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yF = 0; yF < "+r.outDepth+"; yF++) {\n            int xF = wF + yF * "+r.strideDepth+" - "+r.padInfo.front+";\n\n            if (xF < 0 || xF >= "+r.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n              int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n              if (xR < 0 || xR >= "+r.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n                int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n                if (xC < 0 || xC >= "+r.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Hd=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var n=r.filterDepth,e=r.filterHeight,t=r.filterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(n-1-r.padInfo.front)+", "+(e-1-r.padInfo.top)+", "+(t-1-r.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+n+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+r.strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+r.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+n+" - 1 - wF;\n\n          for (int wR = 0; wR < "+e+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+e+" - 1 - wR;\n\n            for (int wC = 0; wC < "+t+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+t+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+r.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},qd=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+r.outChannels/r.inChannels+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n            int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n              int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Xd=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var n=r.filterHeight,e=r.filterWidth,s=r.outChannels/r.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+(n-1-r.padInfo.top)+", "+(e-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+n+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+n+" - 1 - wR;\n\n          for (int wC = 0; wC < "+e+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+e+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+s+"; dm++) {\n              int d2 = d1 * "+s+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Bc=function(r,n,e,t){void 0===n&&(n=!1),void 0===e&&(e=null),void 0===t&&(t=!1),this.variableNames=["x","W"],this.outputShape=r.outShape;var o=r.padInfo.top,a=r.padInfo.left,i=r.strideHeight,s=r.strideWidth,u=r.dilationHeight,c=r.dilationWidth,l=r.filterHeight,h=r.filterWidth,f=4*Math.floor(r.inChannels/4),d=r.inChannels%4,p="channelsLast"===r.dataFormat,g=p?1:2,m=p?2:3,y=p?3:1,x="",w="";e&&(x=t?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"\n          float activation(float x) {\n            "+e+"\n          }\n        ",w="result = activation(result);");var b=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),t&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+x+"\n\n      const ivec2 strides = ivec2("+i+", "+s+");\n      const ivec2 pads = ivec2("+o+", "+a+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+y+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+g+"], coords["+m+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+l+"; wR++) {\n          int xR = xRCorner + wR * "+u+";\n\n          if (xR < 0 || xR >= "+r.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+h+"; wC++) {\n            int xC = xCCorner + wC * "+c+";\n\n            if (xC < 0 || xC >= "+r.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+f+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+p+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1===d)+") {\n\n              if ("+p+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+f+") *\n                    getW(wR, wC, "+f+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+f+", xR, xC) *\n                    getW(wR, wC, "+f+", d2);\n              }\n\n            } else if ("+(2===d)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2)\n              );\n\n              if ("+p+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3===d)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2),\n                getW(wR, wC, "+f+" + 2, d2)\n              );\n\n              if ("+p+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1),\n                  getX(batch, xR, xC, "+f+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC),\n                  getX(batch, "+f+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+b+"\n        "+w+"\n        setOutput(result);\n      }\n    "},Kd=function(r){this.variableNames=["x","W"],this.outputShape=r.outShape;var n=r.padInfo.front,e=r.padInfo.top,t=r.padInfo.left,o=r.strideDepth,a=r.strideHeight,i=r.strideWidth,s=r.dilationDepth,u=r.dilationHeight,c=r.dilationWidth,l=r.filterDepth,h=r.filterHeight,f=r.filterWidth,d=4*Math.floor(r.inChannels/4),p=r.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+n+", "+e+", "+t+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+l+"; wF++) {\n          int xF = xFCorner + wF * "+s+";\n\n          if (xF < 0 || xF >= "+r.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+"; wR++) {\n            int xR = xRCorner + wR * "+u+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+f+"; wC++) {\n              int xC = xCCorner + wC * "+c+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+d+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1===p)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+d+") *\n                  getW(wF, wR, wC, "+d+", d2);\n              } else if ("+(2===p)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+d+"),\n                  getX(batch, xF, xR, xC, "+d+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+d+", d2),\n                  getW(wF, wR, wC, "+d+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3===p)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+d+"),\n                  getX(batch, xF, xR, xC, "+d+" + 1),\n                  getX(batch, xF, xR, xC, "+d+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+d+", d2),\n                  getW(wF, wR, wC, "+d+" + 1, d2),\n                  getW(wF, wR, wC, "+d+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Lc=function(r,n,e,t){void 0===n&&(n=!1),void 0===e&&(e=null),void 0===t&&(t=!1),this.variableNames=["x","W"],this.outputShape=r.outShape;var o=r.inHeight,a=r.inWidth,i=r.padInfo.top,s=r.padInfo.left,u=r.strideHeight,c=r.strideWidth,l=r.dilationHeight,h=r.dilationWidth,f=r.filterHeight,d=r.filterWidth,p=r.outChannels/r.inChannels,g="",m="";e&&(g=t?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"\n          float activation(float x) {\n            "+e+"\n          }\n        ",m="result = activation(result);");var y=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),t&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+g+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+p+";\n        int q = d2 - d1 * "+p+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+f+"; wR++) {\n          int xR = xRCorner + wR * "+l+";\n\n          if (xR < 0 || xR >= "+o+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+d+"; wC++) {\n            int xC = xCCorner + wC * "+h+";\n\n            if (xC < 0 || xC >= "+a+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+y+"\n        "+m+"\n        setOutput(result);\n      }\n    "},Wc=function(r,n,e,t){void 0===n&&(n=!1),void 0===e&&(e=null),void 0===t&&(t=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r.outShape;for(var o=r.inHeight,a=r.inWidth,i=r.padInfo.top,s=r.padInfo.left,u=r.strideHeight,c=r.strideWidth,l=r.dilationHeight,h=r.dilationWidth,f=r.filterHeight,d=r.filterWidth,p=d,g="int xR; int xC; int xCOffset;",m=0;m<f;m++)for(var y=0;y<d;y++)g+="\n          vec4 xTexelR"+m+"C"+2*y+" = vec4(0.);\n          vec4 wR"+m+"C"+y+" = vec4(0.);\n          vec4 xR"+m+"C"+y+" = vec4(0.);";for(m=0;m<f;m++)for(var x=0;x<p;x++){if(g+="\n          xR = xRCorner + "+m*l+";\n          xC = xCCorner + "+(y=2*x)*h+";\n        ",1===c){if(y<d&&(g+=s%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+m+"C"+y+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    xTexelR"+m+"C"+y+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+m+"C"+y+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+m+"C"+y+" = vec4(previous.zw, xTexelR"+m+"C"+y+".xy);\n                } else {\n                  xR"+m+"C"+y+" = vec4(0, 0, xTexelR"+m+"C"+y+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+o+" && xC >= 0 && xC < "+a+") {\n                  xTexelR"+m+"C"+y+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+m+"C"+y+" = vec4(0.);\n                }\n\n                xR"+m+"C"+y+" = xTexelR"+m+"C"+y+";\n              ",y+1<d)){var w=s%2==0?Ya(h):h;h%2==0&&s%2==1||h%2!=0&&s%2!=1?(g+="\n                  xCOffset = xC + "+s%2+" + "+w+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+m+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",h>1&&(g+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+o+" &&\n                      xCOffset >= 0 && xCOffset < "+a+") {\n                      xTexelR"+m+"C"+y+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+m+"C"+y+" = vec4(0.);\n                    }\n                  "),g+="\n                  xR"+m+"C"+(y+1)+" = vec4(\n                    xTexelR"+m+"C"+y+".zw, xTexelR"+m+"C"+(y+2)+".xy);\n                "):g+="\n                  xCOffset = xC + "+w+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+m+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+m+"C"+(y+1)+" = xTexelR"+m+"C"+(y+2)+";\n                "}}else y<d&&(g+="\n              if(xR >= 0 && xR < "+o+") {\n            ",s%2==1?(g+="\n                xCOffset = xC + 1 - "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+m+"C"+y+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+m+"C"+y+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+a+") {\n                  xTexelR"+m+"C"+(y+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+m+"C"+(y+2)+" = vec4(0.);\n                }\n\n                xR"+m+"C"+y+" = vec4(\n                  xTexelR"+m+"C"+y+".zw, xTexelR"+m+"C"+(y+2)+".zw);\n              ",y+1<d&&(g+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+c+";\n                  if(xCOffset >= 0 && xCOffset < "+a+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+m+"C"+(y+1)+" = vec4(xTexelR"+m+"C"+(y+2)+".xy, final.xy);\n                ")):(g+="\n                if(xC >= 0 && xC < "+a+") {\n                  xTexelR"+m+"C"+y+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+m+"C"+y+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+m+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+m+"C"+(y+2)+" = vec4(0.);\n                }\n\n                xR"+m+"C"+y+" = vec4(\n                  xTexelR"+m+"C"+y+".xy, xTexelR"+m+"C"+(y+2)+".xy);\n              ",y+1<d&&(g+="\n                  xR"+m+"C"+(y+1)+" = vec4(\n                    xTexelR"+m+"C"+y+".zw, xTexelR"+m+"C"+(y+2)+".zw);\n                ")),g+="}");y<d&&(g+="\n            vec4 wTexelR"+m+"C"+y+" = getW("+m+", "+y+", d1, q);\n            wR"+m+"C"+y+" = vec4(wTexelR"+m+"C"+y+".xz, wTexelR"+m+"C"+y+".xz);\n          ",y+1<d&&(g+="\n              vec4 wTexelR"+m+"C"+(y+1)+" = getW("+m+", "+(y+1)+", d1, q);\n              wR"+m+"C"+(y+1)+" =\n                vec4(wTexelR"+m+"C"+(y+1)+".xz, wTexelR"+m+"C"+(y+1)+".xz);"))}for(m=0;m<f;m++)for(y=0;y<d;y++)g+="dotProd += xR"+m+"C"+y+" * wR"+m+"C"+y+";";var b="",_="";e&&(b=t?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"vec4 activation(vec4 x) {\n          "+e+"\n        }",_="result = activation(result);");var E=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),t&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+b+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+g+"\n\n        vec4 result = dotProd;\n        "+E+"\n        "+_+"\n        setOutput(result);\n      }\n    "},Yd=function(r,n,e,t,o){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var a=r[0],i=r[1],s=r[2],l=e[0],h=e[1];this.outputShape=[n[0],l,h,r[3]];var d=[i-1+".0",s-1+".0"],p=d[0],g=d[1],m=l>1?[""+(i-1)/(l-1),"(y2-y1) * height_ratio","y1*"+p+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+p],b=h>1?[""+(s-1)/(h-1),"(x2-x1) * width_ratio","x1*"+g+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+g];this.userCode="\n      const float height_ratio = float("+m[0]+");\n      const float width_ratio = float("+b[0]+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+a+") {\n          return;\n        }\n\n        float height_scale = "+m[1]+";\n        float width_scale = "+b[1]+";\n\n        float in_y = "+m[2]+";\n        if( in_y < 0.0 || in_y > "+p+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n        float in_x = "+b[2]+";\n        if( in_x < 0.0 || in_x > "+g+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+("bilinear"===t?1:0)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "},$d=function(r,n,e){this.variableNames=["x"],this.outputShape=r;var t=r.length,o=r[r.length-1],a=e?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(e?"return "+o+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+Oe(t)+" coords = getOutputCoords();\n        int end = "+Uc(t,"coords")+";\n        float val = 0.0;\n        for (int i = "+o+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+a+" end) {\n            continue;\n          }\n          if (idx == end && "+n+") {\n            continue;\n          }\n          "+Uc(t,"coords")+" = idx;\n          val += getX("+function(i,s){if(1===i)return""+s;if(2===i)return s+".x, "+s+".y";if(3===i)return s+".x, "+s+".y, "+s+".z";if(4===i)return s+".x, "+s+".y, "+s+".z, "+s+".w";throw Error("Cumulative sum for rank "+i+" is not yet supported")}(t,"coords")+");\n        }\n        setOutput(val);\n      }\n    "};function Uc(r,n){if(1===r)return""+n;if(2===r)return n+".y";if(3===r)return n+".z";if(4===r)return n+".w";throw Error("Cumulative sum for rank "+r+" is not yet supported")}var Jd=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=eo.DENSE;var n=to(r),e=gt();this.outputShape=r,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+cr(["r","c","d"],r)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+n[0]+", "+n[1]+"));\n        int index = 4 * (resTexRC.x * "+n[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+e.output+" = result;\n      }\n    "},Qd=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=eo.DENSE;var n=to(r),e=gt();this.outputShape=r,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+cr(["r","c","d"],r)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+n[0]+", "+n[1]+"));\n        int index = 4 * (resTexRC.x * "+n[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+e.output+" = result;\n      }\n    "},Zd=function(){function r(n,e,t){this.variableNames=["x"],this.outputShape=[],this.outputShape=n,this.blockSize=e,this.dataFormat=t,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+e+";\n      int offset_h = imod(h, "+e+");\n      int in_w = w / "+e+";\n      int offset_w = imod(w, "+e+");\n      int offset_d = (offset_h * "+e+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return r.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},r.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},r.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},r.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},r.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},r}(),ep=function(r){this.variableNames=["X"],this.outputShape=[r,r],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "},tp=function(r){this.variableNames=["A"],this.outTexUsage=At.DOWNLOAD;var n=gt();this.outputShape=r,this.userCode="\n      "+Dc+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+n.output+" = encode_float(x);\n      }\n    "},np=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=At.DOWNLOAD;var n=gt();this.outputShape=r,this.userCode="\n      "+Dc+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+n.output+" = encode_float(x);\n      }\n    "},rp=function(r,n,e){void 0===e&&(e=!1),this.variableNames=["A"];var t=gt(),o=n[0],a=n[1];this.outputShape=r;var i="result";e&&(i="floor(result * 255. + 0.5)"),this.userCode="\n      "+Mi(r)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+a+";\n        int c = imod(flatIndex, "+a+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n        vec4 values = "+t.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+t.output+" = vec4("+i+", 0., 0., 0.);\n      }\n    "},op=function(r,n,e){void 0===e&&(e=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var t=gt(),o=n[0],a=n[1];this.outputShape=r;var i="",s="result";e&&(s="floor(result * 255. + 0.5)");for(var u=0;u<=1;u++)for(var c=0;c<=1;c++){var l=2*u+c;i+="\n          localCoords = coords;\n          if(localCoords[2] + "+c+" < "+r[2]+") {\n            localCoords[2] += "+c+";\n            if(localCoords[1] + "+u+" < "+r[1]+") {\n              localCoords[1] += "+u+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+a+";\n              c = imod(flatIndex, "+a+");\n              uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n              values = "+t.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+l+"] = values[0];\n              } else if(offset == 1) {\n                result["+l+"] = values[1];\n              } else if(offset == 2) {\n                result["+l+"] = values[2];\n              } else {\n                result["+l+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+Mi(r)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+i+"\n\n        "+t.output+" = "+s+";\n      }\n    "},Vc=function(r,n,e){this.variableNames=["real","imag"];var t=n[1];this.outputShape=n;var o=e?"2.0 * "+Math.PI:"-2.0 * "+Math.PI;this.userCode="\n      const float exponentMultiplier = "+o+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+r+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+t+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+t+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+(e?t+".0":"1.0")+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "},sp=function(){function r(n,e){this.outputShape=[],this.variableNames=["x"],this.outputShape=n,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n){var e=this;return function(t,o){null==e.valueLoc&&(e.valueLoc=t.getUniformLocationNoThrow(o,"value")),t.gl.uniform1f(e.valueLoc,n)}},r}(),up=function(r,n,e){this.variableNames=["A","indices"];var t=r.slice();t[e]=n,this.outputShape=t,this.rank=t.length;var o=Oe(this.rank),a=function(i,s){var u=i.length;if(u>4)throw Error("Gather for rank "+u+" is not yet supported");if(1===u)return"int(getIndices(resRC))";for(var c=["resRC.x","resRC.y","resRC.z","resRC.w"],l=[],h=0;h<i.length;h++)l.push(h===s?"int(getIndices("+c[h]+"))":""+c[h]);return l.join()}(r,e);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},cp=function(r,n,e){this.sliceDim=r,this.strides=n,this.variableNames=["x","indices"],this.outputShape=e;var t=Oe(n.length),o=Oe(e.length);this.userCode="\n        "+t+" strides = "+t+"("+this.strides+");\n         void main() {\n          "+o+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+(this.sliceDim>1?"strides[j]":"strides")+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};function Gc(r,n){var e=gt();return Bu(r,n,e.version+"\n    precision highp float;\n    "+e.attribute+" vec3 clipSpacePos;\n    "+e.attribute+" vec2 uv;\n    "+e.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function zc(r,n){return Vu(r,n,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function jc(r,n){return Gu(r,n,new Uint16Array([0,1,2,2,1,3]))}function po(r,n,e,t,o,a,i){ju(e,t);var s=zu(r,n),u=r.TEXTURE_2D;return te(r,n,function(){return r.bindTexture(u,s)}),te(r,n,function(){return r.texParameteri(u,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE)}),te(r,n,function(){return r.texParameteri(u,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)}),te(r,n,function(){return r.texParameteri(u,r.TEXTURE_MIN_FILTER,r.NEAREST)}),te(r,n,function(){return r.texParameteri(u,r.TEXTURE_MAG_FILTER,r.NEAREST)}),te(r,n,function(){return r.texImage2D(u,0,o,e,t,0,a,i,null)}),te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,null)}),s}function Hc(r,n,e,t,o){var a=Mo(e,t);return po(r,n,a[0],a[1],o.internalFormatFloat,o.textureFormatFloat,r.FLOAT)}function qc(r,n,e,t,o){var a=Mo(e,t);return po(r,n,a[0],a[1],o.internalFormatHalfFloat,o.textureFormatFloat,o.textureTypeHalfFloat)}function Xc(r,n,e,t,o){var a=Mo(e,t);return po(r,n,a[0],a[1],r.RGBA,r.RGBA,r.UNSIGNED_BYTE)}function Kc(r,n,e,t,o){var a=no(e,t);return po(r,n,a[0],a[1],o.internalFormatPackedFloat,r.RGBA,r.FLOAT)}function Yc(r,n,e,t,o){var a=no(e,t);return po(r,n,a[0],a[1],o.internalFormatPackedHalfFloat,r.RGBA,o.textureTypeHalfFloat)}function $c(r,n,e,t){return te(r,n,function(){return r.bindBuffer(r.ARRAY_BUFFER,t)}),di(r,n,e,"clipSpacePos",t,3,20,0)&&di(r,n,e,"uv",t,2,20,12)}function Jc(r,n,e,t,o,a,i){var s,u,c;te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,e)}),a instanceof Uint8Array?(s=new Uint8Array(t*o*4),u=r.UNSIGNED_BYTE,c=r.RGBA):(s=new Float32Array(t*o*4),u=r.FLOAT,c=i.internalFormatPackedFloat),s.set(a),te(r,n,function(){return r.texImage2D(r.TEXTURE_2D,0,c,t,o,0,r.RGBA,u,s)}),te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,null)})}function Qc(r,n,e,t){te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,e)}),t.data instanceof Uint8Array?te(r,n,function(){return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t.width,t.height,0,r.RGBA,r.UNSIGNED_BYTE,t.data)}):te(r,n,function(){return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)}),te(r,n,function(){return r.bindTexture(r.TEXTURE_2D,null)})}function Zc(r,n,e,t,o){var a=r.createBuffer();te(r,n,function(){return r.bindBuffer(r.PIXEL_PACK_BUFFER,a)});var i=16*e*t;return te(r,n,function(){return r.bufferData(r.PIXEL_PACK_BUFFER,i,r.STREAM_READ)}),te(r,n,function(){return r.readPixels(0,0,t,e,r.RGBA,r.FLOAT,0)}),te(r,n,function(){return r.bindBuffer(r.PIXEL_PACK_BUFFER,null)}),a}function el(r,n,e){var t=r,o=new Float32Array(e);return t.bindBuffer(t.PIXEL_PACK_BUFFER,n),t.getBufferSubData(t.PIXEL_PACK_BUFFER,0,o),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),o}function tl(r,n,e,t,o){var a=Mo(e,t),i=a[0],s=a[1],u=new Uint8Array(e*t*4);return te(r,n,function(){return r.readPixels(0,0,i,s,o.downloadTextureFormat,r.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function nl(r,n,e,t,o,a,i,s){var f,u=r,c=new Float32Array((f=no(a,i))[0]*f[1]*4);return u.bindBuffer(u.PIXEL_PACK_BUFFER,n),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,c),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),c}function rl(r,n,e,t){var o=new Float32Array(e*t*4);return te(r,n,function(){return r.readPixels(0,0,t,e,r.RGBA,r.FLOAT,o)}),o}var lp=Object.freeze({createVertexShader:Gc,createVertexBuffer:zc,createIndexBuffer:jc,createFloat32MatrixTexture:Hc,createFloat16MatrixTexture:qc,createUnsignedBytesMatrixTexture:Xc,createPackedMatrixTexture:Kc,createFloat16PackedMatrixTexture:Yc,bindVertexProgramAttributeStreams:$c,uploadDenseMatrixToTexture:Jc,uploadPixelDataToTexture:Qc,createBufferFromOutputTexture:Zc,downloadFloat32MatrixFromBuffer:el,downloadByteEncodedFloatMatrixFromOutputTexture:tl,downloadPackedMatrixFromBuffer:nl,downloadMatrixFromPackedOutputTexture:rl}),ol=function(){function r(n){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var e=O().getNumber("WEBGL_VERSION");null!=n?(this.gl=n,Pu(e,n)):this.gl=tn(e);var t="WEBGL_color_buffer_float";if(1===O().getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=ro(this.gl,this.debug,"OES_texture_float"),Tt(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=ro(this.gl,this.debug,"OES_texture_half_float");else if(O().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(t),Tt(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=ro(this.gl,this.debug,"EXT_color_buffer_half_float");else if(O().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(Tt(this.gl,t="EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension(t);else{if(!Tt(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=zc(this.gl,this.debug),this.indexBuffer=jc(this.gl,this.debug),this.framebuffer=Hu(this.gl,this.debug),this.textureConfig=fi(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(r.prototype,"debug",{get:function(){return O().getBool("DEBUG")},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){var n=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var e=this.gl;te(e,this.debug,function(){return e.finish()}),te(e,this.debug,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),te(e,this.debug,function(){return e.deleteFramebuffer(n.framebuffer)}),te(e,this.debug,function(){return e.bindBuffer(e.ARRAY_BUFFER,null)}),te(e,this.debug,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}),te(e,this.debug,function(){return e.deleteBuffer(n.indexBuffer)}),this.disposed=!0}},r.prototype.createFloat32MatrixTexture=function(n,e){return this.throwIfDisposed(),Hc(this.gl,this.debug,n,e,this.textureConfig)},r.prototype.createFloat16MatrixTexture=function(n,e){return this.throwIfDisposed(),qc(this.gl,this.debug,n,e,this.textureConfig)},r.prototype.createUnsignedBytesMatrixTexture=function(n,e){return this.throwIfDisposed(),Xc(this.gl,this.debug,n,e)},r.prototype.uploadPixelDataToTexture=function(n,e){this.throwIfDisposed(),Qc(this.gl,this.debug,n,e)},r.prototype.uploadDenseMatrixToTexture=function(n,e,t,o){this.throwIfDisposed(),Jc(this.gl,this.debug,n,e,t,o,this.textureConfig)},r.prototype.createFloat16PackedMatrixTexture=function(n,e){return this.throwIfDisposed(),Yc(this.gl,this.debug,n,e,this.textureConfig)},r.prototype.createPackedMatrixTexture=function(n,e){return this.throwIfDisposed(),Kc(this.gl,this.debug,n,e,this.textureConfig)},r.prototype.deleteMatrixTexture=function(n){var e=this;this.throwIfDisposed(),this.outputTexture===n&&(pi(this.gl,this.debug,this.framebuffer),this.outputTexture=null),te(this.gl,this.debug,function(){return e.gl.deleteTexture(n)})},r.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(n,e,t){var o=this;return this.downloadMatrixDriver(n,function(){return tl(o.gl,o.debug,e,t,o.textureConfig)})},r.prototype.downloadPackedMatrixFromBuffer=function(n,e,t,o,a,i){return nl(this.gl,n,0,0,0,a,i)},r.prototype.downloadFloat32MatrixFromBuffer=function(n,e){return el(this.gl,n,e)},r.prototype.createBufferFromTexture=function(n,e,t){this.bindTextureToFrameBuffer(n);var o=Zc(this.gl,this.debug,e,t);return this.unbindTextureToFrameBuffer(),o},r.prototype.createAndWaitForFence=function(){var n=this.createFence(this.gl);return this.pollFence(n)},r.prototype.createFence=function(n){var e,t,o=this;if(O().getBool("WEBGL_FENCE_API_ENABLED")){var a=n,i=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);n.flush(),t=function(){var s=a.clientWaitSync(i,0,0);return s===a.ALREADY_SIGNALED||s===a.CONDITION_SATISFIED},e=i}else O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(e=this.beginQuery(),this.endQuery(),t=function(){return o.isQueryAvailable(e,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):t=function(){return!0};return{query:e,isFencePassed:t}},r.prototype.downloadMatrixFromPackedTexture=function(n,e,t){var o=this;return this.downloadMatrixDriver(n,function(){return rl(o.gl,o.debug,e,t)})},r.prototype.createProgram=function(n){this.throwIfDisposed();var e=this.gl,t=Lu(e,this.debug,n),o=Gc(e,this.debug),a=Wu(e,this.debug);return te(e,this.debug,function(){return e.attachShader(a,o)}),te(e,this.debug,function(){return e.attachShader(a,t)}),Uu(e,this.debug,a),this.debug&&Lo(e,this.debug,a),this.vertexAttrsAreBound||(this.setProgram(a),this.vertexAttrsAreBound=$c(e,this.debug,this.program,this.vertexBuffer)),a},r.prototype.deleteProgram=function(n){var e=this;this.throwIfDisposed(),n===this.program&&(this.program=null),null!=n&&te(this.gl,this.debug,function(){return e.gl.deleteProgram(n)})},r.prototype.setProgram=function(n){var e=this;this.throwIfDisposed(),this.program=n,null!=this.program&&this.debug&&Lo(this.gl,this.debug,this.program),te(this.gl,this.debug,function(){return e.gl.useProgram(n)})},r.prototype.getUniformLocation=function(n,e,t){return void 0===t&&(t=!0),this.throwIfDisposed(),t?Xu(this.gl,this.debug,n,e):Ku(this.gl,n,e)},r.prototype.getAttributeLocation=function(n,e){var t=this;return this.throwIfDisposed(),te(this.gl,this.debug,function(){return t.gl.getAttribLocation(n,e)})},r.prototype.getUniformLocationNoThrow=function(n,e){return this.throwIfDisposed(),this.gl.getUniformLocation(n,e)},r.prototype.setInputMatrixTexture=function(n,e,t){this.throwIfDisposed(),this.throwIfNoProgram(),Yu(this.gl,this.debug,0,n,e,t)},r.prototype.setOutputMatrixTexture=function(n,e,t){this.setOutputMatrixTextureDriver(n,t,e)},r.prototype.setOutputPackedMatrixTexture=function(n,e,t){this.throwIfDisposed();var o=no(e,t);this.setOutputMatrixTextureDriver(n,o[0],o[1])},r.prototype.setOutputMatrixWriteRegion=function(n,e,t,o){this.setOutputMatrixWriteRegionDriver(t,n,o,e)},r.prototype.setOutputPackedMatrixWriteRegion=function(n,e,t,o){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},r.prototype.debugValidate=function(){null!=this.program&&Lo(this.gl,this.debug,this.program),oo(this.gl)},r.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var n=this.gl;this.debug&&this.debugValidate(),te(n,this.debug,function(){return n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)})},r.prototype.blockUntilAllProgramsCompleted=function(){var n=this;this.throwIfDisposed(),te(this.gl,this.debug,function(){return n.gl.finish()})},r.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=ro(this.gl,this.debug,2===O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},r.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},r.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},r.prototype.beginQuery=function(){if(2===O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var n=this.gl,e=this.getQueryTimerExtensionWebGL2(),t=n.createQuery();return n.beginQuery(e.TIME_ELAPSED_EXT,t),t}var o=this.getQueryTimerExtensionWebGL1(),a=o.createQueryEXT();return o.beginQueryEXT(o.TIME_ELAPSED_EXT,a),a},r.prototype.endQuery=function(){if(2!==O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var n=this.getQueryTimerExtensionWebGL1();n.endQueryEXT(n.TIME_ELAPSED_EXT)}else{var e=this.gl,t=this.getQueryTimerExtensionWebGL2();e.endQuery(t.TIME_ELAPSED_EXT)}},r.prototype.waitForQueryAndGetTime=function(n){return Q(this,void 0,void 0,function(){var e=this;return ee(this,function(t){switch(t.label){case 0:return[4,$a(function(){return e.disposed||e.isQueryAvailable(n,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return t.sent(),[2,this.getQueryTime(n,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},r.prototype.getQueryTime=function(n,e){if(0===e)return null;if(2===e){var t=this.gl;return t.getQueryParameter(n,t.QUERY_RESULT)/1e6}var o=this.getQueryTimerExtensionWebGL1();return o.getQueryObjectEXT(n,o.QUERY_RESULT_EXT)/1e6},r.prototype.isQueryAvailable=function(n,e){if(0===e)return!0;if(2===e){var t=this.gl,o=this.getQueryTimerExtensionWebGL2(),a=t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(o.GPU_DISJOINT_EXT)),a&&!this.disjoint}return a=(o=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(n,o.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(o.GPU_DISJOINT_EXT)),a&&!this.disjoint},r.prototype.pollFence=function(n){var e=this;return new Promise(function(t){e.addItemToPoll(function(){return n.isFencePassed()},function(){return t()})})},r.prototype.pollItems=function(){for(var n=function(t){for(var o=0;o<t.length&&t[o]();++o);return o-1}(this.itemsToPoll.map(function(t){return t.isDoneFn})),e=0;e<=n;++e)(0,this.itemsToPoll[e].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(n+1)},r.prototype.addItemToPoll=function(n,e){var t=this;this.itemsToPoll.push({isDoneFn:n,resolveFn:e}),this.itemsToPoll.length>1||$a(function(){return t.pollItems(),0===t.itemsToPoll.length})},r.prototype.bindTextureToFrameBuffer=function(n){this.throwIfDisposed(),Wo(this.gl,this.debug,n,this.framebuffer),this.debug&&oo(this.gl)},r.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(Wo(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&oo(this.gl)):pi(this.gl,this.debug,this.framebuffer)},r.prototype.downloadMatrixDriver=function(n,e){this.bindTextureToFrameBuffer(n);var t=e();return this.unbindTextureToFrameBuffer(),t},r.prototype.setOutputMatrixTextureDriver=function(n,e,t){this.throwIfDisposed();var o=this.gl;Wo(o,this.debug,n,this.framebuffer),this.debug&&oo(o),this.outputTexture=n,te(o,this.debug,function(){return o.viewport(0,0,e,t)}),te(o,this.debug,function(){return o.scissor(0,0,e,t)})},r.prototype.setOutputMatrixWriteRegionDriver=function(n,e,t,o){var a=this;this.throwIfDisposed(),te(this.gl,this.debug,function(){return a.gl.scissor(n,e,t,o)})},r.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},r.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},r}();function al(r,n){if(r.length!==n.length)throw Error("Binary was compiled with "+r.length+" inputs, but was executed with "+n.length+" inputs");r.forEach(function(e,t){var o=e.logicalShape,a=n[t],i=a.shape;if(!Je(o,i))throw Error("Binary was compiled with different shapes than the current args. Shapes "+o+" and "+i+" must match");if(!e.isUniform||!a.isUniform){var s=e.texShape,u=a.isUniform?null:a.texData.texShape;if(!Je(s,u))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+s+" and "+u+" must match")}})}var hp=function(r,n,e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r;for(var o=e.inChannels,a=e.strideWidth,i=e.strideHeight,s=e.padInfo,u=e.outWidth,c=e.dilationWidth,l=e.dilationHeight,h=e.dataFormat,f=s.left,d=s.top,p=o*e.filterWidth,g=gt(),m="channelsLast"===h,y=m?0:1,x=m?1:2,w="",b=0;b<=1;b++)for(var _=0;_<=1;_++)w+="\n          blockIndex = rc.y + "+_+";\n          pos = rc.x + "+b+";\n\n          if(blockIndex < "+r[1]+" && pos < "+r[0]+") {\n            offsetY = int(blockIndex / ("+u+")) * "+i+" - "+d+";\n            d0 = offsetY + "+l+" * (pos / "+p+");\n\n            if(d0 < "+n[y]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+u+".) * "+a+". - "+f+".);\n              d1 = offsetX + "+c+" * (int(mod(float(pos), "+p+".) / "+o+".));\n\n              if(d1 < "+n[x]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+o+".));\n\n                if ("+m+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*b+_)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*b+_)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+w+"\n\n        "+g.output+" = result;\n      }\n    "},fp=function(r,n,e,t,o){this.variableNames=["x"],this.outputShape=[];var i=n,s=r[3]-1;this.outputShape=r;var u="float("+e+") + float("+t+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+i+"; j <= "+i+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+s+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(val);\n      }\n    "},dp=function(r,n,e,t,o){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=r,this.depth=r[3],this.depthRadius=n,this.bias=e,this.alpha=t,this.beta=o,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+n+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+n+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+t+") * norm + float("+e+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+t+")\n                * float("+o+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+o+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "},pp=function(r,n,e,t,o){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var i=n,s=r[3]-1;this.outputShape=r;var u="float("+e+") + float("+t+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+i+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+i+"; j <= "+i+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+s+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(result);\n      }\n    "},vp=function(r){this.variableNames=["dy","maxPos"],this.outputShape=r.inShape;var o=r.effectiveFilterHeight,a=r.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(o-1-r.padInfo.top)+", "+(a-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+o+";\n          wR += "+r.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+a+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(o*a-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+a+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},mp=function(r){this.variableNames=["dy","maxPos"],this.outputShape=r.inShape;var s=r.effectiveFilterDepth,u=r.effectiveFilterHeight,c=r.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(s-1-r.padInfo.front)+", "+(u-1-r.padInfo.top)+", "+(c-1-r.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+s+";\n           wD += "+r.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+r.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+r.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+r.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+r.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(s*u*c-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+u+" * "+c+" +\n                  wR * "+c+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Li=function(r,n,e,t,o,a,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===o&&(o=!1),void 0===a&&(a=null),void 0===i&&(i=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n;var u=Math.ceil((e?r[1]:r[2])/2),c=e?"i * 2, rc.y":"rc.y, i * 2",l=t?"rc.z, i * 2":"i * 2, rc.z",h=e?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],f=t?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],d="",p="";a&&(d=i?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+a+"\n        }":"vec4 activation(vec4 x) {\n          "+a+"\n        }",p="result = activation(result);");var g=o?"result += getBiasAtOutCoords();":"";o&&this.variableNames.push("bias"),i&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+d+"\n\n      const float sharedDimension = "+u+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+u+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+c+");\n          vec4 b = getMatrixB(rc.x, "+l+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+h[0]+" * "+f[0]+");\n          result += ("+h[1]+" * "+f[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+g+"\n\n        "+p+"\n\n        setOutput(result);\n      }\n    "},gp=function(){function r(n,e,t){this.variableNames=["probs"],this.outputShape=[n,t],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(e-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(e-1)+"));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n){var e=this;return function(t,o){null==e.seedLoc&&(e.seedLoc=t.getUniformLocation(o,"seed")),t.gl.uniform1f(e.seedLoc,n)}},r}(),yp=function(r,n,e,t){this.variableNames=["indices"],this.outputShape=[r,n],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+t+"), float("+e+"),\n                      float(index == coords.y)));\n      }\n    "},bp=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=r;var s,c,l,n=r.length;if(0===n)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var e=kt("rc",n),t=Oe(n),o=function(s,u,c){if(1===s)return"rc > "+u[0];for(var l="",h=s-2;h<s;h++)l+=c[h]+" >= "+u[h],h<s-1&&(l+="||");return l}(n,r,e),a=function(s,u,c,l){if(1===s)return"";var h=l.slice(-2);return"\n    int r = "+h[0]+";\n    int c = "+h[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+u+";\n    bool rEdge = rp1 >= "+c+";\n  "}(n,r[r.length-1],r[r.length-2],e),i=(l=function(h,f){for(var d=[],p=0;p<=1;p++)for(var g=0;g<=1;g++){for(var m=(0===p?"r":"rp1")+", "+(0===g?"c":"cp1"),y=2;y<h;y++)m=f[f.length-1-y]+","+m;d.push(m)}return d}(c=(s=r).length,e),1===c?"getA(rc),\n            rc + 1 >= "+s[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+l[0]+"),\n          cEdge ? 0. : getA("+l[1]+"),\n          rEdge ? 0. : getA("+l[2]+"),\n          rEdge || cEdge ? 0. : getA("+l[3]+")");this.userCode="\n        void main() {\n          "+t+" rc = getOutputCoords();\n\n          if("+o+") {\n            setOutput(vec4(0));\n          } else {\n            "+a+"\n\n            setOutput(vec4("+i+"));\n          }\n        }\n      "}},xp=function(r,n,e){this.variableNames=["x"],this.outputShape=n.map(function(u,c){return u[0]+r[c]+u[1]});var t=r.length,o=Oe(t),a=n.map(function(u){return u[0]}).join(","),i=n.map(function(u,c){return u[0]+r[c]}).join(","),s=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,t);this.userCode=1!==t?"\n      "+o+" start = "+o+"("+a+");\n      "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+e+"));\n        } else {\n          "+o+" coords = outC - start;\n          setOutput(getX("+s+"));\n        }\n      }\n    ":"\n        int start = "+a+";\n        int end = "+i+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+e+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "},wp=function(r,n,e){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n.map(function(m,y){return m[0]+r[y]+m[1]});for(var t=r.length,o=Oe(t),a=n.map(function(m){return m[0]}).join(","),i=n.map(function(m,y){return m[0]+r[y]}).join(","),s=kt("rc",t),u=kt("source",t),c=s[t-1]+" < "+this.outputShape[t-1],l=1===t?"source":"vec2("+u.slice(-2).join()+")",h=[o+" rc = outputLoc;",s[t-1]+" += 1;\n       if("+c+") {\n      ",1===t?"":"}\n       rc = outputLoc;\n       "+s[t-2]+" += 1;\n       if("+s[t-2]+" < "+this.outputShape[t-2]+") {",1===t?"":"  "+s[t-1]+" += 1;\n         if("+c+") {"],f=1===t?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",d="",p=0,g=1===t?2:4;p<g;p++)d+="\n        "+h[p]+"\n        if ("+f+") {\n          result["+p+"] = float("+e+");\n        } else {\n          "+o+" source = rc - start;\n          result["+p+"] = getChannel(getX("+u.join()+"), "+l+");\n        }\n      ";this.userCode="\n      const "+o+" start = "+o+"("+a+");\n      const "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+(d+=1===t?"} ":"}}")+"\n        setOutput(result);\n      }\n    "},Wi=function(r,n,e){if(this.variableNames=["x"],"avg"===n&&e)throw new Error("Cannot compute positions for average pool.");var t=r.filterWidth,o=r.strideHeight,a=r.strideWidth,i=r.dilationHeight,s=r.dilationWidth,u=r.effectiveFilterHeight,c=r.effectiveFilterWidth,l=r.padInfo.top,h=r.padInfo.left;this.outputShape=r.outShape;var f="avg"===n,d="0.0";if(f||(d="-1.0 / 1e-20"),e)this.userCode="\n        const ivec2 strides = ivec2("+o+", "+a+");\n        const ivec2 pads = ivec2("+l+", "+h+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+i+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+s+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+c+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var p=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===n&&(p="avgValue / count");var g=4*Math.floor(t/4),m=t%4,y="\n      if ("+f+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+o+", "+a+");\n      const ivec2 pads = ivec2("+l+", "+h+");\n      const float initializationValue = "+d+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+r.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+d+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+u+";\n            wR += "+i+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+r.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+g+"; wC += 4) {\n            int xC = xCCorner + wC * "+s+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              getValue(batch, xR, xC + 3 * "+s+", d)\n            );\n\n            "+y+"\n          }\n\n          int xC = xCCorner + "+g+";\n          if ("+(1===m)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+y+"\n          } else if ("+(2===m)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+y+"\n          } else if ("+(3===m)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              initializationValue\n            );\n\n            "+y+"\n          }\n        }\n        setOutput("+p+");\n      }\n    "}},Ui=function(r,n,e){if(this.variableNames=["x"],"avg"===n&&e)throw new Error("Cannot compute positions for average pool.");var t=r.filterWidth,o=r.strideDepth,a=r.strideHeight,i=r.strideWidth,s=r.dilationDepth,u=r.dilationHeight,c=r.dilationWidth,l=r.effectiveFilterDepth,h=r.effectiveFilterHeight,f=r.effectiveFilterWidth,d=r.padInfo.front,p=r.padInfo.top,g=r.padInfo.left;this.outputShape=r.outShape;var m="avg"===n,y="0.0";if(m||(y="-1.0 / 1e-20"),e)this.userCode="\n        const ivec3 strides =\n            ivec3("+o+", "+a+", "+i+");\n        const ivec3 pads = ivec3("+d+", "+p+", "+g+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+l+";\n              wD += "+s+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+r.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+h+";\n                wR += "+u+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+r.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+f+";\n                  wC += "+c+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+r.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+h+" * "+f+" +\n                      wR * "+f+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var x=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===n&&(x="avgValue / count");var w=4*Math.floor(t/4),b=t%4,_="\n      if ("+m+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+d+", "+p+", "+g+");\n      const float initializationValue = "+y+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+r.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+y+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+s+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+r.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+";\n            wR += "+u+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+w+"; wC += 4) {\n              int xC = xCCorner + wC * "+c+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+c+", ch)\n              );\n\n              "+_+"\n            }\n\n            int xC = xCCorner + "+w+";\n            if ("+(1===b)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+_+"\n            } else if ("+(2===b)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+_+"\n            } else if ("+(3===b)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                initializationValue\n              );\n\n              "+_+"\n            }\n          }\n          setOutput("+x+");\n        }\n      }\n    "}},_p=function(r,n){this.variableNames=["x"];var e=r.windowSize,t=r.batchSize,o=r.inSize,a=Math.ceil(o/e);this.outputShape=[t,a];var i="0.0",s="";"prod"===n?i="1.0":"min"===n?(i="1.0 / 1e-20",s="min"):"max"===n&&(i="-1.0 / 1e-20",s="max");var u=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===n?u="sumValue":"prod"===n?u="prodValue":"all"===n?u="allValue":"any"===n&&(u="anyValue");var c=4*Math.floor(e/4),l=e%4,h="\n      if ("+("sum"===n)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===n)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+s+"(values, minMaxValue);\n      }\n    ",f="vec4";"all"===n?(i="1.0",h="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",f="bvec4"):"any"===n&&(i="0.0",h="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",f="bvec4");var d="";o%e>0&&(d="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+i+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+d+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+e+";\n\n        vec4 minMaxValue = vec4("+i+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+c+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+h+"\n        }\n\n        int inIdx = inOffset + "+c+";\n        if ("+(1===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(2===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(3===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+h+"\n        }\n        setOutput("+u+");\n      }\n    "},Cp=function(r,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r;for(var e="",t=0;t<4;t++){var o="thisRC = rc;";t%2==1&&(o+="thisRC.z += 1;"),t>1&&(o+="thisRC.y += 1;"),e+="\n        "+o+"\n        "+(t>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+t+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(t>0?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+cr(["r","c","d"],n)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+Mi(r)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+r[1]+";\n        int cols = "+r[2]+";\n\n        "+e+"\n\n        setOutput(result);\n      }\n    "},Ep=function(r,n,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=n.shape;var t=n.shape,o=t[1],a=t[2],i=r.shape,s=i[1],u=i[2],c=[e&&s>1?o-1:o,e&&u>1?a-1:a],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],h=c[0]/l[0],f=c[1]/l[1],d=1/h,p=1/f,g=2*Math.ceil(d)+2,m=2*Math.ceil(p)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+d+");\n        const float invWidthScale = float("+p+");\n\n        const int winHeight = int("+g+");\n        const int winWidth = int("+m+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(o-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(a-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},Rp=function(r,n,e,t){this.variableNames=["A"],this.outputShape=[];var a=r[1],i=r[2];this.outputShape=[r[0],n,e,r[3]];var u=[t&&n>1?a-1:a,t&&e>1?i-1:i],c=[t&&n>1?n-1:n,t&&e>1?e-1:e];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "},Sp=function(r,n,e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var a=r[1],i=r[2],s=r[3];this.outputShape=[r[0],n,e,s];var u=[t&&n>1?a-1:a,t&&e>1?i-1:i],c=[t&&n>1?n-1:n,t&&e>1?e-1:e];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+",\n          "+u[1]/c[1]+");\n      const vec3 inputShapeRC = vec3("+a+".0, "+i+".0,\n                                     "+i+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(s-1)+";\n        bool hasNextRow = coords.z < "+(e-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "},kp=function(r,n,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=n.shape;var t=n.shape,o=t[1],a=t[2],i=r.shape,s=i[1],u=i[2],c=[e&&s>1?o-1:o,e&&u>1?a-1:a],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],h=c[0]/l[0],f=c[1]/l[1],d=1/h,p=1/f,g=2*Math.ceil(d)+2,m=2*Math.ceil(p)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+d+");\n        const float invWidthScale = float("+p+");\n\n        const int winHeight = int("+g+");\n        const int winWidth = int("+m+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+c[0]+") *\n                (float(dyR) / float("+l[0]+"));\n\n            float sourceFracCol =\n                float("+c[1]+") *\n                  (float(dyC) / float("+l[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+o+") - 1),\n                "+e+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+a+") - 1),\n                "+e+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},Ip=function(r,n,e,t){this.variableNames=["A"],this.outputShape=[];var a=r[1],i=r[2];this.outputShape=[r[0],n,e,r[3]];var u=[t&&n>1?a-1:a,t&&e>1?i-1:i],c=[t&&n>1?n-1:n,t&&e>1?e-1:e];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(t?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "},Fp=function(r,n){this.variableNames=["x"];var e=r.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");if(this.outputShape=r,1!==e){var t=r.map(function(a,i){return-1!==n.indexOf(s=i)&&1!==r[s]?r[s]+" - coords["+s+"] - 1":"coords["+s+"]";var s}).join(","),o=Oe(e);this.userCode="\n      void main() {\n        "+o+" coords = getOutputCoords();\n        setOutput(getX("+t+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+r[0]+" - coord - 1));\n        }\n      "},Ap=function(r,n){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var e=r.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");this.outputShape=r;var u,t=kt("rc",e),o=t[e-1]+" + 1 < "+this.outputShape[e-1],a=t[e-2]+" + 1 < "+this.outputShape[e-2],i=Oe(e);function s(u){var c=r.map(function(l,h){return d=u,-1!==n.indexOf(f=h)&&1!==r[f]?r[f]+" - "+d[f]+" - 1":""+d[f];var f,d});return"getChannel(getX("+c.join(",")+"), vec2("+c.slice(-2).join(",")+"))"}this.userCode=1===e?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+r[0]+" - rc - 1),\n            "+r[0]+" - rc - 1);\n          if("+o+"){\n              result.g = getChannel(getX("+r[0]+" - (rc  + 1) - 1),\n                "+r[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+i+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+s(t.slice())+";\n          if("+o+"){\n            result.g = "+((u=t.slice())[e-1]="("+u[e-1]+" + 1)",s(u)+";\n          }\n          if(")+a+") {\n            result.b = "+function(u){return u[e-2]="("+u[e-2]+" + 1)",s(u)}(t.slice())+";\n            if("+o+") {\n              result.a = "+function(u){return u[e-1]="("+u[e-1]+" + 1)",u[e-2]="("+u[e-2]+" + 1)",s(u)}(t.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "},il=function(r,n,e,t,o,a,i){void 0===i&&(i=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=a;var s=Oe(o.length),u=Oe(a.length),c="";1===e?c="i":2===e&&(c="i, j");var h="";1===t?h="i":2===t&&(h="i, coords[1]"),this.userCode="\n        "+s+" strides = "+s+"("+o+");\n\n        void main() {\n          "+u+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+r+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+n+"; j++) {\n              int index = round(getIndices("+c+"));\n              flattenedIndex += index * "+(n>1?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += getUpdates("+h+");\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "},Dp=function(r,n){this.variableNames=["x","segmentIds"];var e=r.windowSize,t=r.batchSize,o=r.inSize,a=r.numSegments,i=a*Math.ceil(o/e);this.outputShape=[t,i];var s=4*Math.floor(e/4),u=e%4,c="\n        sumValue += dot(values, segFilter);\n    ",l="";o%e>0&&(l="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      ");var h="";o%e>0&&(h="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+l+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+h+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+a+")) * float("+e+"));\n        int currentSeg = int(mod(float(outIdx), float("+a+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+s+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+c+"\n        }\n\n        int inIdx = inOffset + "+s+";\n        if ("+(1===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+c+"\n        } else if ("+(2===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+c+"\n        } else if ("+(3===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+c+"\n        }\n        setOutput(sumValue);\n      }\n    "},Tp=function(r,n,e){var t,o;if(this.variableNames=["c","a","b"],this.outputShape=n,e>4)throw Error("Where for rank "+e+" is not yet supported");if(1===e)o="resRC",t="resRC";else{for(var a=["resRC.x","resRC.y","resRC.z","resRC.w"],i=[],s=[],u=0;u<n.length;u++)s.push(""+a[u]),u<r&&i.push(""+a[u]);t=i.join(),o=s.join()}var c=Oe(e);this.userCode="\n      void main() {\n        "+c+" resRC = getOutputCoords();\n        float cVal = getC("+t+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+o+"));\n        } else {\n          setOutput(getB("+o+"));\n        }\n      }\n    "},Np=function(){function r(n){this.variableNames=["source"],this.outputShape=n,this.rank=n.length;var e,t=Oe(this.rank),o="uniform int start["+this.rank+"];",a=function(i){if(1===i)return"sourceLoc";if(i<=6)return Vi.slice(0,i).map(function(s){return"sourceLoc."+s}).join(",");throw Error("Slicing for rank "+i+" is not yet supported")}(this.rank);e="\n        "+t+" sourceLoc;\n        "+t+" coords = getOutputCoords();\n        "+n.map(function(i,s){return"sourceLoc."+Vi[s]+" = start["+s+"] + coords."+Vi[s]+";"}).join("\n")+"\n      ",this.userCode="\n      "+o+"\n      void main() {\n        "+e+"\n        setOutput(getSource("+a+"));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n){var e=this;if(n.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+n.length+")");return function(t,o){null==e.startLoc&&(e.startLoc=t.getUniformLocationNoThrow(o,"start"),null==e.startLoc)||t.gl.uniform1iv(e.startLoc,n)}},r}(),Vi=["x","y","z","w","u","v"],Pp=function(){function r(n){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n,this.rank=n.length;var e=Oe(this.rank),t=kt("coords",this.rank),o=kt("sourceLoc",this.rank),a=1===this.rank?"sourceLoc":"vec2("+o.slice(-2).join()+")",i="getChannel(getSource("+o.join()+"), "+a+")",s="\n      result.x = "+i+";\n      if (++"+t[this.rank-1]+" < "+n[this.rank-1]+") {\n        ++"+o[this.rank-1]+";\n        result.y = "+i+";\n        --"+o[this.rank-1]+";\n      }\n    ",u=1===this.rank?"":"\n      --"+t[this.rank-1]+";\n      if (++"+t[this.rank-2]+" < "+n[this.rank-2]+") {\n        ++"+o[this.rank-2]+";\n        result.z = "+i+";\n        if (++"+t[this.rank-1]+" < "+n[this.rank-1]+") {\n          ++"+o[this.rank-1]+";\n          result.w = "+i+";\n        }\n      }\n    ",c=this.rank<=4?"sourceLoc = coords +\n            "+e+"("+n.map(function(l,h){return"start["+h+"]"}).join()+");":n.map(function(l,h){return o[h]+" = "+t[h]+" + start["+h+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+e+" coords = getOutputCoords();\n        "+e+" sourceLoc;\n        "+c+"\n        vec4 result = vec4(0.);\n        "+s+"\n        "+u+"\n        setOutput(result);\n      }\n    "}return r.prototype.getCustomSetupFunc=function(n){var e=this;if(n.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+n.length+")");return function(t,o){null==e.startLoc&&(e.startLoc=t.getUniformLocationNoThrow(o,"start"),null==e.startLoc)||t.gl.uniform1iv(e.startLoc,n)}},r}(),Mp=function(r,n,e){this.variableNames=["x"],this.outputShape=e;var t=e.length,o=Oe(e.length),a=Oe(e.length),i="";if(1===t)i="coords * strides + begin";else{var s=0;i=e.map(function(u,c){return s++,1===e.length?"coords * strides["+c+"] + begin["+c+"]":"coords["+(s-1)+"] * strides["+c+"] + begin["+c+"]"}).join(",")}this.userCode="\n      "+o+" begin = "+o+"("+r+");\n      "+o+" strides = "+o+"("+n+");\n\n      void main() {\n        "+a+" coords = getOutputCoords();\n        setOutput(getX("+i+"));\n      }\n    "},Op=function(){function r(n){this.gpgpu=n,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return r.prototype.acquireTexture=function(n,e,t){var o,a=sl(e,t),i=ul(n,a,t);if(i in this.freeTextures||(this.freeTextures[i]=[]),i in this.usedTextures||(this.usedTextures[i]=[]),this.freeTextures[i].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var s=this.freeTextures[i].shift();return this.usedTextures[i].push(s),s}return this.numUsedTextures++,this.log(),a===Dt.PACKED_2X2_FLOAT32?o=this.gpgpu.createPackedMatrixTexture(n[0],n[1]):a===Dt.PACKED_2X2_FLOAT16?o=this.gpgpu.createFloat16PackedMatrixTexture(n[0],n[1]):a===Dt.UNPACKED_FLOAT32?o=this.gpgpu.createFloat32MatrixTexture(n[0],n[1]):a===Dt.UNPACKED_FLOAT16?o=this.gpgpu.createFloat16MatrixTexture(n[0],n[1]):a===Dt.PACKED_4X1_UNSIGNED_BYTE&&(o=this.gpgpu.createUnsignedBytesMatrixTexture(n[0],n[1])),this.usedTextures[i].push(o),o},r.prototype.releaseTexture=function(n,e,t,o){if(null!=this.freeTextures){var a=ul(e,sl(t,o),o);a in this.freeTextures||(this.freeTextures[a]=[]),this.freeTextures[a].push(n),this.numFreeTextures++,this.numUsedTextures--;var i=this.usedTextures[a],s=i.indexOf(n);if(s<0)throw new Error("Cannot release a texture that was never provided by this texture manager");i.splice(s,1),this.log()}},r.prototype.log=function(){this.logEnabled&&console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+(this.numFreeTextures+this.numUsedTextures)+")")},r.prototype.getNumUsedTextures=function(){return this.numUsedTextures},r.prototype.getNumFreeTextures=function(){return this.numFreeTextures},r.prototype.dispose=function(){var n=this;if(null!=this.freeTextures){for(var e in this.freeTextures)this.freeTextures[e].forEach(function(t){n.gpgpu.deleteMatrixTexture(t)});for(var e in this.usedTextures)this.usedTextures[e].forEach(function(o){n.gpgpu.deleteMatrixTexture(o)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},r}();function sl(r,n){if(r===At.UPLOAD)return Dt.PACKED_2X2_FLOAT32;if(r===At.RENDER||null==r)return e=n,O().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?e?Dt.PACKED_2X2_FLOAT32:Dt.UNPACKED_FLOAT32:e?Dt.PACKED_2X2_FLOAT16:Dt.UNPACKED_FLOAT16;var e;if(r===At.DOWNLOAD||r===At.PIXELS)return Dt.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+r)}function ul(r,n,e){return r[0]+"_"+r[1]+"_"+n+"_"+e}var Bp=function(r,n){this.variableNames=["A"];for(var e=new Array(r.length),t=0;t<e.length;t++)e[t]=r[t]*n[t];this.outputShape=e,this.rank=e.length;var o=Oe(this.rank),a=function(i){var s=i.length;if(s>5)throw Error("Tile for rank "+s+" is not yet supported");if(1===s)return"imod(resRC, "+i[0]+")";for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],c=[],l=0;l<i.length;l++)c.push("imod("+u[l]+", "+i[l]+")");return c.join()}(r);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},Lp=function(r,n){this.variableNames=["A"];for(var e=new Array(r.length),t=0;t<e.length;t++)e[t]=r[n[t]];this.outputShape=e,this.rank=e.length;var o=Oe(this.rank),a=function(i){var s=i.length;if(s>6)throw Error("Transpose for rank "+s+" is not yet supported");for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],c=new Array(s),l=0;l<i.length;l++)c[i[l]]=u[l];return c.join()}(n);this.userCode="\n    void main() {\n      "+o+" resRC = getOutputCoords();\n      setOutput(getA("+a+"));\n    }\n    "},Wp=function(r,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var e=new Array(r.length),t=0;t<e.length;t++)e[t]=r[n[t]];if(this.outputShape=e,this.rank=e.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var o=Oe(this.rank),a=Ac("rc",this.rank),i=new Array(this.rank);for(t=0;t<n.length;t++)i[n[t]]=a[t];var s="vec2("+i.slice(-2).join()+")",u="++"+a[this.rank-1]+" < "+e[this.rank-1],c="getChannel(getA("+i.join()+"), "+s+")";this.userCode="\n    void main() {\n      "+o+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+c+";\n      if("+u+") {\n        result[1] = "+c+";\n      }\n      --"+a[this.rank-1]+";\n      if(++"+a[this.rank-2]+" < "+e[this.rank-2]+") {\n        result[2] = "+c+";\n        if("+u+") {\n          result[3] = "+c+";\n        }\n      }\n      setOutput(result);\n    }\n    "},Gi=1.7580993408473768,zi=1.0507009873554805,me=function(r,n){this.variableNames=["A"],this.outputShape=r,this.userCode="\n      float unaryOperation(float x) {\n        "+n+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Yt="if (isnan(x)) return x;",cl="return abs(x);",ll=Yt+"\n  return (x < 0.0) ? 0.0 : x;\n",hl=Yt+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",fl="return (x >= 0.0) ? x : (exp(x) - 1.0);",Vp="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+Gi+";\n  float scale = "+zi+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",dl="return -x;",pl="return ceil(x);",vl="return floor(x);",ml="return exp(x);",gl="return exp(x) - 1.0;",Gp=Yt+"\n  return sin(x);\n",zp=Yt+"\n  return cos(x);\n",jp=Yt+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n",Hp=Yt+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n",qp=Yt+"\n  return atan(x);\n",Xp=Yt+"return log(x + sqrt(x * x + 1.0));",Kp=Yt+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",Yp=Yt+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",ra="return x;",yl="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",bl="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",xl="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",vo=function(r,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+n+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Jp=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=r;var n=r.length,e=kt("rc",n),t=Oe(n),o=function(s,u){if(1===s)return"rc";for(var c="",l=0;l<s;l++)c+=u[l],l<s-1&&(c+=",");return c}(n,e),a=e.slice(-2),i=n<=1?"rc":"vec2("+a.join(",")+")";this.userCode="\n      void main() {\n        "+t+" rc = getOutputCoords();\n        vec4 packedInput = getA("+o+");\n\n        setOutput(getChannel(packedInput, "+i+"));\n      }\n    "},oa={};function aa(r,n){if(void 0===n&&(n=!1),"linear"===r)return"return x;";if("relu"===r)return n?yl:ll;if("elu"===r)return n?xl:fl;if("relu6"===r)return n?bl:hl;if("prelu"===r)return n?Oc:Mc;throw new Error("Activation "+r+" has not been implemented for the WebGL backend.")}var wl=function(r){function n(e){var t,o=r.call(this)||this;if(o.pendingRead=new WeakMap,o.pendingDisposal=new WeakSet,o.dataRefCount=new WeakMap,o.numBytesInGPU=0,o.uploadWaitMs=0,o.downloadWaitMs=0,o.warnedAboutMemory=!1,o.pendingDeletes=0,o.disposed=!1,!O().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==e){var a=tn(O().getNumber("WEBGL_VERSION"));o.binaryCache=((t=O().getNumber("WEBGL_VERSION"))in oa||(oa[t]={}),oa[t]),o.gpgpu=new ol(a),o.canvas=a.canvas,o.gpgpuCreatedLocally=!0}else o.gpgpu=e,o.binaryCache={},o.gpgpuCreatedLocally=!1,o.canvas=e.gl.canvas;return o.textureManager=new Op(o.gpgpu),o.numMBBeforeWarning=null==O().global.screen?1024:O().global.screen.height*O().global.screen.width*window.devicePixelRatio*600/1024/1024,o.texData=new _c(o,A),o}return Ft(n,r),n.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},n.prototype.write=function(e,t,o){if(O().getBool("DEBUG")&&this.checkNumericalProblems(e),"complex64"===o&&null!=e)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var a={};return this.texData.set(a,{shape:t,dtype:o,values:e,usage:At.UPLOAD}),a},n.prototype.move=function(e,t,o,a){if(O().getBool("DEBUG")&&this.checkNumericalProblems(t),"complex64"===a)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:o,dtype:a,values:t,usage:At.UPLOAD})},n.prototype.readSync=function(e){var t=this.texData.get(e),o=t.values,a=t.dtype,i=t.complexTensors,u=t.shape;if(null!=t.slice){var l;l=t.isPacked?new vo(u,ra):new me(u,ra);var h=this.runWebGLProgram(l,[{dataId:e,shape:u,dtype:a}],a),f=this.readSync(h.dataId);return this.disposeData(h.dataId),f}if(null!=o)return this.convertAndCacheOnCPU(e);if("string"===a)return o;var d,p,g=null!=this.activeTimers;return g&&(d=Ht()),p="complex64"===a?Di(i.real.dataSync(),i.imag.dataSync()):this.getValuesFromTexture(e),g&&(this.downloadWaitMs+=Ht()-d),this.convertAndCacheOnCPU(e,p)},n.prototype.read=function(e){return Q(this,void 0,void 0,function(){var t,o,a,i,u,c,l,h,f,d,p,g,m,y,x,_,E,F,I;return ee(this,function(S){switch(S.label){case 0:if(this.pendingRead.has(e))return t=this.pendingRead.get(e),[2,new Promise(function(k){return t.push(k)})];if(o=this.texData.get(e),a=o.values,i=o.shape,u=o.dtype,c=o.complexTensors,l=o.isPacked,null!=o.slice)return h=l?new vo(i,ra):new me(i,ra),f=this.runWebGLProgram(h,[{dataId:e,shape:i,dtype:u}],u),d=this.read(f.dataId),this.disposeData(f.dataId),[2,d];if(null!=a)return[2,this.convertAndCacheOnCPU(e)];if(!O().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===O().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return p=null,"complex64"!==u&&O().get("WEBGL_BUFFER_SUPPORTED")&&(g=this.decode(e),m=this.texData.get(g.dataId),p=(I=this.gpgpu).createBufferFromTexture.apply(I,[m.texture].concat(to(i)))),this.pendingRead.set(e,[]),"complex64"===u?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:S.sent(),S.label=2;case 2:return"complex64"!==u?[3,4]:[4,Promise.all([c.real.data(),c.imag.data()])];case 3:return x=S.sent(),y=Di(x[0],x[1]),[3,5];case 4:null==p?y=this.getValuesFromTexture(e):(_=re(i),y=this.gpgpu.downloadFloat32MatrixFromBuffer(p,_)),S.label=5;case 5:return null!=g&&this.disposeData(g.dataId),E=this.convertAndCacheOnCPU(e,y),F=this.pendingRead.get(e),this.pendingRead.delete(e),F.forEach(function(k){return k(E)}),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e),this.pendingDeletes--),[2,E]}})})},n.prototype.checkNumericalProblems=function(e){if(null!=e)for(var t=0;t<e.length;t++){var o=e[t];if(!Mu(o))throw O().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error("The value "+o+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'"):Error("The value "+o+" cannot be represented on this device.")}},n.prototype.getValuesFromTexture=function(e){var t,o=this.texData.get(e),a=o.shape,i=o.dtype,s=o.isPacked,u=re(a);if(O().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var c=this.decode(e),l=this.texData.get(c.dataId),h=(t=this.gpgpu).downloadMatrixFromPackedTexture.apply(t,[l.texture].concat(to(a))).subarray(0,u);return this.disposeData(c.dataId),h}var f=O().getBool("WEBGL_PACK")&&!0===s,d=f?Uo(a):a,p=f?new np(d):new tp(d),g=this.runWebGLProgram(p,[{shape:d,dtype:i,dataId:e}],"float32"),m=this.texData.get(g.dataId),y=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(m.texture,m.texShape[0],m.texShape[1]).subarray(0,u);return this.disposeData(g.dataId),y},n.prototype.time=function(e){return Q(this,void 0,void 0,function(){var t,o,a,i,s,u,c;return ee(this,function(l){switch(l.label){case 0:return t=this.activeTimers,o=[],a=!1,null==this.programTimersStack?(this.programTimersStack=o,a=!0):this.activeTimers.push(o),this.activeTimers=o,e(),i=mn(this.activeTimers.map(function(h){return h.query})).filter(function(h){return null!=h}),s=mn(this.activeTimers.map(function(h){return h.name})).filter(function(h){return null!=h}),this.activeTimers=t,a&&(this.programTimersStack=null),u={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[4,Promise.all(i)]:[3,2];case 1:return c=l.sent(),u.kernelMs=mu(c),u.getExtraProfileInfo=function(){return c.map(function(h,f){return{name:s[f],ms:h}}).map(function(h){return h.name+": "+h.ms}).join(", ")},[3,3];case 2:u.kernelMs={error:"WebGL query timers are not supported in this environment."},l.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,u]}})})},n.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},n.prototype.startTimer=function(){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:Ht(),endMs:null}},n.prototype.endTimer=function(e){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),e):(e.endMs=Ht(),e)},n.prototype.getQueryTime=function(e){return Q(this,void 0,void 0,function(){var t;return ee(this,function(o){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[2,this.gpgpu.waitForQueryAndGetTime(e)]:[2,(t=e).endMs-t.startMs]})})},n.prototype.disposeData=function(e){if(!this.pendingDisposal.has(e)){if(this.pendingRead.has(e))return this.pendingDisposal.add(e),void this.pendingDeletes++;if(this.texData.has(e)){this.releaseGPUData(e);var t=this.texData.get(e).complexTensors;null!=t&&(t.real.dispose(),t.imag.dispose()),this.texData.delete(e)}}},n.prototype.releaseGPUData=function(e){var t=this.texData.get(e),o=t.texture,a=t.dtype,i=t.texShape,s=t.usage,u=t.isPacked,c=t.slice,l=c&&c.origDataId||e,h=this.dataRefCount.get(l);h>1?this.dataRefCount.set(l,h-1):(this.dataRefCount.delete(l),null!=o&&(this.numBytesInGPU-=this.computeBytes(i,a),this.textureManager.releaseTexture(o,i,s,u)));var f=this.texData.get(e);f.texture=null,f.texShape=null,f.isPacked=!1,f.slice=null},n.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},n.prototype.getDataInfo=function(e){return this.texData.get(e)},n.prototype.getCPUBackend=function(){return O().getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=A.findBackend("cpu")),this.cpuBackend):null},n.prototype.shouldExecuteOnCPU=function(e,t){var o=this;return void 0===t&&(t=128),null!=this.getCPUBackend()&&e.every(function(a){return null==o.texData.get(a.dataId).texture&&a.size<t})},n.prototype.getGPGPUContext=function(){return this.gpgpu},n.prototype.complex=function(e,t){var o=this.makeOutput(e.shape,"complex64");return this.texData.get(o.dataId).complexTensors={real:A.keep(e.clone()),imag:A.keep(t.clone())},o},n.prototype.real=function(e){return this.texData.get(e.dataId).complexTensors.real.clone()},n.prototype.imag=function(e){return this.texData.get(e.dataId).complexTensors.imag.clone()},n.prototype.slice=function(e,t,o){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,t,o);if(0===re(o))return pt([],o,e.dtype);var a=this.texData.get(e.dataId).isPacked,i=Ri(e.shape,t,o);if(a||!i){var s=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Pp(o):new Np(o),u=s.getCustomSetupFunc(t);return this.compileAndRun(s,[e],null,u)}return this.uploadToGPU(e.dataId),this.shallowSlice(e,t,o)},n.prototype.shallowSlice=function(e,t,o){var a=this.texData.get(e.dataId),i=this.makeOutput(o,e.dtype),s=this.texData.get(i.dataId);Object.assign(s,a),s.shape=o,s.dtype=e.dtype;var u=Si(t,e.strides);a.slice&&(u+=a.slice.flatOffset),s.slice={flatOffset:u,origDataId:a.slice&&a.slice.origDataId||e.dataId};var c=this.dataRefCount.get(s.slice.origDataId)||1;return this.dataRefCount.set(s.slice.origDataId,c+1),i},n.prototype.stridedSlice=function(e,t,o,a){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.stridedSlice(e,t,o,a);var i=$o(t,o,a);if(i.some(function(u){return 0===u}))return pt([],i);var s=new Mp(t,a,i);return this.compileAndRun(s,[e])},n.prototype.reverse=function(e,t){var o=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Ap(e.shape,t):new Fp(e.shape,t);return this.compileAndRun(o,[e])},n.prototype.concat=function(e,t){if("complex64"===e[0].dtype){var o=e.map(function(d){return Bt(d)}),a=e.map(function(d){return rn(d)});return dt(this.concat(o,t),this.concat(a,t))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,t);if(1===e.length)return e[0];if(e.length>O().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var i=Math.floor(e.length/2),s=this.concat(e.slice(0,i),t),u=this.concat(e.slice(i),t);return this.concat([s,u],t)}if(O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&e[0].rank>1){var c=new Vd(e.map(function(d){return d.shape}),t);return this.compileAndRun(c,e)}var l=or(e.map(function(d){return d.shape}),t),h=e.map(function(d){return d.as2D(-1,re(d.shape.slice(t)))}),f=new Ud(h.map(function(d){return d.shape}));return this.compileAndRun(f,h).reshape(l)},n.prototype.neg=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.neg(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,dl,e.dtype);var t=new me(e.shape,dl);return this.compileAndRun(t,[e])},n.prototype.batchMatMul=function(e,t,o,a){var i=o?e.shape[2]:e.shape[1],s=a?t.shape[1]:t.shape[2],u=o?e.shape[1]:e.shape[2],c=e.shape[0];if((1===i||1===s)&&u>1e3){o&&(e=e.transpose([0,2,1])),a&&(t=t.transpose([0,2,1]));var l=1===s?e:e.as3D(c,u,1),h=1===s?2:1,f=1===s?t.as3D(c,1,u):t;return this.multiply(l,f).sum(h,!0)}var d=it(e.dtype,t.dtype),p=new Li(e.shape,[c,i,s],o,a);return this.compileAndRun(p,[e,t],d)},n.prototype.fusedBatchMatMul=function(e){var t=e.a,o=e.b,a=e.transposeA,i=e.transposeB,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=a?t.shape[2]:t.shape[1],h=i?o.shape[1]:o.shape[2],f=t.shape[0],d=it(t.dtype,o.dtype),p=null!=s,g=null!=c,m=u?aa(u,!0):null,y=new Li(t.shape,[f,l,h],a,i,p,m,g),x=[t,o];return s&&x.push(s),c&&x.push(c),this.compileAndRun(y,x,d)},n.prototype.multiply=function(e,t){if("complex64"===e.dtype){var o=this.texData.get(e.dataId),a=this.texData.get(t.dataId),i=new Nc("return areal * breal - aimag * bimag;",e.shape,t.shape),s=new Nc("return areal * bimag + aimag * breal;",e.shape,t.shape),u=[this.makeComplexComponentTensorInfo(e,o.complexTensors.real),this.makeComplexComponentTensorInfo(e,o.complexTensors.imag),this.makeComplexComponentTensorInfo(t,a.complexTensors.real),this.makeComplexComponentTensorInfo(t,a.complexTensors.imag)],c=this.compileAndRun(i,u),l=this.compileAndRun(s,u),h=this.complex(c,l);return c.dispose(),l.dispose(),h}if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.multiply(e,t);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,Pc,e.dtype);var f=new Xe(Pc,e.shape,t.shape);return this.compileAndRun(f,[e,t],e.dtype)},n.prototype.batchNormalization=function(e,t,o,a,i,s){var u=[e,t,o],c=null;null!=s&&(c=s.shape,u.push(s));var l=null;if(null!=i&&(l=i.shape,u.push(i)),O().getBool("WEBGL_PACK_NORMALIZATION")){var h=new Pd(e.shape,t.shape,o.shape,c,l,a);return this.compileAndRun(h,u)}var f=new Nd(e.shape,t.shape,o.shape,c,l,a);return this.compileAndRun(f,u)},n.prototype.localResponseNormalization4D=function(e,t,o,a,i){var s=O().getBool("WEBGL_PACK_NORMALIZATION")?new pp(e.shape,t,o,a,i):new fp(e.shape,t,o,a,i);return this.compileAndRun(s,[e])},n.prototype.LRNGrad=function(e,t,o,a,i,s,u){var c=new dp(t.shape,a,i,s,u);return this.compileAndRun(c,[t,o,e])},n.prototype.tile=function(e,t){if("string"===e.dtype){var o=this.readSync(e.dataId).map(function(i){return Yr(i)});return Ic(de(e.shape,e.dtype,o),t)}var a=new Bp(e.shape,t);return this.compileAndRun(a,[e])},n.prototype.pad=function(e,t,o){var a=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new wp(e.shape,t,o):new xp(e.shape,t,o);return this.compileAndRun(a,[e])},n.prototype.transpose=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,t);var o=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Wp(e.shape,t):new Lp(e.shape,t);return this.compileAndRun(o,[e])},n.prototype.gather=function(e,t,o){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.gather(e,t,o);var a=new up(e.shape,t.size,o);return this.compileAndRun(a,[e,t])},n.prototype.batchToSpaceND=function(e,t,o){R(e.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var a=t.reduce(function(h,f){return h*f}),i=qo(e.shape,t,a),s=Xo(i.length,t.length),u=Ko(e.shape,t,a),c=vc(o,t.length),l=mc(u,o,t.length);return e.reshape(i).transpose(s).reshape(u).slice(c,l)},n.prototype.spaceToBatchND=function(e,t,o){R(e.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var a=t.reduce(function(f,d){return f*d}),i=[[0,0]];i.push.apply(i,o);for(var s=1+t.length;s<e.shape.length;++s)i.push([0,0]);var u=e.pad(i),c=qo(u.shape,t,a,!1),l=Xo(c.length,t.length,!1),h=Ko(u.shape,t,a,!1);return u.reshape(c).transpose(l).reshape(h)},n.prototype.reduce=function(e,t,o){var a=e.shape[0],i=e.shape[1],s=Yo(i),u=new _p({windowSize:s,inSize:i,batchSize:a},t),c=this.compileAndRun(u,[e],o);return 1===c.shape[1]?c:this.reduce(c,t,o)},n.prototype.argReduce=function(e,t,o){void 0===o&&(o=null);var a=e.shape[0],i=e.shape[1];null!=o&&(a=o.shape[0],i=o.shape[1]);var s=Yo(i),u=new Ed({windowSize:s,inSize:i,batchSize:a},t,null==o),c=[e];null!=o&&c.push(o);var l=this.compileAndRun(u,c,"int32");return 1===l.shape[1]?l:this.argReduce(e,t,l)},n.prototype.argReducePacked=function(e,t,o){void 0===o&&(o=null);var a=null!=o?o.shape:e.shape,i=Yo(a[a.length-1]),s=new Ad(a,i,t,null==o),c=this.compileAndRun(s,null==o?[e]:[e,o],"int32");return c.rank===e.rank?this.argReducePacked(e,t,c):c},n.prototype.sum=function(e,t){Rt("sum",t,e.rank);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i),u=ui(e.dtype);return this.reduce(s,"sum",u).reshape(a)},n.prototype.prod=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.prod(e,t);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i),u=ui(e.dtype);return this.reduce(s,"prod",u).reshape(a)},n.prototype.unsortedSegmentSum=function(e,t,o){var a=0,i=qt([a],e.rank),s=e;null!=i&&(s=e.transpose(i),a=Xt(1,e.rank)[0]);var u=function(d,p,g){for(var m=[],y=d.length,x=0;x<y;x++)m.push(x!==p?d[x]:g);return m}(s.shape,a,o),c=re([s.shape[a]]),l=s.as2D(-1,c),h=ui(e.dtype),f=this.segOpCompute(l,"unsortedSegmentSum",t,h,o).reshape(u);return null!=i&&(f=f.transpose(zo(i))),f},n.prototype.segOpCompute=function(e,t,o,a,i){var s=e.shape[0],u=e.shape[1],c=function(f,d){var p,g=!1;for(f<=30?(p=f,g=!0):p=Po(f,Math.floor(Math.sqrt(f)));!g;)p>d||p===f?g=!0:p=Po(f,p+1);return p}(u,i),l=new Dp({windowSize:c,inSize:u,batchSize:s,numSegments:i},t),h=this.compileAndRun(l,[e,o],a);return h.shape[1]===i?h:(o=jo(0,i).tile([u/c]),this.segOpCompute(h,t,o,a,i))},n.prototype.argMinMaxReduce=function(e,t,o){var a=[t];if(Rt("arg"+o.charAt(0).toUpperCase()+o.slice(1),a,e.rank),!O().getBool("WEBGL_PACK_REDUCE")||e.rank<=2){var i=ft(e.shape,a),s=i[0],u=re(i[1]),c=e.as2D(-1,u);return this.argReduce(c,o).reshape(s)}return this.argReducePacked(e,o)},n.prototype.argMin=function(e,t){return this.argMinMaxReduce(e,t,"min")},n.prototype.argMax=function(e,t){return this.argMinMaxReduce(e,t,"max")},n.prototype.cumsum=function(e,t,o,a){if(t!==e.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(e.rank-1)+" but got axis="+t);var i=new $d(e.shape,o,a);return this.compileAndRun(i,[e])},n.prototype.equal=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(equal(a, b));\n","bool");var o=new Xe("return float(a == b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.notEqual=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(notEqual(a, b));\n","bool");var o=new Xe("return float(a != b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.less=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.less(e,t);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(lessThan(a, b));\n","bool");var o=new Xe("return float(a < b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.lessEqual=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(lessThanEqual(a, b));\n","bool");var o=new Xe("return float(a <= b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.greater=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.greater(e,t);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(greaterThan(a, b));\n","bool");var o=new Xe("return float(a > b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.greaterEqual=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var o=new Xe("return float(a >= b);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.logicalNot=function(e){var t=new me(e.shape,"return float(!(x >= 1.0));");return this.compileAndRun(t,[e])},n.prototype.logicalAnd=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var o=new Xe("return float(a >= 1.0 && b >= 1.0);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.logicalOr=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var o=new Xe("return float(a >= 1.0 || b >= 1.0);",e.shape,t.shape);return this.compileAndRun(o,[e,t],"bool")},n.prototype.select=function(e,t,o){var a=new Tp(e.rank,t.shape,t.rank);return this.compileAndRun(a,[e,t,o],it(t.dtype,o.dtype))},n.prototype.where=function(e){Go("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var t=e.dataSync();return Pi(e.shape,t)},n.prototype.topk=function(e,t,o){return Fc(e.dataSync(),e.shape,e.dtype,t)},n.prototype.min=function(e,t){Rt("min",t,e.rank);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i);return this.reduce(s,"min",s.dtype).reshape(a)},n.prototype.minimum=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.minimum(e,t);var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Xe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.mod=function(e,t){var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Xe("if (b == 0.0) return NAN;\n  return mod(a, b);",e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.max=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.max(e,t);Rt("max",t,e.rank);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i);return this.reduce(s,"max",s.dtype).reshape(a)},n.prototype.maximum=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.maximum(e,t);var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Xe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.all=function(e,t){Rt("all",t,e.rank);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i);return this.reduce(s,"all",s.dtype).reshape(a)},n.prototype.any=function(e,t){Rt("any",t,e.rank);var o=ft(e.shape,t),a=o[0],i=re(o[1]),s=e.as2D(-1,i);return this.reduce(s,"any",s.dtype).reshape(a)},n.prototype.realDivide=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var o=new Xe("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",e.shape,t.shape);return this.compileAndRun(o,[e,t],"float32")},n.prototype.floorDiv=function(e,t){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var o=new Xe("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",e.shape,t.shape);return this.compileAndRun(o,[e,t],"int32")},n.prototype.add=function(e,t){if("complex64"===e.dtype&&"complex64"===t.dtype)return this.complexSeparableBinaryOp(e,t,Oi);if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.add(e,t);var o=it(e.dtype,t.dtype);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,Oi,o);var a=new Xe(Oi,e.shape,t.shape);return this.compileAndRun(a,[e,t],o)},n.prototype.packedUnaryOp=function(e,t,o){var a=new vo(e.shape,t);return this.compileAndRun(a,[e],o)},n.prototype.packedBinaryOp=function(e,t,o,a,i){void 0===i&&(i=!1);var s=new wn(o,e.shape,t.shape,i);return this.compileAndRun(s,[e,t],a)},n.prototype.complexSeparableBinaryOp=function(e,t,o){var a=this,i=this.texData.get(e.dataId),s=this.texData.get(t.dataId),u=[[i.complexTensors.real,s.complexTensors.real],[i.complexTensors.imag,s.complexTensors.imag]].map(function(f){var d=f[0],p=f[1],g=a.makeComplexComponentTensorInfo(e,d),m=a.makeComplexComponentTensorInfo(t,p),y=new Xe(o,e.shape,t.shape);return a.compileAndRun(y,[g,m],it(d.dtype,p.dtype))}),c=u[0],l=u[1],h=this.complex(c,l);return c.dispose(),l.dispose(),h},n.prototype.makeComplexComponentTensorInfo=function(e,t){return{dataId:t.dataId,dtype:t.dtype,shape:e.shape}},n.prototype.addN=function(e){if(1===e.length)return e[0];if(e.length>O().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var t=Math.floor(e.length/2),o=this.addN(e.slice(0,t)),a=this.addN(e.slice(t));return this.addN([o,a])}var i=e.map(function(c){return c.dtype}).reduce(function(c,l){return it(c,l)}),s=e.map(function(c){return c.shape}),u=O().getBool("WEBGL_PACK")?new Cd(e[0].shape,s):new _d(e[0].shape,s);return this.compileAndRun(u,e,i)},n.prototype.subtract=function(e,t){if("complex64"===e.dtype&&"complex64"===t.dtype)return this.complexSeparableBinaryOp(e,t,Bi);if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.subtract(e,t);var o=it(e.dtype,t.dtype);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,Bi,e.dtype);var a=new Xe(Bi,e.shape,t.shape);return this.compileAndRun(a,[e,t],o)},n.prototype.pow=function(e,t){var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Xe("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",e.shape,t.shape),a=it(e.dtype,t.dtype);return this.compileAndRun(o,[e,t],a)},n.prototype.ceil=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.ceil(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,pl,e.dtype);var t=new me(e.shape,pl);return this.compileAndRun(t,[e])},n.prototype.floor=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.floor(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,vl,e.dtype);var t=new me(e.shape,vl);return this.compileAndRun(t,[e])},n.prototype.sign=function(e){var t=new me(e.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(t,[e])},n.prototype.isNaN=function(e){var t=new me(e.shape,"return float(isnan(x));");return this.compileAndRun(t,[e],"bool")},n.prototype.isInf=function(e){var t=new me(e.shape,"return float(isinf(x));");return this.compileAndRun(t,[e],"bool")},n.prototype.isFinite=function(e){var t=new me(e.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(t,[e],"bool")},n.prototype.round=function(e){var t=new me(e.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(t,[e])},n.prototype.exp=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.exp(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,ml,e.dtype);var t=new me(e.shape,ml);return this.compileAndRun(t,[e])},n.prototype.expm1=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.expm1(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,gl,e.dtype);var t=new me(e.shape,gl);return this.compileAndRun(t,[e])},n.prototype.softmax=function(e,t){var o=Qe([t],e.shape),a=this.max(e,o),i=wt(a.shape,o),s=this.subtract(e,a.reshape(i)),u=this.exp(s),c=this.sum(u,o).reshape(i);return this.realDivide(u,c)},n.prototype.log=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.log(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",e.dtype);var t=new me(e.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(t,[e])},n.prototype.log1p=function(e){var t=new me(e.shape,"return log(1.0 + x);");return this.compileAndRun(t,[e])},n.prototype.sqrt=function(e){var t=new me(e.shape,"return sqrt(x);");return this.compileAndRun(t,[e])},n.prototype.rsqrt=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.rsqrt(e);var t=new me(e.shape,"return inversesqrt(x);");return this.compileAndRun(t,[e])},n.prototype.reciprocal=function(e){var t=new me(e.shape,"return 1.0 / x;");return this.compileAndRun(t,[e])},n.prototype.relu=function(e){var t;return t=O().getBool("WEBGL_PACK")?new vo(e.shape,yl):new me(e.shape,ll),this.compileAndRun(t,[e])},n.prototype.relu6=function(e){var t;return t=O().getBool("WEBGL_PACK")?new vo(e.shape,bl):new me(e.shape,hl),this.compileAndRun(t,[e])},n.prototype.prelu=function(e,t){var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn(Oc,e.shape,t.shape):new Xe(Mc,e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.elu=function(e){if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,xl,e.dtype);var t=new me(e.shape,fl);return this.compileAndRun(t,[e])},n.prototype.eluDer=function(e,t){var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",e.shape,t.shape):new Xe("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.selu=function(e){var t=new me(e.shape,Vp);return this.compileAndRun(t,[e])},n.prototype.int=function(e){var t=new me(e.shape,"return float(int(x));");return this.compileAndRun(t,[e],"int32")},n.prototype.clip=function(e,t,o){var a,i=(a=O().getBool("WEBGL_PACK_CLIP")?new Ld(e.shape):new Bd(e.shape)).getCustomSetupFunc(t,o);return this.compileAndRun(a,[e],null,i)},n.prototype.abs=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.abs(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,cl,e.dtype);var t=new me(e.shape,cl);return this.compileAndRun(t,[e])},n.prototype.complexAbs=function(e){var t=this.texData.get(e.dataId),o=new Wd(e.shape),a=[this.makeComplexComponentTensorInfo(e,t.complexTensors.real),this.makeComplexComponentTensorInfo(e,t.complexTensors.imag)];return this.compileAndRun(o,a)},n.prototype.sigmoid=function(e){var t=new me(e.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(t,[e])},n.prototype.softplus=function(e){var t=new me(e.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(t,[e])},n.prototype.sin=function(e){var t=new me(e.shape,Gp);return this.compileAndRun(t,[e])},n.prototype.cos=function(e){var t=new me(e.shape,zp);return this.compileAndRun(t,[e])},n.prototype.tan=function(e){var t=new me(e.shape,"return tan(x);");return this.compileAndRun(t,[e])},n.prototype.asin=function(e){var t=new me(e.shape,jp);return this.compileAndRun(t,[e])},n.prototype.acos=function(e){var t=new me(e.shape,Hp);return this.compileAndRun(t,[e])},n.prototype.atan=function(e){var t=new me(e.shape,qp);return this.compileAndRun(t,[e])},n.prototype.atan2=function(e,t){var o=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Xe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",e.shape,t.shape);return this.compileAndRun(o,[e,t])},n.prototype.sinh=function(e){var t=new me(e.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(t,[e])},n.prototype.cosh=function(e){var t=new me(e.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(t,[e])},n.prototype.tanh=function(e){var t=new me(e.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(t,[e])},n.prototype.asinh=function(e){var t=new me(e.shape,Xp);return this.compileAndRun(t,[e])},n.prototype.acosh=function(e){var t=new me(e.shape,Kp);return this.compileAndRun(t,[e])},n.prototype.atanh=function(e){var t=new me(e.shape,Yp);return this.compileAndRun(t,[e])},n.prototype.erf=function(e){var t=new me(e.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(t,[e])},n.prototype.step=function(e,t){var a,o=new me(e.shape,(void 0===(a=t)&&(a=0),Yt+"\n    return x > 0.0 ? 1.0 : float("+a+");\n  "));return this.compileAndRun(o,[e])},n.prototype.conv2dByMatMul=function(e,t,o,a,i,s){var u=e.shape,c=this.texData.get(e.dataId),d="channelsLast"===o.dataFormat,g=u[2]%2!=0&&!!c.isPacked;if((1==u[0]*u[1]*u[2]||1===o.outChannels)&&o.inChannels>1e3||!O().getBool("WEBGL_LAZILY_UNPACK")||!O().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!g){var y=this.reshape(e,[1,d?u[0]*u[1]*u[2]:u[0]*u[2]*u[3],o.inChannels]),x=this.reshape(t,[1,o.inChannels,o.outChannels]);return this.reshape(this.fusedBatchMatMul({a:y,b:x,transposeA:!1,transposeB:!1,bias:a,activation:i,preluActivationWeights:s}),o.outShape)}var b={dataId:e.dataId,shape:[1,d?u[0]*u[1]*(u[2]+1):u[0]*u[2]*(u[3]+1),o.inChannels],dtype:e.dtype},_=c.shape;c.shape=c.shape.slice(),c.shape[c.shape.length-2]++,R(so(c.shape,b.shape),function(){return"packed reshape "+c.shape+" to "+b.shape+" isn't free"});var E=this.reshape(t,[1,o.inChannels,o.outChannels]),F=this.fusedBatchMatMul({a:b,b:E,transposeA:!1,transposeB:!1,bias:a,activation:i,preluActivationWeights:s}),I=this.texData.get(F.dataId);return R(I.isPacked,function(){return"batchMatMul result is expected to be packed"}),c.shape=_,I.shape=o.outShape,A.makeTensorFromDataId(F.dataId,o.outShape,F.dtype)},n.prototype.conv2dWithIm2Row=function(e,t,o,a,i,s){var h=o.outWidth,f=o.outHeight,d="channelsLast"===o.dataFormat,p=o.filterWidth*o.filterHeight*o.inChannels,g=f*h,m=[p,g],y=e.squeeze([0]),x=t.reshape([1,p,-1]),w=new hp(m,y.shape,o),b=this.compileAndRun(w,[y]).reshape([1,m[0],m[1]]),_=null!=a,E=null!=s,F=i?aa(i,!0):null,I=new Li(b.shape,[1,g,o.outChannels],!0,!1,_,F,E),S=[b,x];return a&&S.push(a),E&&S.push(s),this.compileAndRun(I,S).reshape(d?[1,f,h,o.outChannels]:[1,o.outChannels,f,h])},n.prototype.fusedConv2d=function(e){var t=e.input,o=e.filter,a=e.convInfo,i=e.bias,s=e.activation,u=e.preluActivationWeights;if(1===a.filterHeight&&1===a.filterWidth&&1===a.dilationHeight&&1===a.dilationWidth&&1===a.strideHeight&&1===a.strideWidth&&("SAME"===a.padInfo.type||"VALID"===a.padInfo.type))return this.conv2dByMatMul(t,o,a,i,s,u);if(O().getBool("WEBGL_CONV_IM2COL")&&1===t.shape[0])return this.conv2dWithIm2Row(t,o,a,i,s,u);var c=null!=i,l=null!=u,h=s?aa(s,!1):null,f=new Bc(a,c,h,l),d=[t,o];return i&&d.push(i),u&&d.push(u),this.compileAndRun(f,d)},n.prototype.conv2d=function(e,t,o){if(1===o.filterHeight&&1===o.filterWidth&&1===o.dilationHeight&&1===o.dilationWidth&&1===o.strideHeight&&1===o.strideWidth&&("SAME"===o.padInfo.type||"VALID"===o.padInfo.type))return this.conv2dByMatMul(e,t,o);if(O().getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,t,o);var a=new Bc(o);return this.compileAndRun(a,[e,t])},n.prototype.conv2dDerInput=function(e,t,o){var a=new zd(o);return this.compileAndRun(a,[e,t])},n.prototype.conv2dDerFilter=function(e,t,o){var a=new Gd(o);return this.compileAndRun(a,[e,t])},n.prototype.fusedDepthwiseConv2D=function(e){var t,o=e.input,a=e.filter,i=e.convInfo,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=O().getBool("WEBGL_PACK_DEPTHWISECONV")&&i.strideWidth<=2&&i.outChannels/i.inChannels==1,h=u?aa(u,l):null,f=[o,a],d=null!=s,p=null!=c;return d&&f.push(s),p&&f.push(c),l?(t=new Wc(i,d,h,p),this.compileAndRun(t,f)):(t=new Lc(i,d,h,p),this.compileAndRun(t,f))},n.prototype.depthwiseConv2D=function(e,t,o){var a;return O().getBool("WEBGL_PACK_DEPTHWISECONV")&&o.strideWidth<=2&&o.outChannels/o.inChannels==1?(a=new Wc(o),this.compileAndRun(a,[e,t])):(a=new Lc(o),this.compileAndRun(a,[e,t]))},n.prototype.depthwiseConv2DDerInput=function(e,t,o){var a=new Xd(o);return this.compileAndRun(a,[e,t])},n.prototype.depthwiseConv2DDerFilter=function(e,t,o){var a=new qd(o);return this.compileAndRun(a,[e,t])},n.prototype.conv3d=function(e,t,o){var a=new Kd(o);return this.compileAndRun(a,[e,t])},n.prototype.conv3dDerInput=function(e,t,o){var a=new Hd(o);return this.compileAndRun(a,[e,t])},n.prototype.conv3dDerFilter=function(e,t,o){var a=new jd(o);return this.compileAndRun(a,[e,t])},n.prototype.maxPool=function(e,t){var o=new Wi(t,"max",!1);return this.compileAndRun(o,[e])},n.prototype.avgPool=function(e,t){var o=new Wi(t,"avg",!1);return this.compileAndRun(o,[e],"float32")},n.prototype.maxPoolBackprop=function(e,t,o,a){var i=new Wi(a,"max",!0),s=this.compileAndRun(i,[t]),u=new vp(a),c=this.compileAndRun(u,[e,s],t.dtype);return s.dispose(),c},n.prototype.avgPoolBackprop=function(e,t,o){var a=new Dd(o);return this.compileAndRun(a,[e],t.dtype)},n.prototype.cast=function(e,t){return Fi(e,t,this)},n.prototype.unstack=function(e,t){for(var o=e.shape[t],a=new Array(e.rank-1),i=0,s=0;s<e.rank;s++)s!==t&&(a[i++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[t]=1;var l=new Array(o);for(s=0;s<l.length;s++)u[t]=s,l[s]=this.slice(e,u,c).reshape(a);return l},n.prototype.avgPool3d=function(e,t){var o=new Ui(t,"avg",!1);return this.compileAndRun(o,[e],"float32")},n.prototype.avgPool3dBackprop=function(e,t,o){var a=new Td(o);return this.compileAndRun(a,[e],t.dtype)},n.prototype.maxPool3d=function(e,t){var o=new Ui(t,"max",!1);return this.compileAndRun(o,[e],"float32")},n.prototype.maxPool3dBackprop=function(e,t,o,a){var i=new Ui(a,"max",!0),s=this.compileAndRun(i,[t]),u=new mp(a),c=this.compileAndRun(u,[e,s],t.dtype);return s.dispose(),c},n.prototype.reshape=function(e,t){var o=this.texData.get(e.dataId);if(o.isPacked&&!so(e.shape,t)&&(null===o.texture||!so(o.shape,t))){var a=this.packedReshape(e,t);return A.makeTensorFromDataId(a.dataId,a.shape,a.dtype)}return ta(e,t)},n.prototype.resizeBilinear=function(e,t,o,a){var i=O().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new Sp(e.shape,t,o,a):new Rp(e.shape,t,o,a);return this.compileAndRun(i,[e],"float32")},n.prototype.resizeBilinearBackprop=function(e,t,o){var a=new Ep(e,t,o);return this.compileAndRun(a,[e])},n.prototype.resizeNearestNeighbor=function(e,t,o,a){var i=new Ip(e.shape,t,o,a);return this.compileAndRun(i,[e])},n.prototype.resizeNearestNeighborBackprop=function(e,t,o){var a=new kp(e,t,o);return this.compileAndRun(a,[e])},n.prototype.multinomial=function(e,t,o,a){var i=t?e:bn(e),c=new gp(i.shape[0],i.shape[1],o),l=c.getCustomSetupFunc(a);return this.compileAndRun(c,[i],"int32",l)},n.prototype.oneHot=function(e,t,o,a){var i=new yp(e.size,t,o,a);return this.compileAndRun(i,[e])},n.prototype.diag=function(e){var t=new ep(e.size);return this.compileAndRun(t,[e])},n.prototype.nonMaxSuppression=function(e,t,o,a,i){return Go("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),Ti(e.dataSync(),t.dataSync(),o,a,i)},n.prototype.cropAndResize=function(e,t,o,a,i,s){var u=new Yd(e.shape,t.shape,a,i,s);return this.compileAndRun(u,[e,t,o],"float32")},n.prototype.depthToSpace=function(e,t,o){R(t>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+t});var a=e.shape[0],c=("NHWC"===o?e.shape[1]:e.shape[2])*t,l=("NHWC"===o?e.shape[2]:e.shape[3])*t,h=("NHWC"===o?e.shape[3]:e.shape[1])/(t*t),f=new Zd("NHWC"===o?[a,c,l,h]:[a,h,c,l],t,o);return this.compileAndRun(f,[e])},n.prototype.split=function(e,t,o){return kc(e,t,o)},n.prototype.scatterND=function(e,t,o){var a=co(0,e,o),i=a.sliceRank,s=a.numUpdates,u=a.sliceSize,c=a.strides,l=a.outputSize,h=[l/u,u],f=e.reshape([s,i]),d=t.reshape([s,u]);if(0===l)return ta(pt([]),o);var p=$(0),g=new il(s,i,f.rank,d.rank,c,h);return this.compileAndRun(g,[d,f,p]).reshape(o)},n.prototype.sparseToDense=function(e,t,o,a){var i=co(0,e,o),h=new il(i.numUpdates,i.sliceRank,e.rank,t.rank,i.strides,[i.outputSize,1],!1);return this.compileAndRun(h,[t,e,a]).reshape(o)},n.prototype.fft=function(e){return this.fftImpl(e,!1)},n.prototype.ifft=function(e){return this.fftImpl(e,!0)},n.prototype.fftImpl=function(e,t){var o=this.texData.get(e.dataId),a=new Vc("return real * expR - imag * expI;",e.shape,t),i=new Vc("return real * expI + imag * expR;",e.shape,t),s=[this.makeComplexComponentTensorInfo(e,o.complexTensors.real),this.makeComplexComponentTensorInfo(e,o.complexTensors.imag)],u=this.compileAndRun(a,s),c=this.compileAndRun(i,s),l=this.complex(u,c).as2D(e.shape[0],e.shape[1]);return u.dispose(),c.dispose(),l},n.prototype.gatherND=function(e,t){var o=t.shape,a=o[o.length-1],i=_i(e,t),s=i[0],u=i[1],c=i[2],l=i[3],h=t.reshape([u,a]),f=e.reshape([e.size/c,c]),d=new cp(a,l,[u,c]);return this.compileAndRun(d,[f,h]).reshape(s)},n.prototype.fill=function(e,t,o){if("string"===(o=o||Er(t))){var a=Kr(o,re(e));return a.fill(t),A.makeTensor(a,e,o,this)}var i=new sp(e,t),s=i.getCustomSetupFunc(t);return this.compileAndRun(i,[],o,s)},n.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(e.shape,1,e.dtype)},n.prototype.zerosLike=function(e){return this.fill(e.shape,"string"===e.dtype?"":0,e.dtype)},n.prototype.linspace=function(e,t,o){return Ai(e,t,o)},n.prototype.makeTensorInfo=function(e,t){var o=this.write(null,e,t);return this.texData.get(o).usage=null,{dataId:o,shape:e,dtype:t}},n.prototype.makeOutput=function(e,t){var o=this.makeTensorInfo(e,t).dataId;return A.makeTensorFromDataId(o,e,t,this)},n.prototype.unpackTensor=function(e){var t=new Jp(e.shape);return this.runWebGLProgram(t,[e],e.dtype)},n.prototype.packTensor=function(e){var t=new bp(e.shape);return this.runWebGLProgram(t,[e],e.dtype,null,!0)},n.prototype.packedReshape=function(e,t){var o=[ao(e.shape)].concat(io(e.shape)),a={dtype:e.dtype,shape:o,dataId:e.dataId},i=[ao(t)].concat(io(t)),s=new Cp(i,o),u=this.runWebGLProgram(s,[a],e.dtype,null,!0);return{dataId:u.dataId,shape:t,dtype:u.dtype}},n.prototype.decode=function(e){var t,o=this.texData.get(e),a=o.isPacked,i=o.shape,s=o.dtype,u=Uo(i);return t=a?new Qd(u):new Jd(u),{dtype:s,shape:i,dataId:this.runWebGLProgram(t,[{shape:u,dtype:s,dataId:e}],s,null,!0).dataId}},n.prototype.runWebGLProgram=function(e,t,o,a,i){var s=this;void 0===i&&(i=!1);var u=this.makeTensorInfo(e.outputShape,o),c=this.texData.get(u.dataId);if(e.packedOutput&&(c.isPacked=!0),e.outPackingScheme===eo.DENSE){var l=to(e.outputShape);c.texShape=l.map(function(w){return 2*w})}if(null!=e.outTexUsage&&(c.usage=e.outTexUsage),0===re(u.shape))return c.values=Cr(u.dtype,0),u;var h=[],f=t.map(function(w){if("complex64"===w.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var b=s.texData.get(w.dataId);if(null==b.texture){if(!e.packedInputs&&re(w.shape)<=O().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:w.shape,texData:null,isUniform:!0,uniformValues:b.values};e.packedInputs&&(b.isPacked=!0,b.shape=w.shape)}else if(!!b.isPacked!=!!e.packedInputs)w=b.isPacked?s.unpackTensor(w):s.packTensor(w),h.push(w),b=s.texData.get(w.dataId);else if(b.isPacked&&!so(b.shape,w.shape)){var _=w,E=w.shape;w.shape=b.shape,w=s.packedReshape(w,E),h.push(w),b=s.texData.get(w.dataId),_.shape=E}return s.uploadToGPU(w.dataId),{shape:w.shape,texData:b,isUniform:!1}});this.uploadToGPU(u.dataId);var d,w,E,p={shape:u.shape,texData:c,isUniform:!1},g=(w=e,E="",f.concat(p).forEach(function(S){E+=S.shape+"_"+(S.isUniform?"uniform":S.texData.texShape)+"_"+(null!=S.texData&&null!=S.texData.slice&&S.texData.slice.flatOffset>0)}),w.constructor.name+"_"+E+"_"+w.userCode),m=this.getAndSaveBinary(g,function(){return function(w,b,_,E){var F=b.userCode,I=_.map(function(U,q){var X={logicalShape:U.shape,texShape:U.isUniform?null:U.texData.texShape,isUniform:U.isUniform,isPacked:!U.isUniform&&U.texData.isPacked,flatOffset:null};return null!=U.texData&&null!=U.texData.slice&&U.texData.slice.flatOffset>0&&(X.flatOffset=U.texData.slice.flatOffset),{name:b.variableNames[q],shapeInfo:X}}),S=I.map(function(U){return U.shapeInfo}),k={logicalShape:E.shape,texShape:E.texData.texShape,isUniform:!1,isPacked:E.texData.isPacked,flatOffset:null},N=Rd(I,k,F,b.packedInputs),T=w.createProgram(N),W=null,B=w.getUniformLocation(T,"NAN",!1);1===O().getNumber("WEBGL_VERSION")&&(W=w.getUniformLocation(T,"INFINITY",!1));for(var L={},H=0;H<b.variableNames.length;H++){var G=b.variableNames[H];L[G]=w.getUniformLocation(T,G,!1),L["offset"+G]=w.getUniformLocation(T,"offset"+G,!1)}return{program:b,source:N,webGLProgram:T,uniformLocations:L,inShapeInfos:S,outShapeInfo:k,infLoc:W,nanLoc:B}}(s.gpgpu,e,f,p)}),y=null!=this.activeTimers;if(y&&(d=this.startTimer()),function(w,b,_,E,F){al(b.inShapeInfos,_),al([b.outShapeInfo],[E]);var I=E.texData.texture,S=E.texData.texShape;E.texData.isPacked?w.setOutputPackedMatrixTexture(I,S[0],S[1]):w.setOutputMatrixTexture(I,S[0],S[1]),w.setProgram(b.webGLProgram),1===O().getNumber("WEBGL_VERSION")&&null!==b.infLoc&&w.gl.uniform1f(b.infLoc,1/0),null!==b.nanLoc&&w.gl.uniform1f(b.nanLoc,NaN),_.forEach(function(k,N){var T=b.program.variableNames[N],W=b.uniformLocations[T],B=b.uniformLocations["offset"+T];if(null!=W)if(k.isUniform)if(re(k.shape)<2)w.gl.uniform1f(W,k.uniformValues[0]);else{var L=k.uniformValues;L instanceof Float32Array||(L=new Float32Array(L)),w.gl.uniform1fv(W,L)}else null!=k.texData.slice&&null!=B&&w.gl.uniform1i(B,k.texData.slice.flatOffset),w.setInputMatrixTexture(k.texData.texture,W,N)}),null!=F&&F(w,b.webGLProgram),w.executeProgram()}(this.gpgpu,m,f,p,a),h.forEach(function(w){return s.disposeData(w.dataId)}),y&&(d=this.endTimer(d),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(d)})),!O().getBool("WEBGL_LAZILY_UNPACK")&&c.isPacked&&!1===i){var x=this.unpackTensor(u);return this.disposeData(u.dataId),x}return u},n.prototype.compileAndRun=function(e,t,o,a,i){void 0===i&&(i=!1);var s=this.runWebGLProgram(e,t,o=o||t[0].dtype,a,i);return A.makeTensorFromDataId(s.dataId,s.shape,s.dtype)},n.prototype.getAndSaveBinary=function(e,t){return e in this.binaryCache||(this.binaryCache[e]=t()),this.binaryCache[e]},n.prototype.getTextureManager=function(){return this.textureManager},n.prototype.dispose=function(){var e=this;this.disposed||(O().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(t){e.gpgpu.deleteProgram(e.binaryCache[t].webGLProgram),delete e.binaryCache[t]}),this.textureManager.dispose(),null!=this.canvas&&typeof HTMLCanvasElement<"u"&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},n.prototype.floatPrecision=function(){var e=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=Z(function(){if(!O().get("WEBGL_RENDER_FLOAT32_ENABLED")){var t=O().getBool("DEBUG");O().set("DEBUG",!1);var o=e.abs($(1e-8)).dataSync()[0];if(O().set("DEBUG",t),o>0)return 32}return 16})),this.floatPrecisionValue},n.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},n.prototype.uploadToGPU=function(e){var t,o=this.texData.get(e),a=o.shape,i=o.dtype,s=o.values,c=o.usage,l=o.isPacked;if(null==o.texture){var h,f=null!=this.activeTimers;f&&(h=Ht());var d=o.texShape;if(null==d&&(d=Qu(a,l),o.texShape=d),null!=s){var p=Uo(a),g=void 0,m=d[1],y=d[0],x=s instanceof Uint8Array;l?(m=(t=no(d[0],d[1]))[0],g=new op(p,[y=t[1],m],x)):g=new rp(p,[y,m],x);var w=this.makeTensorInfo([y,m],i);this.texData.get(w.dataId).usage=x?At.PIXELS:At.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(w.dataId),m,y,s);var b=this.runWebGLProgram(g,[w],i,null,!0),_=this.texData.get(b.dataId);o.texture=_.texture,o.texShape=_.texShape,o.isPacked=_.isPacked,o.usage=_.usage,this.disposeData(w.dataId),this.texData.delete(b.dataId),o.values=null,f&&(this.uploadWaitMs+=Ht()-h)}else{var E=this.acquireTexture(d,c,i,l);o.texture=E}}},n.prototype.convertAndCacheOnCPU=function(e,t){var o=this.texData.get(e),a=o.dtype;return this.releaseGPUData(e),null!=t&&(o.values=function(i,s){if("float32"===s||"complex64"===s)return i;if("int32"===s||"bool"===s){for(var u="int32"===s?new Int32Array(i.length):new Uint8Array(i.length),c=0;c<u.length;++c)u[c]=Math.round(i[c]);return u}throw new Error("Unknown dtype "+s)}(t,a)),o.values},n.prototype.acquireTexture=function(e,t,o,a){if(this.numBytesInGPU+=this.computeBytes(e,o),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var i=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+i+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(e,t,a)},n.prototype.computeBytes=function(e,t){return e[0]*e[1]*Ja(t)},n}(Cc);Nu()&&A.registerBackend("webgl",function(){return new wl},2);var Zp=D({square_:function(r){var n=C(r,"x","square");return A.runKernelFunc(function(t,o){return o([n]),t.square(n)},{x:n},null,"Square",{},[n],[])}}),mo="SquaredDifference",_l=D({squaredDifference_:function(r,n){var e,t=C(r,"a","squaredDifference"),o=C(n,"b","squaredDifference");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(s,u){var c=s.squaredDifference(t,o);return u([t,o]),c},{a:t,b:o},function(s,u){var c=u[0],l=u[1],h=$(2);return{a:function(){return s.mul(c.sub(l).mul(h))},b:function(){return s.mul(l.sub(c).mul(h))}}},mo,{},[t,o],[])}}),ev=D({abs_:function(r){var n=C(r,"x","abs");return"complex64"===n.dtype?A.runKernelFunc(function(e){return e.complexAbs(n)},{$x:n}):A.runKernelFunc(function(e,t){var o=e.abs(n);return t([n]),o},{x:n},function(e,t){var o=t[0];return{x:function(){return e.mul(o.toFloat().step(-1))}}},"Abs")}}),tv=D({acos_:function(r){var n=C(r,"x","acos");return A.runKernelFunc(function(e,t){var o=e.acos(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.divStrict($(1).sub(o.toFloat().square()).sqrt()).neg()}}})}}),nv=D({acosh_:function(r){var n=C(r,"x","acosh");return A.runKernelFunc(function(e,t){var o=e.acosh(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.divStrict(o.toFloat().square().sub(1).sqrt())}}})}}),rv=D({asin_:function(r){var n=C(r,"x","asin");return A.runKernelFunc(function(e,t){var o=e.asin(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.divStrict($(1).sub(o.toFloat().square()).sqrt())}}})}}),ov=D({asinh_:function(r){var n=C(r,"x","asinh");return A.runKernelFunc(function(e,t){var o=e.asinh(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.divStrict($(1).add(o.toFloat().square()).sqrt())}}})}}),av=D({atan_:function(r){var n=C(r,"x","atan");return A.runKernelFunc(function(e,t){var o=e.atan(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div(o.toFloat().square().add(1))}}})}}),iv=D({atanh_:function(r){var n=C(r,"x","atanh");return A.runKernelFunc(function(e,t){var o=e.atanh(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div($(1).sub(o.toFloat().square()))}}})}}),sv=D({ceil_:function(r){var n=C(r,"x","ceil");return A.runKernelFunc(function(e){return e.ceil(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),ji=D({clipByValue_:function(r,n,e){var t=C(r,"x","clipByValue");return R(n<=e,function(){return"Error in clip: min ("+n+") must be less than or equal to max ("+e+")."}),A.runKernelFunc(function(i,s){var u=i.clip(t,n,e);return s([t]),u},{x:t},function(i,s){var u=s[0];return{x:function(){return i.where(u.greaterEqual(n).logicalAnd(u.lessEqual(e)),Se(i))}}},"ClipByValue",{min:n,max:e},[t])}}),uv=D({cos_:function(r){var n=C(r,"x","cos");return A.runKernelFunc(function(t,o){var a=t.cos(n);return o([n]),a},{x:n},function(t,o){var a=o[0];return{x:function(){return a.toFloat().sin().neg().mul(t)}}},"Cos",{},[n])}}),cv=D({cosh_:function(r){var n=C(r,"x","cosh");return A.runKernelFunc(function(e,t){var o=e.cosh(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return o.toFloat().sinh().mulStrict(e)}}})}}),lv=D({erf_:function(r){var n=C(r,"x","erf");return R("int32"===n.dtype||"float32"===n.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===n.dtype&&(n=n.toFloat()),A.runKernelFunc(function(e,t){var o=e.erf(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.mul(o.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),Hi=D({exp_:function(r){var n=C(r,"x","exp");return A.runKernelFunc(function(e,t){var o=e.exp(n);return t([o]),o},{x:n},function(e,t){return{x:function(){return e.mulStrict(t[0])}}},"Exp",{},[],[!0])}}),hv=D({expm1_:function(r){var n=C(r,"x","expm1");return A.runKernelFunc(function(e,t){var o=e.expm1(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.mul(o.exp())}}})}}),fv=D({floor_:function(r){var n=C(r,"x","floor");return A.runKernelFunc(function(e){return e.floor(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),dv=D({log_:function(r){var n=C(r,"x","log");return A.runKernelFunc(function(t,o){var a=t.log(n);return o([n]),a},{x:n},function(t,o){var a=o[0];return{x:function(){return t.div(a.toFloat())}}},"Log",{},[n])}}),pv=D({log1p_:function(r){var n=C(r,"x","log1p");return A.runKernelFunc(function(e,t){var o=e.log1p(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div(o.add(1))}}})}}),vv=D({logSigmoid_:function(r){var n=C(r,"x","logSigmoid");return A.runKernelFunc(function(e,t){var o=e.softplus(n.neg()).neg();return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.mul(o.neg().sigmoid())}}})}}),ia=D({neg_:function(r){var n=C(r,"x","neg");return A.runKernelFunc(function(t){return t.neg(n)},{x:n},function(t){return{x:function(){return t.neg()}}},"Neg",{},[n])}}),mv=D({reciprocal_:function(r){var n=C(r,"x","reciprocal");return A.runKernelFunc(function(e,t){var o=e.reciprocal(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div(o.square().neg())}}})}}),gv=D({round_:function(r){var n=C(r,"x","round");return A.runKernelFunc(function(e){return e.round(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),Cl=D({rsqrt_:function(r){var n=C(r,"x","rsqrt");return A.runKernelFunc(function(t,o){var a=t.rsqrt(n);return o([n]),a},{x:n},function(t,o){var a=o[0];return{x:function(){return t.div(a.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},[n])}}),El=D({sigmoid_:function(r){var n=C(r,"x","sigmoid");return A.runKernelFunc(function(e,t){var o=e.sigmoid(n);return t([o]),o},{x:n},function(e,t){var o=t[0];return{x:function(){return e.mul(o.mul($(1).sub(o)))}}},"Sigmoid")}}),yv=D({sign_:function(r){var n=C(r,"x","sign");return A.runKernelFunc(function(e){return e.sign(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),bv=D({isNaN_:function(r){var n=C(r,"x","isNaN");return A.runKernelFunc(function(e){return e.isNaN(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),xv=D({isInf_:function(r){var n=C(r,"x","isInf");return A.runKernelFunc(function(e){return e.isInf(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),wv=D({isFinite_:function(r){var n=C(r,"x","isFinite");return A.runKernelFunc(function(e){return e.isFinite(n)},{$x:n},function(e){return{$x:function(){return Se(e)}}})}}),_v=D({sin_:function(r){var n=C(r,"x","sin");return A.runKernelFunc(function(t,o){var a=t.sin(n);return o([n]),a},{x:n},function(t,o){var a=o[0];return{x:function(){return a.toFloat().cos().mul(t)}}},"Sin",{},[n])}}),Cv=D({sinh_:function(r){var n=C(r,"x","sinh");return A.runKernelFunc(function(e,t){var o=e.sinh(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return o.toFloat().cosh().mulStrict(e)}}})}}),Ev=D({softplus_:function(r){var n=C(r,"x","softplus");return A.runKernelFunc(function(e,t){var o=e.softplus(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.mul(o.sigmoid())}}})}}),Rv=D({sqrt_:function(r){var n=C(r,"x","sqrt");return A.runKernelFunc(function(e,t){var o=e.sqrt(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div(o.toFloat().sqrt().mul(2))}}})}}),Sv=D({step_:function(r,n){void 0===n&&(n=0);var e=C(r,"x","step");return A.runKernelFunc(function(t){return t.step(e,n)},{$x:e},function(t){return{$x:function(){return Se(t)}}})}}),kv=D({tan_:function(r){var n=C(r,"x","tan");return A.runKernelFunc(function(e,t){var o=e.tan(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return e.div(o.cos().square())}}})}}),Iv=D({tanh_:function(r){var n=C(r,"x","tanh");return A.runKernelFunc(function(e,t){var o=e.tanh(n);return t([o]),o},{x:n},function(e,t){var o=t[0];return{x:function(){return $(1).sub(o.square()).mulStrict(e)}}},"Tanh",{},null,[!0])}});function Rl(r,n,e,t,o,a){var i,s,u=C(r,"x","batchNorm"),c=C(n,"mean","batchNorm"),l=C(e,"variance","batchNorm");return null!=o&&(i=C(o,"scale","batchNorm")),null!=t&&(s=C(t,"offset","batchNorm")),R(2===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),R(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),R(2===l.rank||1===l.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+l.rank+"."}),null!=i&&R(2===i.rank||1===i.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+i.rank+"."}),null!=s&&R(2===s.rank||1===s.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),go(u,c,l,s,i,a)}function Sl(r,n,e,t,o,a){var i,s,u=C(r,"x","batchNorm"),c=C(n,"mean","batchNorm"),l=C(e,"variance","batchNorm");return null!=o&&(i=C(o,"scale","batchNorm")),null!=t&&(s=C(t,"offset","batchNorm")),R(3===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),R(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),R(3===l.rank||1===l.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+l.rank+"."}),null!=i&&R(3===i.rank||1===i.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+i.rank+"."}),null!=s&&R(3===s.rank||1===s.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),go(u,c,l,s,i,a)}function kl(r,n,e,t,o,a){var i,s,u=C(r,"x","batchNorm"),c=C(n,"mean","batchNorm"),l=C(e,"variance","batchNorm");return null!=o&&(i=C(o,"scale","batchNorm")),null!=t&&(s=C(t,"offset","batchNorm")),R(4===u.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),R(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),R(4===l.rank||1===l.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+l.rank+"."}),null!=i&&R(4===i.rank||1===i.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+i.rank+"."}),null!=s&&R(4===s.rank||1===s.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),go(u,c,l,s,i,a)}function go(r,n,e,t,o,a){null==a&&(a=.001);var i,s,u,c=C(r,"x","batchNorm"),l=C(n,"mean","batchNorm"),h=C(e,"variance","batchNorm");return null!=o&&(i=C(o,"scale","batchNorm")),null!=t&&(s=C(t,"offset","batchNorm")),R(l.rank===h.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),R(null==s||l.rank===s.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),R(null==i||l.rank===i.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),u=0===c.rank||1===c.rank?c.as4D(1,1,1,c.size):2===c.rank?c.as4D(1,1,c.shape[0],c.shape[1]):3===c.rank?c.as4D(1,c.shape[0],c.shape[1],c.shape[2]):c,A.runKernelFunc(function(d,p){var g=d.batchNormalization(u,sa(l),sa(h),a,sa(i),sa(s));return p([c,l,h,i]),g},{x:c,mean:l,variance:h,scale:i,offset:s},function(d,p){var m=p[0],y=p[1],x=p[2],w=p[3],b=null==w?$(1):w,_=et(y.shape,u.shape),E=[];if(1===y.rank){for(var F=0;F<u.shape.length-1;++F)E.push(u.shape[F]);E.push(1)}var I=m.sub(y),S=d.mul(b),k=Cl(x.add($(a))),N=k.mul(k).mul(k).mul($(-.5));return{x:function(){return 1===y.rank?d.mul(Ir(k.as4D(1,1,1,y.shape[0]),E)).mul(b).reshape(m.shape):d.mul(k).mul(b).reshape(m.shape)},mean:function(){var T=k.mul($(-1)).mul(S);return 1===y.rank&&(T=T.sum(_)),T.reshape(y.shape)},variance:function(){var T=N.mul(I).mul(S);return 1===y.rank&&(T=T.sum(_)),T.reshape(y.shape)},scale:function(){var T=I.mul(k),W=d.mul(T);return 1===y.rank&&(W=W.sum(_)),W.reshape(y.shape)},offset:function(){var T=d;return 1===y.rank&&(T=T.sum(_)),T.reshape(y.shape)}}},"BatchNormalization",{varianceEpsilon:a},[c,l,h,i]).reshape(c.shape)}function sa(r){return null==r?null:0===r.rank?r.as1D():1===r.rank?r:2===r.rank?r.as4D(1,1,r.shape[0],r.shape[1]):3===r.rank?r.as4D(1,r.shape[0],r.shape[1],r.shape[2]):r}function ua(){ac("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var Fv=D({batchNormalization2d_:function(r,n,e,t,o,a){return void 0===t&&(t=.001),ua(),Rl(r,n,e,a,o,t)}}),Av=D({batchNormalization3d_:function(r,n,e,t,o,a){return void 0===t&&(t=.001),ua(),Sl(r,n,e,a,o,t)}}),Dv=D({batchNormalization4d_:function(r,n,e,t,o,a){return void 0===t&&(t=.001),ua(),kl(r,n,e,a,o,t)}}),Tv=D({batchNormalization_:function(r,n,e,t,o,a){return void 0===t&&(t=.001),ua(),go(r,n,e,a,o,t)}}),Il=D({batchNorm_:go}),Nv=D({batchNorm2d_:Rl}),Pv=D({batchNorm3d_:Sl}),Mv=D({batchNorm4d_:kl}),ca=D({logicalAnd_:function(r,n){var e=C(r,"a","logicalAnd","bool"),t=C(n,"b","logicalAnd","bool");return xe(e.shape,t.shape),A.runKernelFunc(function(o){return o.logicalAnd(e,t)},{a:e,b:t},null,"LogicalAnd")}}),Ov=D({logicalNot_:function(r){var n=C(r,"x","logicalNot","bool");return A.runKernelFunc(function(e){return e.logicalNot(n)},{$x:n})}}),Fl=D({logicalOr_:function(r,n){var e=C(r,"a","logicalOr","bool"),t=C(n,"b","logicalOr","bool");return xe(e.shape,t.shape),A.runKernelFunc(function(o){return o.logicalOr(e,t)},{$a:e,$b:t})}}),Bv=D({logicalXor_:function(r,n){var e=C(r,"a","logicalXor","bool"),t=C(n,"b","logicalXor","bool");return xe(e.shape,t.shape),Fl(r,n).logicalAnd(ca(r,n).logicalNot())}}),hr=D({where_:function(r,n,e){var t=C(n,"a","where"),o=C(e,"b","where"),a=C(r,"condition","where","bool");return Re(t.shape,o.shape,"Error in where: "),1===a.rank?R(a.shape[0]===t.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):Re(a.shape,o.shape,"Error in where: "),A.runKernelFunc(function(i,s){var u=i.select(a,t,o);return s([a]),u},{$condition:a,$a:t,$b:o},function(i,s){var u=s[0];return{$condition:function(){return Se(u).toFloat()},$a:function(){return i.mul(u.cast(i.dtype))},$b:function(){return i.mul(u.logicalNot().cast(i.dtype))}}})}}),Al=function(r){return Q(this,void 0,void 0,function(){var n,e,t;return ee(this,function(o){switch(o.label){case 0:return[4,(n=C(r,"condition","whereAsync","bool")).data()];case 1:return e=o.sent(),t=Pi(n.shape,e),r!==n&&n.dispose(),[2,t]}})})},we=D({add_:function(r,n){var e,t=C(r,"a","add"),o=C(n,"b","add");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i){return i.add(t,o)},{a:t,b:o},function(i){return{a:function(){var s=i,u=et(t.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(t.shape)},b:function(){var s=i,u=et(o.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(o.shape)}}},"Add")}}),Lv=D({addN_:function(r){R(Array.isArray(r),function(){return"The argument passed to tf.addN() must be a list of tensors"}),R(r.length>=1,function(){return"Must pass at least one tensor to tf.addN(), but got "+r.length});var n=r.map(function(o,a){return C(o,"tensors"+a,"addN")}),e=n[0];return n.forEach(function(o){if(o.dtype!==e.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),n.forEach(function(o){if(!Je(o.shape,e.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")}),A.runKernelFunc(function(o){return o.addN(n)},n,function(o){var a={};return n.forEach(function(i,s){a[s]=function(){return o.clone()}}),a},"AddN")}}),Wv=D({addStrict_:function(r,n){var e=C(r,"a","addStrict"),t=C(n,"b","addStrict");return Re(e.shape,t.shape,"Error in addStrict: "),e.add(t)}}),Uv=D({atan2_:function(r,n){var e,t=C(r,"a","atan2"),o=C(n,"b","atan2");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i,s){var u=i.atan2(t,o);return s([t,o]),u},{$a:t,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=we(u.square(),c.square()),h=i.mul(c.div(l)),f=et(u.shape,a);return f.length>0&&(h=h.sum(f)),h.reshape(u.shape)},$b:function(){var l=we(u.square(),c.square()),h=ia(i.mul(u.div(l))),f=et(c.shape,a);return f.length>0&&(h=h.sum(f)),h.reshape(c.shape)}}})}}),$t=D({div_:function(r,n){var e,t=C(r,"a","div"),o=C(n,"b","div");if(e=Ue(t,o),o=e[1],"int32"===(t=e[0]).dtype&&"int32"===o.dtype)return Dl(t,o);var a=xe(t.shape,o.shape);return A.runKernelFunc(function(i,s){var u=i.realDivide(t,o);return s([t,o]),u},{a:t,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=et(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=et(c.shape,a);h.length>0&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"Div")}}),Vv=D({divNoNan_:function(r,n){var e,t=C(r,"a","div"),o=C(n,"b","div");t=(e=Ue(t,o))[0];var a=$t(t,o=e[1]),i=Se(a),s=o.equal(i);return hr(s,i,a)}}),Gv=D({divStrict_:function(r,n){var e=C(r,"a","div"),t=C(n,"b","div");return Re(e.shape,t.shape,"Error in divideStrict: "),e.div(t)}}),Dl=D({floorDiv_:function(r,n){var e,t=C(r,"a","floorDiv"),o=C(n,"b","floorDiv");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i,s){var u=i.floorDiv(t,o);return s([t,o]),u},{a:t,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=et(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=et(c.shape,a);h.length>0&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"FloorDiv")}}),qi=D({maximum_:function(r,n){var e,t=C(r,"a","maximum"),o=C(n,"b","maximum");return e=Ue(t,o),o=e[1],"bool"===(t=e[0]).dtype&&(t=t.toInt(),o=o.toInt()),xe(t.shape,o.shape),A.runKernelFunc(function(a,i){var s=a.maximum(t,o);return i([t,o]),s},{a:t,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.greaterEqual(u).toFloat())},b:function(){return a.mul(s.less(u).toFloat())}}},"Maximum")}}),zv=D({maximumStrict_:function(r,n){var e=C(r,"a","maximumStrict"),t=C(n,"b","maximumStrict");return Re(e.shape,t.shape,"Error in maximumStrict: "),e.maximum(t)}}),Tl=D({minimum_:function(r,n){var e,t=C(r,"a","minimum"),o=C(n,"b","minimum");return e=Ue(t,o),o=e[1],"bool"===(t=e[0]).dtype&&(t=t.toInt(),o=o.toInt()),xe(t.shape,o.shape),A.runKernelFunc(function(a,i){var s=a.minimum(t,o);return i([t,o]),s},{a:t,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.lessEqual(u).toFloat())},b:function(){return a.mul(s.greater(u).toFloat())}}},"Minimum")}}),jv=D({minimumStrict_:function(r,n){var e=C(r,"a","minimumStrict"),t=C(n,"b","minimumStrict");return Re(e.shape,t.shape,"Error in minimumStrict: "),e.minimum(t)}}),Hv=D({mod_:function(r,n){var e,t=C(r,"a","mod"),o=C(n,"b","mod");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i,s){var u=i.mod(t,o);return s([t,o]),u},{$a:t,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=et(u.shape,a);return l.length>0?i.sum(l).reshape(u.shape):i},$b:function(){var l=i.mul(u.div(c).floor().neg()),h=et(c.shape,a);return h.length>0?l.sum(h).reshape(c.shape):l}}})}}),qv=D({modStrict_:function(r,n){var e=C(r,"a","modStrict"),t=C(n,"b","modStrict");return Re(e.shape,t.shape,"Error in modStrict: "),e.mod(t)}}),yt=D({mul_:function(r,n){var e,t=C(r,"a","mul"),o=C(n,"b","mul");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i,s){var u=i.multiply(t,o);return s([t,o]),u},{a:t,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.mul(c.toFloat()),h=et(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=et(c.shape,a);return h.length>0?l.sum(h).reshape(c.shape):l}}},"Mul")}}),Xv=D({mulStrict_:function(r,n){var e=C(r,"a","mul"),t=C(n,"b","mul");return Re(e.shape,t.shape,"Error in multiplyStrict: "),e.mul(t)}}),la=D({pow_:function(r,n){var e,t=C(r,"base","pow"),o=C(n,"exp","pow");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(s,u){var c=s.pow(t,o);return u([t,o,c]),c},{a:t,b:o},function(s,u){var c=u[0],l=u[1],h=u[2];return{a:function(){var f=l.toFloat(),d=s.mul(f.mul(c.pow(f.sub($(1))))),p=et(c.shape,a);return p.length>0&&(d=d.sum(p)),d.reshape(c.shape)},b:function(){var f=c.greater(0),d=c.log().where(f,Se(c)),p=s.mul(h.mul(d)),g=et(l.shape,a);return g.length>0&&(p=p.sum(g)),p.reshape(l.shape)}}},"Pow",{},[t,o],[!0])}}),Kv=D({powStrict_:function(r,n){return Re(r.shape,n.shape,"Error in powStrict: "),r.pow(n)}}),Yv=D({squaredDifferenceStrict_:function(r,n){var e=C(r,"a","squaredDifferenceStrict"),t=C(n,"b","squaredDifferenceStrict");return Re(e.shape,t.shape,"Error in squaredDifferenceStrict: "),e.squaredDifference(t)}}),ot=D({sub_:function(r,n){var e,t=C(r,"a","sub"),o=C(n,"b","sub");e=Ue(t,o);var a=xe((t=e[0]).shape,(o=e[1]).shape);return A.runKernelFunc(function(i){return i.subtract(t,o)},{a:t,b:o},function(i){return{a:function(){var s=i,u=et(t.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(t.shape)},b:function(){var s=i,u=et(o.shape,a);return u.length>0&&(s=s.sum(u)),s.neg().reshape(o.shape)}}},"Sub")}}),$v=D({subStrict_:function(r,n){var e=C(r,"a","subStrict"),t=C(n,"b","subStrict");return Re(e.shape,t.shape,"Error in subStrict: "),e.sub(t)}}),Nl=D({equal_:function(r,n){var e,t=C(r,"a","equal"),o=C(n,"b","equal");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a){return a.equal(t,o)},{$a:t,$b:o})}}),Jv=D({equalStrict_:function(r,n){var e=C(r,"a","equalStrict"),t=C(n,"b","equalStrict");return Re(e.shape,t.shape,"Error in equalStrict: "),e.equal(t)}}),Qv=D({greater_:function(r,n){var e,t=C(r,"a","greater"),o=C(n,"b","greater");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a){return a.greater(t,o)},{a:t,b:o},null,"Greater")}}),Pl=D({greaterEqual_:function(r,n){var e,t=C(r,"a","greaterEqual"),o=C(n,"b","greaterEqual");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a,i){var s=a.greaterEqual(t,o);return i([t,o]),s},{a:t,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return Se(s)},b:function(){return Se(u)}}},"GreaterEqual")}}),Zv=D({greaterEqualStrict_:function(r,n){var e=C(r,"a","greaterEqualStrict"),t=C(n,"b","greaterEqualStrict");return Re(e.shape,t.shape,"Error in greaterEqualStrict: "),e.greaterEqual(t)}}),em=D({greaterStrict_:function(r,n){var e=C(r,"a","greaterStrict"),t=C(n,"b","greaterStrict");return Re(e.shape,t.shape,"Error in greaterStrict: "),e.greater(t)}}),tm=D({less_:function(r,n){var e,t=C(r,"a","less"),o=C(n,"b","less");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a){return a.less(t,o)},{a:t,b:o},null,"Less")}}),nm=D({lessEqual_:function(r,n){var e,t=C(r,"a","lessEqual"),o=C(n,"b","lessEqual");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a,i){var s=a.lessEqual(t,o);return i([t,o]),s},{a:t,b:o},null,"LessEqual")}}),rm=D({lessEqualStrict_:function(r,n){var e=C(r,"a","lessEqualStrict"),t=C(n,"b","lessEqualStrict");return Re(e.shape,t.shape,"Error in lessEqualStrict: "),e.lessEqual(t)}}),om=D({lessStrict_:function(r,n){var e=C(r,"a","lessStrict"),t=C(n,"b","lessStrict");return Re(e.shape,t.shape,"Error in lessStrict: "),e.less(t)}}),am=D({notEqual_:function(r,n){var e,t=C(r,"a","notEqual"),o=C(n,"b","notEqual");return e=Ue(t,o),xe((t=e[0]).shape,(o=e[1]).shape),A.runKernelFunc(function(a){return a.notEqual(t,o)},{a:t,b:o},null,"NotEqual")}}),im=D({notEqualStrict_:function(r,n){var e=C(r,"a","notEqualStrict"),t=C(n,"b","notEqualStrict");return Re(e.shape,t.shape,"Error in notEqualStrict: "),e.notEqual(t)}});function Ml(r,n){for(var e=[],t=r;t<n;++t)e.push(t);return e}function Ol(r){for(var n=[],e=0;e<r.length;++e)for(var t=0;t<r[e].length;++t)n.push(r[e][t]);return n}var Xi=D({gather_:function(r,n,e){void 0===e&&(e=0);var t=C(r,"x","gather"),o=C(n,"indices","gather","int32");e=Qe(e,t.shape)[0];var a=function(i,s,u){for(var c=i.shape[u],l=[],h=1,f=1,d=0;d<u;d++)l.push(i.shape[d]),h*=i.shape[d];for(d=0;d<s.rank;d++)l.push(s.shape[d]);for(d=u+1;d<i.rank;d++)l.push(i.shape[d]),f*=i.shape[d];return{batchSize:h,sliceSize:f,dimSize:c,outputShape:l}}(t,o,e);return A.runKernelFunc(function(i,s){var u=i.gather(t,o.flatten(),e);return s([o]),u},{x:t,indices:o},function(i,s){var u=s[0];return{x:function(){var c=t.shape,l=u.size,h=c.slice(0,e),f=h.length,d=c.slice(e,c.length).slice(1),p=d.length,g=Ml(0,f),m=Ml(f+1,f+1+p),y=Ol([h,[l],d]),x=i.reshape(y),w=u.reshape([l]),b=Ol([[f],g,m]),_=x.transpose(b),E=Bl(_,w,t.shape[e]),F=zo(b);return E.transpose(F)},indices:function(){return u}}},"Gather",{axis:e}).reshape(a.outputShape)}}),Bl=D({unsortedSegmentSum_:function(r,n,e){var t=C(r,"x","unsortedSegmentSum"),o=C(n,"segmentIds","unsortedSegmentSum","int32");return R(Ve(e),function(){return"numSegments must be of dtype int"}),A.runKernelFunc(function(a,i){var s=a.unsortedSegmentSum(t,o,e);return i([o]),s},{$x:t},function(a,i){var s=i[0];return{$x:function(){return function(u,c){for(var l=qi(c,Se(c)),h=Xi(u,l),f=Pl(c,$(0,"int32")),d=h.rank-f.rank,p=0;p<d;++p)f=Lt(f,p+1);f=ca(f,kr(h.shape,"bool"));var g=Se(h);return hr(f,h,g)}(a,s)}}})}});function Ll(r,n,e,t,o,a,i){void 0===a&&(a="NHWC"),R(r.length===n.rank,function(){return"Length of inShape ("+r.length+") and rank of dy ("+n.rank+") must match"});var s=r,u=n,c=!1;3===n.rank&&(c=!0,u=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]),s=[1,r[0],r[1],r[2]]),R(4===s.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+s.length+"."}),R(4===u.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),R(4===e.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+e.rank});var l="NHWC"===a?s[3]:s[1],h="NHWC"===a?u.shape[3]:u.shape[1];R(l===e.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+e.shape[2]+"."}),R(h===e.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+h+") must match output depth for filter "+e.shape[3]+"."}),null!=i&&R(Ve(o),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var f=ea(a),d=zn(s,e.shape,t,1,o,i,!1,f),p=A.runKernelFunc(function(g,m){var y=g.conv2dDerInput(u,e,d);return m([e,u]),y},{dy4D:u,filter:e},function(g,m){var y=m[0],x=m[1];return{dy4D:function(){return Wt(g,y,t,o,a,1,i)},filter:function(){return Yi(g,x,y.shape,t,o,a,i)}}});return c?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p}function Ki(r){var a,n="number"==typeof(a=r)?[a,a,a]:2===a.length?[a[0],a[1],1]:a;return 1===n[0]&&1===n[1]&&1===n[2]}function Wl(r,n,e,t,o){R(r.length===n.rank,function(){return"Length of inShape ("+r.length+") and rank of dy ("+n.rank+") must match"});var a=r,i=n,s=!1;4===n.rank&&(s=!0,i=n.as5D(1,n.shape[0],n.shape[1],n.shape[2],n.shape[3]),a=[1,r[0],r[1],r[2],r[3]]);var u=a[4],c=i.shape[4];R(5===a.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+a.length+"."}),R(5===i.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+i.rank}),R(5===e.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+e.rank}),R(u===e.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+e.shape[3]+"."}),R(c===e.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+c+") must match output depth for filter "+e.shape[4]+"."});var l=ho(a,e.shape,t,1,o),h=A.runKernelFunc(function(f){return f.conv3dDerInput(i,e,l)},{dy5D:i});return s?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}var um=D({conv1d_:function(r,n,e,t,o,a,i){void 0===o&&(o="NWC"),void 0===a&&(a=1);var s=C(r,"x","conv1d"),u=C(n,"filter","conv1d"),c=s,l=!1;2===s.rank&&(l=!0,c=s.as3D(1,s.shape[0],s.shape[1])),R(3===c.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+c.rank+"."}),R(3===u.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),null!=i&&R(Ve(t),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+t+"."}),R(c.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+c.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),R(_t(e,a),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+e+" and dilation '"+a+"'"}),R("NWC"===o,function(){return"Error in conv1d: got dataFormat of "+o+" but only NWC is currently supported."});var h=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),f=c.as4D(c.shape[0],1,c.shape[1],c.shape[2]),d=Wt(f,h,[1,e],t,"NHWC",[1,a],i);return l?d.as2D(d.shape[2],d.shape[3]):d.as3D(d.shape[0],d.shape[2],d.shape[3])}}),Wt=D({conv2d_:function(r,n,e,t,o,a,i){void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]);var s=C(r,"x","conv2d"),u=C(n,"filter","conv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),R(4===c.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+c.rank+"."}),R(4===u.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+u.rank+"."}),null!=i&&R(Ve(t),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+t+"."});var h="NHWC"===o?c.shape[3]:c.shape[1];R(h===u.shape[2],function(){return"Error in conv2d: depth of input ("+h+") must match input depth for filter "+u.shape[2]+"."}),R(_t(e,a),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"});var f=ea(o),d=zn(c.shape,u.shape,e,a,t,i,!1,f),g=A.runKernelFunc(function(m,y){var x=m.conv2d(c,u,d);return y([u,c]),x},{x:c,filter:u},function(m,y){var w=y[0],b=y[1];return R(ur(a),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"}),{x:function(){return Ul(b.shape,m,w,e,t,o)},filter:function(){return Yi(b,m,w.shape,e,t,o)}}},"Conv2D",d,[u,c]);return l?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),cm=D({conv3d_:function(r,n,e,t,o,a){void 0===o&&(o="NDHWC"),void 0===a&&(a=[1,1,1]);var d,i=C(r,"x","conv3d"),s=C(n,"filter","conv3d"),u=i,c=!1;4===i.rank&&(c=!0,u=i.as5D(1,i.shape[0],i.shape[1],i.shape[2],i.shape[3])),R(5===u.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+u.rank+"."}),R(5===s.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+s.rank+"."}),R(u.shape[4]===s.shape[3],function(){return"Error in conv3d: depth of input ("+u.shape[4]+") must match input depth for filter "+s.shape[3]+"."}),R((d=a,Ki(e)||Ki(d)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),R("NDHWC"===o,function(){return"Error in conv3d: got dataFormat of "+o+" but only NDHWC is currently supported."});var l=ho(u.shape,s.shape,e,a,t),h=A.runKernelFunc(function(f,d){var p=f.conv3d(u,s,l);return d([u,s]),p},{x:u,$filter:s},function(f,d){R(Ki(a),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"});var p=d[0],g=d[1];return{x:function(){return Wl(p.shape,f,g,e,t)},$filter:function(){return function(m,y,x,w,b){var _=m;4===m.rank&&(_=m.as5D(1,m.shape[0],m.shape[1],m.shape[2],m.shape[3]));var E=y;4===E.rank&&(E=y.as5D(1,y.shape[0],y.shape[1],y.shape[2],y.shape[3])),R(5===_.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+_.shape+"."}),R(5===E.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+E.shape+"."}),R(5===x.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+x+"."}),R(_.shape[4]===x[3],function(){return"Error in conv3dDerFilter: depth of input "+_.shape[4]+") must match input depth in filter ("+x[3]+"."}),R(E.shape[4]===x[4],function(){return"Error in conv3dDerFilter: depth of dy ("+E.shape[4]+") must match output depth for filter ("+x[4]+")."});var F=ho(_.shape,x,w,1,b);return A.runKernelFunc(function(I){return I.conv3dDerFilter(_,E,F)},{x5D:_,dy5D:E})}(p,f,g.shape,e,t)}}});return c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),Yi=D({conv2dDerFilter_:function(r,n,e,t,o,a,i){void 0===a&&(a="NHWC");var s=r;3===r.rank&&(s=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var u=n;3===u.rank&&(u=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),R(4===s.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),R(4===u.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),R(4===e.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+e+"."});var c="NHWC"===a?s.shape[3]:s.shape[1],l="NHWC"===a?u.shape[3]:u.shape[1];R(c===e[2],function(){return"Error in conv2dDerFilter: depth of input "+c+") must match input depth in filter ("+e[2]+"."}),R(l===e[3],function(){return"Error in conv2dDerFilter: depth of dy ("+l+") must match output depth for filter ("+e[3]+")."}),null!=i&&R(Ve(o),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var h=ea(a),f=zn(s.shape,e,t,1,o,i,!1,h);return A.runKernelFunc(function(d){return d.conv2dDerFilter(s,u,f)},{x4D:s,dy4D:u})}}),Ul=D({conv2dDerInput_:Ll}),ha=D({depthwiseConv2d_:function(r,n,e,t,o,a,i){void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]);var s=C(r,"x","depthwiseConv2d"),u=C(n,"filter","depthwiseConv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),R(4===c.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),R(4===u.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+u.rank+"."}),R(c.shape[3]===u.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+u.shape[2]+"."}),null==a&&(a=[1,1]),R(_t(e,a),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),null!=i&&R(Ve(t),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+t+"."});var h=zn(c.shape,u.shape,e,a,t,i,!0),d=A.runKernelFunc(function(p,g){var m=p.depthwiseConv2D(c,u,h);return g([c,u]),m},{x:c,filter:u},function(p,g){R(ur(a),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"});var m=g[0],y=g[1];return{x:function(){return Vl(m.shape,p,y,h)},filter:function(){return Gl(m,p,y.shape,h)}}},"DepthwiseConv2dNative",h,[c,u]);return l?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}}),Vl=D({depthwiseConv2dDerInput_:function(r,n,e,t){var o=n,a=!1;3===n.rank&&(a=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var i=A.runKernelFunc(function(s){return s.depthwiseConv2DDerInput(o,e,t)},{dy4D:o});return a?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),Gl=D({depthwiseConv2dDerFilter_:function(r,n,e,t){var o=r;3===r.rank&&(o=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var a=n;return 3===a.rank&&(a=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),A.runKernelFunc(function(i){return i.depthwiseConv2DDerFilter(o,a,t)},{x4D:o,dy4D:a})}}),$i=D({separableConv2d_:function(r,n,e,t,o,a,i){void 0===a&&(a=[1,1]),void 0===i&&(i="NHWC");var s=C(r,"x","separableConv2d"),u=C(n,"depthwiseFilter","separableConv2d"),c=C(e,"pointwiseFilter","separableConv2d"),l=s,h=!1;if(3===s.rank&&(h=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),"NCHW"===i)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");R(4===l.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+l.rank+"."}),R(4===u.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+u.rank+"."}),R(4===c.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+u.rank+"."}),R(1===c.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+c.shape[0]+"."}),R(1===c.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+c.shape[1]+"."});var f=u.shape[2],d=u.shape[3];R(c.shape[2]===f*d,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+f*d+", but got "+c.shape[2]+"."});var p=ha(l,u,t,o,i,a),g=Wt(p,c,1,"valid",i);return h?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),lm=D({conv2dTranspose_:function(r,n,e,t,o,a){return Ll(e,C(r,"x","conv2dTranspose"),C(n,"filter","conv2dTranspose"),t,o,"NHWC",a)}}),hm=D({conv3dTranspose_:function(r,n,e,t,o){return Wl(e,C(r,"x","conv3dTranspose"),C(n,"filter","conv3dTranspose"),t,o)}}),fa=D({matMul_:function(r,n,e,t){var o;void 0===e&&(e=!1),void 0===t&&(t=!1);var a=C(r,"a","matMul"),i=C(n,"b","matMul");o=Ue(a,i),a=o[0],i=o[1];var s=e?a.shape[a.rank-2]:a.shape[a.rank-1],u=t?i.shape[i.rank-1]:i.shape[i.rank-2],c=e?a.shape[a.rank-1]:a.shape[a.rank-2],l=t?i.shape[i.rank-2]:i.shape[i.rank-1],h=a.shape.slice(0,-2),f=i.shape.slice(0,-2),d=re(h),p=re(f);R(a.rank>=2&&i.rank>=2&&a.rank===i.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+i.rank+"."}),R(Je(h,f),function(){return"Error in matMul: outer dimensions ("+h+") and ("+f+") of Tensors with shapes "+a.shape+" and "+i.shape+" must match."}),R(s===u,function(){return"Error in matMul: inner shapes ("+s+") and ("+u+") of Tensors with shapes "+a.shape+" and "+i.shape+" and transposeA="+e+" and transposeB="+t+" must match."});var g=a.shape.slice(0,-2).concat([c,l]),m=e?a.as3D(d,s,c):a.as3D(d,c,s),y=t?i.as3D(p,l,u):i.as3D(p,u,l);return A.runKernelFunc(function(w,b){var _=w.batchMatMul(m,y,e,t);return b([m,y]),_},{a:m,b:y},function(w,b){var E=b[0],F=b[1];return e||t?!e&&t?{a:function(){return w.matMul(F,!1,!1)},b:function(){return w.matMul(E,!0,!1)}}:e&&!t?{a:function(){return F.matMul(w,!1,!0)},b:function(){return E.matMul(w,!1,!1)}}:{a:function(){return F.matMul(w,!0,!0)},b:function(){return w.matMul(E,!0,!0)}}:{a:function(){return w.matMul(F,!1,!0)},b:function(){return E.matMul(w,!0,!1)}}},"BatchMatMul",{transposeA:e,transposeB:t}).reshape(g)}}),fm=D({dot_:function(r,n){var e=C(r,"t1","dot"),t=C(n,"t2","dot");R(!(1!==e.rank&&2!==e.rank||1!==t.rank&&2!==t.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+e.rank+" and "+t.rank+"."});var o=1===e.rank?e.size:e.shape[1],a=1===t.rank?t.size:t.shape[0];return R(o===a,function(){return"Error in dot: inner dimensions of inputs must match, but got "+o+" and "+a+"."}),1===e.rank&&1===t.rank?e.as2D(1,-1).matMul(t.as2D(-1,1)).asScalar():1===e.rank&&2===t.rank?e.as2D(1,-1).matMul(t.as2D(t.shape[0],t.shape[1])).as1D():2===e.rank&&1===t.rank?e.matMul(t.as2D(-1,1)).as1D():e.matMul(t.as2D(t.shape[0],t.shape[1]))}}),dm=D({outerProduct_:function(r,n){var e=C(r,"v1","outerProduct"),t=C(n,"v2","outerProduct");return R(1===e.rank&&1===t.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+e.rank+" and "+t.rank+"."}),e.as2D(-1,1).matMul(t.as2D(1,-1))}}),yo=D({reverse_:function(r,n){var e=C(r,"x","reverse");if(0===e.rank)return e.clone();var t=Qe(n,e.shape);return A.runKernelFunc(function(o){return o.reverse(e,t)},{$x:e},function(o){return{$x:function(){return o.reverse(t)}}}).reshapeAs(e)}}),pm=D({reverse1d_:function(r){var n=C(r,"x","reverse");return R(1===n.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+n.rank+"."}),yo(n,0)}}),vm=D({reverse2d_:function(r,n){var e=C(r,"x","reverse");return R(2===e.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+e.rank+"."}),yo(e,n)}}),mm=D({reverse3d_:function(r,n){var e=C(r,"x","reverse");return R(3===e.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+e.rank+"."}),yo(e,n)}}),gm=D({reverse4d_:function(r,n){var e=C(r,"x","reverse");return R(4===e.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+e.rank+"."}),yo(e,n)}});function zl(r,n,e,t,o,a){var i=C(r,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),null==t&&(t=[1,1]),R(4===s.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),R(_t(e,t),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+t+"'"}),null!=a&&R(Ve(o),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=Fr(s.shape,n,e,t,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Je(c.inShape,c.outShape))return i.clone();var h=A.runKernelFunc(function(f,d){var p=f.maxPool(s,c);return d([s,p]),p},{x:s},function(f,d){var p=d[0],g=d[1];return{x:function(){return function(m,y,x,w,b,_,E){var I=C(m,"dy","maxPoolBackprop"),S=C(y,"input","maxPoolBackprop"),k=C(x,"output","maxPoolBackprop");R(S.rank===I.rank,function(){return"Rank of input ("+S.rank+") does not match rank of dy ("+I.rank+")"}),null==_&&(_=[1,1]),R(_t(b,_),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+b+" and dilations '"+_+"'"}),R(4===I.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+I.rank+"."}),R(4===S.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+S.rank+"."});var N=Fr(S.shape,w,b,_,E,void 0);return A.runKernelFunc(function(T){return T.maxPoolBackprop(I,S,k,N)},{$dy:I,$input:S})}(f,p,g,n,e,t,o)}}},"MaxPool",c,[s]);return u?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}function jl(r,n,e,t,o,a){var i=C(r,"x","avgPool","float32");null==t&&(t=[1,1]),R(_t(e,t),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+t+"'"});var s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),R(4===s.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),null!=a&&R(Ve(o),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=Fr(s.shape,n,e,t,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Je(c.inShape,c.outShape))return i.clone();var l=A.runKernelFunc(function(h){return h.avgPool(s,c)},{x:s},function(h){return{x:function(){return function(f,d,p,g,m,y){var x=C(f,"dy","avgPoolBackprop"),w=C(d,"input","avgPoolBackprop");R(w.rank===x.rank,function(){return"Rank of input ("+w.rank+") does not match rank of dy ("+x.rank+")"}),null==m&&(m=[1,1]),R(_t(g,m),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+m+"'"});var b=w,_=x,E=!1;3===w.rank&&(E=!0,b=w.as4D(1,w.shape[0],w.shape[1],w.shape[2]),_=x.as4D(1,x.shape[0],x.shape[1],x.shape[2])),R(4===_.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+_.rank+"."}),R(4===b.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+b.rank+"."});var F=Fr(b.shape,p,g,m,y),I=A.runKernelFunc(function(S){return S.avgPoolBackprop(_,b,F)},{dy4D:_,input4D:b});return E?I.as3D(I.shape[1],I.shape[2],I.shape[3]):I}(h,s,n,e,t,o)}}},"AvgPool",c);return l=l.cast(i.dtype),u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l}var st=D({maxPool_:function(r,n,e,t,o){return zl(r,n,e,1,t,o)}}),bo=D({avgPool_:function(r,n,e,t,o){return jl(r,n,e,1,t,o)}}),ym=D({pool_:function(r,n,e,t,o,a){null==o&&(o=[1,1]),null==a&&(a=1),0===t&&(t="valid");var i=C(r,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),R(_t(a,o),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+o+"'"});var c,_,E,F,I,l=Fr(s.shape,n,a,o,t),h=[l.dilationHeight,l.dilationWidth];c="same"===t?(_=h,E=[l.filterHeight,l.filterWidth].map(function(S,k){return S+(S-1)*(_[k]-1)}).map(function(S){return S-1}),F=E.map(function(S){return Math.floor(S/2)}),I=E.map(function(S,k){return S-F[k]}),E.map(function(S,k){return[F[k],I[k]]})):[[0,0],[0,0]];var f=1===h[0]&&1===h[1],d=function(b,_,E){var F=E.map(function(B){return B[0]}),I=E.map(function(B){return B[1]}),S=b.concat(F,I),k=_.map(function(B,L){return(B-S[L]%B)%B}),N=I.map(function(B,L){return B+k[L]});return[_.map(function(B,L){return[F[L],N[L]]}),_.map(function(B,L){return[0,k[L]]})]}([l.inHeight,l.inWidth],h,c),g=d[1],m=f?t:"valid",y=f?s:dc(s,h,d[0]),x=("avg"===e?function(){return jl(y,n,a,1,m)}:function(){return zl(y,n,a,1,m)})(),w=f?x:lc(x,h,g);return u?w.as3D(w.shape[1],w.shape[2],w.shape[3]):w}}),bm=D({maxPool3d_:function(r,n,e,t,o,a,i){void 0===a&&(a="NDHWC");var s=C(r,"x","maxPool3d"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),R(5===u.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),R("NDHWC"===a,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),R(_t(e,i),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+i+"'"}),null!=o&&R(Ve(t),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+t+"."});var l=lo(u.shape,n,e,i,t,o,a),h=A.runKernelFunc(function(f,d){var p=f.maxPool3d(u,l);return d([u,p]),p},{x:u},function(f,d){var p=d[0],g=d[1];return{x:function(){return function(m,y,x,w,b,_,E,F){var I=C(m,"dy","maxPool3dBackprop"),S=C(y,"input","maxPool3dBackprop"),k=C(x,"output","maxPool3dBackprop"),N=I,T=S,W=k,B=!1;4===S.rank&&(B=!0,N=I.as5D(1,I.shape[0],I.shape[1],I.shape[2],I.shape[3]),T=S.as5D(1,S.shape[0],S.shape[1],S.shape[2],S.shape[3]),W=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3])),R(5===N.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+N.rank+"."}),R(5===T.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+T.rank+"."}),R(5===W.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+W.rank+"."}),null==_&&(_=[1,1,1]),R(_t(b,_),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+b+" and dilations '"+_+"'"}),null!=F&&R(Ve(E),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+F+" but got pad "+E+"."});var L=lo(T.shape,w,b,_,E,F),H=A.runKernelFunc(function(G){return G.maxPool3dBackprop(N,T,W,L)},{dy5D:N,input5D:T});return B?H.as4D(H.shape[1],H.shape[2],H.shape[3],H.shape[4]):H}(f,p,g,n,e,i,t,o)}}});return c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),xm=D({avgPool3d_:function(r,n,e,t,o,a,i){void 0===a&&(a="NDHWC");var s=C(r,"x","avgPool3d","float32"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),R(5===u.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),R("NDHWC"===a,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),R(_t(e,i),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+i+"'"}),null!=o&&R(Ve(t),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+t+"."});var l=lo(u.shape,n,e,i,t,o,a),h=A.runKernelFunc(function(f){return f.avgPool3d(u,l)},{x:u},function(f){return{x:function(){return function(d,p,g,m,y,x,w){var b=C(d,"dy","avgPool3dBackprop"),_=C(p,"input","avgPool3dBackprop"),E=b,F=_,I=!1;4===_.rank&&(I=!0,E=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3]),F=_.as5D(1,_.shape[0],_.shape[1],_.shape[2],_.shape[3])),R(5===E.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+E.rank+"."}),R(5===F.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+F.rank+"."}),null==y&&(y=[1,1,1]),R(_t(m,y),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+m+" and dilations '"+y+"'"}),null!=w&&R(Ve(x),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+w+" but got pad "+x+"."});var S=lo(F.shape,g,m,y,x,w),k=A.runKernelFunc(function(N){return N.avgPool3dBackprop(E,F,S)},{dy5D:E,input5D:F});return I?k.as4D(k.shape[1],k.shape[2],k.shape[3],k.shape[4]):k}(f,u,n,e,i,t,o)}}});return h=h.cast(u.dtype),c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),an=D({slice_:function(r,n,e){var t,o,a=C(r,"x","slice");if(0===a.rank)throw new Error("Slicing scalar is not possible");(t="number"==typeof n?[n].concat(new Array(a.rank-1).fill(0)):n.length<a.rank?n.concat(new Array(a.rank-n.length).fill(0)):n.slice()).forEach(function(u){R(-1!==u,function(){return"slice() does not support negative begin indexing."})}),o=(o=null==e?new Array(a.rank).fill(-1):"number"==typeof e?[e].concat(new Array(a.rank-1).fill(-1)):e.length<a.rank?e.concat(new Array(a.rank-e.length).fill(-1)):e).map(function(u,c){return u>=0?u:(R(-1===u,function(){return"Negative size values should be exactly -1 but got "+u+" for the slice() size at index "+c+"."}),a.shape[c]-t[c])}),bc(a,t,o);var i=a.shape;return A.runKernelFunc(function(u){return u.slice(a,t,o)},{x:a},function(u){for(var c=[],l=0;l<u.rank;l++)c.push([t[l],i[l]-t[l]-o[l]]);return{x:function(){return u.pad(c)}}},"Slice",{begin:t,size:o})}}),wm=D({slice1d_:function(r,n,e){var t=C(r,"x","slice1d");return R(1===t.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+t.rank+" tensor"}),an(t,[n],[e])}}),_m=D({slice2d_:function(r,n,e){var t=C(r,"x","slice2d");return R(2===t.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+t.rank+" tensor"}),an(t,n,e)}}),Hl=D({slice3d_:function(r,n,e){var t=C(r,"x","slice3d");return R(3===t.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+t.rank+" tensor"}),an(t,n,e)}}),Cm=D({slice4d_:function(r,n,e){var t=C(r,"x","slice4d");return R(4===t.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+t.rank+" tensor"}),an(t,n,e)}});function ql(r,n,e,t,o){return n.rank<e.rank&&(n=n.reshape(wt(n.shape,t))),r.rank<e.rank&&(r=r.reshape(wt(r.shape,t))),{x:function(){var a=r.mul(e.equal(n).cast(r.dtype));return null==o?a:a.transpose(o)}}}var Em=D({all_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","all","bool"),o=Qe(n,t.shape),a=o,i=qt(a,t.rank);null!=i&&(t=t.transpose(i),a=Xt(a.length,t.rank));var s=A.runKernelFunc(function(c){return c.all(t,a)},{$x:t});if(e){var u=wt(s.shape,o);return s.reshape(u)}return s}}),Rm=D({any_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","any","bool"),o=Qe(n,t.shape),a=o,i=qt(a,t.rank);null!=i&&(t=t.transpose(i),a=Xt(a.length,t.rank));var s=A.runKernelFunc(function(c){return c.any(t,a)},{$x:t});if(e){var u=wt(s.shape,o);return s.reshape(u)}return s}}),Sm=D({argMax_:function(r,n){void 0===n&&(n=0);var e=C(r,"x","argMax");null==n&&(n=0);var t=Qe(n,e.shape),o=qt(t,e.rank);return null!=o&&(e=e.transpose(o),t=Xt(t.length,e.rank)),A.runKernelFunc(function(s,u){var c=s.argMax(e,t[0]);return u([e]),c},{x:e},function(s,u){var c=u[0];return{x:function(){return Se(c)}}},"ArgMax",{axis:t[0]},[e])}}),km=D({argMin_:function(r,n){void 0===n&&(n=0);var e=C(r,"x","argMin");null==n&&(n=0);var t=Qe(n,e.shape),o=qt(t,e.rank);return null!=o&&(e=e.transpose(o),t=Xt(t.length,e.rank)),A.runKernelFunc(function(a,i){var s=a.argMin(e,t[0]);return i([e]),s},{$x:e},function(a,i){var s=i[0];return{$x:function(){return Se(s)}}})}}),Im=D({logSumExp_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","logSumExp"),o=Qe(n,t.shape),a=t.max(o,!0),i=t.sub(a).exp().sum(o).log(),s=a.reshape(i.shape).add(i);if(e){var u=wt(s.shape,o);return s.reshape(u)}return s}}),da=D({max_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","max"),o=t,a=Qe(n,t.shape),i=a,s=qt(i,t.rank);null!=s&&(t=t.transpose(s),i=Xt(i.length,t.rank));var c=A.runKernelFunc(function(h,f){var d=h.max(t,i);return f([o,d]),d},{x:t},function(h,f){return ql(h,f[1],f[0],a,s)},"Max",{axes:i},[t],[!0]);if(e){var l=wt(c.shape,a);c=c.reshape(l)}return c}}),Fm=D({mean_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","mean"),o=Qe(n,t.shape),a=re(ft(t.shape,o)[1]);return Jo(function(i){var s=$(a);return{value:(s.dtype===i.dtype?i:i.cast(s.dtype)).div(s).sum(n,e),gradFunc:function(u){var c=i.shape.slice();return o.forEach(function(l){c[l]=1}),u.reshape(c).mul(kr(i.shape,"float32")).div(a)}}})(t)}}),Am=D({min_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","min"),o=t,a=Qe(n,t.shape),i=a,s=qt(i,t.rank);null!=s&&(t=t.transpose(s),i=Xt(i.length,t.rank));var c=A.runKernelFunc(function(h,f){var d=h.min(t,i);return f([o,d]),d},{x:t},function(h,f){return ql(h,f[1],f[0],a,s)},"Min",{axes:i},[t],[!0]);if(e){var l=wt(c.shape,a);c=c.reshape(l)}return c}}),Dm=D({moments_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=Qe(n,(r=C(r,"x","moments")).shape),o=r.mean(t,e),a=o.shape;e||(a=wt(o.shape,t));var i=r.toFloat().sub(o.reshape(a)).square();return{mean:o,variance:i.mean(t,e)}}}),Xl=D({sum_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","sum");"bool"===t.dtype&&(t=t.toInt());var o=Qe(n,t.shape);return Jo(function(a){var i=qt(o,a.rank),s=o,u=a;null!=i&&(u=a.transpose(i),s=Xt(s.length,a.rank));var c=function(d){var p=a.shape.slice();return o.forEach(function(g){p[g]=1}),d.reshape(p).mul(kr(a.shape,"float32"))},h=A.runKernelFunc(function(d){return d.sum(u,s)},{x:u},function(d){return{x:function(){return c(d)}}},"Sum",{axes:s});if(e){var f=wt(h.shape,o);h=h.reshape(f)}return{value:h,gradFunc:c}})(t)}}),Tm=D({prod_:function(r,n,e){void 0===n&&(n=null),void 0===e&&(e=!1);var t=C(r,"x","prod");"bool"===t.dtype&&(t=t.toInt());var o=Qe(n,t.shape),a=qt(o,t.rank),i=o,s=t;null!=a&&(s=t.transpose(a),i=Xt(i.length,t.rank));var u=A.runKernelFunc(function(l){return l.prod(s,i)},{permutedX:s});if(e){var c=wt(u.shape,o);u=u.reshape(c)}return u}}),Kl=D({elu_:function(r){var n=C(r,"x","elu");return A.runKernelFunc(function(e,t){var o=e.elu(n);return t([o]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){return A.runKernelFunc(function(a){return a.eluDer(e,o)},{dy:e,y:o})}}})}}),Nm=D({leakyRelu_:function(r,n){void 0===n&&(n=.2);var e=C(r,"x","leakyRelu");return qi($(n).mul(e),e)}}),Yl=D({prelu_:function(r,n){var e=C(r,"x","prelu"),t=C(n,"alpha","prelu");return A.runKernelFunc(function(o,a){var i=o.prelu(e,t);return a([e,t]),i},{x:e,alpha:t},function(o,a){var i=a[0],s=a[1],u=i.greater(0);return{x:function(){return hr(u,o,o.mul(s))},alpha:function(){var c=hr(u,Se(o),o.mul(i)),l=et(s.shape,o.shape);return l.length>0&&(c=c.sum(l)),c.reshape(s.shape)}}},"Prelu")}}),Ge=D({relu_:function(r){var n=C(r,"x","relu");return"bool"===n.dtype?n.toInt():A.runKernelFunc(function(e,t){var o=e.relu(n);return t([n]),o},{x:n},function(e,t){var o=t[0];return{x:function(){return e.mulStrict(o.step().toFloat())}}},"Relu")}}),$l=D({relu6_:function(r){var n=C(r,"x","relu6");return"bool"===n.dtype?n.toInt():A.runKernelFunc(function(e,t){var o=e.relu6(n);return t([n]),o},{x:n},function(e,t){var o=t[0],a=o.lessEqual(6).mul(o.step());return{x:function(){return e.mulStrict(a.toFloat())}}},"Relu6")}}),Pm=D({selu_:function(r){var n=C(r,"x","selu");return A.runKernelFunc(function(e,t){var o=e.selu(n);return t([n]),o},{$x:n},function(e,t){var o=t[0];return{$x:function(){var a=o.greater($(0)),i=$(Gi),s=$(zi),u=e.mul(s),c=e.mul(i).mul(o.toFloat().exp());return hr(a,u,c)}}})}}),jn=D({transpose_:function(r,n){var e=C(r,"x","transpose");return null==n&&(n=e.shape.map(function(o,a){return a}).reverse()),R(e.rank===n.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of perm "+n+"."}),n.forEach(function(o){R(o>=0&&o<e.rank,function(){return"All entries in 'perm' must be between 0 and "+(e.rank-1)+" but got "+n})}),e.rank<=1?e.clone():A.runKernelFunc(function(o){return o.transpose(e,n)},{x:e},function(o){var a=zo(n);return{x:function(){return o.transpose(a)}}},"Transpose",{perm:n})}}),Mm=D({localResponseNormalization_:function(r,n,e,t,o){void 0===n&&(n=5),void 0===e&&(e=1),void 0===t&&(t=1),void 0===o&&(o=.5);var a=C(r,"x","localResponseNormalization");R(4===a.rank||3===a.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+a.rank+"."}),R(Ve(n),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+n+"."});var i=a,s=!1;3===a.rank&&(s=!0,i=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var u=A.runKernelFunc(function(c,l){var h=c.localResponseNormalization4D(i,n,e,t,o);return l([i,h]),h},{x4D:i},function(c,l){var h=l[0],f=l[1];return{x4D:function(){return A.runKernelFunc(function(d){return d.LRNGrad(c,h,f,n,e,t,o)},{})}}});return s?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),Jl=D({norm_:function(r,n,e,t){void 0===n&&(n="euclidean"),void 0===e&&(e=null),void 0===t&&(t=!1);var o=function s(u,c,l){if(void 0===l&&(l=null),0===u.rank)return u.abs();if(1!==u.rank&&null===l)return s(u.reshape([-1]),c,l);if(1===u.rank||"number"==typeof l||Array.isArray(l)&&1===l.length){if(1===c)return u.abs().sum(l);if(c===1/0)return u.abs().max(l);if(c===-1/0)return u.abs().min(l);if("euclidean"===c||2===c)return u.abs().pow($(2,"int32")).sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(l)&&2===l.length){if(1===c)return u.abs().sum(l[0]).max(l[1]-1);if(c===1/0)return u.abs().sum(l[1]).max(l[0]);if(c===-1/0)return u.abs().sum(l[1]).min(l[0]);if("fro"===c||"euclidean"===c)return u.square().sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}throw new Error("Error in norm: invalid axis: "+l)}(r=C(r,"x","norm"),n,e),a=o.shape;if(t){var i=Qe(e,r.shape);a=wt(o.shape,i)}return o.reshape(a)}}),Om=D({basicLSTMCell_:function(r,n,e,t,o,a){var i=C(r,"forgetBias","basicLSTMCell"),s=C(n,"lstmKernel","basicLSTMCell"),u=C(e,"lstmBias","basicLSTMCell"),c=C(t,"data","basicLSTMCell"),l=C(o,"c","basicLSTMCell"),h=C(a,"h","basicLSTMCell"),f=c.concat(h,1).matMul(s).add(u),p=f.shape[1]/4,g=[f.shape[0],p],m=f.slice([0,0],g),y=f.slice([0,p],g),x=f.slice([0,2*p],g),w=f.slice([0,3*p],g),b=m.sigmoid().mulStrict(y.tanh()).addStrict(l.mulStrict(i.add(x).sigmoid())),_=b.tanh().mulStrict(w.sigmoid());return[b,_]}}),Bm=D({multiRNNCell_:function(r,n,e,t){for(var o=C(n,"data","multiRNNCell"),a=uo(e,"c","multiRNNCell"),i=uo(t,"h","multiRNNCell"),s=o,u=[],c=0;c<r.length;c++){var l=r[c](s,a[c],i[c]);u.push(l[0]),u.push(l[1]),s=l[1]}var h=[],f=[];for(c=0;c<u.length;c+=2)h.push(u[c]),f.push(u[c+1]);return[h,f]}}),Lm=D({movingAverage_:function(r,n,e,t,o){void 0===o&&(o=!0);var a=C(r,"v","movingAverage"),i=C(n,"x","movingAverage"),s=C(e,"decay","movingAverage");Du(a,i),R(Je(a.shape,i.shape),function(){return"Shape mismatch in v and x"});var u=$(1),c=u.sub(s),l=i.sub(a).mul(c);if(o){R(null!=t,function(){return"When using zeroDebias: true, step is required."});var h=C(t,"step","movingAverage");l=l.div(u.sub(la(s,h)))}return a.add(l)}}),Wm=D({stridedSlice_:function(r,n,e,t,o,a,i,s,u){if(void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===u&&(u=0),null==t&&(t=new Array(n.length)),0!==i)throw new Error("ellipsis mask is not yet supported");var c=C(r,"x","stridedSlice"),l=Ei(s),h=c.shape.slice();l.forEach(function(m){n[m]=0,e[m]=1,h.splice(m,0,1)}),c=c.reshape(h);for(var f=0;f<c.rank;f++)n[f]=xc(o,n,t,c.shape,f),e[f]=wc(a,e,t,c.shape,f),t[f]=t[f]||1;var d=Ei(u);d.forEach(function(m){e[m]=n[m]+1,t[m]=1});var p=$o(n,e,t),g=p.filter(function(m,y){return-1===d.indexOf(y)});return t.every(function(m){return 1===m})?an(c,n,p).reshape(g):A.runKernelFunc(function(m){return m.stridedSlice(c,n,e,t)},{$x:c}).reshape(g)}}),Um=D({topk_:function(r,n,e){void 0===n&&(n=1),void 0===e&&(e=!0);var t=C(r,"x","topk");if(0===t.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var o=t.shape[t.shape.length-1];if(n>o)throw new Error("'k' passed to topk() must be <= the last dimension ("+o+") but got "+n);var a=A.runKernelFunc(function(i){return i.topk(t,n,e)},{$x:t});return{values:a[0],indices:a[1]}}}),Vm=D({scatterND_:function(r,n,e){var t=C(r,"indices","scatterND","int32"),o=C(n,"updates","scatterND");return yc(o,t,e),A.runKernelFunc(function(a){return a.scatterND(t,o,e)},{indices:t,updates:o},null,"ScatterNd",{shape:e})}}),Ji=D({fft_:function(r){R("complex64"===r.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+r.dtype+"."});var n=r.shape[r.shape.length-1],t=r.as2D(r.size/n,n);return A.runKernelFunc(function(o){return o.fft(t)},{input:r}).reshape(r.shape)}}),pa=D({ifft_:function(r){R("complex64"===r.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+r.dtype+"."});var n=r.shape[r.shape.length-1],t=r.as2D(r.size/n,n);return A.runKernelFunc(function(o){return o.ifft(t)},{input:r}).reshape(r.shape)}}),Qi=D({rfft_:function(r,n){R("float32"===r.dtype,function(){return"The dtype for rfft() must be real value but got "+r.dtype});var e,t=r.shape[r.shape.length-1],o=r.size/t;if(null!=n&&n<t){var a=r.shape.map(function(y){return 0}),i=r.shape.map(function(y){return y});i[r.shape.length-1]=n,e=r.slice(a,i),t=n}else if(null!=n&&n>t){var s=r.shape.map(function(y){return y});s[r.shape.length-1]=n-t,e=r.concat(Le(s),r.shape.length-1),t=n}else e=r;var u=e.zerosLike(),c=dt(e,u).as2D(o,t),l=Ji(c),h=Math.floor(t/2)+1,f=Bt(l),d=rn(l),p=f.split([h,t-h],f.shape.length-1),g=d.split([h,t-h],d.shape.length-1),m=e.shape.slice();return m[e.shape.length-1]=h,dt(p[0],g[0]).reshape(m)}}),Ql=D({irfft_:function(r){var n=r.shape[r.shape.length-1],e=r.size/n;if(n<=2){var t=r.as2D(e,n),o=pa(t);return Bt(o)}var a=[e,2*(n-1)],i=Bt(r).as2D(e,n),s=rn(r).as2D(e,n),u=i.slice([0,1],[e,n-2]).reverse(1),c=s.slice([0,1],[e,n-2]).reverse(1).mul($(-1)),l=i.concat(u,1),h=s.concat(c,1);return t=dt(l,h).as2D(a[0],a[1]),o=pa(t),Bt(o)}}),Gm=Object.freeze({fft:Ji,ifft:pa,rfft:Qi,irfft:Ql}),zm=D({sparseToDense_:function(r,n,e,t){void 0===t&&(t=0);var o=C(r,"sparseIndices","sparseToDense","int32"),a=C(n,"sparseValues","sparseToDense"),i=C(t,"defaultValue","sparseToDense",a.dtype);return function(s,u,c,l){if("int32"!==s.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+s.dtype+".");if(s.rank>2)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+s.shape+".");var h=s.rank>0?s.shape[0]:1,f=s.rank>1?s.shape[1]:1;if(c.length!==f)throw new Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+f+".");if(0!==u.rank&&(1!==u.rank||u.size!==h))throw new Error("sparseValues has incorrect shape "+u.shape+", should be [] or ["+h+"]");if(u.dtype!==l.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(o,a,e,i),A.runKernelFunc(function(s){return s.sparseToDense(o,a,e,i)},{$sparseIndices:o,$sparseValues:a,$defaultValue:i})}}),jm=D({gatherND_:function(r,n){var e=C(n,"indices","gatherND","int32"),t=C(r,"x","gatherND");return A.runKernelFunc(function(o){return o.gatherND(t,e)},{x:t,indices:e},null,"GatherNd")}}),Hm=D({diag_:function(r){var n=C(r,"x","diag").flatten(),e=r.shape.concat(r.shape);return A.runKernelFunc(function(t){return t.diag(n)},{$x:n}).reshape(e)}}),qm=D({dropout_:function(r,n,e,t){var o=C(r,"x","dropout");if(R("float32"===o.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+o.dtype+" tensor instead."}),R(n>=0&&n<1,function(){return"rate must be a float in the range [0, 1), but got "+n+"."}),0===n)return r instanceof Me?o.clone():o;var a=function(u,c){if(null==c)return u.shape.slice();if(Je(u.shape,c))return c;if(u.shape.length===c.length){for(var l=[],h=0;h<u.shape.length;h++)l.push(null==c[h]&&null!=u.shape[h]?u.shape[h]:c[h]);return l}return c}(o,e),i=1-n,s=fc(a,0,1,"float32",t).add(i).floor().div(i);return o.mul(s)}});function Zl(r,n,e){for(var t=1-r%2,o=new Float32Array(r),a=0;a<r;++a){var i=2*Math.PI*a/(r+t-1);o[a]=n-e*Math.cos(i)}return Ze(o,"float32")}var bt,Zi=D({hannWindow_:function(r){return Zl(r,.5,.5)}}),eh=D({hammingWindow_:function(r){return Zl(r,.54,.46)}}),es=D({frame_:function(r,n,e,t,o){void 0===t&&(t=!1),void 0===o&&(o=0);for(var a=0,i=[];a+n<=r.size;)i.push(an(r,a,n)),a+=e;if(t)for(;a<r.size;){var s=a+n-r.size,u=nt([an(r,a,n-s),on([s],o)]);i.push(u),a+=e}return 0===i.length?Gn([],[0,n]):nt(i).as2D(i.length,n)}}),th=D({stft_:function(r,n,e,t,o){void 0===o&&(o=Zi),null==t&&(t=Math.floor(Math.pow(2,Math.ceil(Math.log(n)/Math.log(2)))));for(var i=es(r,n,e),s=yt(i,o(n)),u=[],c=0;c<i.shape[0];c++)u.push(Qi(s.slice([c,0],[1,n]),t));return nt(u)}}),Xm=Object.freeze({hannWindow:Zi,hammingWindow:eh,frame:es,stft:th});!function(r){r[r.NONE=0]="NONE",r[r.MEAN=1]="MEAN",r[r.SUM=2]="SUM",r[r.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(bt||(bt={}));var Ym=D({absoluteDifference_:function(r,n,e,t){void 0===t&&(t=bt.SUM_BY_NONZERO_WEIGHTS);var o=C(r,"labels","absoluteDifference"),a=C(n,"predictions","absoluteDifference"),i=null;null!=e&&(i=C(e,"weights","absoluteDifference")),Re(o.shape,a.shape,"Error in absoluteDifference: ");var s=o.sub(a).abs();return _n(s,i,t)}}),_n=D({computeWeightedLoss_:function(r,n,e){void 0===e&&(e=bt.SUM_BY_NONZERO_WEIGHTS);var t=C(r,"losses","computeWeightedLoss"),o=null;null!=n&&(o=C(n,"weights","computeWeightedLoss"));var a=null==o?t:t.mul(o);if(e===bt.NONE)return a;if(e===bt.SUM)return a.sum();if(e===bt.MEAN){if(null==o)return a.mean();var i=t.size/o.size,s=a.sum().div(o.sum());return i>1?s.div($(i)):s}if(e===bt.SUM_BY_NONZERO_WEIGHTS){if(null==o)return a.sum().div($(t.size));var u=o.mul(kr(t.shape)).notEqual($(0)).sum().toFloat();return a.sum().div(u)}throw Error("Unknown reduction: "+e)}}),$m=D({cosineDistance_:function(r,n,e,t,o){void 0===o&&(o=bt.SUM_BY_NONZERO_WEIGHTS);var a=C(r,"labels","cosineDistance"),i=C(n,"predictions","cosineDistance"),s=null;null!=t&&(s=C(t,"weights","cosineDistance")),Re(a.shape,i.shape,"Error in cosineDistance: ");var u=$(1).sub(a.mul(i).sum(e,!0));return _n(u,s,o)}}),Jm=D({hingeLoss_:function(r,n,e,t){void 0===t&&(t=bt.SUM_BY_NONZERO_WEIGHTS);var o=C(r,"labels","hingeLoss"),a=C(n,"predictions","hingeLoss"),i=null;null!=e&&(i=C(e,"weights","hingeLoss")),Re(o.shape,a.shape,"Error in hingeLoss: ");var s=$(1);o=$(2).mul(o).sub(s);var u=s.sub(o.mul(a)).relu();return _n(u,i,t)}}),Qm=D({huberLoss_:function(r,n,e,t,o){void 0===t&&(t=1),void 0===o&&(o=bt.SUM_BY_NONZERO_WEIGHTS);var a=C(r,"labels","huberLoss"),i=C(n,"predictions","huberLoss"),s=null;null!=e&&(s=C(e,"weights","huberLoss")),Re(a.shape,i.shape,"Error in huberLoss: ");var u=$(t),c=i.sub(a).abs(),l=Tl(c,u),h=c.sub(l),f=$(.5).mul(l.square()).add(u.mul(h));return _n(f,s,o)}}),Zm=D({logLoss_:function(r,n,e,t,o){void 0===t&&(t=1e-7),void 0===o&&(o=bt.SUM_BY_NONZERO_WEIGHTS);var a=C(r,"labels","logLoss"),i=C(n,"predictions","logLoss"),s=null;null!=e&&(s=C(e,"weights","logLoss")),Re(a.shape,i.shape,"Error in logLoss: ");var u=$(1),c=$(t),l=a.mul(i.add(c).log()).neg().sub(u.sub(a).mul(u.sub(i).add(c).log()));return _n(l,s,o)}}),eg=D({meanSquaredError_:function(r,n,e,t){void 0===t&&(t=bt.SUM_BY_NONZERO_WEIGHTS);var o=C(r,"labels","meanSquaredError"),a=C(n,"predictions","meanSquaredError"),i=null;null!=e&&(i=C(e,"weights","meanSquaredError")),Re(o.shape,a.shape,"Error in meanSquaredError: ");var s=o.squaredDifference(a);return _n(s,i,t)}}),tg=D({sigmoidCrossEntropy_:function(r,n,e,t,o){void 0===t&&(t=0),void 0===o&&(o=bt.SUM_BY_NONZERO_WEIGHTS);var a=C(r,"multiClassLabels","sigmoidCrossEntropy"),i=C(n,"logits","sigmoidCrossEntropy"),s=null;if(null!=e&&(s=C(e,"weights","sigmoidCrossEntropy")),Re(a.shape,i.shape,"Error in sigmoidCrossEntropy: "),t>0){var u=$(t),c=$(1),l=$(.5);a=a.mul(c.sub(u)).add(l.mul(u))}var h=function(f,d){var p=C(f,"labels","sigmoidCrossEntropyWithLogits"),g=C(d,"logits","sigmoidCrossEntropyWithLogits");Re(p.shape,g.shape,"Error in sigmoidCrossEntropyWithLogits: ");var m=g.relu(),y=g.mul(p),x=g.abs().neg().exp().log1p();return m.sub(y).add(x)}(a,i);return _n(h,s,o)}}),ng=D({softmaxCrossEntropy_:function(r,n,e,t,o){void 0===t&&(t=0),void 0===o&&(o=bt.SUM_BY_NONZERO_WEIGHTS);var a=C(r,"onehotLabels","softmaxCrossEntropy"),i=C(n,"logits","softmaxCrossEntropy"),s=null;if(null!=e&&(s=C(e,"weights","softmaxCrossEntropy")),Re(a.shape,i.shape,"Error in softmaxCrossEntropy: "),t>0){var u=$(t),c=$(1),l=$(a.shape[1]);a=a.mul(c.sub(u)).add(u.div(l))}var h=function(f,d,p){if(void 0===p&&(p=-1),-1===p&&(p=d.rank-1),p!==d.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+d.rank+" and dim was "+p);return Jo(function(g,m,y){var x=m.logSumExp([p],!0),w=m.toFloat().sub(x);return y([g,w]),{value:w.mul(g).neg().sum([p]),gradFunc:function(b,_){var E=_[0],F=_[1],I=wt(b.shape,[p]);return[b.reshape(I).mul(E.toFloat().sub(F.exp())),b.reshape(I).mul(F.exp().sub(E.toFloat()))]}}})(f,d)}(a,i);return _n(h,s,o)}}),rg=Object.freeze({get Reduction(){return bt},absoluteDifference:Ym,computeWeightedLoss:_n,cosineDistance:$m,hingeLoss:Jm,huberLoss:Qm,logLoss:Zm,meanSquaredError:eg,sigmoidCrossEntropy:tg,softmaxCrossEntropy:ng});function nh(r,n){return void 0===n&&(n=!1),A.tidy(function(){if(2!==r.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+r.shape.length+"D Tensor.");for(var e=r.shape[0],t=r.shape[1],o=hc(e),a=r.clone(),i=Gn([[1]],[1,1]),s=i.clone(),u=e>=t?t:e,c=function(h){var f,d=a,p=s,g=o;f=A.tidy(function(){var m=a.slice([h,h],[e-h,1]),y=m.norm(),x=a.slice([h,h],[1,1]),w=Gn([[-1]]).where(x.greater(0),Gn([[1]])),b=x.sub(w.mul(y)),_=m.div(b);s=1===_.shape[0]?i.clone():i.concat(_.slice([1,0],[_.shape[0]-1,_.shape[1]]),0);var E=w.matMul(b).div(y).neg(),F=a.slice([h,0],[e-h,t]),I=E.mul(s);if(0===h)a=F.sub(I.matMul(s.transpose().matMul(F)));else{var S=F.sub(I.matMul(s.transpose().matMul(F)));a=a.slice([0,0],[h,t]).concat(S,0)}var k=o.slice([0,h],[e,o.shape[1]-h]);if(0===h)o=k.sub(k.matMul(s).matMul(I.transpose()));else{var N=k.sub(k.matMul(s).matMul(I.transpose()));o=o.slice([0,0],[e,h]).concat(N,1)}return[s,a,o]}),s=f[0],a=f[1],o=f[2],Et([d,p,g])},l=0;l<u;++l)c(l);return!n&&e>t&&(o=o.slice([0,0],[e,t]),a=a.slice([0,0],[t,t])),[o,a]})}var og=D({bandPart_:function(r,n,e){if(n%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+n+".");if(e%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+e+".");var t=C(r,"a","bandPart");if(t.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+t.rank+".");var o=t.shape,a=t.shape.slice(-2),i=a[0],s=a[1];if(!(n<=i))throw new Error("bandPart(): numLower ("+n+") must not be greater than the number of rows ("+i+").");if(!(e<=s))throw new Error("bandPart(): numUpper ("+e+") must not be greater than the number of columns ("+s+").");n<0&&(n=i),e<0&&(e=s);var u=jo(0,i,1,"int32").reshape([-1,1]),c=jo(0,s,1,"int32"),l=ot(u,c),h=ca(l.lessEqual($(+n,"int32")),l.greaterEqual($(-e,"int32"))),f=Le([i,s],t.dtype);return Nt(rt(t.reshape([-1,i,s])).map(function(d){return hr(h,d,f)})).reshape(o)}}),ag=D({gramSchmidt_:function(r){var n;if(Array.isArray(r)){n=!1,R(null!=r&&r.length>0,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var e=r[0].shape[0],t=function(u){R(r[u].shape[0]===e,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+r[u].shape[0]+" vs. "+e+")"})},o=1;o<r.length;++o)t(o)}else n=!0,r=bi(r,r.shape[0],0).map(function(u){return pc(u,[0])});R(r.length<=r[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+r.length+") exceeds number of dimensions ("+r[0].shape[0]+")."});var a=[],i=r,s=function(u){a.push(A.tidy(function(){var c=i[u];if(u>0)for(var l=0;l<u;++l){var h=Xl(a[l].mulStrict(c)).mul(a[l]);c=c.sub(h)}return c.div(Jl(c,"euclidean"))}))};for(o=0;o<r.length;++o)s(o);return n?Nt(a,0):a}}),ig=D({qr_:function(r,n){if(void 0===n&&(n=!1),r.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+r.rank);if(2===r.rank)return nh(r,n);var e=r.shape.slice(0,r.shape.length-2).reduce(function(i,s){return i*s}),t=rt(r.reshape([e,r.shape[r.shape.length-2],r.shape[r.shape.length-1]]),0),o=[],a=[];return t.forEach(function(i){var s=nh(i,n),c=s[1];o.push(s[0]),a.push(c)}),[Nt(o,0).reshape(r.shape),Nt(a,0).reshape(r.shape)]}}),sg=Object.freeze({bandPart:og,gramSchmidt:ag,qr:ig});function va(r,n,e,t,o,a){null==t&&(t=.5),null==o&&(o=Number.NEGATIVE_INFINITY),null==a&&(a=0);var i=r.shape[0];return e=Math.min(e,i),R(0<=t&&t<=1,function(){return"iouThreshold must be in [0, 1], but was '"+t+"'"}),R(2===r.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+r.rank+"'"}),R(4===r.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+r.shape[1]}),R(1===n.rank,function(){return"scores must be a 1D tensor"}),R(n.shape[0]===i,function(){return"scores has incompatible shape with boxes. Expected "+i+", but was "+n.shape[0]}),R(0<=a&&a<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+a+"'"}),{maxOutputSize:e,iouThreshold:t,scoreThreshold:o,softNmsSigma:a}}var ug=D({resizeBilinear_:function(r,n,e){void 0===e&&(e=!1);var t=C(r,"images","resizeBilinear");R(3===t.rank||4===t.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+t.rank+"."}),R(2===n.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+n+"."});var o=t,a=!1;3===t.rank&&(a=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var i=n[0],s=n[1],u=A.runKernelFunc(function(c,l){return l([o]),c.resizeBilinear(o,i,s,e)},{x:o},function(c,l){return{x:function(){return A.runKernelFunc(function(h){return h.resizeBilinearBackprop(c,l[0],e)},{})}}},"ResizeBilinear",{alignCorners:e,newHeight:i,newWidth:s});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),cg=D({resizeNearestNeighbor_:function(r,n,e){void 0===e&&(e=!1);var t=C(r,"images","resizeNearestNeighbor");R(3===t.rank||4===t.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+t.rank+"."}),R(2===n.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+n+"."}),R("float32"===t.dtype||"int32"===t.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var o=t,a=!1;3===t.rank&&(a=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var i=n[0],s=n[1],u=A.runKernelFunc(function(c,l){return l([o]),c.resizeNearestNeighbor(o,i,s,e)},{batchImages:o},function(c,l){return{batchImages:function(){return A.runKernelFunc(function(h){return h.resizeNearestNeighborBackprop(c,l[0],e)},{})}}});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),lg=D({nonMaxSuppression_:function(r,n,e,t,o){void 0===t&&(t=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY);var a=C(r,"boxes","nonMaxSuppression"),i=C(n,"scores","nonMaxSuppression"),s=va(a,i,e,t,o);return A.runKernelFunc(function(c){return c.nonMaxSuppression(a,i,e,t,o)},{boxes:a,scores:i},null,"NonMaxSuppressionV3",{maxOutputSize:e=s.maxOutputSize,iouThreshold:t=s.iouThreshold,scoreThreshold:o=s.scoreThreshold})}}),fg=D({nonMaxSuppressionWithScore_:function(r,n,e,t,o,a){void 0===t&&(t=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0);var i=C(r,"boxes","nonMaxSuppression"),s=C(n,"scores","nonMaxSuppression"),u=va(i,s,e,t,o,a),c={maxOutputSize:e=u.maxOutputSize,iouThreshold:t=u.iouThreshold,scoreThreshold:o=u.scoreThreshold,softNmsSigma:a=u.softNmsSigma},l=A.runKernel("NonMaxSuppressionV5",{boxes:i,scores:s},c);return{selectedIndices:l[0],selectedScores:l[1]}}}),pg=D({cropAndResize_:function(r,n,e,t,o,a){var i=C(r,"image","cropAndResize"),s=C(n,"boxes","cropAndResize","float32"),u=C(e,"boxInd","cropAndResize","int32");o=o||"bilinear",a=a||0;var c=s.shape[0];return R(4===i.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+i.rank+"."}),R(2===s.rank&&4===s.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+c+",4] but had shape "+s.shape+"."}),R(1===u.rank&&u.shape[0]===c,function(){return"Error in cropAndResize: boxInd must be have size ["+c+"] but had shape "+s.shape+"."}),R(2===t.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+t.length+"."}),R(t[0]>=1&&t[1]>=1,function(){return"cropSize must be atleast [1,1], but was "+t}),R("bilinear"===o||"nearest"===o,function(){return"method must be bilinear or nearest, but was "+o}),A.runKernelFunc(function(l,h){return l.cropAndResize(i,s,u,t,o,a)},{images:i,boxes:s,boxInd:u},null,"CropAndResize",{method:o,extrapolationValue:a,cropSize:t})}}),ts=Object.freeze({resizeBilinear:ug,resizeNearestNeighbor:cg,nonMaxSuppression:lg,nonMaxSuppressionAsync:function(r,n,e,t,o){return void 0===t&&(t=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),Q(this,void 0,void 0,function(){var a,i,s,u,h;return ee(this,function(f){switch(f.label){case 0:return a=C(r,"boxes","nonMaxSuppressionAsync"),i=C(n,"scores","nonMaxSuppressionAsync"),s=va(a,i,e,t,o),e=s.maxOutputSize,t=s.iouThreshold,o=s.scoreThreshold,[4,Promise.all([a.data(),i.data()])];case 1:return u=f.sent(),h=Ti(u[0],u[1],e,t,o),a!==r&&a.dispose(),i!==n&&i.dispose(),[2,h]}})})},nonMaxSuppressionWithScore:fg,nonMaxSuppressionWithScoreAsync:function(r,n,e,t,o,a){return void 0===t&&(t=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0),Q(this,void 0,void 0,function(){var i,s,u,c,f;return ee(this,function(d){switch(d.label){case 0:return i=C(r,"boxes","nonMaxSuppressionAsync"),s=C(n,"scores","nonMaxSuppressionAsync"),u=va(i,s,e,t,o,a),e=u.maxOutputSize,t=u.iouThreshold,o=u.scoreThreshold,a=u.softNmsSigma,[4,Promise.all([i.data(),s.data()])];case 1:return c=d.sent(),f=Ni(c[0],c[1],e,t,o,a),i!==r&&i.dispose(),s!==n&&s.dispose(),[2,f]}})})},cropAndResize:pg}),ns=function(r,n){return!(r>0)||"linear"===n},rs=function(r,n,e){if(null==e||"linear"===e)return r;if("relu"===e)return r.mul(n.step());throw new Error("Gradient for activation "+e+" has not been implemented yet.")},os=function(r,n){var e=n,t=et(r.shape,n.shape);return t.length>0&&(e=e.sum(t)),e.reshape(r.shape)},as=function(r,n,e){if("linear"===n)return r;if("relu"===n)return Ge(r);if("elu"===n)return Kl(r);if("relu6"===n)return $l(r);if("prelu"===n)return Yl(r,e);throw new Error("Unknown fused activation "+n+".")},vg=D({fusedMatMul_:function(r){var n,e=r.a,t=r.b,o=r.transposeA,a=void 0!==o&&o,i=r.transposeB,s=void 0!==i&&i,u=r.bias,c=r.activation,l=void 0===c?"linear":c,h=r.preluActivationWeights;if(!1===ns(A.state.gradientDepth,l)){var f=fa(e,t,a,s);return null!=u&&(f=we(f,u)),as(f,l,h)}var d=C(e,"a","fused matMul"),p=C(t,"b","fused matMul");n=Ue(d,p),d=n[0],p=n[1];var g=a?d.shape[d.rank-2]:d.shape[d.rank-1],m=s?p.shape[p.rank-1]:p.shape[p.rank-2],y=a?d.shape[d.rank-1]:d.shape[d.rank-2],x=s?p.shape[p.rank-2]:p.shape[p.rank-1],w=d.shape.slice(0,-2),b=p.shape.slice(0,-2),_=re(w),E=re(b);R(d.rank>=2&&p.rank>=2&&d.rank===p.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+d.rank+" and "+p.rank+"."}),R(Je(w,b),function(){return"Error in fused matMul: outer dimensions ("+w+") and ("+b+") of Tensors with shapes "+d.shape+" and "+p.shape+" must match."}),R(g===m,function(){return"Error in fused matMul: inner shapes ("+g+") and ("+m+") of Tensors with shapes "+d.shape+" and "+p.shape+" and transposeA="+a+" and transposeB="+s+" must match."});var F,I,S=d.shape.slice(0,-2).concat([y,x]),k=a?d.as3D(_,g,y):d.as3D(_,y,g),N=s?p.as3D(E,x,m):p.as3D(E,m,x);null!=u&&xe(S,(F=Ue(F=C(u,"bias","fused matMul"),d)[0]).shape),null!=h&&(I=C(h,"prelu weights","fused matMul"));var T={a:k,b:N};return null!=u&&(T.bias=F),null!=h&&(T.preluActivationWeights=I),A.runKernelFunc(function(B,L){var H=B.fusedBatchMatMul({a:k,b:N,transposeA:a,transposeB:s,bias:F,activation:l,preluActivationWeights:I});return L([k,N,H]),H},T,function(B,L){var H=L[0],G=L[1],q=rs(B,L[2],l),X={};return null!=u&&(X={bias:function(){return os(F,q)}}),Object.assign(a||s?!a&&s?{a:function(){return q.matMul(G,!1,!1)},b:function(){return q.matMul(H,!0,!1)}}:a&&!s?{a:function(){return G.matMul(q,!1,!0)},b:function(){return H.matMul(q,!1,!1)}}:{a:function(){return G.matMul(q,!0,!0)},b:function(){return q.matMul(H,!0,!0)}}:{a:function(){return q.matMul(G,!1,!0)},b:function(){return H.matMul(q,!0,!1)}},X)},"_FusedMatMul",{transposeA:a,transposeB:s,activation:l},[k,N],[!0]).reshape(S)}}),mg=D({fusedConv2d_:function(r){var n=r.x,e=r.filter,t=r.strides,o=r.pad,a=r.dataFormat,i=void 0===a?"NHWC":a,s=r.dilations,u=void 0===s?[1,1]:s,c=r.dimRoundingMode,l=r.bias,h=r.activation,f=void 0===h?"linear":h,d=r.preluActivationWeights;if(!1===ns(A.state.gradientDepth,f=f||"linear")){var p=Wt(n,e,t,o,i,u,c);return null!=l&&(p=we(p,l)),as(p,f,d)}var g=C(n,"x","conv2d"),m=C(e,"filter","conv2d"),y=g,x=!1;3===g.rank&&(x=!0,y=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),R(4===y.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+y.rank+"."}),R(4===m.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+m.rank+"."}),null!=c&&R(Ve(o),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+c+" but got pad "+o+"."}),R(y.shape[3]===m.shape[2],function(){return"Error in conv2d: depth of input ("+y.shape[3]+") must match input depth for filter "+m.shape[2]+"."}),R(_t(t,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+u+"'"}),R("NHWC"===i,function(){return"Error in conv2d: got dataFormat of "+i+" but only NHWC is currently supported."});var w,b,_=zn(y.shape,m.shape,t,u,o,c);null!=l&&(w=Ue(w=C(l,"bias","fused conv2d"),g)[0],xe(_.outShape,w.shape)),null!=d&&(b=C(d,"prelu weights","fused conv2d"));var E={x:y,filter:m};null!=l&&(E.bias=w),null!=d&&(E.preluActivationWeights=b);var I=A.runKernelFunc(function(S,k){var N=S.fusedConv2d({input:y,filter:m,convInfo:_,bias:w,activation:f,preluActivationWeights:b});return k([m,y,N]),N},E,function(S,k){var T=k[0],W=k[1],L=rs(S,k[2],f);R(ur(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});var H={};return null!=l&&(H={bias:function(){return os(w,L)}}),Object.assign({x:function(){return Ul(W.shape,L,T,t,o)},filter:function(){return Yi(W,L,T.shape,t,o)}},H)},"FusedConv2D",{convInfo:_,activation:f},[m,y],[!0]);return x?I.as3D(I.shape[1],I.shape[2],I.shape[3]):I}}),gg=D({fusedDepthwiseConv2d_:function(r){var n=r.x,e=r.filter,t=r.strides,o=r.pad,a=r.dataFormat,i=void 0===a?"NHWC":a,s=r.dilations,u=void 0===s?[1,1]:s,c=r.dimRoundingMode,l=r.bias,h=r.activation,f=void 0===h?"linear":h,d=r.preluActivationWeights;if(!1===ns(A.state.gradientDepth,f)){var p=ha(n,e,t,o,i,u,c);return null!=l&&(p=we(p,l)),as(p,f,d)}var g=C(n,"x","depthwiseConv2d"),m=C(e,"filter","depthwiseConv2d"),y=g,x=!1;3===g.rank&&(x=!0,y=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),R(4===y.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+y.rank+"."}),R(4===m.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+m.rank+"."}),R(y.shape[3]===m.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+y.shape[3]+") must match the inChannels dimension in filter "+m.shape[2]+"."}),null==u&&(u=[1,1]),R(_t(t,u),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+u+"'"}),null!=c&&R(Ve(o),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+c+" but got pad "+o+"."});var w,b,_=zn(y.shape,m.shape,t,u,o,c,!0);null!=l&&(w=Ue(w=C(l,"bias","fused conv2d"),g)[0],xe(_.outShape,w.shape)),null!=d&&(b=C(d,"prelu weights","fused depthwiseConv2d"));var E={x:y,filter:m};null!=l&&(E.bias=w),null!=d&&(E.preluActivationWeights=b);var I=A.runKernelFunc(function(S,k){var N=S.fusedDepthwiseConv2D({input:y,filter:m,convInfo:_,bias:w,activation:f,preluActivationWeights:b});return k([m,y,N]),N},E,function(S,k){R(ur(u),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+u+"'"});var N=k[0],T=k[1],B=rs(S,k[2],f),L={};return null!=l&&(L={bias:function(){return os(w,B)}}),Object.assign({x:function(){return Vl(T.shape,B,N,_)},filter:function(){return Gl(T,B,N.shape,_)}},L)},"FusedDepthwiseConv2D",{convInfo:_,activation:f},[m,y],[!0]);return x?I.as3D(I.shape[1],I.shape[2],I.shape[3]):I}}),yg=Object.freeze({matMul:vg,conv2d:mg,depthwiseConv2d:gg}),bg=Object.freeze({image:ts,linalg:sg,losses:rg,spectral:Gm,fused:yg,signal:Xm,square:Zp,squaredDifference:_l,conv1d:um,conv2d:Wt,conv3d:cm,depthwiseConv2d:ha,separableConv2d:$i,conv2dTranspose:lm,conv3dTranspose:hm,op:D,batchNormalization2d:Fv,batchNormalization3d:Av,batchNormalization4d:Dv,batchNormalization:Tv,batchNorm:Il,batchNorm2d:Nv,batchNorm3d:Pv,batchNorm4d:Mv,booleanMaskAsync:function(r,n,e){return Q(this,void 0,void 0,function(){var t,o,a,i,s,u,c,l,h,f,d,p,g;return ee(this,function(m){switch(m.label){case 0:for(t=C(r,"tensor","boolMask"),o=C(n,"mask","boolMask","bool"),a=null==e?0:e,s=t.shape,R((i=o.rank)>0,function(){return"mask cannot be scalar"}),Re(s.slice(a,a+i),o.shape,"mask's shape must match the first K dimensions of tensor's shape,"),u=1,c=a;c<a+i;c++)u*=s[c];return l=s.slice(0,a).concat([u],s.slice(a+i)),h=t.reshape(l),f=o.reshape([-1]),[4,Al(f)];case 1:return d=m.sent(),p=d.squeeze([1]),g=Xi(h,p,a),r!==t&&t.dispose(),n!==o&&o.dispose(),p.dispose(),h.dispose(),f.dispose(),d.dispose(),[2,g]}})})},complex:dt,real:Bt,imag:rn,concat:nt,concat1d:Uf,concat2d:Vf,concat3d:Gf,concat4d:zf,split:bi,matMul:fa,dot:fm,outerProduct:dm,reverse:yo,reverse1d:pm,reverse2d:vm,reverse3d:mm,reverse4d:gm,maxPool:st,avgPool:bo,pool:ym,maxPool3d:bm,avgPool3d:xm,slice:an,slice1d:wm,slice2d:_m,slice3d:Hl,slice4d:Cm,abs:ev,acos:tv,acosh:nv,asin:rv,asinh:ov,atan:av,atanh:iv,ceil:sv,clipByValue:ji,cos:uv,cosh:cv,erf:lv,exp:Hi,expm1:hv,floor:fv,log:dv,log1p:pv,logSigmoid:vv,neg:ia,reciprocal:mv,round:gv,rsqrt:Cl,sigmoid:El,sign:yv,isNaN:bv,isInf:xv,isFinite:wv,sin:_v,sinh:Cv,softplus:Ev,sqrt:Rv,step:Sv,tan:kv,tanh:Iv,all:Em,any:Rm,argMax:Sm,argMin:km,logSumExp:Im,max:da,mean:Fm,min:Am,moments:Dm,sum:Xl,prod:Tm,equal:Nl,equalStrict:Jv,greater:Qv,greaterEqual:Pl,greaterEqualStrict:Zv,greaterStrict:em,less:tm,lessEqual:nm,lessEqualStrict:rm,lessStrict:om,notEqual:am,notEqualStrict:im,add:we,addN:Lv,addStrict:Wv,atan2:Uv,div:$t,divNoNan:Vv,divStrict:Gv,floorDiv:Dl,maximum:qi,maximumStrict:zv,minimum:Tl,minimumStrict:jv,mod:Hv,modStrict:qv,mul:yt,mulStrict:Xv,pow:la,powStrict:Kv,squaredDifferenceStrict:Yv,sub:ot,subStrict:$v,elu:Kl,leakyRelu:Nm,prelu:Yl,relu:Ge,relu6:$l,selu:Pm,logicalAnd:ca,logicalNot:Ov,logicalOr:Fl,logicalXor:Bv,where:hr,whereAsync:Al,buffer:de,print:function Qf(r,n){void 0===n&&(n=!1),console.log(r.toString(n))},batchToSpaceND:lc,broadcastTo:Zf,cast:ed,clone:td,cumsum:nd,depthToSpace:rd,expandDims:Lt,eye:hc,multinomial:od,oneHot:wi,pad:sr,pad1d:ad,pad2d:id,pad3d:sd,pad4d:ud,rand:cd,randomNormal:ld,randomGamma:hd,randomUniform:fc,reshape:Kt,spaceToBatchND:dc,squeeze:pc,stack:Nt,tile:Ir,truncatedNormal:fd,unstack:rt,setdiff1dAsync:function(r,n){return Q(this,void 0,void 0,function(){var e,t,o,a,i,s,u,c,l,h;return ee(this,function(f){switch(f.label){case 0:return e=C(r,"x","setdiff1d"),t=C(n,"y","setdiff1d"),R(e.dtype===t.dtype,function(){return"x and y should have the same dtype, but got x ("+e.dtype+") and y ("+t.dtype+")."}),R(1===e.rank,function(){return"x should be 1D tensor, but got x ("+e.shape+")."}),R(1===t.rank,function(){return"y should be 1D tensor, but got y ("+t.shape+")."}),[4,e.data()];case 1:return o=f.sent(),[4,t.data()];case 2:for(a=f.sent(),i=new Set(a),s=0,l=0;l<o.length;l++)i.has(o[l])||s++;for(u=new Zr([s],e.dtype),c=new Zr([s],"int32"),l=0,h=0;l<o.length;l++)i.has(o[l])||(u.values[h]=o[l],c.values[h]=l,h++);return[2,[u.toTensor(),c.toTensor()]]}})})},fill:on,linspace:function Wf(r,n,e){if(e<=0)throw new Error("The number of values should be positive.");return A.runKernelFunc(function(t){return t.linspace(r,n,e)},{})},ones:kr,range:jo,scalar:$,tensor:pt,tensor1d:Ze,tensor2d:Gn,tensor3d:yi,tensor4d:St,tensor5d:function Of(r,n,e){if(tr(r),null!=n&&5!==n.length)throw new Error("tensor5d() requires shape to have five numbers");var t=nn(r,e);if(5!==t.length&&1!==t.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===t.length&&null==n)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return Vn(r,n,t,e)},tensor6d:function Bf(r,n,e){if(tr(r),null!=n&&6!==n.length)throw new Error("tensor6d() requires shape to have six numbers");var t=nn(r,e);if(6!==t.length&&1!==t.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===t.length&&null==n)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return Vn(r,n=n||t,t,e)},variable:function Lf(r,n,e,t){return void 0===n&&(n=!0),A.makeVariable(r,n,e,t)},zeros:Le,onesLike:cc,zerosLike:Se,transpose:jn,softmax:bn,logSoftmax:vd,localResponseNormalization:Mm,norm:Jl,gather:Xi,unsortedSegmentSum:Bl,basicLSTMCell:Om,multiRNNCell:Bm,movingAverage:Lm,stridedSlice:Wm,topk:Um,scatterND:Vm,fft:Ji,ifft:pa,rfft:Qi,irfft:Ql,sparseToDense:zm,gatherND:jm,diag:Hm,dropout:qm,hannWindow:Zi,hammingWindow:eh,frame:es,stft:th,inTopKAsync:function(r,n,e){return void 0===e&&(e=1),Q(this,void 0,void 0,function(){var t,o,a,i,s,u,c,l,h,f,d,p,g,m;return ee(this,function(y){switch(y.label){case 0:return t=C(r,"predictions","inTopK"),o=C(n,"targets","inTopK"),R(t.rank>1,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+t.rank}),R(t.rank-1===o.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+t.rank+" and targets rank "+o.rank}),Re(t.shape.slice(0,t.shape.length-1),o.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),a=t.shape[t.shape.length-1],R(e>0&&e<=a,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+a+"), but got "+e}),[4,t.data()];case 1:return i=y.sent(),[4,o.data()];case 2:for(s=y.sent(),l=(u=[i.length/a,a])[1],h=Cr("bool",c=u[0]),f=0;f<c;f++){for(p=i.subarray(d=f*l,d+l),g=[],m=0;m<p.length;m++)g.push({value:p[m],index:m});for(g.sort(function(x,w){return w.value-x.value}),h[f]=0,m=0;m<e;m++)if(g[m].index===s[f]){h[f]=1;break}}return r!==t&&t.dispose(),n!==o&&o.dispose(),[2,pt(h,o.shape,"bool")]}})})}});function j(r,n){Array.isArray(r)||(r=[r]),r.forEach(function(e){null!=e&&R("complex64"!==e.dtype,function(){return n+" does not support complex64 tensors."})})}function is(r,n,e,t){if("linear"===e)return r.linear(n);if("relu"===e)return r.relu(n);if("elu"===e)return r.elu(n);if("relu6"===e)return r.relu6(n);if("prelu"===e)return r.prelu(n,t);throw new Error("Activation "+e+" has not been implemented for the CPU backend.")}var xg=function(r){function n(){var e=r.call(this)||this;return e.blockSize=48,e.firstUse=!0,e.data=new _c(e,A),e}return Ft(n,r),n.prototype.write=function(e,t,o){this.firstUse&&(this.firstUse=!1,O().get("IS_NODE")&&Go("\n============================\nHi there \u{1f44b}. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var a={};return this.data.set(a,{values:e,dtype:o}),a},n.prototype.move=function(e,t,o,a){this.data.set(e,{values:t,dtype:a})},n.prototype.numDataIds=function(){return this.data.numDataIds()},n.prototype.read=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){return[2,this.readSync(e)]})})},n.prototype.readSync=function(e){var t=this.data.get(e),a=t.complexTensors;return"complex64"===t.dtype?Di(this.readSync(a.real.dataId),this.readSync(a.imag.dataId)):this.data.get(e).values},n.prototype.bufferSync=function(e){var t=this.readSync(e.dataId),o=t;if("string"===e.dtype)try{o=t.map(function(a){return Yr(a)})}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return de(e.shape,e.dtype,o)},n.prototype.makeOutput=function(e,t,o){var a=this.write(e,t,o);return A.makeTensorFromDataId(a,t,o,this)},n.prototype.disposeData=function(e){if(this.data.has(e)){var t=this.data.get(e).complexTensors;null!=t&&(t.real.dispose(),t.imag.dispose()),this.data.delete(e)}},n.prototype.time=function(e){return Q(this,void 0,void 0,function(){var t;return ee(this,function(o){return t=Ht(),e(),[2,{kernelMs:Ht()-t}]})})},n.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},n.prototype.complex=function(e,t){var o=this.makeOutput(null,e.shape,"complex64");return this.data.get(o.dataId).complexTensors={real:A.keep(e.clone()),imag:A.keep(t.clone())},o},n.prototype.real=function(e){return this.data.get(e.dataId).complexTensors.real.clone()},n.prototype.imag=function(e){return this.data.get(e.dataId).complexTensors.imag.clone()},n.prototype.slice=function(e,t,o){if(j(e,"slice"),Ri(e.shape,t,o)){var a=Si(t,e.strides),i=re(o);return pt(this.readSync(e.dataId).subarray(a,a+i),o,e.dtype)}for(var s=de(o,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c).map(function(h,f){return h+t[f]});s.values[c]=u.get.apply(u,l)}return s.toTensor()},n.prototype.stridedSlice=function(e,t,o,a){j(e,"stridedSlice");var i=$o(t,o,a);if(i.some(function(d){return 0===d}))return pt([],i);for(var s=de(i,e.dtype),u=this.bufferSync(e),c=0;c<s.size;c++){for(var l=s.indexToLoc(c),h=new Array(l.length),f=0;f<h.length;f++)h[f]=l[f]*a[f]+t[f];s.set.apply(s,[u.get.apply(u,h)].concat(l))}return s.toTensor()},n.prototype.diag=function(e){for(var t=this.readSync(e.dataId),o=de([e.size,e.size],e.dtype),a=o.values,i=0;i<t.length;i++)a[i*e.size+i]=t[i];return o.toTensor()},n.prototype.unstack=function(e,t){for(var o=e.shape[t],a=new Array(e.rank-1),i=0,s=0;s<e.rank;s++)s!==t&&(a[i++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[t]=1;var l=new Array(o);for(s=0;s<l.length;s++)u[t]=s,l[s]=this.slice(e,u,c).reshape(a);return l},n.prototype.reverse=function(e,t){j(e,"reverse");for(var o=de(e.shape,e.dtype),a=this.bufferSync(e),i=function(u){var c=o.indexToLoc(u),l=c.slice();t.forEach(function(h){return l[h]=e.shape[h]-1-l[h]}),o.set.apply(o,[a.get.apply(a,l)].concat(c))},s=0;s<o.size;s++)i(s);return o.toTensor()},n.prototype.concat=function(e,t){var o=this;if("complex64"===e[0].dtype){var a=e.map(function(d){return Bt(d)}),i=e.map(function(d){return rn(d)});return dt(this.concat(a,t),this.concat(i,t))}var s=e.map(function(d){var p=re(d.shape.slice(t));return d.as2D(-1,p)}),u=or(s.map(function(d){return d.shape}),1),c=de(u,e[0].dtype).values;if(1===s[0].shape[0]){var l=0;s.forEach(function(d){c.set(o.readSync(d.dataId),l),l+=d.size})}else{var h=0;s.forEach(function(d){for(var p=o.readSync(d.dataId),g=0,m=0;m<d.shape[0];++m)for(var y=m*u[1]+h,x=0;x<d.shape[1];++x)c[y+x]=p[g++];h+=d.shape[1]})}var f=or(e.map(function(d){return d.shape}),t);return pt(c,f,e[0].dtype)},n.prototype.neg=function(e){return j(e,"neg"),this.multiply($(-1),e)},n.prototype.add=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(o,a,i,s){return{real:o+i,imag:a+s}}):this.broadcastedBinaryOp(e,t,it(e.dtype,t.dtype),function(o,a){return o+a})},n.prototype.addN=function(e){var t=this;j(e,"addN");for(var o=e.map(function(l){return t.readSync(l.dataId)}),a=de(e[0].shape,e[0].dtype),i=a.values,s=0;s<e.length;s++)for(var u=o[s],c=0;c<i.length;c++)i[c]+=u[c];return a.toTensor()},n.prototype.softmax=function(e,t){var o=Qe([t],e.shape),a=this.max(e,o),i=wt(a.shape,o),s=this.subtract(e,a.reshape(i)),u=this.exp(s),c=this.sum(u,o).reshape(i);return this.realDivide(u,c)},n.prototype.subtract=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(o,a,i,s){return{real:o-i,imag:a-s}}):this.broadcastedBinaryOp(e,t,it(e.dtype,t.dtype),function(o,a){return o-a})},n.prototype.pow=function(e,t){return j([e,t],"pow"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){return Math.pow(o,a)})},n.prototype.batchMatMul=function(e,t,o,a){j([e,t],"matMul");for(var i=o?e.shape[1]:e.shape[2],s=o?e.shape[2]:e.shape[1],u=a?t.shape[1]:t.shape[2],c=e.shape[0],l=this.readSync(e.dataId),h=this.readSync(t.dataId),f=o?[e.strides[0],1,e.strides[1]]:[e.strides[0],e.strides[1],1],d=f[0],p=f[1],g=f[2],m=a?[1,t.strides[1],t.strides[0]]:[t.strides[1],1,t.strides[0]],y=m[0],x=m[1],w=m[2],b=s*u,_=de([c,s,u],e.dtype),E=_.values,F=this.blockSize,I=0;I<c;I++)for(var S=0;S<s;S+=F)for(var k=0;k<u;k+=F)for(var N=0;N<i;N+=F)for(var T=Math.min(S+F,s),W=Math.min(k+F,u),B=Math.min(N+F,i),L=S;L<T;L++)for(var H=k;H<W;H++){for(var G=0,U=N;U<B;U++)G+=l[I*d+L*p+U*g]*h[U*y+H*x+I*w];E[I*b+(L*u+H)]+=G}return _.toTensor()},n.prototype.fusedBatchMatMul=function(e){var s=e.bias,u=e.activation,c=e.preluActivationWeights,l=this.batchMatMul(e.a,e.b,e.transposeA,e.transposeB);return s&&(l=this.add(l,s)),u&&(l=is(this,l,u,c)),l},n.prototype.multiply=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(o,a,i,s){return{real:o*i-a*s,imag:o*s+a*i}}):this.broadcastedBinaryOp(e,t,it(e.dtype,t.dtype),function(o,a){return o*a})},n.prototype.realDivide=function(e,t){return j([e,t],"realDivide"),this.broadcastedBinaryOp(e,t,"float32",function(o,a){return o/a})},n.prototype.floorDiv=function(e,t){return j([e,t],"floorDiv"),this.broadcastedBinaryOp(e,t,"int32",function(o,a){return Math.floor(o/a)})},n.prototype.sum=function(e,t){j(e,"sum"),Rt("sum",t,e.rank);for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],it(e.dtype,"int32")),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=0,p=0;p<u;++p)d+=l[f+p];c[h]=d}return s},n.prototype.prod=function(e,t){j(e,"sum");for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],it(e.dtype,"int32")),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=1,p=0;p<u;++p)d*=l[f+p];c[h]=d}return s},n.prototype.unsortedSegmentSum=function(e,t,o){j(e,"unsortedSegmentSum");for(var a=[],i=e.rank-t.rank,s=0;s<i;++s)t=t.expandDims(s+1);for(s=0;s<o;++s){var u=$(s,"int32"),c=Nl(u,t).asType("float32").mul(e).sum(0);a.push(c)}return Nt(a)},n.prototype.argMin=function(e,t){j(e,"argMin");var o=[t];Rt("argMin",o,e.rank);for(var a=ft(e.shape,o),s=a[1],u=Le(a[0],"int32"),c=re(s),l=this.readSync(u.dataId),h=this.readSync(e.dataId),f=0;f<l.length;++f){for(var d=f*c,p=h[d],g=0,m=0;m<c;++m){var y=h[d+m];y<p&&(p=y,g=m)}l[f]=g}return u},n.prototype.argMax=function(e,t){j(e,"argMax");var o=[t];Rt("argMax",o,e.rank);for(var a=ft(e.shape,o),s=a[1],u=Le(a[0],"int32"),c=re(s),l=this.readSync(u.dataId),h=this.readSync(e.dataId),f=0;f<l.length;++f){for(var d=f*c,p=h[d],g=0,m=0;m<c;++m){var y=h[d+m];y>p&&(p=y,g=m)}l[f]=g}return u},n.prototype.cumsum=function(e,t,o,a){if(j(e,"cumsum"),t!==e.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(e.rank-1)+" but got axis="+t);for(var i=it(e.dtype,"int32"),s=Le(e.shape,i),u=this.readSync(s.dataId),c=this.readSync(e.dataId),l=e.shape[e.rank-1],h=a?function(m,y){return m+l-y-1}:function(m,y){return m+y},f=0;f<c.length;f+=l)for(var d=0;d<l;d++){var p=h(f,d);if(0===d)u[p]=o?0:c[p];else{var g=h(f,d-1);u[p]=o?c[g]+u[g]:c[p]+u[g]}}return s},n.prototype.equal=function(e,t){return j([e,t],"equal"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o===a?1:0})},n.prototype.notEqual=function(e,t){return j([e,t],"notEqual"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o!==a?1:0})},n.prototype.less=function(e,t){return j([e,t],"less"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o<a?1:0})},n.prototype.lessEqual=function(e,t){return j([e,t],"lessEqual"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o<=a?1:0})},n.prototype.greater=function(e,t){return j([e,t],"greater"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o>a?1:0})},n.prototype.greaterEqual=function(e,t){return j([e,t],"greaterEqual"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o>=a?1:0})},n.prototype.logicalNot=function(e){j(e,"logicalNot");for(var t=this.readSync(e.dataId),o=new Uint8Array(t.length),a=0;a<t.length;++a)o[a]=t[a]?0:1;return this.makeOutput(o,e.shape,"bool")},n.prototype.logicalAnd=function(e,t){return j([e,t],"logicalAnd"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o&&a})},n.prototype.logicalOr=function(e,t){return j([e,t],"logicalOr"),this.broadcastedBinaryOp(e,t,"bool",function(o,a){return o||a})},n.prototype.select=function(e,t,o){j([e,t,o],"select");for(var a=this.readSync(e.dataId),i=this.readSync(t.dataId),s=this.readSync(o.dataId),u=Le(t.shape,it(t.dtype,o.dtype)),c=this.readSync(u.dataId),l=0,h=0===e.rank||e.rank>1||1===t.rank?1:re(t.shape.slice(1)),f=0;f<a.length;f++)for(var d=0;d<h;d++)c[l++]=1===a[f]?i[f]:s[f];return u},n.prototype.where=function(e){j([e],"where");var t=this.readSync(e.dataId);return Pi(e.shape,t)},n.prototype.topk=function(e,t,o){return j(e,"topk"),Fc(this.readSync(e.dataId),e.shape,e.dtype,t)},n.prototype.min=function(e,t){j(e,"min"),Rt("min",t,e.rank);for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],e.dtype),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p){var g=l[f+p];g<d&&(d=g)}c[h]=d}return s},n.prototype.minimum=function(e,t){return j([e,t],"minimum"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){return Math.min(o,a)})},n.prototype.mod=function(e,t){return j([e,t],"mod"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){var i=o%a;return o<0&&a<0||o>=0&&a>=0?i:(i+a)%a})},n.prototype.max=function(e,t){j(e,"max"),Rt("max",t,e.rank);for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],e.dtype),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p){var g=l[f+p];g>d&&(d=g)}c[h]=d}return s},n.prototype.maximum=function(e,t){return j([e,t],"maximum"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){return Math.max(o,a)})},n.prototype.all=function(e,t){j(e,"all"),Rt("all",t,e.rank);for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],e.dtype),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p)d=d&&l[f+p];c[h]=d}return s},n.prototype.any=function(e,t){j(e,"any"),Rt("any",t,e.rank);for(var o=ft(e.shape,t),i=o[1],s=Le(o[0],e.dtype),u=re(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p)d=d||l[f+p];c[h]=d}return s},n.prototype.squaredDifference=function(e,t){return j([e,t],"squaredDifference"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){var i=o-a;return i*i})},n.prototype.ceil=function(e){j(e,"ceil");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.ceil(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.floor=function(e){j(e,"floor");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.floor(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.sign=function(e){j(e,"x");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=t[a]<0?-1:t[a]>0?1:0;return this.makeOutput(o,e.shape,"float32")},n.prototype.isNaN=function(e){j(e,"x");for(var t=this.readSync(e.dataId),o=new Uint8Array(t.length),a=0;a<t.length;++a)Number.isNaN(t[a])&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},n.prototype.isInf=function(e){j(e,"x");for(var t=this.readSync(e.dataId),o=new Uint8Array(t.length),a=0;a<t.length;++a)Math.abs(t[a])===1/0&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},n.prototype.isFinite=function(e){j(e,"x");for(var t=this.readSync(e.dataId),o=new Uint8Array(t.length),a=0;a<t.length;++a)Number.isFinite(t[a])&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},n.prototype.round=function(e){j(e,"round");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a){var i=Math.floor(t[a]);o[a]=t[a]-i<.5?Math.floor(t[a]):t[a]-i>.5?Math.ceil(t[a]):i%2==0?i:i+1}return this.makeOutput(o,e.shape,"float32")},n.prototype.exp=function(e){j(e,"exp");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.exp(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.expm1=function(e){j(e,"expm1");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.expm1(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.log=function(e){j(e,"log");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.log(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.log1p=function(e){j(e,"log1p");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.log1p(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.sqrt=function(e){j(e,"sqrt");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=Math.sqrt(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.rsqrt=function(e){j(e,"rsqrt");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=1/Math.sqrt(t[a]);return this.makeOutput(o,e.shape,"float32")},n.prototype.reciprocal=function(e){j(e,"reciprocal");for(var t=this.readSync(e.dataId),o=new Float32Array(t.length),a=0;a<t.length;++a)o[a]=1/t[a];return this.makeOutput(o,e.shape,"float32")},n.prototype.linear=function(e){return e},n.prototype.relu=function(e){j(e,"relu");for(var t=Le(e.shape,e.dtype),o=this.readSync(t.dataId),a=this.readSync(e.dataId),i=0;i<a.length;++i)o[i]=Math.max(0,a[i]);return t},n.prototype.relu6=function(e){j(e,"relu");for(var t=Le(e.shape,e.dtype),o=this.readSync(t.dataId),a=this.readSync(e.dataId),i=0;i<a.length;++i)o[i]=Math.min(Math.max(0,a[i]),6);return t},n.prototype.prelu=function(e,t){return j([e,t],"prelu"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){return o<0?a*o:o})},n.prototype.elu=function(e){j(e,"elu");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var i=o[a];t[a]=i>=0?i:Math.exp(i)-1}return this.makeOutput(t,e.shape,"float32")},n.prototype.eluDer=function(e,t){j([e,t],"eluDer");for(var o=new Float32Array(t.size),a=this.readSync(t.dataId),i=this.readSync(e.dataId),s=0;s<a.length;++s){var u=a[s];o[s]=u>=1?i[s]:i[s]*(u+1)}return this.makeOutput(o,t.shape,"float32")},n.prototype.selu=function(e){j(e,"selu");for(var t=Gi,o=zi,a=new Float32Array(e.size),i=this.readSync(e.dataId),s=0;s<i.length;++s){var u=i[s];a[s]=u>=0?o*u:t*(Math.exp(u)-1)}return this.makeOutput(a,e.shape,"float32")},n.prototype.clip=function(e,t,o){j(e,"clip");for(var a=new Float32Array(e.size),i=this.readSync(e.dataId),s=0;s<i.length;++s){var u=i[s];a[s]=u>o?o:u<t?t:u}return this.makeOutput(a,e.shape,"float32")},n.prototype.abs=function(e){for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.abs(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.complexAbs=function(e){for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<e.size;++a)t[a]=Math.hypot(o[2*a],o[2*a+1]);return this.makeOutput(t,e.shape,"float32")},n.prototype.int=function(e){j(e,"int");for(var t=new Int32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=o[a];return this.makeOutput(t,e.shape,"int32")},n.prototype.sigmoid=function(e){j(e,"sigmoid");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=1/(1+Math.exp(-o[a]));return this.makeOutput(t,e.shape,"float32")},n.prototype.softplus=function(e){j(e,"softplus");for(var t=Math.log(1.1920928955078125e-7)+2,o=new Float32Array(e.size),a=this.readSync(e.dataId),i=0;i<a.length;++i){var l,s=a[i]>-t,u=a[i]<t,c=Math.exp(a[i]);l=u?c:s?a[i]:Math.log(1+c),o[i]=l}return this.makeOutput(o,e.shape,"float32")},n.prototype.sin=function(e){j(e,"sin");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.sin(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.cos=function(e){j(e,"cos");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.cos(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.tan=function(e){j(e,"tan");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.tan(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.asin=function(e){j(e,"asin");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.asin(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.acos=function(e){j(e,"acos");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.acos(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.atan=function(e){j(e,"atan");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.atan(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.atan2=function(e,t){return j([e,t],"atan2"),this.broadcastedBinaryOp(e,t,e.dtype,function(o,a){return Math.atan2(o,a)})},n.prototype.sinh=function(e){j(e,"sinh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.sinh(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.cosh=function(e){j(e,"cosh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.cosh(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.tanh=function(e){j(e,"tanh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=gu(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.asinh=function(e){j(e,"asinh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.asinh(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.acosh=function(e){j(e,"acosh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.acosh(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.atanh=function(e){j(e,"atanh");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)t[a]=Math.atanh(o[a]);return this.makeOutput(t,e.shape,"float32")},n.prototype.erf=function(e){j(e,"erf");for(var t=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var i=Math.sign(o[a]),s=Math.abs(o[a]),u=1/(1+.3275911*s);t[a]=i*(1-((((1.061405429*u-1.453152027)*u+1.421413741)*u-.284496736)*u+.254829592)*u*Math.exp(-s*s))}return this.makeOutput(t,e.shape,"float32")},n.prototype.step=function(e,t){void 0===t&&(t=0),j(e,"step");for(var o=new Float32Array(e.size),a=this.readSync(e.dataId),i=0;i<a.length;++i){var s=a[i];o[i]=isNaN(s)?NaN:s>0?1:t}return this.makeOutput(o,e.shape,"float32")},n.prototype.fusedConv2d=function(e){var i=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.conv2d(e.input,e.filter,e.convInfo);return i&&(c=this.add(c,i)),s&&(c=is(this,c,s,u)),c},n.prototype.conv2d=function(e,t,o){j([e,t],"conv2d");for(var a=o.filterHeight,i=o.filterWidth,s=o.dilationHeight,u=o.dilationWidth,c=o.padInfo.left,l=o.padInfo.top,h="channelsLast"===o.dataFormat,f=de(o.outShape,e.dtype),d=e.strides[0],p=h?e.strides[1]:e.strides[2],g=h?e.strides[2]:1,m=h?1:e.strides[1],y=f.strides[0],x=h?f.strides[1]:f.strides[2],w=h?f.strides[2]:1,b=h?1:f.strides[1],_=this.readSync(e.dataId),E=this.readSync(t.dataId),F=f.values,I=0;I<o.batchSize;++I)for(var S=I*d,k=I*y,N=0;N<o.outHeight;++N)for(var T=k+N*x,W=N*o.strideHeight-l,B=0;B<a;B++){var L=W+B*s;if(!(L<0||L>=o.inHeight))for(var H=B*t.strides[0],G=S+L*p,U=0;U<o.outWidth;++U)for(var q=T+U*w,X=U*o.strideWidth-c,J=0;J<i;J++){var ie=X+J*u;if(!(ie<0||ie>=o.inWidth))for(var ue=G+ie*g,ye=H+J*t.strides[1],be=0;be<o.inChannels;++be){for(var _e=_[ue+be*m],ke=0;ke<o.outChannels;++ke)F[q+ke*b]+=_e*E[ye+ke];ye+=o.outChannels}}}return f.toTensor()},n.prototype.conv3d=function(e,t,o){for(var a=o.filterDepth,i=o.filterHeight,s=o.filterWidth,u=o.dilationDepth,c=o.dilationHeight,l=o.dilationWidth,h=o.padInfo.front,f=o.padInfo.left,d=o.padInfo.top,p=de(o.outShape,e.dtype),g=this.readSync(e.dataId),m=this.readSync(t.dataId),y=p.values,x=0;x<o.batchSize;++x)for(var w=x*e.strides[0],b=x*p.strides[0],_=0;_<o.outDepth;++_)for(var E=b+_*p.strides[1],F=_*o.strideDepth-h,I=0;I<a;I++){var S=F+I*u;if(!(S<0||S>=o.inDepth))for(var k=I*t.strides[0],N=w+S*e.strides[1],T=0;T<o.outHeight;++T)for(var W=E+T*p.strides[2],B=T*o.strideHeight-d,L=0;L<i;L++){var H=B+L*c;if(!(H<0||H>=o.inHeight))for(var G=k+L*t.strides[1],U=N+H*e.strides[2],q=0;q<o.outWidth;++q)for(var X=W+q*o.outChannels,J=q*o.strideWidth-f,ie=0;ie<s;ie++){var ue=J+ie*l;if(!(ue<0||ue>=o.inWidth))for(var be=U+ue*o.inChannels,_e=G+ie*t.strides[2],ke=0;ke<o.inChannels;++ke){for(var Ce=g[be+ke],Ie=0;Ie<o.outChannels;++Ie)y[X+Ie]+=Ce*m[_e+Ie];_e+=o.outChannels}}}}return p.toTensor()},n.prototype.conv2dDerInput=function(e,t,o){j([e,t],"conv2dDerInput");for(var a=de(o.inShape,"float32"),i=a.values,s=this.readSync(e.dataId),u=this.readSync(t.dataId),c=t.strides,l=c[0],h=c[1],f=c[2],d=o.batchSize,p=o.filterHeight,g=o.filterWidth,m=o.inChannels,y=o.inHeight,x=o.inWidth,w=o.outChannels,b=o.outHeight,_=o.outWidth,E=o.strideHeight,F=o.strideWidth,S=p-1-o.padInfo.top,k=g-1-o.padInfo.left,N="channelsLast"===o.dataFormat,T=a.strides[0],W=N?a.strides[1]:a.strides[2],B=N?a.strides[2]:1,L=N?1:a.strides[1],H=e.strides[0],G=N?e.strides[1]:e.strides[2],U=N?e.strides[2]:1,q=N?1:e.strides[1],X=0;X<d;++X)for(var J=0;J<m;++J)for(var ie=0;ie<y;++ie)for(var ue=ie-S,ye=Math.max(0,Math.ceil(ue/E)),be=Math.min(b,(p+ue)/E),_e=0;_e<x;++_e){for(var ke=_e-k,Ce=Math.max(0,Math.ceil(ke/F)),Ie=Math.min(_,(g+ke)/F),$e=0,Ee=ye;Ee<be;++Ee)for(var Pe=Ee*E-ue,Ae=Ce;Ae<Ie;++Ae)for(var Ke=H*X+G*Ee+U*Ae,ze=l*(p-1-Pe)+h*(g-1-(Ae*F-ke))+f*J,je=0;je<w;++je)$e+=s[Ke+q*je]*u[ze+je];i[T*X+W*ie+B*_e+L*J]=$e}return a.toTensor()},n.prototype.conv3dDerInput=function(e,t,o){for(var a=de(o.inShape,"float32"),i=a.values,s=a.strides,u=s[0],c=s[1],l=s[2],h=s[3],f=this.readSync(e.dataId),d=e.strides,p=d[0],g=d[1],m=d[2],y=d[3],x=this.readSync(t.dataId),w=t.strides,b=w[0],_=w[1],E=w[2],F=w[3],I=o.batchSize,S=o.filterDepth,k=o.filterHeight,N=o.filterWidth,T=o.inChannels,W=o.inDepth,B=o.inHeight,L=o.inWidth,H=o.outChannels,G=o.outDepth,U=o.outHeight,q=o.outWidth,X=o.strideDepth,J=o.strideHeight,ie=o.strideWidth,ue=S-1-o.padInfo.front,ye=k-1-o.padInfo.top,be=N-1-o.padInfo.left,_e=0;_e<I;++_e)for(var ke=0;ke<T;++ke)for(var Ce=0;Ce<W;++Ce)for(var Ie=Ce-ue,$e=Math.max(0,Math.ceil(Ie/X)),Ee=Math.min(G,(S+Ie)/X),Pe=0;Pe<B;++Pe)for(var Ae=Pe-ye,Ke=Math.max(0,Math.ceil(Ae/J)),ze=Math.min(U,(k+Ae)/J),je=0;je<L;++je){for(var fn=je-be,dn=Math.max(0,Math.ceil(fn/ie)),Ot=Math.min(q,(N+fn)/ie),jr=0,In=$e;In<Ee;++In)for(var Qn=In*X-Ie,Fn=Ke;Fn<ze;++Fn)for(var Hr=Fn*J-Ae,An=dn;An<Ot;++An)for(var ou=p*_e+g*In+m*Fn+y*An,qr=b*(S-1-Qn)+_*(k-1-Hr)+E*(N-1-(An*ie-fn))+F*ke,pn=0;pn<H;++pn)jr+=f[ou+pn]*x[qr+pn];i[u*_e+c*Ce+l*Pe+h*je+ke]=jr}return a.toTensor()},n.prototype.conv2dDerFilter=function(e,t,o){j([e,t],"conv2dDerFilter");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c="channelsLast"===o.dataFormat,l=de(o.filterShape,"float32"),h=o.padInfo.left,f=o.padInfo.top,d=this.bufferSync(e),p=this.bufferSync(t),g=0;g<s;++g)for(var m=Math.max(0,Math.ceil((f-g)/a)),y=Math.min(o.outHeight,(o.inHeight+f-g)/a),x=0;x<u;++x)for(var w=Math.max(0,Math.ceil((h-x)/i)),b=Math.min(o.outWidth,(o.inWidth+h-x)/i),_=0;_<o.inChannels;++_)for(var E=0;E<o.outChannels;++E){for(var F=0,I=0;I<o.batchSize;++I)for(var S=m;S<y;++S)for(var k=g+S*a-f,N=w;N<b;++N){var T=x+N*i-h;F+=c?d.get(I,k,T,_)*p.get(I,S,N,E):d.get(I,_,k,T)*p.get(I,E,S,N)}l.set(F,g,x,_,E)}return l.toTensor()},n.prototype.conv3dDerFilter=function(e,t,o){for(var a=o.strideDepth,i=o.strideHeight,s=o.strideWidth,u=o.filterDepth,c=o.filterHeight,l=o.filterWidth,h=de(o.filterShape,"float32"),f=h.values,d=h.strides,p=d[0],g=d[1],m=d[2],y=d[3],x=this.readSync(t.dataId),w=t.strides,b=w[0],_=w[1],E=w[2],F=w[3],I=this.readSync(e.dataId),S=e.strides,k=S[0],N=S[1],T=S[2],W=S[3],B=o.padInfo.front,L=o.padInfo.left,H=o.padInfo.top,G=0;G<u;++G)for(var U=Math.max(0,Math.ceil((B-G)/a)),q=Math.min(o.outDepth,(o.inDepth+B-G)/a),X=G*p,J=0;J<c;++J)for(var ie=Math.max(0,Math.ceil((H-J)/i)),ue=Math.min(o.outHeight,(o.inHeight+H-J)/i),ye=J*g+X,be=0;be<l;++be)for(var _e=Math.max(0,Math.ceil((L-be)/s)),ke=Math.min(o.outWidth,(o.inWidth+L-be)/s),Ce=be*m+ye,Ie=0;Ie<o.inChannels;++Ie)for(var $e=Ie*y+Ce,Ee=0;Ee<o.outChannels;++Ee){for(var Pe=0,Ae=0;Ae<o.batchSize;++Ae)for(var Ke=Ae*k,ze=Ae*b,je=U;je<q;++je)for(var fn=(G+je*a-B)*N+Ke,dn=je*_+ze,Ot=ie;Ot<ue;++Ot)for(var jr=(J+Ot*i-H)*T+fn,In=Ot*E+dn,Qn=_e;Qn<ke;++Qn)Pe+=I[(be+Qn*s-L)*W+jr+Ie]*x[Qn*F+In+Ee];f[$e+Ee]=Pe}return h.toTensor()},n.prototype.fusedDepthwiseConv2D=function(e){var i=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.depthwiseConv2D(e.input,e.filter,e.convInfo);return i&&(c=this.add(c,i)),s&&(c=is(this,c,s,u)),c},n.prototype.depthwiseConv2D=function(e,t,o){j([e,t],"depthwiseConv2D");for(var a=o.filterHeight,i=o.filterWidth,s=o.dilationHeight,u=o.dilationWidth,c=o.padInfo.left,l=o.padInfo.top,h=o.outChannels/o.inChannels,f=de(o.outShape,e.dtype),d=this.readSync(e.dataId),p=this.readSync(t.dataId),g=f.values,m=0;m<o.batchSize;++m)for(var y=m*e.strides[0],x=m*f.strides[0],w=0;w<o.outHeight;++w)for(var b=x+w*f.strides[1],_=w*o.strideHeight-c,E=0;E<a;++E){var F=_+E*s;if(!(F<0||F>=o.inHeight))for(var I=E*t.strides[0],S=y+F*e.strides[1],k=0;k<o.outWidth;++k)for(var N=b+k*f.strides[2],T=k*o.strideWidth-l,W=0;W<i;++W){var B=T+W*u;if(!(B<0||B>=o.inWidth))for(var H=S+B*o.inChannels,G=N,U=I+W*t.strides[1],q=0;q<o.inChannels;++q){for(var X=d[H+q],J=0;J<h;++J)g[G+J]+=X*p[U+J];G+=h,U+=h}}}return f.toTensor()},n.prototype.depthwiseConv2DDerInput=function(e,t,o){j([e,t],"depthwiseConv2DDerInput");for(var a=de(o.inShape,"float32"),i=a.values,s=a.strides,u=s[0],c=s[1],l=s[2],h=this.readSync(e.dataId),f=e.strides,d=f[0],p=f[1],g=f[2],m=this.readSync(t.dataId),y=t.strides,x=y[0],w=y[1],b=y[2],_=o.batchSize,E=o.filterHeight,F=o.filterWidth,I=o.inChannels,S=o.inHeight,k=o.inWidth,T=o.outHeight,W=o.outWidth,B=o.strideHeight,L=o.strideWidth,H=E-1-o.padInfo.top,G=F-1-o.padInfo.left,U=o.outChannels/I,q=0;q<_;++q)for(var X=0;X<I;++X)for(var J=0;J<S;++J)for(var ie=J-H,ue=Math.max(0,Math.ceil(ie/B)),ye=Math.min(T,(E+ie)/B),be=0;be<k;++be){for(var _e=be-G,ke=Math.max(0,Math.ceil(_e/L)),Ce=Math.min(W,(F+_e)/L),Ie=0,$e=ue;$e<ye;++$e)for(var Ee=$e*B-ie,Pe=ke;Pe<Ce;++Pe)for(var Ae=d*q+p*$e+g*Pe,Ke=x*(E-1-Ee)+w*(F-1-(Pe*L-_e))+b*X,ze=0;ze<U;++ze)Ie+=h[Ae+(X*U+ze)]*m[Ke+ze];i[u*q+c*J+l*be+X]=Ie}return a.toTensor()},n.prototype.depthwiseConv2DDerFilter=function(e,t,o){j([e,t],"depthwiseConv2DDerFilter");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c=de(o.filterShape,"float32"),l=o.padInfo.left,h=o.padInfo.top,f=o.outChannels/o.inChannels,d=this.bufferSync(e),p=this.bufferSync(t),g=0;g<s;++g)for(var m=Math.max(0,Math.ceil((h-g)/a)),y=Math.min(o.outHeight,(o.inHeight+h-g)/a),x=0;x<u;++x)for(var w=Math.max(0,Math.ceil((l-x)/i)),b=Math.min(o.outWidth,(o.inWidth+l-x)/i),_=0;_<o.outChannels;++_){for(var E=Math.trunc(_/f),F=_%f,I=0,S=0;S<o.batchSize;++S)for(var k=m;k<y;++k)for(var N=g+k*a-h,T=w;T<b;++T)I+=d.get(S,N,x+T*i-l,E)*p.get(S,k,T,_);c.set(I,g,x,E,F)}return c.toTensor()},n.prototype.tile=function(e,t){return j(e,"tile"),Ic(this.bufferSync(e),t)},n.prototype.pad=function(e,t,o){j(e,"pad");var a=t.map(function(f,d){return f[0]+e.shape[d]+f[1]}),i=t.map(function(f){return f[0]}),s=this.bufferSync(e),u=de(a,e.dtype);0!==o&&u.values.fill(o);for(var c=0;c<e.size;c++){var l=s.indexToLoc(c),h=l.map(function(f,d){return f+i[d]});u.set.apply(u,[s.get.apply(s,l)].concat(h))}return u.toTensor()},n.prototype.transpose=function(e,t){j(e,"transpose");for(var o=new Array(e.rank),a=0;a<o.length;a++)o[a]=e.shape[t[a]];var i=this.readSync(e.dataId),s=de(o,e.dtype),u=this.bufferSync(e);for(a=0;a<e.size;++a){for(var c=u.indexToLoc(a),l=new Array(c.length),h=0;h<l.length;h++)l[h]=c[t[h]];var f=s.locToIndex(l);s.values[f]=i[a]}return s.toTensor()},n.prototype.gather=function(e,t,o){j([e,t],"gather");var a=e.shape.slice(),i=this.readSync(t.dataId);a[o]=i.length;for(var s=de(a,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c),h=l.slice();h[o]=i[l[o]];var f=u.locToIndex(h);s.values[c]=u.values[f]}return s.toTensor()},n.prototype.batchToSpaceND=function(e,t,o){j([e],"batchToSpaceND");var a=t.reduce(function(h,f){return h*f}),i=qo(e.shape,t,a),s=Xo(i.length,t.length),u=Ko(e.shape,t,a),c=vc(o,t.length),l=mc(u,o,t.length);return e.reshape(i).transpose(s).reshape(u).slice(c,l)},n.prototype.spaceToBatchND=function(e,t,o){j([e],"spaceToBatchND");var a=t.reduce(function(f,d){return f*d}),i=[[0,0]];i.push.apply(i,o);for(var s=1+t.length;s<e.shape.length;++s)i.push([0,0]);var u=e.pad(i),c=qo(u.shape,t,a,!1),l=Xo(c.length,t.length,!1),h=Ko(u.shape,t,a,!1);return u.reshape(c).transpose(l).reshape(h)},n.prototype.pool=function(e,t,o){j(e,"pool");for(var a=t.strideHeight,i=t.strideWidth,s=t.dilationHeight,u=t.dilationWidth,c=t.effectiveFilterHeight,l=t.effectiveFilterWidth,h=t.padInfo.top,f=t.padInfo.left,d="max"===o?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,p=this.readSync(e.dataId),g=de(t.outShape,e.dtype),m=g.values,y=t.outShape[1]*t.outShape[2]*t.outShape[3],x=t.outShape[2]*t.outShape[3],w=t.outShape[3],b=0;b<t.batchSize;++b)for(var _=b*y,E=b*e.strides[0],F=0;F<t.inChannels;++F)for(var I=0;I<t.outHeight;++I)for(var S=I*a-h,k=Math.max(0,S),N=Math.min(t.inHeight,c+S),T=_+I*x,W=0;W<t.outWidth;++W){for(var B=W*i-f,L=Math.max(0,B),H=Math.min(t.inWidth,l+B),G=d,U=0,q=0,X=k;X<N;X+=s){for(var J=E+X*e.strides[1],ie=L;ie<H;ie+=u){var ue=p[J+ie*e.strides[2]+F];"max"===o&&ue>G?G=ue:"avg"===o&&(U+=ue,q++)}if(isNaN(G))break}m[T+W*w+F]="avg"===o?U/q:G}return g.toTensor()},n.prototype.maxPool=function(e,t){return this.pool(e,t,"max")},n.prototype.maxPoolPositions=function(e,t){for(var o=de(t.outShape,"int32"),a=t.strideHeight,i=t.strideWidth,s=t.dilationHeight,u=t.dilationWidth,c=t.effectiveFilterHeight,l=t.effectiveFilterWidth,h=t.padInfo.top,f=t.padInfo.left,d=this.bufferSync(e),p=0;p<t.batchSize;++p)for(var g=0;g<t.inChannels;++g)for(var m=0;m<t.outHeight;++m){for(var y=m*a-h,x=y;x<0;)x+=s;for(var w=Math.min(t.inHeight,c+y),b=0;b<t.outWidth;++b){for(var _=b*i-f,E=_;E<0;)E+=u;for(var F=Math.min(t.inWidth,l+_),I=Number.NEGATIVE_INFINITY,S=-1,k=x;k<w;k+=s)for(var N=k-y,T=E;T<F;T+=u){var W=T-_,B=d.get(p,k,T,g);B>I&&(I=B,S=N*l+W)}o.set(S,p,m,b,g)}}return o.toTensor()},n.prototype.maxPoolBackprop=function(e,t,o,a){j([t,o],"maxPoolBackprop");for(var i=this.maxPoolPositions(t,a),s=a.strideHeight,u=a.strideWidth,c=a.dilationHeight,l=a.dilationWidth,h=a.effectiveFilterHeight,f=a.effectiveFilterWidth,d=f-1-a.padInfo.left,p=h-1-a.padInfo.top,g=de(t.shape,"float32"),m=this.bufferSync(i),y=this.bufferSync(e),x=0;x<a.batchSize;++x)for(var w=0;w<a.inChannels;++w)for(var b=0;b<a.inHeight;++b)for(var _=0;_<a.inWidth;++_){for(var E=b-p,F=_-d,I=0,S=0;S<h;S+=c){var k=(E+S)/s;if(!(k<0||k>=a.outHeight||Math.floor(k)!==k))for(var N=0;N<f;N+=l){var T=(F+N)/u;if(!(T<0||T>=a.outWidth||Math.floor(T)!==T)){var W=h*f-1-m.get(x,k,T,w)===S*f+N?1:0;0!==W&&(I+=y.get(x,k,T,w)*W)}}}g.set(I,x,b,_,w)}return g.toTensor()},n.prototype.avgPoolBackprop=function(e,t,o){j([e,t],"avgPoolBackprop");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c=o.dilationHeight,l=o.dilationWidth,h=o.effectiveFilterHeight,f=o.effectiveFilterWidth,d=f-1-o.padInfo.left,p=h-1-o.padInfo.top,g=de(t.shape,"float32"),m=1/(s*u),y=this.bufferSync(e),x=0;x<o.batchSize;++x)for(var w=0;w<o.inChannels;++w)for(var b=0;b<o.inHeight;++b)for(var _=0;_<o.inWidth;++_){for(var E=b-p,F=_-d,I=0,S=0;S<h;S+=c){var k=(E+S)/a;if(!(k<0||k>=o.outHeight||Math.floor(k)!==k))for(var N=0;N<f;N+=l){var T=(F+N)/i;T<0||T>=o.outWidth||Math.floor(T)!==T||(I+=y.get(x,k,T,w))}}g.set(I*m,x,b,_,w)}return g.toTensor()},n.prototype.pool3d=function(e,t,o){j(e,"pool3d");for(var a=t.strideDepth,i=t.strideHeight,s=t.strideWidth,u=t.dilationDepth,c=t.dilationHeight,l=t.dilationWidth,h=t.effectiveFilterDepth,f=t.effectiveFilterHeight,d=t.effectiveFilterWidth,p=t.padInfo.front,g=t.padInfo.top,m=t.padInfo.left,y="max"===o?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,x=this.readSync(e.dataId),w=de(t.outShape,e.dtype),b=w.values,_=t.outShape[1]*t.outShape[2]*t.outShape[3]*t.outShape[4],E=t.outShape[2]*t.outShape[3]*t.outShape[4],F=t.outShape[3]*t.outShape[4],I=t.outShape[4],S=0;S<t.batchSize;++S)for(var k=S*_,N=S*e.strides[0],T=0;T<t.inChannels;++T)for(var W=0;W<t.outDepth;++W){for(var B=W*a-p,L=B;L<0;)L+=u;for(var H=Math.min(t.inDepth,h+B),G=k+W*E,U=0;U<t.outHeight;++U){for(var q=U*i-g,X=q;X<0;)X+=c;for(var J=Math.min(t.inHeight,f+q),ie=G+U*F,ue=0;ue<t.outWidth;++ue){for(var ye=ue*s-m,be=ye;be<0;)be+=l;for(var _e=Math.min(t.inWidth,d+ye),ke=ie+ue*I,Ce=y,Ie=0,$e=0,Ee=L;Ee<H;Ee+=u){for(var Pe=N+Ee*e.strides[1],Ae=X;Ae<J;Ae+=c){for(var Ke=Pe+Ae*e.strides[2],ze=be;ze<_e;ze+=l){var je=x[Ke+ze*e.strides[3]+T];if("max"===o&&je>Ce?Ce=je:"avg"===o&&(Ie+=je,$e++),isNaN(Ce))break}if(isNaN(Ce))break}if(isNaN(Ce))break}b[ke+T]="avg"===o?Ie/$e:Ce}}}return w.toTensor()},n.prototype.avgPool3d=function(e,t){return j(e,"avgPool3d"),this.pool3d(e,t,"avg").toFloat()},n.prototype.avgPool3dBackprop=function(e,t,o){j([e,t],"avgPool3dBackprop");for(var a=o.strideDepth,i=o.strideHeight,s=o.strideWidth,u=o.filterDepth,c=o.filterHeight,l=o.filterWidth,h=o.dilationDepth,f=o.dilationHeight,d=o.dilationWidth,p=o.effectiveFilterDepth,g=o.effectiveFilterHeight,m=o.effectiveFilterWidth,y=p-1-o.padInfo.front,x=m-1-o.padInfo.left,w=g-1-o.padInfo.top,b=de(t.shape,"float32"),_=1/(u*c*l),E=this.bufferSync(e),F=0;F<o.batchSize;++F)for(var I=0;I<o.inChannels;++I)for(var S=0;S<o.inDepth;++S)for(var k=0;k<o.inHeight;++k)for(var N=0;N<o.inWidth;++N){for(var T=S-y,W=k-w,B=N-x,L=0,H=0;H<p;H+=h){var G=(T+H)/a;if(!(G<0||G>=o.outDepth||Math.floor(G)!==G))for(var U=0;U<g;U+=f){var q=(W+U)/i;if(!(q<0||q>=o.outHeight||Math.floor(q)!==q))for(var X=0;X<m;X+=d){var J=(B+X)/s;J<0||J>=o.outWidth||Math.floor(J)!==J||(L+=E.get(F,G,q,J,I))}}}b.set(L*_,F,S,k,N,I)}return b.toTensor()},n.prototype.maxPool3d=function(e,t){return j(e,"maxPool3d"),this.pool3d(e,t,"max").toFloat()},n.prototype.maxPool3dPositions=function(e,t){for(var o=de(t.outShape,"int32"),a=t.strideDepth,i=t.strideHeight,s=t.strideWidth,u=t.dilationDepth,c=t.dilationHeight,l=t.dilationWidth,h=t.effectiveFilterDepth,f=t.effectiveFilterHeight,d=t.effectiveFilterWidth,p=t.padInfo.front,g=t.padInfo.top,m=t.padInfo.left,y=this.bufferSync(e),x=0;x<t.batchSize;++x)for(var w=0;w<t.inChannels;++w)for(var b=0;b<t.outDepth;++b){for(var _=b*a-p,E=_;E<0;)E+=u;for(var F=Math.min(t.inDepth,h+_),I=0;I<t.outHeight;++I){for(var S=I*i-g,k=S;k<0;)k+=c;for(var N=Math.min(t.inHeight,f+S),T=0;T<t.outWidth;++T){for(var W=T*s-m,B=W;B<0;)B+=l;for(var L=Math.min(t.inWidth,d+W),H=Number.NEGATIVE_INFINITY,G=-1,U=E;U<F;U+=u)for(var q=U-_,X=k;X<N;X+=c)for(var J=X-S,ie=B;ie<L;ie+=l){var ue=ie-W,ye=y.get(x,U,X,ie,w);ye>=H&&(H=ye,G=q*f*d+J*f+ue)}o.set(G,x,b,I,T,w)}}}return o.toTensor()},n.prototype.maxPool3dBackprop=function(e,t,o,a){j([t,o],"maxPool3dBackprop");for(var i=this.maxPool3dPositions(t,a),s=a.strideDepth,u=a.strideHeight,c=a.strideWidth,l=a.dilationDepth,h=a.dilationHeight,f=a.dilationWidth,d=a.effectiveFilterDepth,p=a.effectiveFilterHeight,g=a.effectiveFilterWidth,m=d-1-a.padInfo.front,y=g-1-a.padInfo.left,x=p-1-a.padInfo.top,w=de(t.shape,"float32"),b=this.bufferSync(i),_=this.bufferSync(e),E=0;E<a.batchSize;++E)for(var F=0;F<a.inChannels;++F)for(var I=0;I<a.inDepth;++I)for(var S=0;S<a.inHeight;++S)for(var k=0;k<a.inWidth;++k){for(var N=I-m,T=S-x,W=k-y,B=0,L=0;L<d;L+=l){var H=(N+L)/s;if(!(H<0||H>=a.outDepth||Math.floor(H)!==H))for(var G=0;G<p;G+=h){var U=(T+G)/u;if(!(U<0||U>=a.outHeight||Math.floor(U)!==U))for(var q=0;q<g;q+=f){var X=(W+q)/c;if(!(X<0||X>=a.outWidth||Math.floor(X)!==X)){var J=d*p*g-1-b.get(E,H,U,X,F)===L*p*g+G*g+q?1:0;0!==J&&(B+=_.get(E,H,U,X,F)*J)}}}}w.set(B,E,I,S,k,F)}return w.toTensor()},n.prototype.cast=function(e,t){return Fi(e,t,this)},n.prototype.reshape=function(e,t){return ta(e,t)},n.prototype.avgPool=function(e,t){return j(e,"avgPool"),this.pool(e,t,"avg").toFloat()},n.prototype.resizeBilinear=function(e,t,o,a){j(e,"resizeBilinear");for(var i=e.shape,s=i[0],u=i[1],c=i[2],l=i[3],h=this.readSync(e.dataId),f=new Float32Array(re([s,t,o,l])),d=[a&&t>1?u-1:u,a&&o>1?c-1:c],p=[a&&t>1?t-1:t,a&&o>1?o-1:o],g=0,m=d[0]/p[0],y=d[1]/p[1],x=0;x<s;x++)for(var w=0;w<t;w++)for(var b=m*w,_=Math.floor(b),E=b-_,F=Math.min(u-1,Math.ceil(b)),I=x*e.strides[0]+_*e.strides[1],S=x*e.strides[0]+F*e.strides[1],k=0;k<o;k++)for(var N=y*k,T=Math.floor(N),W=N-T,B=Math.min(c-1,Math.ceil(N)),L=I+T*e.strides[2],H=S+T*e.strides[2],G=I+B*e.strides[2],U=S+B*e.strides[2],q=0;q<l;q++){var X=h[L+q],J=h[H+q],ie=X+(h[G+q]-X)*W;f[g++]=ie+(J+(h[U+q]-J)*W-ie)*E}return pt(f,[s,t,o,l])},n.prototype.resizeBilinearBackprop=function(e,t,o){j([e,t],"resizeBilinearBackprop");for(var a=t.shape,i=a[0],s=a[1],u=a[2],c=a[3],l=e.shape,h=l[1],f=l[2],d=new Float32Array(i*s*u*c),p=[o&&h>1?s-1:s,o&&f>1?u-1:u],g=[o&&h>1?h-1:h,o&&f>1?f-1:f],m=p[0]/g[0],y=p[1]/g[1],x=this.readSync(e.dataId),w=0,b=0;b<i;b++)for(var _=b*t.strides[0],E=0;E<h;E++)for(var F=E*m,I=Math.floor(F),S=Math.min(Math.ceil(F),s-1),k=_+I*t.strides[1],N=_+S*t.strides[1],T=F-I,W=1-T,B=0;B<f;B++)for(var L=B*y,H=Math.floor(L),G=Math.min(Math.ceil(L),u-1),U=L-H,q=1-U,X=k+H*t.strides[2],J=k+G*t.strides[2],ie=N+H*t.strides[2],ue=N+G*t.strides[2],ye=W*q,be=W*U,_e=T*q,ke=T*U,Ce=0;Ce<c;Ce++){var Ie=x[w++];d[X+Ce]+=Ie*ye,d[J+Ce]+=Ie*be,d[ie+Ce]+=Ie*_e,d[ue+Ce]+=Ie*ke}return St(d,[i,u,s,c],t.dtype)},n.prototype.resizeNearestNeighbor=function(e,t,o,a){j(e,"resizeNearestNeighbor");for(var i=e.shape,s=i[0],u=i[1],c=i[2],l=i[3],h=this.readSync(e.dataId),f=new Float32Array(s*t*o*l),d=[a&&t>1?u-1:u,a&&o>1?c-1:c],p=[a&&t>1?t-1:t,a&&o>1?o-1:o],g=d[0]/p[0],m=d[1]/p[1],y=0,x=0;x<s;x++)for(var w=x*e.strides[0],b=0;b<t;b++)for(var _=g*b,E=w+Math.min(u-1,a?Math.round(_):Math.floor(_))*e.strides[1],F=0;F<o;F++)for(var I=m*F,S=E+Math.min(c-1,a?Math.round(I):Math.floor(I))*e.strides[2],k=0;k<l;k++)f[y++]=h[S+k];return pt(f,[s,t,o,l],e.dtype)},n.prototype.resizeNearestNeighborBackprop=function(e,t,o){j([e,t],"resizeNearestNeighborBackprop");for(var a=t.shape,i=a[0],s=a[1],u=a[2],c=a[3],l=e.shape,h=l[1],f=l[2],d=new Float32Array(i*s*u*c),p=this.readSync(e.dataId),g=[o&&h>1?s-1:s,o&&f>1?u-1:u],m=[o&&h>1?h-1:h,o&&f>1?f-1:f],y=g[0]/m[0],x=g[1]/m[1],w=1/y,b=1/x,_=2*Math.ceil(w)+2,E=2*Math.ceil(b)+2,F=0;F<i;F++)for(var I=F*t.strides[0],S=0;S<s;S++)for(var k=I+S*t.strides[1],N=Math.floor(S*w),T=Math.floor(N-_/2),W=0;W<u;W++)for(var B=k+W*t.strides[2],L=Math.floor(W*b),H=Math.floor(L-E/2),G=0;G<c;G++){for(var U=0,q=0;q<_;q++){var X=q+T;if(!(X<0||X>=h)){var J=I+X*e.strides[1],ie=X*y;if(S===Math.min(s-1,o?Math.round(ie):Math.floor(ie)))for(var ue=0;ue<E;ue++){var ye=ue+H;if(!(ye<0||ye>=f)){var be=J+ye*e.strides[2],_e=ye*x;W===Math.min(u-1,o?Math.round(_e):Math.floor(_e))&&(U+=p[be+G])}}}}d[B+G]=U}return St(d,t.shape,t.dtype)},n.prototype.batchNormalization=function(e,t,o,a,i,s){j([e,t,o,i,s],"batchNorm");for(var u=this.readSync(e.dataId),c=this.readSync(t.dataId),l=this.readSync(o.dataId),h=i?this.readSync(i.dataId):new Float32Array([1]),f=s?this.readSync(s.dataId):new Float32Array([0]),d=new Float32Array(u.length),p=f.length,g=h.length,m=l.length,y=c.length,x=0,w=0,b=0,_=0,E=0;E<u.length;++E)d[E]=f[x++]+(u[E]-c[w++])*h[b++]/Math.sqrt(l[_++]+a),x>=p&&(x=0),w>=y&&(w=0),b>=g&&(b=0),_>=m&&(_=0);return St(d,e.shape)},n.prototype.localResponseNormalization4D=function(e,t,o,a,i){j(e,"localResponseNormalization4D");var s=e.shape[3],u=s-1,c=this.readSync(e.dataId),l=e.size,h=new Float32Array(l);function f(m){for(var y=m%s,x=m-y+Math.max(0,y-t),w=m-y+Math.min(y+t,u),b=0;x<=w;x++){var _=c[x];b+=_*_}return b}for(var d=0;d<l;d++){var p=f(d),g=c[d]*Math.pow(o+a*p,-i);h[d]=g}return St(h,e.shape)},n.prototype.LRNGrad=function(e,t,o,a,i,s,u){j(e,"LRNGrad");for(var c=e.shape[3],l=this.readSync(e.dataId),h=this.readSync(t.dataId),f=this.readSync(o.dataId),d=new Float32Array(e.size),p=e.size,g=0;g<p;g++){for(var m=g%c,y=g-m+Math.max(0,m-a),x=g-m+Math.min(c,m+a+1),w=0,b=y;b<x;b++)w+=Math.pow(h[b],2);for(w=s*w+i,b=y;b<x;b++){var _=-2*s*u*h[b]*f[g]/w;g===b&&(_+=Math.pow(w,-u)),d[b]+=_*=l[g]}}return St(d,e.shape)},n.prototype.multinomial=function(e,t,o,a){j(e,"multinomial");for(var i=t?e:bn(e),s=i.shape[0],u=i.shape[1],c=Le([s,o],"int32"),l=this.readSync(c.dataId),h=this.readSync(i.dataId),f=0;f<s;++f){var d=f*u,p=new Float32Array(u-1);p[0]=h[d];for(var g=1;g<p.length;++g)p[g]=p[g-1]+h[d+g];for(var m=Ho(a.toString()),y=f*o,x=0;x<o;++x){var w=m();l[y+x]=p.length;for(var b=0;b<p.length;b++)if(w<p[b]){l[y+x]=b;break}}}return c},n.prototype.oneHot=function(e,t,o,a){j(e,"oneHot");var i=new Float32Array(e.size*t);i.fill(a);for(var s=this.readSync(e.dataId),u=0;u<e.size;++u)s[u]>=0&&s[u]<t&&(i[u*t+s[u]]=o);return Gn(i,[e.size,t],"int32")},n.prototype.nonMaxSuppression=function(e,t,o,a,i){return j(e,"nonMaxSuppression"),Ti(this.readSync(e.dataId),this.readSync(t.dataId),o,a,i)},n.prototype.fft=function(e){return this.fftBatch(e,!1)},n.prototype.ifft=function(e){return this.fftBatch(e,!0)},n.prototype.fftBatch=function(e,t){for(var o=e.shape[0],a=e.shape[1],i=de(e.shape,"float32"),s=de(e.shape,"float32"),u=Bt(e).as2D(o,a),c=rn(e).as2D(o,a),l=0;l<o;l++)for(var h=u.slice([l,0],[1,a]),f=c.slice([l,0],[1,a]),d=dt(h,f),p=this.readSync(this.fftImpl(d,t).dataId),g=0;g<a;g++){var m=Ec(p,g);i.values[l*a+g]=m.real,s.values[l*a+g]=m.imag}return dt(i.toTensor(),s.toTensor()).as2D(o,a)},n.prototype.fftImpl=function(e,t){var o=e.as1D(),a=o.size;if(this.isExponentOf2(a)){var i=this.fftRadix2(o,a,t).as2D(e.shape[0],e.shape[1]);return t&&(i=dt(Bt(i).div($(a)),rn(i).div($(a)))),i}var s=this.readSync(e.dataId),u=function(c){for(var l=new Float32Array(c.length/2),h=new Float32Array(c.length/2),f=0;f<c.length;f+=2)l[f/2]=c[f],h[f/2]=c[f+1];return{real:l,imag:h}}(this.fourierTransformByMatmul(s,a,t));return dt(u.real,u.imag).as2D(e.shape[0],e.shape[1])},n.prototype.isExponentOf2=function(e){return!(e&e-1)},n.prototype.fftRadix2=function(e,t,o){if(1===t)return e;var a=this.readSync(e.dataId),i=t/2,s=function(y){for(var x=Math.ceil(y.length/4),w=new Float32Array(x),b=new Float32Array(x),_=0;_<y.length;_+=4)w[Math.floor(_/4)]=y[_],b[Math.floor(_/4)]=y[_+1];return{real:w,imag:b}}(a),u=dt(s.real,s.imag).as1D(),c=function(y){for(var x=Math.floor(y.length/4),w=new Float32Array(x),b=new Float32Array(x),_=2;_<y.length;_+=4)w[Math.floor(_/4)]=y[_],b[Math.floor(_/4)]=y[_+1];return{real:w,imag:b}}(a),l=dt(c.real,c.imag).as1D();u=this.fftRadix2(u,i,o),l=this.fftRadix2(l,i,o);var h=function(y,x){for(var w=new Float32Array(y/2),b=new Float32Array(y/2),_=0;_<Math.ceil(y/2);_++){var E=(x?2:-2)*Math.PI*(_/y);w[_]=Math.cos(E),b[_]=Math.sin(E)}return{real:w,imag:b}}(t,o),f=dt(h.real,h.imag).mul(l),d=u.add(f),p=u.sub(f),g=Bt(d).concat(Bt(p)),m=rn(d).concat(rn(p));return dt(g,m).as1D()},n.prototype.fourierTransformByMatmul=function(e,t,o){for(var a=new Float32Array(2*t),i=0;i<t;i++){for(var s=0,u=0,c=0;c<t;c++){var l=gd(i*c,t,o),h=Ec(e,c);s+=h.real*l.real-h.imag*l.imag,u+=h.real*l.imag+h.imag*l.real}o&&(s/=t,u/=t),md(a,s,u,i)}return a},n.prototype.depthToSpace=function(e,t,o){R("NHWC"===o,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+o}),R(t>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+t});for(var a=e.shape[0],i=e.shape[1],s=e.shape[2],u=e.shape[3],c=i*t,l=s*t,h=u/(t*t),f=this.readSync(e.dataId),d=new Float32Array(a*c*l*h),p=0,g=0;g<a;++g)for(var m=0;m<c;++m)for(var y=Math.floor(m/t),x=m%t,w=0;w<l;++w)for(var b=Math.floor(w/t),_=(x*t+w%t)*h,E=0;E<h;++E)d[p++]=f[E+_+u*(b+s*(y+i*g))];return St(d,[a,c,l,h])},n.prototype.broadcastedBinaryOp=function(e,t,o,a){var i=xe(e.shape,t.shape),s=de(i,o),u=this.readSync(e.dataId),c=this.readSync(t.dataId),l=xn(e.shape,i),h=xn(t.shape,i),f=s.values;if(l.length+h.length===0)for(var d=0;d<f.length;++d)f[d]=a(u[d%u.length],c[d%c.length]);else{var p=this.bufferSync(e),g=this.bufferSync(t),m=function(y){var x=s.indexToLoc(y),w=x.slice(-e.rank);l.forEach(function(F){return w[F]=0});var b=p.locToIndex(w),_=x.slice(-t.rank);h.forEach(function(F){return _[F]=0});var E=g.locToIndex(_);f[y]=a(u[b],c[E])};for(d=0;d<f.length;++d)m(d)}return s.toTensor()},n.prototype.broadcastedBinaryComplexOp=function(e,t,o){var a=xe(e.shape,t.shape),i=de(a,"float32"),s=de(a,"float32"),u=this.readSync(e.dataId),c=this.readSync(t.dataId),l=xn(e.shape,a),h=xn(t.shape,a),f=i.values,d=s.values;if(l.length+h.length===0)for(var p=0;p<f.length;p++){var g=p%u.length,m=p%c.length,y=o(u[2*g],u[2*g+1],c[2*m],c[2*m+1]);f[p]=y.real,d[p]=y.imag}else{var x=this.bufferSync(this.data.get(e.dataId).complexTensors.real),w=this.bufferSync(this.data.get(t.dataId).complexTensors.real),b=function(_){var E=i.indexToLoc(_),F=E.slice(-e.rank);l.forEach(function(T){return F[T]=0});var I=x.locToIndex(F),S=E.slice(-t.rank);h.forEach(function(T){return S[T]=0});var k=w.locToIndex(S),N=o(u[2*I],u[2*I+1],c[2*k],c[2*k+1]);f[_]=N.real,d[_]=N.imag};for(p=0;p<f.length;p++)b(p)}return this.complex(i.toTensor(),s.toTensor())},n.prototype.split=function(e,t,o){return kc(e,t,o)},n.prototype.dispose=function(){},n.prototype.floatPrecision=function(){return 32},n.prototype.epsilon=function(){return 1e-7},n.prototype.cropAndResize=function(e,t,o,a,i,s){for(var u=e.shape,c=u[0],l=u[1],h=u[2],f=u[3],d=t.shape[0],p=a[0],g=a[1],m=de([d,p,g,f],"float32"),y=this.readSync(t.dataId),x=this.readSync(o.dataId),w=this.readSync(e.dataId),b=e.strides,_=m.strides,E=0;E<d;E++){var F=4*E,I=y[F],S=y[F+1],k=y[F+2],N=y[F+3],T=x[E];if(!(T>=c))for(var W=p>1?(k-I)*(l-1)/(p-1):0,B=g>1?(N-S)*(h-1)/(g-1):0,L=0;L<p;L++){var H=p>1?I*(l-1)+L*W:.5*(I+k)*(l-1);if(H<0||H>l-1)for(var G=0;G<g;G++)for(var U=0;U<f;U++){var q=U+G*_[2]+L*_[1]+E*_[0];m.values[q]=s}else if("bilinear"===i){var X=Math.floor(H),J=Math.ceil(H),ie=H-X;for(G=0;G<g;G++)if((Ee=g>1?S*(h-1)+G*B:.5*(S+N)*(h-1))<0||Ee>h-1)for(U=0;U<f;U++)m.values[q=U+G*_[2]+L*_[1]+E*_[0]]=s;else{var ue=Math.floor(Ee),ye=Math.ceil(Ee),be=Ee-ue;for(U=0;U<f;U++){var _e=w[q=U+ue*b[2]+X*b[1]+T*b[0]],ke=w[q=U+ye*b[2]+X*b[1]+T*b[0]],Ce=w[q=U+ue*b[2]+J*b[1]+T*b[0]],Ie=_e+(ke-_e)*be,$e=Ce+(w[q=U+ye*b[2]+J*b[1]+T*b[0]]-Ce)*be;m.values[q=U+G*_[2]+L*_[1]+E*_[0]]=Ie+($e-Ie)*ie}}}else for(G=0;G<g;++G){var Ee;if((Ee=g>1?S*(h-1)+G*B:.5*(S+N)*(h-1))<0||Ee>h-1)for(U=0;U<f;U++)m.values[q=U+G*_[2]+L*_[1]+E*_[0]]=s;else{var Pe=Math.round(Ee),Ae=Math.round(H);for(U=0;U<f;U++)m.values[U+G*_[2]+L*_[1]+E*_[0]]=w[U+Pe*b[2]+Ae*b[1]+T*b[0]]}}}}return m.toTensor()},n.prototype.sparseToDense=function(e,t,o,a){var i=co(0,e,o);return this.scatter(e,t,o,i.outputSize,i.sliceSize,i.numUpdates,i.sliceRank,i.strides,a,!1)},n.prototype.gatherND=function(e,t){var o=t.shape,a=o[o.length-1],i=_i(e,t),s=i[0],u=i[1],c=i[2],l=i[3];if(0===u)return pt([],s,e.dtype);for(var h=new Zr([u,c],e.dtype),f=this.readSync(t.dataId),d=this.readSync(e.dataId),p=0;p<u;p++){for(var g=[],m=0,y=0;y<a;y++){var x=f[p*a+y];m+=x*l[y],g.push(x)}if(m<0||m>=e.size/c)throw new Error("Invalid indices: "+g+" does not index into "+e.shape);for(var w=0;w<c;w++)h.values[p*c+w]=d[m*c+w]}return h.toTensor().reshape(s)},n.prototype.scatterND=function(e,t,o){var a=co(0,e,o),i=a.sliceRank,s=a.numUpdates,u=a.sliceSize,c=a.strides,l=a.outputSize,h=$(0);return this.scatter(e,t,o,l,u,s,i,c,h,!0)},n.prototype.fill=function(e,t,o){var a=Kr(o=o||Er(t),re(e));return a.fill(t),A.makeTensor(a,e,o,this)},n.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(e.shape,1,e.dtype)},n.prototype.zerosLike=function(e){var t=Kr(e.dtype,re(e.shape));return this.makeOutput(t,e.shape,e.dtype)},n.prototype.linspace=function(e,t,o){return Ai(e,t,o)},n.prototype.scatter=function(e,t,o,a,i,s,u,c,l,h){var f=[a/i,i],d=this.readSync(e.dataId),p=this.readSync(t.dataId);if(0===a)return pt([],o,t.dtype);var g=new Zr(f,t.dtype);g.values.fill(this.readSync(l.dataId)[0]);for(var m=0;m<s;m++){for(var y=[],x=0,w=0;w<u;w++){var b=d[m*u+w];y.push(b),x+=b*c[w]}if(x<0||x>=a/i)throw new Error("Invalid indices: "+y+" does not index into "+o);for(var _=0;_<i;_++)h?g.values[x*i+_]+=p[m*i+_]:g.values[x*i+_]=0===t.rank?p[0]:p[m*i+_]}return g.toTensor().reshape(o)},n}(Cc);A.registerBackend("cpu",function(){return new xg},1);for(var ss=0,rh=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(r){var n=r.inputs,t=r.attrs,a=n.boxes,i=n.scores,u=t.maxOutputSize,c=t.iouThreshold,l=t.scoreThreshold,h=t.softNmsSigma,f=r.backend;j(a,"NonMaxSuppressionWithScore");var d=Ni(f.data.get(a.dataId).values,f.data.get(i.dataId).values,u,c,l,h);return[d.selectedIndices,d.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(r){var t=r.inputs.x,o=r.backend;j(t,"square");for(var a=o.data.get(t.dataId).values,i=new Float32Array(a.length),s=0;s<a.length;++s){var u=a[s];i[s]=u*u}return{dataId:o.write(i,t.shape,t.dtype),shape:t.shape,dtype:t.dtype}}},{kernelName:mo,backendName:"cpu",kernelFunc:function(r){var n=r.inputs,o=n.a,a=n.b,i=r.backend;j([o,a],mo);var s=i.data.get(o.dataId).values,u=i.data.get(a.dataId).values,c=function(f,d,p,g,m,y){var x=xe(f,d),w=x.length,b=jt(x),_=Cr(m,re(x)),E=f.length,F=d.length,I=jt(f),S=jt(d),k=xn(f,x),N=xn(d,x);if(k.length+N.length===0)for(var T=0;T<_.length;++T)_[T]=y(p[T%p.length],g[T%g.length]);else{var W=function(B){var L=Su(B,w,b),H=L.slice(-E);k.forEach(function(X){return H[X]=0});var G=ni(H,E,I),U=L.slice(-F);N.forEach(function(X){return U[X]=0});var q=ni(U,F,S);_[B]=y(p[G],g[q])};for(T=0;T<_.length;++T)W(T)}return[_,x]}(o.shape,a.shape,s,u,o.dtype,function(f,d){var p=f-d;return p*p}),h=c[1];return{dataId:i.write(c[0],h,o.dtype),shape:h,dtype:o.dtype}}}];ss<rh.length;ss++)Zt(rh[ss]);for(var Mr,wg=function(r){this.variableNames=["A"];var n=gt(),e=r[0],t=r[1];this.outputShape=r,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+t+".0, "+e+".0);\n\n        vec4 values = "+n.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},_g=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var n=gt(),e=r[0],t=r[1];this.outputShape=r,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+t+".0, "+e+".0);\n            vec4 values = "+n.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+n.output+" = result;\n      }\n    "},us=0,oh=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(r){var e=r.backend,o=r.inputs.pixels,i=typeof HTMLVideoElement<"u"&&o instanceof HTMLVideoElement,s=typeof HTMLImageElement<"u"&&o instanceof HTMLImageElement,u=i?[o.videoWidth,o.videoHeight]:[o.width,o.height],c=u[0],l=u[1],h=[l,c],f=[l,c,r.attrs.numChannels];(s||i)&&(null==Mr&&(Mr=document.createElement("canvas").getContext("2d")),Mr.canvas.width=c,Mr.canvas.height=l,Mr.drawImage(o,0,0,c,l),o=Mr.canvas);var d=e.makeTensorInfo(h,"int32");e.texData.get(d.dataId).usage=At.PIXELS,e.gpgpu.uploadPixelDataToTexture(e.getTexture(d.dataId),o);var p=O().getBool("WEBGL_PACK")?new _g(f):new wg(f),g=e.runWebGLProgram(p,[d],"int32");return e.disposeData(d.dataId),g}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(r){var n=r.inputs,e=r.backend,t=r.attrs;Go("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var i=n.scores,u=t.maxOutputSize,c=t.iouThreshold,l=t.scoreThreshold,h=t.softNmsSigma,f=e,d=Ni(f.readSync(n.boxes.dataId),f.readSync(i.dataId),u,c,l,h);return[d.selectedIndices,d.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(r){var t=r.inputs.x,o=r.backend,a=new me(t.shape,"return x * x;");return o.runWebGLProgram(a,[t],t.dtype)}},{kernelName:mo,backendName:"webgl",kernelFunc:function(r){var n=r.inputs,o=n.a,a=n.b,i=r.backend,s=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wn("return (a - b) * (a - b);",o.shape,a.shape):new Xe("return (a - b) * (a - b);",o.shape,a.shape);return i.compileAndRun(s,[o,a])}}];us<oh.length;us++)Zt(oh[us]);for(var cs=0,ah=[{kernelName:"Square",gradFunc:function(r,n){var e=n[0];return{x:function(){return r.mul(e.toFloat().mul(2))}}}},{kernelName:mo,gradFunc:function(r,n){var e=n[0],t=n[1],o=$(2);return{a:function(){return yt(r,yt(o,ot(e,t)))},b:function(){return yt(r,yt(o,ot(t,e)))}}}}];cs<ah.length;cs++)_r(ah[cs]);var Cg=function(){function r(){}return r.prototype.fetch=function(n,e){return fetch(n,e)},r.prototype.now=function(){return performance.now()},r.prototype.encode=function(n,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Browser's encoder only supports utf-8, but got "+e);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(n)},r.prototype.decode=function(n,e){return new TextDecoder(e).decode(n)},r}();O().get("IS_BROWSER")&&O().setPlatform("browser",new Cg);var ls,Rg=function(){function r(){this.util=ge(745),this.textEncoder=new this.util.TextEncoder}return r.prototype.fetch=function(n,e){return null!=O().global.fetch?O().global.fetch(n,e):(null==ls&&(ls=ge(7318)),ls(n,e))},r.prototype.now=function(){var n=process.hrtime();return 1e3*n[0]+n[1]/1e6},r.prototype.encode=function(n,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Node built-in encoder only supports utf-8, but got "+e);return this.textEncoder.encode(n)},r.prototype.decode=function(n,e){return 0===n.length?"":new this.util.TextDecoder(e).decode(n)},r}();O().get("IS_NODE")&&O().setPlatform("node",new Rg);var hs={float32:4,int32:4,uint16:2,uint8:1,bool:1},ma=4;function ih(r,n){for(var e={},t=0,o=function(s){var u=s.name,c=s.dtype,l=s.shape,h=re(l),f=void 0;if("quantization"in s){var d=s.quantization;if("uint8"!==d.dtype&&"uint16"!==d.dtype)throw new Error("Weight "+s.name+" has unknown quantization dtype "+d.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var p=hs[d.dtype],g=r.slice(t,t+h*p),m="uint8"===d.dtype?new Uint8Array(g):new Uint16Array(g);if("float32"===c)f=Float32Array.from(m,function(E){return E*d.scale+d.min});else{if("int32"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=Int32Array.from(m,function(E){return Math.round(E*d.scale+d.min)})}t+=h*p}else if("string"===c){var y=re(s.shape);f=[];for(var x=0;x<y;x++){var w=new Uint32Array(r.slice(t,t+ma))[0];t+=ma;var b=new Uint8Array(r.slice(t,t+w));f.push(b),t+=w}}else{var _=hs[c];if(g=r.slice(t,t+h*_),"float32"===c)f=new Float32Array(g);else if("int32"===c)f=new Int32Array(g);else{if("bool"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=new Uint8Array(g)}t+=h*_}e[u]=pt(f,l,c)},a=0,i=n;a<i.length;a++)o(i[a]);return e}function Sg(r){if(null===r)throw new Error("Invalid input value: "+JSON.stringify(r));var n=0,e=[];r.forEach(function(a){if(n+=a.byteLength,e.push(a.byteLength===a.buffer.byteLength?a:new a.constructor(a)),!(a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+a.constructor.name)});var t=new Uint8Array(n),o=0;return e.forEach(function(a){t.set(new Uint8Array(a.buffer),o),o+=a.byteLength}),t.buffer}var fs=typeof Buffer<"u"&&(typeof Blob>"u"||typeof atob>"u"||typeof btoa>"u");function sh(r){return fs?Buffer.byteLength(r):new Blob([r]).size}function ds(r){var n=0;r.forEach(function(o){n+=o.byteLength});var e=new Uint8Array(n),t=0;return r.forEach(function(o){e.set(new Uint8Array(o),t),t+=o.byteLength}),e.buffer}function uh(r){for(r=r.trim();r.endsWith("/");)r=r.slice(0,r.length-1);var n=r.split("/");return n[n.length-1]}function xo(r){if(r.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==r.modelTopology?0:sh(JSON.stringify(r.modelTopology)),weightSpecsBytes:null==r.weightSpecs?0:sh(JSON.stringify(r.weightSpecs)),weightDataBytes:null==r.weightData?0:r.weightData.byteLength}}var Pt=function(){function r(){this.saveRouters=[],this.loadRouters=[]}return r.getInstance=function(){return null==r.instance&&(r.instance=new r),r.instance},r.registerSaveRouter=function(n){r.getInstance().saveRouters.push(n)},r.registerLoadRouter=function(n){r.getInstance().loadRouters.push(n)},r.getSaveHandlers=function(n){return r.getHandlers(n,"save")},r.getLoadHandlers=function(n,e){return r.getHandlers(n,"load",e)},r.getHandlers=function(n,e,t){var o=[];return("load"===e?r.getInstance().loadRouters:r.getInstance().saveRouters).forEach(function(a){var i=a(n,t);null!==i&&o.push(i)}),o},r}(),Or="://",Hn=function(){function r(){this.managers={}}return r.getInstance=function(){return null==r.instance&&(r.instance=new r),r.instance},r.registerManager=function(n,e){R(null!=n,function(){return"scheme must not be undefined or null."}),n.endsWith(Or)&&(n=n.slice(0,n.indexOf(Or))),R(n.length>0,function(){return"scheme must not be an empty string."});var t=r.getInstance();R(null==t.managers[n],function(){return"A model store manager is already registered for scheme '"+n+"'."}),t.managers[n]=e},r.getManager=function(n){var e=this.getInstance().managers[n];if(null==e)throw new Error("Cannot find model manager for scheme '"+n+"'");return e},r.getSchemes=function(){return Object.keys(this.getInstance().managers)},r}();function ga(r){if(-1===r.indexOf(Or))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+Hn.getSchemes().join(","));return{scheme:r.split(Or)[0],path:r.split(Or)[1]}}function ch(r,n,e){return void 0===e&&(e=!1),Q(this,void 0,void 0,function(){var t,o,a,i,s,u,c,l,h;return ee(this,function(f){switch(f.label){case 0:return R(r!==n,function(){return"Old path and new path are the same: '"+r+"'"}),R((t=Pt.getLoadHandlers(r)).length>0,function(){return"Copying failed because no load handler is found for source URL "+r+"."}),R(t.length<2,function(){return"Copying failed because more than one ("+t.length+") load handlers for source URL "+r+"."}),o=t[0],R((a=Pt.getSaveHandlers(n)).length>0,function(){return"Copying failed because no save handler is found for destination URL "+n+"."}),R(a.length<2,function(){return"Copying failed because more than one ("+t.length+") save handlers for destination URL "+n+"."}),i=a[0],s=ga(r).scheme,u=ga(r).path,c=s===ga(r).scheme,[4,o.load()];case 1:return l=f.sent(),e&&c?[4,Hn.getManager(s).removeModel(u)]:[3,3];case 2:f.sent(),f.label=3;case 3:return[4,i.save(l)];case 4:return h=f.sent(),!e||c?[3,6]:[4,Hn.getManager(s).removeModel(u)];case 5:f.sent(),f.label=6;case 6:return[2,h.modelArtifactsInfo]}})})}var fr="models_store",qn="model_info_store";function lh(){if(!O().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var r=window||self,n=r.indexedDB||r.mozIndexedDB||r.webkitIndexedDB||r.msIndexedDB||r.shimIndexedDB;if(null==n)throw new Error("The current browser does not appear to support IndexedDB.");return n}function ps(r){var n=r.result;n.createObjectStore(fr,{keyPath:"modelPath"}),n.createObjectStore(qn,{keyPath:"modelPath"})}var Br=function(){function r(n){if(this.indexedDB=lh(),null==n||!n)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=n}return r.prototype.save=function(n){return Q(this,void 0,void 0,function(){return ee(this,function(e){if(n.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,n)]})})},r.prototype.load=function(){return Q(this,void 0,void 0,function(){return ee(this,function(n){return[2,this.databaseAction(this.modelPath)]})})},r.prototype.databaseAction=function(n,e){var t=this;return new Promise(function(o,a){var i=t.indexedDB.open("tensorflowjs",1);i.onupgradeneeded=function(){return ps(i)},i.onsuccess=function(){var s=i.result;if(null==e){var u=s.transaction(fr,"readonly"),c=u.objectStore(fr).get(t.modelPath);c.onsuccess=function(){if(null==c.result)return s.close(),a(new Error("Cannot find model with path '"+t.modelPath+"' in IndexedDB."));o(c.result.modelArtifacts)},c.onerror=function(g){return s.close(),a(c.error)},u.oncomplete=function(){return s.close()}}else{var l,h=xo(e),f=s.transaction(qn,"readwrite"),d=f.objectStore(qn),p=d.put({modelPath:t.modelPath,modelArtifactsInfo:h});p.onsuccess=function(){var g=(l=s.transaction(fr,"readwrite")).objectStore(fr).put({modelPath:t.modelPath,modelArtifacts:e,modelArtifactsInfo:h});g.onsuccess=function(){return o({modelArtifactsInfo:h})},g.onerror=function(m){var y=(d=f.objectStore(qn)).delete(t.modelPath);y.onsuccess=function(){return s.close(),a(g.error)},y.onerror=function(x){return s.close(),a(g.error)}}},p.onerror=function(g){return s.close(),a(p.error)},f.oncomplete=function(){null==l?s.close():l.oncomplete=function(){return s.close()}}}},i.onerror=function(s){return a(i.error)}})},r.URL_SCHEME="indexeddb://",r}(),hh=function(r){return O().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith(Br.URL_SCHEME)?(n=r.slice(Br.URL_SCHEME.length),new Br(n)):null;var n};Pt.registerSaveRouter(hh),Pt.registerLoadRouter(hh);var kg=function(){function r(){this.indexedDB=lh()}return r.prototype.listModels=function(){return Q(this,void 0,void 0,function(){var n=this;return ee(this,function(e){return[2,new Promise(function(t,o){var a=n.indexedDB.open("tensorflowjs",1);a.onupgradeneeded=function(){return ps(a)},a.onsuccess=function(){var i=a.result,s=i.transaction(qn,"readonly"),u=s.objectStore(qn).getAll();u.onsuccess=function(){for(var c={},l=0,h=u.result;l<h.length;l++){var f=h[l];c[f.modelPath]=f.modelArtifactsInfo}t(c)},u.onerror=function(c){return i.close(),o(u.error)},s.oncomplete=function(){return i.close()}},a.onerror=function(i){return o(a.error)}})]})})},r.prototype.removeModel=function(n){return Q(this,void 0,void 0,function(){var e=this;return ee(this,function(t){var o;return n=(o=n).startsWith(Br.URL_SCHEME)?o.slice(Br.URL_SCHEME.length):o,[2,new Promise(function(a,i){var s=e.indexedDB.open("tensorflowjs",1);s.onupgradeneeded=function(){return ps(s)},s.onsuccess=function(){var u,c=s.result,l=c.transaction(qn,"readwrite"),h=l.objectStore(qn),f=h.get(n);f.onsuccess=function(){if(null==f.result)return c.close(),i(new Error("Cannot find model with path '"+n+"' in IndexedDB."));var d=h.delete(n),p=function(){var g=(u=c.transaction(fr,"readwrite")).objectStore(fr).delete(n);g.onsuccess=function(){return a(f.result.modelArtifactsInfo)},g.onerror=function(m){return i(f.error)}};d.onsuccess=p,d.onerror=function(g){return p(),c.close(),i(f.error)}},f.onerror=function(d){return c.close(),i(f.error)},l.oncomplete=function(){null==u?c.close():u.oncomplete=function(){return c.close()}}},s.onerror=function(u){return i(s.error)}})]})})},r}();if(O().getBool("IS_BROWSER"))try{Hn.registerManager(Br.URL_SCHEME,new kg)}catch{}var Cn="/",Lr="tensorflowjs_models",fh="info",Ig="model_topology",Fg="weight_specs",Ag="weight_data",Dg="model_metadata";function dh(r){return{info:[Lr,r,fh].join(Cn),topology:[Lr,r,Ig].join(Cn),weightSpecs:[Lr,r,Fg].join(Cn),weightData:[Lr,r,Ag].join(Cn),modelMetadata:[Lr,r,Dg].join(Cn)}}function Tg(r){var n=r.split(Cn);if(n.length<3)throw new Error("Invalid key format: "+r);return n.slice(1,n.length-1).join(Cn)}var Wr=function(){function r(n){if(!O().getBool("IS_BROWSER")||typeof window>"u"||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==n||!n)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=n,this.keys=dh(this.modelPath)}return r.prototype.save=function(n){return Q(this,void 0,void 0,function(){var e,t,o;return ee(this,function(a){if(n.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");e=JSON.stringify(n.modelTopology),t=JSON.stringify(n.weightSpecs),o=xo(n);try{return this.LS.setItem(this.keys.info,JSON.stringify(o)),this.LS.setItem(this.keys.topology,e),this.LS.setItem(this.keys.weightSpecs,t),this.LS.setItem(this.keys.weightData,function(i){if(fs)return Buffer.from(i).toString("base64");for(var s=new Uint8Array(i),u="",c=0,l=s.length;c<l;c++)u+=String.fromCharCode(s[c]);return btoa(u)}(n.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:n.format,generatedBy:n.generatedBy,convertedBy:n.convertedBy,userDefinedMetadata:n.userDefinedMetadata})),[2,{modelArtifactsInfo:o}]}catch{throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+o.modelTopologyBytes+", weightSpecsBytes="+o.weightSpecsBytes+", weightDataBytes="+o.weightDataBytes+".")}return[2]})})},r.prototype.load=function(){return Q(this,void 0,void 0,function(){var n,e,t,o,a,i,s;return ee(this,function(u){if(null==(n=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==n.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(e={},null==(t=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(e.modelTopology=t,null==(o=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(e.weightSpecs=o,null!=(a=this.LS.getItem(this.keys.modelMetadata))&&(i=JSON.parse(a),e.format=i.format,e.generatedBy=i.generatedBy,e.convertedBy=i.convertedBy,e.userDefinedMetadata=i.userDefinedMetadata),null==(s=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return e.weightData=function(c){if(fs){var l=Buffer.from(c,"base64");return l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)}for(var h=atob(c),f=new Uint8Array(h.length),d=0;d<h.length;++d)f.set([h.charCodeAt(d)],d);return f.buffer}(s),[2,e]})})},r.URL_SCHEME="localstorage://",r}(),ph=function(r){return O().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith(Wr.URL_SCHEME)?(n=r.slice(Wr.URL_SCHEME.length),new Wr(n)):null;var n};Pt.registerSaveRouter(ph),Pt.registerLoadRouter(ph);var Ng=function(){function r(){R(O().getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),R(typeof window>"u"||void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return r.prototype.listModels=function(){return Q(this,void 0,void 0,function(){var n,e,t,o,a,i;return ee(this,function(s){for(n={},e=Lr+Cn,t=Cn+fh,o=0;o<this.LS.length;++o)(a=this.LS.key(o)).startsWith(e)&&a.endsWith(t)&&(i=Tg(a),n[i]=JSON.parse(this.LS.getItem(a)));return[2,n]})})},r.prototype.removeModel=function(n){return Q(this,void 0,void 0,function(){var e,t;return ee(this,function(o){var a;if(n=(a=n).startsWith(Wr.URL_SCHEME)?a.slice(Wr.URL_SCHEME.length):a,e=dh(n),null==this.LS.getItem(e.info))throw new Error("Cannot find model at path '"+n+"'");return t=JSON.parse(this.LS.getItem(e.info)),this.LS.removeItem(e.info),this.LS.removeItem(e.topology),this.LS.removeItem(e.weightSpecs),this.LS.removeItem(e.weightData),[2,t]})})},r}();if(O().getBool("IS_BROWSER"))try{Hn.registerManager(Wr.URL_SCHEME,new Ng)}catch{}function vh(r){return new Promise(function(n){return setTimeout(n)}).then(r)}var vs=function(){function r(n){if(!O().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");n.startsWith(r.URL_SCHEME)&&(n=n.slice(r.URL_SCHEME.length)),null!=n&&0!==n.length||(n="model"),this.modelTopologyFileName=n+".json",this.weightDataFileName=n+".weights.bin"}return r.prototype.save=function(n){return Q(this,void 0,void 0,function(){var e,a,i,s;return ee(this,function(u){switch(u.label){case 0:if(typeof document>"u")throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(e=window.URL.createObjectURL(new Blob([n.weightData],{type:"application/octet-stream"})),!(n.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return a=window.URL.createObjectURL(new Blob([JSON.stringify({modelTopology:n.modelTopology,format:n.format,generatedBy:n.generatedBy,convertedBy:n.convertedBy,weightsManifest:[{paths:["./"+this.weightDataFileName],weights:n.weightSpecs}]})],{type:"application/json"})),(i=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,i.href=a,[4,vh(function(){return i.dispatchEvent(new MouseEvent("click"))})];case 2:return u.sent(),null==n.weightData?[3,4]:((s=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,s.href=e,[4,vh(function(){return s.dispatchEvent(new MouseEvent("click"))})]);case 3:u.sent(),u.label=4;case 4:return[2,{modelArtifactsInfo:xo(n)}]}})})},r.URL_SCHEME="downloads://",r}(),Bg=function(){function r(n){if(null==n||n.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+n);this.files=n}return r.prototype.load=function(){return Q(this,void 0,void 0,function(){var n,e,t=this;return ee(this,function(o){return n=this.files[0],e=this.files.slice(1),[2,new Promise(function(a,i){var s=new FileReader;s.onload=function(u){var c=JSON.parse(u.target.result),l=c.modelTopology;if(null!=l){0===e.length&&a({modelTopology:l});var h=c.weightsManifest;if(null!=h){var f;try{f=t.checkManifestAndWeightFiles(h,e)}catch(m){return void i(m)}var d=[],p=[],g=[];h.forEach(function(m){m.paths.forEach(function(y){p.push(y),g.push(null)}),d.push.apply(d,m.weights)}),h.forEach(function(m){m.paths.forEach(function(y){var x=new FileReader;x.onload=function(w){var b=w.target.result,_=p.indexOf(y);g[_]=b,-1===g.indexOf(null)&&a({modelTopology:l,weightSpecs:d,weightData:ds(g),format:c.format,generatedBy:c.generatedBy,convertedBy:c.convertedBy,userDefinedMetadata:c.userDefinedMetadata})},x.onerror=function(w){return i("Failed to weights data from file of path '"+y+"'.")},x.readAsArrayBuffer(f[y])})})}else i(new Error("weightManifest field is missing from file "+n.name))}else i(new Error("modelTopology field is missing from file "+n.name))},s.onerror=function(u){return i("Failed to read model topology and weights manifest JSON from file '"+n.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},s.readAsText(n)})]})})},r.prototype.checkManifestAndWeightFiles=function(n,e){for(var t=[],o=e.map(function(u){return uh(u.name)}),a={},i=0,s=n;i<s.length;i++)s[i].paths.forEach(function(u){var c=uh(u);if(-1!==t.indexOf(c))throw new Error("Duplicate file basename found in weights manifest: '"+c+"'");if(t.push(c),-1===o.indexOf(c))throw new Error("Weight file with basename '"+c+"' is not provided.");a[u]=e[o.indexOf(c)]});if(t.length!==e.length)throw new Error("Mismatch in the number of files in weights manifest ("+t.length+") and the number of weight files provided ("+e.length+").");return a},r}();function mh(r,n,e,t){var a;R(null!=(a=r)&&Array.isArray(a)&&a.length>0,function(){return"promises must be a none empty array"}),function(a,i){R(a>=0&&a<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+a}),R(i>=0&&i<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+i}),R(i>=a,function(){return"startFraction must be no more than endFraction, but got startFraction "+a+" and endFraction "+i})}(e=null==e?0:e,t=null==t?1:t);var o=0;return Promise.all(r.map(function(a){return a.then(function(i){var s=e+ ++o/r.length*(t-e);return n(s),i}),a}))}function gh(r,n){return Q(this,void 0,void 0,function(){var e,t,o,a,i,s,u,c,l;return ee(this,function(h){switch(h.label){case 0:return null==n&&(n={}),e=null==n.fetchFunc?O().platform.fetch:n.fetchFunc,t=r.map(function(f){return e(f,n.requestInit,{isBinary:!0})}),o=0,a=.5,null!=n.onProgress?[3,2]:[4,Promise.all(t)];case 1:return i=h.sent(),[3,4];case 2:return[4,mh(t,n.onProgress,o,a)];case 3:i=h.sent(),h.label=4;case 4:return s=i.map(function(f){return f.arrayBuffer()}),u=.5,c=1,null!=n.onProgress?[3,6]:[4,Promise.all(s)];case 5:return l=h.sent(),[3,8];case 6:return[4,mh(s,n.onProgress,u,c)];case 7:l=h.sent(),h.label=8;case 8:return[2,l]}})})}function yh(r){var n=this;return function(e,t,o){return void 0===t&&(t=""),Q(n,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p;return ee(this,function(g){switch(g.label){case 0:if(a=e.map(function(){return!1}),i={},s=null!=o?o.map(function(){return!1}):[],u=[],e.forEach(function(m,y){var x=0;m.weights.forEach(function(w){var _=hs["quantization"in w?w.quantization.dtype:w.dtype]*re(w.shape),E=function(){a[y]=!0,null==i[y]&&(i[y]=[]),i[y].push({manifestEntry:w,groupOffset:x,sizeBytes:_})};null!=o?o.forEach(function(F,I){F===w.name&&(E(),s[I]=!0)}):E(),u.push(w.name),x+=_})}),!s.every(function(m){return m}))throw c=o.filter(function(m,y){return!s[y]}),new Error("Could not find weights in manifest with names: "+c.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return l=a.reduce(function(m,y,x){return y&&m.push(x),m},[]),h=[],l.forEach(function(m){e[m].paths.forEach(function(y){var x=t+(t.endsWith("/")?"":"/")+y;h.push(x)})}),[4,r(h)];case 1:return f=g.sent(),d={},p=0,l.forEach(function(m){for(var y=e[m].paths.length,x=0,w=0;w<y;w++)x+=f[p+w].byteLength;for(var b=new ArrayBuffer(x),_=new Uint8Array(b),E=0,F=0;F<y;F++){var I=new Uint8Array(f[p+F]);_.set(I,E),E+=I.byteLength}i[m].forEach(function(S){var k=ih(b.slice(S.groupOffset,S.groupOffset+S.sizeBytes),[S.manifestEntry]);for(var N in k)d[N]=k[N]}),p+=y}),[2,d]}})})}}Pt.registerSaveRouter(function(r){return O().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith(vs.URL_SCHEME)?(void 0===(n=r.slice(vs.URL_SCHEME.length))&&(n="model"),new vs(n)):null;var n});var bh=function(){function r(n,e){if(this.DEFAULT_METHOD="POST",null==e&&(e={}),this.weightPathPrefix=e.weightPathPrefix,this.onProgress=e.onProgress,null!=e.fetchFunc?(R("function"==typeof e.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=e.fetchFunc):this.fetch=O().platform.fetch,R(null!=n&&n.length>0,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(n)&&R(2===n.length,function(){return"URL paths for http must have a length of 2, (actual length is "+n.length+")."}),this.path=n,null!=e.requestInit&&null!=e.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=e.requestInit||{}}return r.prototype.save=function(n){return Q(this,void 0,void 0,function(){var e,a;return ee(this,function(i){switch(i.label){case 0:if(n.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(e=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,e.body.append("model.json",new Blob([JSON.stringify({modelTopology:n.modelTopology,format:n.format,generatedBy:n.generatedBy,convertedBy:n.convertedBy,userDefinedMetadata:n.userDefinedMetadata,weightsManifest:[{paths:["./model.weights.bin"],weights:n.weightSpecs}]})],{type:"application/json"}),"model.json"),null!=n.weightData&&e.body.append("model.weights.bin",new Blob([n.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,e)];case 1:if((a=i.sent()).ok)return[2,{modelArtifactsInfo:xo(n),responses:[a]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+a.status+".")}})})},r.prototype.load=function(){return Q(this,void 0,void 0,function(){var n,e,t,o,a,i,s,u,c,l,h,f;return ee(this,function(d){switch(d.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(n=d.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+n.status+". Please verify this URL points to the model JSON of the model to load.");d.label=2;case 2:return d.trys.push([2,4,,5]),[4,n.json()];case 3:return e=d.sent(),[3,5];case 4:throw d.sent(),t="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?t+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":t+=" Please make sure the server is serving valid JSON for this request.",new Error(t);case 5:if(a=e.weightsManifest,i=e.generatedBy,s=e.convertedBy,u=e.format,c=e.userDefinedMetadata,null==(o=e.modelTopology)&&null==a)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==a?[3,7]:[4,this.loadWeights(a)];case 6:f=d.sent(),l=f[0],h=f[1],d.label=7;case 7:return[2,{modelTopology:o,weightSpecs:l,weightData:h,userDefinedMetadata:c,generatedBy:i,convertedBy:s,format:u}]}})})},r.prototype.loadWeights=function(n){return Q(this,void 0,void 0,function(){var t,o,a,i,s,u,c,h,f;return ee(this,function(d){switch(d.label){case 0:for(void 0,void 0,g=(p=Array.isArray(this.path)?this.path[1]:this.path).lastIndexOf("/"),m=p.lastIndexOf("?"),t=[p.substring(0,g)+"/",m>g?p.substring(m):""],o=t[0],a=t[1],i=this.weightPathPrefix||o,s=[],u=0,c=n;u<c.length;u++)s.push.apply(s,c[u].weights);return h=[],n.forEach(function(p){p.paths.forEach(function(g){h.push(i+g+a)})}),[4,gh(h,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return f=d.sent(),[2,[s,ds(f)]]}var p,g,m})})},r.URL_SCHEME_REGEX=/^https?:\/\//,r}();function ms(r){return null!=r.match(bh.URL_SCHEME_REGEX)}var xh=function(r,n){return typeof fetch>"u"?null:(Array.isArray(r)?r.every(function(e){return ms(e)}):ms(r))?gs(r,{onProgress:n}):null};function gs(r,n){return new bh(r,n)}Pt.registerSaveRouter(xh),Pt.registerLoadRouter(xh);var Ur,ys=function(){function r(n){this.modelArtifacts=n}return r.prototype.load=function(){return Q(this,void 0,void 0,function(){return ee(this,function(n){return[2,this.modelArtifacts]})})},r}(),Lg=function(){function r(n){this.saveHandler=n}return r.prototype.save=function(n){return Q(this,void 0,void 0,function(){return ee(this,function(e){return[2,this.saveHandler(n)]})})},r}(),wh=Object.freeze({browserFiles:function(r){return new Bg(r)},browserHTTPRequest:function(r,n){return gs(r,n)},concatenateArrayBuffers:ds,decodeWeights:ih,encodeWeights:function(r,n){return Q(this,void 0,void 0,function(){var e,t,o,a,i,s=this;return ee(this,function(u){switch(u.label){case 0:for(e=[],t=[],o=Array.isArray(r)?r.map(function(c){return c.name}):Object.keys(r),a=function(c){var l=o[c],h=Array.isArray(r)?r[c].tensor:r[l];if("float32"!==h.dtype&&"int32"!==h.dtype&&"bool"!==h.dtype&&"string"!==h.dtype)throw new Error("Unsupported dtype in weight '"+l+"': "+h.dtype);var f={name:l,shape:h.shape,dtype:h.dtype};if("string"===h.dtype){var d=new Promise(function(p){return Q(s,void 0,void 0,function(){var g,m,y,x,w,b,_;return ee(this,function(E){switch(E.label){case 0:return[4,h.bytes()];case 1:for(g=E.sent(),m=g.reduce(function(F,I){return F+I.length},0)+ma*g.length,y=new Uint8Array(m),x=0,w=0;w<g.length;w++)b=g[w],_=new Uint8Array(new Uint32Array([b.length]).buffer),y.set(_,x),y.set(b,x+=ma),x+=b.length;return p(y),[2]}})})});t.push(d)}else t.push(h.data());null!=n&&(f.group=n),e.push(f)},i=0;i<o.length;++i)a(i);return[4,Promise.all(t)];case 1:return[2,{data:Sg(u.sent()),specs:e}]}})})},fromMemory:function(r,n,e,t){return 1===arguments.length?null!=r.modelTopology||null!=r.weightSpecs?new ys(r):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new ys({modelTopology:r})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new ys({modelTopology:r,weightSpecs:n,weightData:e,trainingConfig:t}))},getLoadHandlers:function(r,n){return Pt.getLoadHandlers(r,n)},getModelArtifactsInfoForJSON:xo,getSaveHandlers:function(r){return Pt.getSaveHandlers(r)},http:gs,isHTTPScheme:ms,loadWeights:function(r,n,e,t){return void 0===n&&(n=""),Q(this,void 0,void 0,function(){return ee(this,function(o){return[2,yh(function(a){return gh(a,{requestInit:t})})(r,n,e)]})})},registerLoadRouter:function(r){return Pt.registerLoadRouter(r)},registerSaveRouter:function(r){return Pt.registerSaveRouter(r)},weightsLoaderFactory:yh,withSaveHandler:function(r){return new Lg(r)},copyModel:function(r,n){return Q(this,void 0,void 0,function(){return ee(this,function(e){return[2,ch(r,n,!1)]})})},listModels:function(){return Q(this,void 0,void 0,function(){var r,n,e,t,o,a,i;return ee(this,function(s){switch(s.label){case 0:r=Hn.getSchemes(),n={},e=0,t=r,s.label=1;case 1:return e<t.length?[4,Hn.getManager(o=t[e]).listModels()]:[3,4];case 2:for(i in a=s.sent())n[o+Or+i]=a[i];s.label=3;case 3:return e++,[3,1];case 4:return[2,n]}})})},moveModel:function(r,n){return Q(this,void 0,void 0,function(){return ee(this,function(e){return[2,ch(r,n,!0)]})})},removeModel:function(r){return Q(this,void 0,void 0,function(){var n;return ee(this,function(e){return n=ga(r),[2,Hn.getManager(n.scheme).removeModel(n.path)]})})}}),Wg=D({confusionMatrix_:function(r,n,e){var t=C(r,"labels","confusionMatrix"),o=C(n,"predictions","confusionMatrix");R(null==e||e>0&&Number.isInteger(e),function(){return"If provided, numClasses must be a positive integer, but got "+e}),R(1===t.rank,function(){return"Expected the rank of labels to be 1, but got "+t.rank}),R(1===o.rank,function(){return"Expected the rank of predictions to be 1, but got "+o.rank}),R(t.shape[0]===o.shape[0],function(){return"Mismatch in the number of examples: "+t.shape[0]+" vs. "+o.shape[0]+". Labels and predictions should have the same number of elements."}),R(e>0&&Number.isInteger(e),function(){return"numClasses is required to be a positive integer, but got "+e});var a=wi(t.asType("int32"),e),i=wi(o.asType("int32"),e);return a.transpose().matMul(i).asType("int32")}}),Ug=(Object.freeze({confusionMatrix:Wg}),D({fromPixels_:function(r,n){if(void 0===n&&(n=3),n>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==r)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var e=!1,t=!1,o=!1,a=!1,i=!1;if(r.data instanceof Uint8Array)e=!0;else if(typeof ImageData<"u"&&r instanceof ImageData)t=!0;else if(typeof HTMLVideoElement<"u"&&r instanceof HTMLVideoElement)o=!0;else if(typeof HTMLImageElement<"u"&&r instanceof HTMLImageElement)a=!0;else{if(null==r.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+r.constructor.name);i=!0}if(o&&o&&r.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=zt("FromPixels",A.backendName))return A.runKernel("FromPixels",{pixels:r},{numChannels:n});var s,u,c=o?[r.videoWidth,r.videoHeight]:[r.width,r.height],l=c[0],h=c[1];if(i?s=r.getContext("2d").getImageData(0,0,l,h).data:t||e?s=r.data:(a||o)&&(null==Ur&&(Ur=document.createElement("canvas").getContext("2d")),Ur.canvas.width=l,Ur.canvas.height=h,Ur.drawImage(r,0,0,l,h),s=Ur.getImageData(0,0,l,h).data),4===n)u=new Int32Array(s);else{var f=l*h;u=new Int32Array(f*n);for(var d=0;d<f;d++)for(var p=0;p<n;++p)u[d*n+p]=s[4*d+p]}return yi(u,[h,l,n],"int32")}})),bs=Object.freeze({toPixels:function(r,n){return Q(this,void 0,void 0,function(){var e,t,o,a,i,s,u,c,l,d,p,g,m,y,x,w,b,_,E,F,I;return ee(this,function(S){switch(S.label){case 0:if(e=C(r,"img","toPixels"),r instanceof Me||(e=e.toInt()),2!==e.rank&&3!==e.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+e.rank+".");if(t=e.shape.slice(0,2),o=t[0],a=t[1],(i=2===e.rank?1:e.shape[2])>4||2===i)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+i);return[4,e.data()];case 1:return s=S.sent(),u=e.min(),c=e.max(),[4,Promise.all([u.data(),c.data()])];case 2:if(l=S.sent(),d=l[0][0],p=l[1][0],u.dispose(),c.dispose(),"float32"===e.dtype){if(d<0||p>1)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+d+" - "+p+"].")}else{if("int32"!==e.dtype)throw new Error("Unsupported type for toPixels: "+e.dtype+". Please use float32 or int32 tensors.");if(d<0||p>255)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+d+" - "+p+"].")}for(g="float32"===e.dtype?255:1,m=new Uint8ClampedArray(a*o*4),y=0;y<o*a;++y)x=void 0,w=void 0,b=void 0,_=void 0,1===i?(x=s[y]*g,w=s[y]*g,b=s[y]*g,_=255):3===i?(x=s[3*y]*g,w=s[3*y+1]*g,b=s[3*y+2]*g,_=255):4===i&&(x=s[4*y]*g,w=s[4*y+1]*g,b=s[4*y+2]*g,_=s[4*y+3]*g),m[0+(E=4*y)]=Math.round(x),m[E+1]=Math.round(w),m[E+2]=Math.round(b),m[E+3]=Math.round(_);return null!=n&&(n.width=a,n.height=o,F=n.getContext("2d"),I=new ImageData(m,a,o),F.putImageData(I,0,0)),e!==r&&e.dispose(),[2,m]}})})},fromPixels:Ug}),_h=function(){function r(){}return r.prototype.getClassName=function(){return this.constructor.className},r.fromConfig=function(n,e){return new n(e)},r}(),Ch=function(){function r(){this.classNameMap={}}return r.getMap=function(){return null==r.instance&&(r.instance=new r),r.instance},r.register=function(n){r.getMap().classNameMap[n.className]=[n,n.fromConfig]},r}();function Xn(r){R(null!=r.className,function(){return"Class being registered does not have the static className property defined."}),R("string"==typeof r.className,function(){return"className is required to be a string, but got type "+typeof r.className}),R(r.className.length>0,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),Ch.register(r)}function xs(){return 32===A.backend.floatPrecision()?.001:.1}function ws(r,n,e){var t=!0;if((ht(r)||ht(n))&&(t=!1),ht(r)&&ht(n)&&(t=!0),t){var o=r.constructor.name,a=n.constructor.name;if(o!==a)throw new Error("Arrays are of different type. Actual: "+o+". Expected: "+a)}if(Array.isArray(r)&&Array.isArray(n)){var i=nn(r),s=nn(n);if(!Je(i,s))throw new Error("Arrays have different shapes. Actual: ["+i+"]. Expected: ["+s+"]")}var u=ht(r)?r:mn(r),c=ht(n)?n:mn(n);if(u.length!==c.length)throw new Error("Arrays have different lengths actual: "+u.length+" vs expected: "+c.length+".\nActual:   "+u+".\nExpected: "+c+".");for(var l=0;l<c.length;++l){var h=u[l],f=c[l];if(!e(h,f))throw new Error("Arrays differ: actual["+l+"] = "+h+", expected["+l+"] = "+f+".\nActual:   "+u+".\nExpected: "+c+".")}}function _s(r,n,e){return!isFinite(r)&&!isFinite(n)||!(isNaN(r)||isNaN(n)||Math.abs(r-n)>e)}Object.freeze({Serializable:_h,SerializationMap:Ch,registerClass:Xn}),Object.freeze({TEST_EPSILON_FLOAT16:.1,expectArraysClose:function(r,n,e){return null==e&&(e=xs()),ws(r,n,function(t,o){return _s(t,o,e)})},testEpsilon:xs,expectPromiseToFail:function(r,n){r().then(function(){return n.fail()},function(){return n()})},expectArraysEqual:function(r,n){var e="string"==typeof n||"number"==typeof n||"boolean"==typeof n?[n]:n;return Wn(r)||Wn(r[0])||Wn(n)||Wn(n[0])?ws(r,e,function(t,o){return t==o}):ws(r,n,function(t,o){return _s(t,o,0)})},expectNumbersClose:function(r,n,e){if(null==e&&(e=xs()),!_s(r,n,e))throw new Error("Numbers differ: actual === "+r+", expected === "+n)},expectValuesInRange:function(r,n,e){for(var t=0;t<r.length;t++)if(r[t]<n||r[t]>e)throw new Error("Value out of range:"+r[t]+" low: "+n+", high: "+e)},expectArrayBuffersEqual:function(r,n){expect(new Float32Array(r)).toEqual(new Float32Array(n))}}),Object.freeze({gpgpu_util:lp,webgl_util:Pf,forceHalfFloat:function(){O().set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:wl,setWebGLContext:Pu,GPGPUContext:ol});var dr=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return Ft(n,r),n.prototype.minimize=function(e,t,o){void 0===t&&(t=!1);var a=this.computeGradients(e,o),i=a.value,s=a.grads;if(null!=o){var u=o.map(function(c){return{name:c.name,tensor:s[c.name]}});this.applyGradients(u)}else this.applyGradients(s);return Et(s),t?i:(i.dispose(),null)},Object.defineProperty(n.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),n.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},n.prototype.computeGradients=function(e,t){return function pd(r,n){R(Un(r),function(){return"The f passed in variableGrads(f) must be a function"}),R(null==n||Array.isArray(n)&&n.every(function(l){return l instanceof Sr}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var e=null!=n;if(!e)for(var t in n=[],A.registeredVariables)n.push(A.registeredVariables[t]);var o=e?n.filter(function(l){return!l.trainable}):null,a=n.length;R((n=n.filter(function(l){return l.trainable})).length>0,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+a+" variables is trainable."});var i=A.gradients(r,n,null,!0),s=i.value,u=i.grads;R(u.some(function(l){return null!=l}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),R(0===s.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+s.rank+" tensor"});var c={};return n.forEach(function(l,h){null!=u[h]&&(c[l.name]=u[h])}),null!=o&&o.forEach(function(l){return c[l.name]=null}),{value:s,grads:c}}(e,t)},n.prototype.dispose=function(){null!=this.iterations_&&Et(this.iterations_)},n.prototype.saveIterations=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:$(this.iterations_,"int32")}]})})},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},n.prototype.extractIterations=function(e){return Q(this,void 0,void 0,function(){var t;return ee(this,function(o){switch(o.label){case 0:return t=this,[4,e[0].tensor.data()];case 1:return t.iterations_=o.sent()[0],[2,e.slice(1)]}})})},n}(_h);Object.defineProperty(dr,Symbol.hasInstance,{value:function(r){return null!=r.minimize&&null!=r.computeGradients&&null!=r.applyGradients}});var Rh=function(r){function n(e,t,o){void 0===o&&(o=null);var a=r.call(this)||this;return a.learningRate=e,a.rho=t,a.epsilon=o,a.accumulatedGrads=[],a.accumulatedUpdates=[],null==o&&(a.epsilon=A.backend.epsilon()),a}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=A.registeredVariables[o];null==t.accumulatedGrads[a]&&(t.accumulatedGrads[a]={originalName:o+"/accum_grad",variable:Z(function(){return Se(i).variable(!1)})}),null==t.accumulatedUpdates[a]&&(t.accumulatedUpdates[a]={originalName:o+"/accum_var",variable:Z(function(){return Se(i).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=t.accumulatedGrads[a].variable,c=t.accumulatedUpdates[a].variable;Z(function(){var l=u.mul(t.rho).add(s.square().mul(1-t.rho)),h=c.add(t.epsilon).sqrt().div(u.add(t.epsilon).sqrt()).mul(s),f=c.mul(t.rho).add(h.square().mul(1-t.rho));u.assign(l),c.assign(f);var d=h.mul(-t.learningRate).add(i);i.assign(d)})}}),this.incrementIterations()},n.prototype.dispose=function(){null!=this.accumulatedUpdates&&(Et(this.accumulatedGrads.map(function(e){return e.variable})),Et(this.accumulatedUpdates.map(function(e){return e.variable})))},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){var e;return ee(this,function(t){switch(t.label){case 0:return e=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[t.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){var t;return ee(this,function(o){switch(o.label){case 0:return[4,this.extractIterations(e)];case 1:return e=o.sent(),this.accumulatedGrads=e.slice(0,t=e.length/2).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedUpdates=e.slice(t,2*t).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},n.fromConfig=function(e,t){return new e(t.learningRate,t.rho,t.epsilon)},n.className="Adadelta",n}(dr);Xn(Rh);var Sh=function(r){function n(e,t){void 0===t&&(t=.1);var o=r.call(this)||this;return o.learningRate=e,o.initialAccumulatorValue=t,o.accumulatedGrads=[],o}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=A.registeredVariables[o];null==t.accumulatedGrads[a]&&(t.accumulatedGrads[a]={originalName:o+"/accumulator",variable:Z(function(){return on(i.shape,t.initialAccumulatorValue).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=t.accumulatedGrads[a].variable;Z(function(){var c=u.add(s.square());u.assign(c);var l=s.div(c.add(A.backend.epsilon()).sqrt()).mul(-t.learningRate).add(i);i.assign(l)})}}),this.incrementIterations()},n.prototype.dispose=function(){null!=this.accumulatedGrads&&Et(this.accumulatedGrads.map(function(e){return e.variable}))},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulatedGrads.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){switch(t.label){case 0:return[4,this.extractIterations(e)];case 1:return e=t.sent(),this.accumulatedGrads=e.map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},n.fromConfig=function(e,t){return new e(t.learningRate,t.initialAccumulatorValue)},n.className="Adagrad",n}(dr);Xn(Sh);var kh=function(r){function n(e,t,o,a){void 0===a&&(a=null);var i=r.call(this)||this;return i.learningRate=e,i.beta1=t,i.beta2=o,i.epsilon=a,i.accumulatedFirstMoment=[],i.accumulatedSecondMoment=[],Z(function(){i.accBeta1=$(t).variable(),i.accBeta2=$(o).variable()}),null==a&&(i.epsilon=A.backend.epsilon()),i}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this,o=Array.isArray(e)?e.map(function(a){return a.name}):Object.keys(e);Z(function(){var a=ot(1,t.accBeta1),i=ot(1,t.accBeta2);o.forEach(function(s,u){var c=A.registeredVariables[s];null==t.accumulatedFirstMoment[u]&&(t.accumulatedFirstMoment[u]={originalName:s+"/m",variable:Z(function(){return Se(c).variable(!1)})}),null==t.accumulatedSecondMoment[u]&&(t.accumulatedSecondMoment[u]={originalName:s+"/v",variable:Z(function(){return Se(c).variable(!1)})});var l=Array.isArray(e)?e[u].tensor:e[s];if(null!=l){var h=t.accumulatedFirstMoment[u].variable,f=t.accumulatedSecondMoment[u].variable,d=h.mul(t.beta1).add(l.mul(1-t.beta1)),p=f.mul(t.beta2).add(l.square().mul(1-t.beta2)),g=d.div(a),m=p.div(i);h.assign(d),f.assign(p);var y=g.div(m.sqrt().add(t.epsilon)).mul(-t.learningRate).add(c);c.assign(y)}}),t.accBeta1.assign(t.accBeta1.mul(t.beta1)),t.accBeta2.assign(t.accBeta2.mul(t.beta2))}),this.incrementIterations()},n.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&Et(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedSecondMoment&&Et(this.accumulatedSecondMoment.map(function(e){return e.variable}))},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){var e;return ee(this,function(t){switch(t.label){case 0:return e=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[t.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){var t,o=this;return ee(this,function(a){switch(a.label){case 0:return[4,this.extractIterations(e)];case 1:return e=a.sent(),Z(function(){o.accBeta1.assign(la(o.beta1,o.iterations_+1)),o.accBeta2.assign(la(o.beta2,o.iterations_+1))}),this.accumulatedFirstMoment=e.slice(0,t=e.length/2).map(function(i){return{originalName:i.name,variable:i.tensor.variable(!1)}}),this.accumulatedSecondMoment=e.slice(t,2*t).map(function(i){return{originalName:i.name,variable:i.tensor.variable(!1)}}),[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},n.fromConfig=function(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon)},n.className="Adam",n}(dr);Xn(kh);var Ih=function(r){function n(e,t,o,a,i){void 0===a&&(a=null),void 0===i&&(i=0);var s=r.call(this)||this;return s.learningRate=e,s.beta1=t,s.beta2=o,s.epsilon=a,s.decay=i,s.accumulatedFirstMoment=[],s.accumulatedWeightedInfNorm=[],Z(function(){s.iteration=$(0).variable(),s.accBeta1=$(t).variable()}),null==a&&(s.epsilon=A.backend.epsilon()),s}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this,o=Array.isArray(e)?e.map(function(a){return a.name}):Object.keys(e);Z(function(){var a=ot(1,t.accBeta1),i=$t(-t.learningRate,t.iteration.mul(t.decay).add(1));o.forEach(function(s,u){var c=A.registeredVariables[s];null==t.accumulatedFirstMoment[u]&&(t.accumulatedFirstMoment[u]={originalName:s+"/m",variable:Se(c).variable(!1)}),null==t.accumulatedWeightedInfNorm[u]&&(t.accumulatedWeightedInfNorm[u]={originalName:s+"/v",variable:Se(c).variable(!1)});var l=Array.isArray(e)?e[u].tensor:e[s];if(null!=l){var h=t.accumulatedFirstMoment[u].variable,f=t.accumulatedWeightedInfNorm[u].variable,d=h.mul(t.beta1).add(l.mul(1-t.beta1)),p=f.mul(t.beta2),g=l.abs(),m=p.maximum(g);h.assign(d),f.assign(m);var y=i.div(a).mul(d.div(m.add(t.epsilon))).add(c);c.assign(y)}}),t.iteration.assign(t.iteration.add(1)),t.accBeta1.assign(t.accBeta1.mul(t.beta1))}),this.incrementIterations()},n.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&Et(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedWeightedInfNorm&&Et(this.accumulatedWeightedInfNorm.map(function(e){return e.variable}))},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){throw new Error("getWeights() is not implemented for Adamax yet.")})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){throw new Error("setWeights() is not implemented for Adamax yet.")})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},n.fromConfig=function(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon,t.decay)},n.className="Adamax",n}(dr);Xn(Ih);var Cs=function(r){function n(e){var t=r.call(this)||this;return t.learningRate=e,t.setLearningRate(e),t}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=Array.isArray(e)?e[a].tensor:e[o];if(null!=i){var s=A.registeredVariables[o];Z(function(){var u=t.c.mul(i).add(s);s.assign(u)})}}),this.incrementIterations()},n.prototype.setLearningRate=function(e){this.learningRate=e,null!=this.c&&this.c.dispose(),this.c=function Mf(r){return A.keep(r)}($(-e))},n.prototype.dispose=function(){this.c.dispose()},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()]]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){switch(t.label){case 0:return[4,this.extractIterations(e)];case 1:if(0!==(e=t.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate}},n.fromConfig=function(e,t){return new e(t.learningRate)},n.className="SGD",n}(dr);Xn(Cs);var Fh=function(r){function n(e,t,o){void 0===o&&(o=!1);var a=r.call(this,e)||this;return a.learningRate=e,a.momentum=t,a.useNesterov=o,a.accumulations=[],a.m=$(a.momentum),a}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=A.registeredVariables[o];null==t.accumulations[a]&&(t.accumulations[a]={originalName:o+"/momentum",variable:Z(function(){return Se(i).variable(!1)})});var s=t.accumulations[a].variable,u=Array.isArray(e)?e[a].tensor:e[o];null!=u&&Z(function(){var c,l=t.m.mul(s).add(u);c=t.useNesterov?t.c.mul(u.add(l.mul(t.m))).add(i):t.c.mul(l).add(i),s.assign(l),i.assign(c)})}),this.incrementIterations()},n.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&Et(this.accumulations.map(function(e){return e.variable}))},n.prototype.setMomentum=function(e){this.momentum=e},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){return ee(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulations.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){return ee(this,function(t){switch(t.label){case 0:return[4,this.extractIterations(e)];case 1:return e=t.sent(),this.accumulations=e.map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},n.fromConfig=function(e,t){return new e(t.learningRate,t.momentum,t.useNesterov)},n.className="Momentum",n}(Cs);Xn(Fh);var Ah=function(r){function n(e,t,o,a,i){void 0===t&&(t=.9),void 0===o&&(o=0),void 0===a&&(a=null),void 0===i&&(i=!1);var s=r.call(this)||this;if(s.learningRate=e,s.decay=t,s.momentum=o,s.epsilon=a,s.accumulatedMeanSquares=[],s.accumulatedMoments=[],s.accumulatedMeanGrads=[],s.centered=i,null==a&&(s.epsilon=A.backend.epsilon()),null==e)throw new Error("learningRate for RMSPropOptimizer must be defined.");return s}return Ft(n,r),n.prototype.applyGradients=function(e){var t=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=A.registeredVariables[o];null==t.accumulatedMeanSquares[a]&&(t.accumulatedMeanSquares[a]={originalName:o+"/rms",variable:Z(function(){return Se(i).variable(!1)})}),null==t.accumulatedMoments[a]&&(t.accumulatedMoments[a]={originalName:o+"/momentum",variable:Z(function(){return Se(i).variable(!1)})}),null==t.accumulatedMeanGrads[a]&&t.centered&&(t.accumulatedMeanGrads[a]={originalName:o+"/mg",variable:Z(function(){return Se(i).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=t.accumulatedMeanSquares[a].variable,c=t.accumulatedMoments[a].variable;Z(function(){var l=u.mul(t.decay).add(s.square().mul(1-t.decay));if(t.centered){var h=t.accumulatedMeanGrads[a].variable,f=h.mul(t.decay).add(s.mul(1-t.decay)),d=c.mul(t.momentum).add(s.mul(t.learningRate).div(l.sub(f.square().add(t.epsilon)).sqrt()));u.assign(l),h.assign(f),c.assign(d);var p=i.sub(d);i.assign(p)}else{var g=u.mul(t.decay).add(s.square().mul(1-t.decay));d=c.mul(t.momentum).add(s.mul(t.learningRate).div(g.add(t.epsilon).sqrt())),u.assign(g),c.assign(d),p=i.sub(d),i.assign(p)}})}}),this.incrementIterations()},n.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&Et(this.accumulatedMeanSquares.map(function(e){return e.variable})),null!=this.accumulatedMeanGrads&&this.centered&&Et(this.accumulatedMeanGrads.map(function(e){return e.variable})),null!=this.accumulatedMoments&&Et(this.accumulatedMoments.map(function(e){return e.variable}))},n.prototype.getWeights=function(){return Q(this,void 0,void 0,function(){var e;return ee(this,function(t){switch(t.label){case 0:return e=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&e.push.apply(e,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[t.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},n.prototype.setWeights=function(e){return Q(this,void 0,void 0,function(){var t;return ee(this,function(o){switch(o.label){case 0:return[4,this.extractIterations(e)];case 1:return e=o.sent(),this.accumulatedMeanSquares=e.slice(0,t=this.centered?e.length/3:e.length/2).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedMoments=e.slice(t,2*t).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=e.slice(2*t,3*t).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}})),[2]}})})},n.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},n.fromConfig=function(e,t){return new e(t.learningRate,t.decay,t.momentum,t.epsilon,t.centered)},n.className="RMSProp",n}(dr);Xn(Ah),function(){function r(){}r.sgd=function(n){return new Cs(n)},r.momentum=function(n,e,t){return void 0===t&&(t=!1),new Fh(n,e,t)},r.rmsprop=function(n,e,t,o,a){return void 0===e&&(e=.9),void 0===t&&(t=0),void 0===o&&(o=null),void 0===a&&(a=!1),new Ah(n,e,t,o,a)},r.adam=function(n,e,t,o){return void 0===n&&(n=.001),void 0===e&&(e=.9),void 0===t&&(t=.999),void 0===o&&(o=null),new kh(n,e,t,o)},r.adadelta=function(n,e,t){return void 0===n&&(n=.001),void 0===e&&(e=.95),void 0===t&&(t=null),new Rh(n,e,t)},r.adamax=function(n,e,t,o,a){return void 0===n&&(n=.002),void 0===e&&(e=.9),void 0===t&&(t=.999),void 0===o&&(o=null),void 0===a&&(a=0),new Ih(n,e,t,o,a)},r.adagrad=function(n,e){return void 0===e&&(e=.1),new Sh(n,e)}}(),typeof requestAnimationFrame<"u"?requestAnimationFrame:typeof setImmediate<"u"&&setImmediate,Me.prototype.squaredDifference=function(r){return _l(this,r)},M=bg;var Es=function(r,n){return(Es=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(r,n)};function fe(r,n){function e(){this.constructor=r}Es(r,n),r.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var xt=function(){return xt=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++)for(var a in e=arguments[t])Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]);return n},xt.apply(this,arguments)};function oe(r,n,e,t){return new(e||(e=Promise))(function(a,i){function s(l){try{c(t.next(l))}catch(h){i(h)}}function u(l){try{c(t.throw(l))}catch(h){i(h)}}function c(l){l.done?a(l.value):function o(a){return a instanceof e?a:new e(function(i){i(a)})}(l.value).then(s,u)}c((t=t.apply(r,n||[])).next())})}function ae(r,n){var t,o,a,i,e={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(c){return function(l){return function u(c){if(t)throw new TypeError("Generator is already executing.");for(;e;)try{if(t=1,o&&(a=2&c[0]?o.return:c[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,c[1])).done)return a;switch(o=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,o=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(!(a=(a=e.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){e=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){e.label=c[1];break}if(6===c[0]&&e.label<a[1]){e.label=a[1],a=c;break}if(a&&e.label<a[2]){e.label=a[2],e.ops.push(c);break}a[2]&&e.ops.pop(),e.trys.pop();continue}c=n.call(r,e)}catch(l){c=[6,l],o=0}finally{t=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}function wo(){for(var r=0,n=0,e=arguments.length;n<e;n++)r+=arguments[n].length;var t=Array(r),o=0;for(n=0;n<e;n++)for(var a=arguments[n],i=0,s=a.length;i<s;i++,o++)t[o]=a[i];return t}var Vr=function(){function r(n,e){if(!vr(n)||!vr(e))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:n,height:e}));this._width=n,this._height=e}return Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),r.prototype.reverse=function(){return new r(1/this.width,1/this.height)},r}();function _o(r,n){return r instanceof Me&&r.shape.length===n}function ba(r){return _o(r,3)}function Kn(r){return _o(r,4)}function Th(r){return r%2==0}function Nh(r){return r&&r.width&&r.height}function Rs(r){return r.reduce(function(n,e){return n.add(e)},new Fe(0,0)).div(new Fe(r.length,r.length))}function Co(r,n,e){return Array(r).fill(0).map(function(t,o){return n+o*e})}function vr(r){return!!r&&r!==1/0&&r!==-1/0&&!isNaN(r)||0===r}function Ph(r){return vr(r)&&0<=r&&r<=1}var Fe=function(){function r(n,e){this._x=n,this._y=e}return Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),r.prototype.add=function(n){return new r(this.x+n.x,this.y+n.y)},r.prototype.sub=function(n){return new r(this.x-n.x,this.y-n.y)},r.prototype.mul=function(n){return new r(this.x*n.x,this.y*n.y)},r.prototype.div=function(n){return new r(this.x/n.x,this.y/n.y)},r.prototype.abs=function(){return new r(Math.abs(this.x),Math.abs(this.y))},r.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},r.prototype.floor=function(){return new r(Math.floor(this.x),Math.floor(this.y))},r}(),En=function(){function r(n,e){void 0===e&&(e=!0);var t=n||{},o=[t.left,t.top,t.right,t.bottom].every(vr),a=[t.x,t.y,t.width,t.height].every(vr);if(!a&&!o)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(t));var i=a?[t.x,t.y,t.width,t.height]:[t.left,t.top,t.right-t.left,t.bottom-t.top],s=i[0],u=i[1],c=i[2],l=i[3];r.assertIsValidBox({x:s,y:u,width:c,height:l},"Box.constructor",e),this._x=s,this._y=u,this._width=c,this._height=l}return r.isRect=function(n){return!!n&&[n.x,n.y,n.width,n.height].every(vr)},r.assertIsValidBox=function(n,e,t){if(void 0===t&&(t=!1),!r.isRect(n))throw new Error(e+" - invalid box: "+JSON.stringify(n)+", expected object with properties x, y, width, height");if(!t&&(n.width<0||n.height<0))throw new Error(e+" - width ("+n.width+") and height ("+n.height+") must be positive numbers")},Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topLeft",{get:function(){return new Fe(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topRight",{get:function(){return new Fe(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomLeft",{get:function(){return new Fe(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomRight",{get:function(){return new Fe(this.right,this.bottom)},enumerable:!0,configurable:!0}),r.prototype.round=function(){var n=[this.x,this.y,this.width,this.height].map(function(i){return Math.round(i)});return new r({x:n[0],y:n[1],width:n[2],height:n[3]})},r.prototype.floor=function(){var n=[this.x,this.y,this.width,this.height].map(function(i){return Math.floor(i)});return new r({x:n[0],y:n[1],width:n[2],height:n[3]})},r.prototype.toSquare=function(){var n=this,e=n.x,t=n.y,o=n.width,a=n.height,i=Math.abs(o-a);return o<a&&(e-=i/2,o+=i),a<o&&(t-=i/2,a+=i),new r({x:e,y:t,width:o,height:a})},r.prototype.rescale=function(n){var e=Nh(n)?n.width:n,t=Nh(n)?n.height:n;return new r({x:this.x*e,y:this.y*t,width:this.width*e,height:this.height*t})},r.prototype.pad=function(n,e){var t=[this.x-n/2,this.y-e/2,this.width+n,this.height+e];return new r({x:t[0],y:t[1],width:t[2],height:t[3]})},r.prototype.clipAtImageBorders=function(n,e){var t=this,a=t.y,i=t.right,s=t.bottom,u=Math.max(t.x,0),c=Math.max(a,0),h=s-c;return new r({x:u,y:c,width:Math.min(i-u,n-u),height:Math.min(h,e-c)}).floor()},r.prototype.shift=function(n,e){return new r({x:this.x+n,y:this.y+e,width:this.width,height:this.height})},r.prototype.padAtBorders=function(n,e){var t=this.width+1,o=this.height+1,s=t,u=o,c=this.left,l=this.top,h=this.right,f=this.bottom;return h>e&&(s=-h+e+t,h=e),f>n&&(u=-f+n+o,f=n),c<1&&(u=2-c,c=1),l<1&&(u=2-l,l=1),{dy:1,edy:u,dx:1,edx:s,y:l,ey:f,x:c,ex:h,w:t,h:o}},r.prototype.calibrate=function(n){return new r({left:this.left+n.left*this.width,top:this.top+n.top*this.height,right:this.right+n.right*this.width,bottom:this.bottom+n.bottom*this.height}).toSquare().round()},r}(),xa=function(r){function n(e,t,o,a,i){return void 0===i&&(i=!1),r.call(this,{left:e,top:t,right:o,bottom:a},i)||this}return fe(n,r),n}(En),Mh=function(){function r(n,e,t,o,a){this._imageDims=new Vr(a.width,a.height),this._score=n,this._classScore=e,this._className=t,this._box=new En(o).rescale(this._imageDims)}return Object.defineProperty(r.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativeBox",{get:function(){return new En(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),r.prototype.forSize=function(n,e){return new r(this.score,this.classScore,this.className,this.relativeBox,{width:n,height:e})},r}(),sn=function(r){function n(e,t,o){return r.call(this,e,e,"",t,o)||this}return fe(n,r),n.prototype.forSize=function(e,t){var o=r.prototype.forSize.call(this,e,t);return new n(o.score,o.relativeBox,o.imageDims)},n}(Mh);function Yg(r,n,e){void 0===e&&(e=!0);var a=Math.max(0,Math.min(r.right,n.right)-Math.max(r.left,n.left))*Math.max(0,Math.min(r.bottom,n.bottom)-Math.max(r.top,n.top));return e?a/(r.area+n.area-a):a/Math.min(r.area,n.area)}function Eo(r,n,e,t){void 0===t&&(t=!0);for(var o=n.map(function(s,u){return{score:s,boxIndex:u}}).sort(function(s,u){return s.score-u.score}).map(function(s){return s.boxIndex}),a=[],i=function(){var s=o.pop();a.push(s);for(var u=o,c=[],l=0;l<u.length;l++)c.push(Yg(r[s],r[u[l]],t));o=o.filter(function(p,g){return c[g]<=e})};o.length>0;)i();return a}function Ro(r,n){return Z(function(){var e=n[0],t=n[1],o=n[2],a=on(wo(r.shape.slice(0,3),[1]),e),i=on(wo(r.shape.slice(0,3),[1]),t),s=on(wo(r.shape.slice(0,3),[1]),o),u=nt([a,i,s],3);return ot(r,u)})}function Ss(r){return 1/(1+Math.exp(-r))}var at,wa=function(r){function n(e,t,o,a,i){return void 0===i&&(i=!1),r.call(this,{x:e,y:t,width:o,height:a},i)||this}return fe(n,r),n}(En),_a=function(){function r(n,e,t){void 0===t&&(t=new Fe(0,0));var o=e.width,a=e.height;this._imgDims=new Vr(o,a),this._shift=t,this._positions=n.map(function(i){return i.mul(new Fe(o,a)).add(t)})}return Object.defineProperty(r.prototype,"shift",{get:function(){return new Fe(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativePositions",{get:function(){var n=this;return this._positions.map(function(e){return e.sub(n._shift).div(new Fe(n.imageWidth,n.imageHeight))})},enumerable:!0,configurable:!0}),r.prototype.forSize=function(n,e){return new this.constructor(this.relativePositions,{width:n,height:e})},r.prototype.shiftBy=function(n,e){return new this.constructor(this.relativePositions,this._imgDims,new Fe(n,e))},r.prototype.shiftByPoint=function(n){return this.shiftBy(n.x,n.y)},r.prototype.align=function(n,e){if(void 0===e&&(e={}),n){var t=n instanceof sn?n.box.floor():new En(n);return this.shiftBy(t.x,t.y).align(null,e)}var o=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},e),i=o.minBoxPadding;return o.useDlibAlignment?this.alignDlib():this.alignMinBbox(i)},r.prototype.alignDlib=function(){var n=this.getRefPointsForAlignment(),t=n[1],o=n[2],a=function(h){return o.sub(h).magnitude()},i=(a(n[0])+a(t))/2,s=Math.floor(i/.45),u=Rs(n),c=Math.floor(Math.max(0,u.x-.5*s)),l=Math.floor(Math.max(0,u.y-.43*s));return new wa(c,l,Math.min(s,this.imageWidth+c),Math.min(s,this.imageHeight+l))},r.prototype.alignMinBbox=function(n){var e=function Kg(r){var n=r.map(function(s){return s.x}),e=r.map(function(s){return s.y}),t=n.reduce(function(s,u){return u<s?u:s},1/0),o=e.reduce(function(s,u){return u<s?u:s},1/0),a=n.reduce(function(s,u){return s<u?u:s},0),i=e.reduce(function(s,u){return s<u?u:s},0);return new xa(t,o,a,i)}(this.positions);return e.pad(e.width*n,e.height*n)},r.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},r}(),e0=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],Rs([e[3],e[4]])]},n}(_a),Oh=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.getJawOutline=function(){return this.positions.slice(0,17)},n.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},n.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},n.prototype.getNose=function(){return this.positions.slice(27,36)},n.prototype.getLeftEye=function(){return this.positions.slice(36,42)},n.prototype.getRightEye=function(){return this.positions.slice(42,48)},n.prototype.getMouth=function(){return this.positions.slice(48,68)},n.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(Rs)},n}(_a),Bh=function(){function r(n,e){this._label=n,this._distance=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),r.prototype.toString=function(n){return void 0===n&&(n=!0),this.label+(n?" ("+function qg(r,n){void 0===n&&(n=2);var e=Math.pow(10,n);return Math.floor(r*e)/e}(this.distance)+")":"")},r}(),Lh=function(r){function n(e,t){var o=r.call(this,e)||this;return o._label=t,o}return fe(n,r),n.assertIsValidLabeledBox=function(e,t){if(En.assertIsValidBox(e,t),!vr(e.label))throw new Error(t+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),n}(En),Ca=function(){function r(n,e){if("string"!=typeof n)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(function(t){return!(t instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=n,this._descriptors=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),r.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(n){return Array.from(n)})}},r.fromJSON=function(n){var e=n.descriptors.map(function(t){return new Float32Array(t)});return new r(n.label,e)},r}();function ks(r,n){return Object.assign({},r,{detection:n})}function Wh(){var r=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:r,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function Uh(r){var n="";if(!r)try{r=ge(Object(function(){var o=new Error("Cannot find module 'fs'");throw o.code="MODULE_NOT_FOUND",o}()))}catch(t){n=t.toString()}return{readFile:r?function(t){return new Promise(function(o,a){r.readFile(t,function(i,s){return i?a(i):o(s)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+n)}}}function Vh(){var r=global.Canvas||global.HTMLCanvasElement,n=global.Image||global.HTMLImageElement,o=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},a=Uh();return xt({Canvas:r||function(){return function i(){}}(),CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){return function i(){}}(),Image:n||function(){return function i(){}}(),ImageData:global.ImageData||function(){return function i(){}}(),Video:global.HTMLVideoElement||function(){return function i(){}}(),createCanvasElement:function(){if(r)return new r;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(n)return new n;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:o},a)}function Gh(){return"object"==typeof window&&typeof document<"u"&&typeof HTMLImageElement<"u"&&typeof HTMLCanvasElement<"u"&&typeof HTMLVideoElement<"u"&&typeof ImageData<"u"&&typeof CanvasRenderingContext2D<"u"}function zh(){return"object"==typeof global&&typeof process<"u"&&!!process.version}function Is(r){at=r}function Fs(){Gh()&&Is(Wh()),zh()&&Is(Vh())}!function(r){function n(e,t,o,a){var i=r.call(this,e,t)||this;return i._score=o,i._classScore=a,i}fe(n,r),n.assertIsValidPredictedBox=function(e,t){if(Lh.assertIsValidLabeledBox(e,t),!Ph(e.score)||!Ph(e.classScore))throw new Error(t+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(n.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0})}(Lh);var vt={getEnv:function n0(){if(!at)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return at},setEnv:Is,initialize:Fs,createBrowserEnv:Wh,createFileSystem:Uh,createNodejsEnv:Vh,monkeyPatch:function r0(r){if(at||Fs(),!at)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var n=r.Canvas,e=void 0===n?at.Canvas:n,t=r.Image,o=void 0===t?at.Image:t;at.Canvas=e,at.Image=o,at.createCanvasElement=r.createCanvasElement||function(){return new e},at.createImageElement=r.createImageElement||function(){return new o},at.ImageData=r.ImageData||at.ImageData,at.Video=r.Video||at.Video,at.fetch=r.fetch||at.fetch,at.readFile=r.readFile||at.readFile},isBrowser:Gh,isNodejs:zh};function As(r){return vt.isNodejs()||"string"!=typeof r?r:document.getElementById(r)}function un(r){var n=vt.getEnv(),e=n.Canvas;if(r instanceof n.CanvasRenderingContext2D)return r;var o=As(r);if(!(o instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var a=o.getContext("2d");if(!a)throw new Error("resolveContext2d - canvas 2d context is null");return a}Fs();var mr=function(r){return r.TOP_LEFT="TOP_LEFT",r.TOP_RIGHT="TOP_RIGHT",r.BOTTOM_LEFT="BOTTOM_LEFT",r.BOTTOM_RIGHT="BOTTOM_RIGHT",r}(mr||{}),jh=function(){return function r(n){void 0===n&&(n={});var t=n.backgroundColor,o=n.fontColor,a=n.fontSize,i=n.fontStyle,s=n.padding;this.anchorPosition=n.anchorPosition||mr.TOP_LEFT,this.backgroundColor=t||"rgba(0, 0, 0, 0.5)",this.fontColor=o||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=i||"Georgia",this.padding=s||4}}();!function(){function r(n,e,t){void 0===t&&(t={}),this.text="string"==typeof n?[n]:n instanceof r?n.text:n,this.anchor=e,this.options=new jh(t)}r.prototype.measureWidth=function(n){var e=this.options.padding;return this.text.map(function(t){return n.measureText(t).width}).reduce(function(t,o){return t<o?o:t},0)+2*e},r.prototype.measureHeight=function(){var n=this.options;return this.text.length*n.fontSize+2*n.padding},r.prototype.getUpperLeft=function(n,e){var t=this.options.anchorPosition,o=t===mr.BOTTOM_RIGHT||t===mr.TOP_RIGHT,a=t===mr.BOTTOM_LEFT||t===mr.BOTTOM_RIGHT,i=this.measureWidth(n),s=this.measureHeight(),u=o?this.anchor.x-i:this.anchor.x,c=a?this.anchor.y-s:this.anchor.y;if(e){var h=e.height;return{x:Math.max(Math.min(u,e.width-i),0),y:Math.max(Math.min(c,h-s),0)}}return{x:u,y:c}},r.prototype.draw=function(n){var e=As(n),t=un(e),o=this.options,a=o.backgroundColor,i=o.fontColor,s=o.fontSize,c=o.padding;t.font=s+"px "+o.fontStyle;var l=this.measureWidth(t),h=this.measureHeight();t.fillStyle=a;var f=this.getUpperLeft(t,e);t.fillRect(f.x,f.y,l,h),t.fillStyle=i,this.text.forEach(function(d,p){t.fillText(d,c+f.x,c+f.y+(p+1)*s)})}}();function Hh(r){var n=vt.getEnv();return r instanceof n.Image&&r.complete||r instanceof n.Video&&r.readyState>=3}function s0(r){return new Promise(function(n,e){if(!(r instanceof Blob))return e("bufferToImage - expected buf to be of type: Blob");var t=new FileReader;t.onload=function(){if("string"!=typeof t.result)return e("bufferToImage - expected reader.result to be a string, in onload");var o=vt.getEnv().createImageElement();o.onload=function(){return n(o)},o.onerror=e,o.src=t.result},t.onerror=e,t.readAsDataURL(r)})}function qh(r){var n=vt.getEnv(),t=n.Video;return r instanceof n.Image?new Vr(r.naturalWidth,r.naturalHeight):r instanceof t?new Vr(r.videoWidth,r.videoHeight):new Vr(r.width,r.height)}function Ea(r){var n=r.width,e=r.height,o=(0,vt.getEnv().createCanvasElement)();return o.width=n,o.height=e,o}function Ds(r,n){var e=vt.getEnv().ImageData;if(!(r instanceof e||Hh(r)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var t=n||qh(r),o=t.width,a=t.height,i=Ea({width:o,height:a});return r instanceof e?un(i).putImageData(r,0,0):un(i).drawImage(r,0,0,o,a),i}function u0(r,n){return oe(this,void 0,void 0,function(){var e,t,o,a,i,s;return ae(this,function(u){switch(u.label){case 0:return e=n||vt.getEnv().createCanvasElement(),t=r.shape.slice(Kn(r)?1:0),o=t[0],a=t[1],i=t[2],s=Z(function(){return r.as3D(o,a,i).toInt()}),[4,bs.toPixels(s,e)];case 1:return u.sent(),s.dispose(),[2,e]}})})}function Xh(r){var n=vt.getEnv();return r instanceof n.Image||r instanceof n.Canvas||r instanceof n.Video}var Ra=function(){function r(n,e){var t=this;if(void 0===e&&(e=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(n))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+n);this._treatAsBatchInput=e,this._batchSize=n.length,n.forEach(function(o,a){if(ba(o))return t._imageTensors[a]=o,void(t._inputDimensions[a]=o.shape);if(Kn(o)){var i=o.shape[0];if(1!==i)throw new Error("NetInput - tf.Tensor4D with batchSize "+i+" passed, but not supported in input array");return t._imageTensors[a]=o,void(t._inputDimensions[a]=o.shape.slice(1))}var s=o instanceof vt.getEnv().Canvas?o:Ds(o);t._canvases[a]=s,t._inputDimensions[a]=[s.height,s.width,3]})}return Object.defineProperty(r.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"reshapedInputDimensions",{get:function(){var n=this;return Co(this.batchSize,0,1).map(function(e,t){return n.getReshapedInputDimensions(t)})},enumerable:!0,configurable:!0}),r.prototype.getInput=function(n){return this.canvases[n]||this.imageTensors[n]},r.prototype.getInputDimensions=function(n){return this._inputDimensions[n]},r.prototype.getInputHeight=function(n){return this._inputDimensions[n][0]},r.prototype.getInputWidth=function(n){return this._inputDimensions[n][1]},r.prototype.getReshapedInputDimensions=function(n){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return function Xg(r,n){var e=r.width,t=r.height,o=n/Math.max(t,e);return new Vr(Math.round(e*o),Math.round(t*o))}({width:this.getInputWidth(n),height:this.getInputHeight(n)},this.inputSize)},r.prototype.toBatchTensor=function(n,e){var t=this;return void 0===e&&(e=!0),this._inputSize=n,Z(function(){var o=Co(t.batchSize,0,1).map(function(i){var s=t.getInput(i);if(s instanceof Me){var u=Kn(s)?s:s.expandDims();return u=function $g(r,n){return void 0===n&&(n=!1),Z(function(){var e=r.shape.slice(1),t=e[0],o=e[1];if(t===o)return r;var a=Math.abs(t-o),i=Math.round(a*(n?.5:1)),s=t>o?2:1,u=function(d){var p=r.shape.slice();return p[s]=d,on(p,0)},c=u(i),l=a-c.shape[s],f=[n&&l?u(l):null,r,c].filter(function(d){return!!d}).map(function(d){return d.toFloat()});return nt(f,s)})}(u,e),(u.shape[1]!==n||u.shape[2]!==n)&&(u=ts.resizeBilinear(u,[n,n])),u.as3D(n,n,3)}if(s instanceof vt.getEnv().Canvas)return bs.fromPixels(function c0(r,n,e){void 0===e&&(e=!1);var t=vt.getEnv(),a=t.Canvas;if(!(r instanceof t.Image||r instanceof a))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var i=qh(r),s=n/Math.max(i.height,i.width),u=s*i.width,c=s*i.height,l=Ea({width:n,height:n}),h=r instanceof a?r:Ds(r),f=Math.abs(u-c)/2,d=e&&u<c?f:0,p=e&&c<u?f:0;return un(l).drawImage(h,d,p,u,c),l}(s,n,e));throw new Error("toBatchTensor - at batchIdx "+i+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+s)});return Nt(o.map(function(i){return i.toFloat()})).as4D(t.batchSize,n,n,3)})},r}();function ut(r){return oe(this,void 0,void 0,function(){var n,e,t;return ae(this,function(o){switch(o.label){case 0:if(r instanceof Ra)return[2,r];if(!(n=Array.isArray(r)?r:[r]).length)throw new Error("toNetInput - empty array passed as input");return e=function(a){return Array.isArray(r)?" at input index "+a+":":""},(t=n.map(As)).forEach(function(a,i){if(!Xh(a)&&!ba(a)&&!Kn(a))throw"string"==typeof n[i]?new Error("toNetInput -"+e(i)+" string passed, but could not resolve HTMLElement for element id "+n[i]):new Error("toNetInput -"+e(i)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id");if(Kn(a)){var s=a.shape[0];if(1!==s)throw new Error("toNetInput -"+e(i)+" tf.Tensor4D with batchSize "+s+" passed, but not supported in input array")}}),[4,Promise.all(t.map(function(a){return Xh(a)&&function i0(r){return new Promise(function(n,e){if(r instanceof vt.getEnv().Canvas||Hh(r))return n();function t(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",t),a.currentTarget.removeEventListener("error",o),n(a))}function o(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",t),a.currentTarget.removeEventListener("error",o),e(a))}r.addEventListener("load",t),r.addEventListener("error",o)})}(a)}))];case 1:return o.sent(),[2,new Ra(t,Array.isArray(r))]}})})}function Sa(r,n){return oe(this,void 0,void 0,function(){var e,t,o,a,i,s;return ae(this,function(c){switch(c.label){case 0:return e=vt.getEnv().Canvas,t=r,r instanceof e?[3,5]:[4,ut(r)];case 1:if((o=c.sent()).batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");return(a=o.getInput(0))instanceof e?(i=a,[3,4]):[3,2];case 2:return[4,u0(a)];case 3:i=c.sent(),c.label=4;case 4:t=i,c.label=5;case 5:return s=un(t),[2,n.map(function(l){return l instanceof sn?l.forSize(t.width,t.height).box.floor():l}).map(function(l){return l.clipAtImageBorders(t.width,t.height)}).map(function(l){var h=l.x,f=l.y,d=l.width,p=l.height,g=Ea({width:d,height:p});return un(g).putImageData(s.getImageData(h,f,d,p),0,0),g})]}})})}function Ts(r,n){return oe(this,void 0,void 0,function(){return ae(this,function(e){if(!ba(r)&&!Kn(r))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(Kn(r)&&r.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,Z(function(){var t=r.shape.slice(Kn(r)?1:0),o=t[0],a=t[1],i=t[2];return n.map(function(c){return c instanceof sn?c.forSize(a,o).box:c}).map(function(c){return c.clipAtImageBorders(a,o)}).map(function(c){var l=c.x,h=c.y,f=c.width,d=c.height;return Hl(r.as3D(o,a,i),[h,l,0],[d,f,i])})})]})})}function Kh(r,n){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return[4,(0,vt.getEnv().fetch)(r,n)];case 1:if(!((t=o.sent()).status<400))throw new Error("failed to fetch: ("+t.status+") "+t.statusText+", from url: "+t.url);return[2,t]}})})}function Yh(r){return oe(this,void 0,void 0,function(){var n,e;return ae(this,function(t){switch(t.label){case 0:return[4,Kh(r)];case 1:return[4,(n=t.sent()).blob()];case 2:if(!(e=t.sent()).type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+e.type+", for url: "+n.url);return[2,s0(e)]}})})}function l0(r){return oe(this,void 0,void 0,function(){return ae(this,function(n){switch(n.label){case 0:return[4,Kh(r)];case 1:return[2,n.sent().json()]}})})}function $h(r,n){var e=n+"-weights_manifest.json";if(!r)return{modelBaseUri:"",manifestUri:e};if("/"===r)return{modelBaseUri:"/",manifestUri:"/"+e};var t=r.startsWith("http://")?"http://":r.startsWith("https://")?"https://":"",o=(r=r.replace(t,"")).split("/").filter(function(s){return s}),a=r.endsWith(".json")?o[o.length-1]:e,i=t+(r.endsWith(".json")?o.slice(0,o.length-1):o).join("/");return{modelBaseUri:i=r.startsWith("/")?"/"+i:i,manifestUri:"/"===i?"/"+a:i+"/"+a}}function h0(r,n){return oe(this,void 0,void 0,function(){var e,o,a;return ae(this,function(i){switch(i.label){case 0:return e=$h(r,n),o=e.modelBaseUri,[4,l0(e.manifestUri)];case 1:return a=i.sent(),[2,wh.loadWeights(a,o)]}})})}var Rn=function(){function r(n){this._name=n,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(r.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),r.prototype.getParamFromPath=function(n){var e=this.traversePropertyPath(n);return e.obj[e.objProp]},r.prototype.reassignParamFromPath=function(n,e){var t=this.traversePropertyPath(n),o=t.obj,a=t.objProp;o[a].dispose(),o[a]=e},r.prototype.getParamList=function(){var n=this;return this._paramMappings.map(function(e){var t=e.paramPath;return{path:t,tensor:n.getParamFromPath(t)}})},r.prototype.getTrainableParams=function(){return this.getParamList().filter(function(n){return n.tensor instanceof Sr})},r.prototype.getFrozenParams=function(){return this.getParamList().filter(function(n){return!(n.tensor instanceof Sr)})},r.prototype.variable=function(){var n=this;this.getFrozenParams().forEach(function(e){n.reassignParamFromPath(e.path,e.tensor.variable())})},r.prototype.freeze=function(){var n=this;this.getTrainableParams().forEach(function(e){var t=e.path,o=e.tensor,a=pt(o.dataSync());o.dispose(),n.reassignParamFromPath(t,a)})},r.prototype.dispose=function(n){void 0===n&&(n=!0),this.getParamList().forEach(function(e){if(n&&e.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+e.path);e.tensor.dispose()}),this._params=void 0},r.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(n){return Array.from(n.tensor.dataSync())}).reduce(function(n,e){return n.concat(e)}))},r.prototype.load=function(n){return oe(this,void 0,void 0,function(){return ae(this,function(e){switch(e.label){case 0:return n instanceof Float32Array?(this.extractWeights(n),[2]):[4,this.loadFromUri(n)];case 1:return e.sent(),[2]}})})},r.prototype.loadFromUri=function(n){return oe(this,void 0,void 0,function(){var e;return ae(this,function(t){switch(t.label){case 0:if(n&&"string"!=typeof n)throw new Error(this._name+".loadFromUri - expected model uri");return[4,h0(n,this.getDefaultModelName())];case 1:return e=t.sent(),this.loadFromWeightMap(e),[2]}})})},r.prototype.loadFromDisk=function(n){return oe(this,void 0,void 0,function(){var e,t,o,a,s,u,c,l,h;return ae(this,function(f){switch(f.label){case 0:if(n&&"string"!=typeof n)throw new Error(this._name+".loadFromDisk - expected model file path");return e=vt.getEnv().readFile,t=$h(n,this.getDefaultModelName()),o=t.manifestUri,a=t.modelBaseUri,s=wh.weightsLoaderFactory(function(d){return Promise.all(d.map(function(p){return e(p).then(function(g){return g.buffer})}))}),l=(c=JSON).parse,[4,e(o)];case 1:return u=l.apply(c,[f.sent().toString()]),[4,s(u,a)];case 2:return h=f.sent(),this.loadFromWeightMap(h),[2]}})})},r.prototype.loadFromWeightMap=function(n){var e=this.extractParamsFromWeigthMap(n),o=e.params;this._paramMappings=e.paramMappings,this._params=o},r.prototype.extractWeights=function(n){var e=this.extractParams(n),o=e.params;this._paramMappings=e.paramMappings,this._params=o},r.prototype.traversePropertyPath=function(n){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var e=n.split("/").reduce(function(a,i){if(!a.nextObj.hasOwnProperty(i))throw new Error("traversePropertyPath - object does not have property "+i+", for path "+n);return{obj:a.nextObj,objProp:i,nextObj:a.nextObj[i]}},{nextObj:this.params}),t=e.obj,o=e.objProp;if(!(t&&o&&t[o]instanceof Me))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+n);return{obj:t,objProp:o}},r}();function Mt(r,n,e){return Z(function(){var t=$i(r,n.depthwise_filter,n.pointwise_filter,e,"same");return we(t,n.bias)})}function Ns(r,n,e){return void 0===e&&(e=!1),Z(function(){var t=Ge(e?we(Wt(r,n.conv0.filters,[2,2],"same"),n.conv0.bias):Mt(r,n.conv0,[2,2])),o=Mt(t,n.conv1,[1,1]),i=Mt(Ge(we(t,o)),n.conv2,[1,1]);return Ge(we(t,we(o,i)))})}function ka(r,n,e,t){return void 0===e&&(e=!1),void 0===t&&(t=!0),Z(function(){var o=Ge(e?we(Wt(r,n.conv0.filters,t?[2,2]:[1,1],"same"),n.conv0.bias):Mt(r,n.conv0,t?[2,2]:[1,1])),a=Mt(o,n.conv1,[1,1]),s=Mt(Ge(we(o,a)),n.conv2,[1,1]),c=Mt(Ge(we(o,we(a,s))),n.conv3,[1,1]);return Ge(we(o,we(a,we(s,c))))})}function Jt(r,n,e,t){return void 0===e&&(e="same"),void 0===t&&(t=!1),Z(function(){var o=we(Wt(r,n.filters,[1,1],e),n.bias);return t?Ge(o):o})}function Sn(r,n){Object.keys(r).forEach(function(e){n.some(function(t){return t.originalPath===e})||r[e].dispose()})}function Ia(r,n){return function(e,t,o,a){var i=St(r(e*t*o*o),[o,o,e,t]),s=Ze(r(t));return n.push({paramPath:a+"/filters"},{paramPath:a+"/bias"}),{filters:i,bias:s}}}function Ps(r,n){return function(e,t,o){var a=Gn(r(e*t),[e,t]),i=Ze(r(t));return n.push({paramPath:o+"/weights"},{paramPath:o+"/bias"}),{weights:a,bias:i}}}var Jh=function(){return function r(n,e,t){this.depthwise_filter=n,this.pointwise_filter=e,this.bias=t}}();function Ms(r,n){return function(e,t,o){var a=St(r(9*e),[3,3,e,1]),i=St(r(e*t),[1,1,e,t]),s=Ze(r(t));return n.push({paramPath:o+"/depthwise_filter"},{paramPath:o+"/pointwise_filter"},{paramPath:o+"/bias"}),new Jh(a,i,s)}}function Os(r){return function(n){var e=r(n+"/depthwise_filter",4),t=r(n+"/pointwise_filter",4),o=r(n+"/bias",1);return new Jh(e,t,o)}}function Yn(r,n){return function(e,t,o){var a=r[e];if(!_o(a,t))throw new Error("expected weightMap["+e+"] to be a Tensor"+t+"D, instead have "+a);return n.push({originalPath:e,paramPath:o||e}),a}}function kn(r){var n=r;return{extractWeights:function e(o){var a=n.slice(0,o);return n=n.slice(o),a},getRemainingWeights:function t(){return n}}}function Qh(r,n){var e=Ia(r,n),t=Ms(r,n);function o(i,s,u,c){return void 0===c&&(c=!1),{conv0:c?e(i,s,3,u+"/conv0"):t(i,s,u+"/conv0"),conv1:t(s,s,u+"/conv1"),conv2:t(s,s,u+"/conv2")}}return{extractDenseBlock3Params:o,extractDenseBlock4Params:function a(i,s,u,c){void 0===c&&(c=!1);var l=o(i,s,u,c);return{conv0:l.conv0,conv1:l.conv1,conv2:l.conv2,conv3:t(s,s,u+"/conv3")}}}}function Zh(r){return function(n){return{filters:r(n+"/filters",4),bias:r(n+"/bias",1)}}}function ef(r,n){var e=Yn(r,n),t=Zh(e),o=Os(e);return{extractDenseBlock3Params:function a(s,u){return void 0===u&&(u=!1),{conv0:u?t(s+"/conv0"):o(s+"/conv0"),conv1:o(s+"/conv1"),conv2:o(s+"/conv2")}},extractDenseBlock4Params:function i(s,u){return void 0===u&&(u=!1),{conv0:u?t(s+"/conv0"):o(s+"/conv0"),conv1:o(s+"/conv1"),conv2:o(s+"/conv2"),conv3:o(s+"/conv3")}}}}var tf=function(r){function n(){return r.call(this,"FaceFeatureExtractor")||this}return fe(n,r),n.prototype.forwardInput=function(e){var t=this.params;if(!t)throw new Error("FaceFeatureExtractor - load model before inference");return Z(function(){var s=ka(Ro(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(255)),t.dense0,!0);return s=ka(s,t.dense1),s=ka(s,t.dense2),s=ka(s,t.dense3),bo(s,[7,7],[2,2],"valid")})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},n.prototype.extractParamsFromWeigthMap=function(e){return function d0(r){var n=[],e=ef(r,n).extractDenseBlock4Params,t={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2"),dense3:e("dense3")};return Sn(r,n),{params:t,paramMappings:n}}(e)},n.prototype.extractParams=function(e){return function f0(r){var n=[],e=kn(r),o=e.getRemainingWeights,a=Qh(e.extractWeights,n).extractDenseBlock4Params,i=a(3,32,"dense0",!0),s=a(32,64,"dense1"),u=a(64,128,"dense2"),c=a(128,256,"dense3");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:n,params:{dense0:i,dense1:s,dense2:u,dense3:c}}}(e)},n}(Rn);function cn(r,n){return Z(function(){return we(fa(r,n.weights),n.bias)})}function nf(r){var n={},e={};return Object.keys(r).forEach(function(t){(t.startsWith("fc")?e:n)[t]=r[t]}),{featureExtractorMap:n,classifierMap:e}}var rf=function(r){function n(e,t){var o=r.call(this,e)||this;return o._faceFeatureExtractor=t,o}return fe(n,r),Object.defineProperty(n.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),n.prototype.runNet=function(e){var t=this,o=this.params;if(!o)throw new Error(this._name+" - load model before inference");return Z(function(){var a=e instanceof Ra?t.faceFeatureExtractor.forwardInput(e):e;return cn(a.as2D(a.shape[0],-1),o.fc)})},n.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},n.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),a=t.paramMappings;this._params=t.params,this._paramMappings=a},n.prototype.extractClassifierParams=function(e){return function p0(r,n,e){var t=[],o=kn(r),i=o.getRemainingWeights,u=Ps(o.extractWeights,t)(n,e,"fc");if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{paramMappings:t,params:{fc:u}}}(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},n.prototype.extractParamsFromWeigthMap=function(e){var t=nf(e),a=t.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(t.featureExtractorMap),function v0(r){var n=[],e=Yn(r,n),o={fc:function t(a){return{weights:e(a+"/weights",2),bias:e(a+"/bias",1)}}("fc")};return Sn(r,n),{params:o,paramMappings:n}}(a)},n.prototype.extractParams=function(e){var t=this.getClassifierChannelsIn(),o=this.getClassifierChannelsOut(),a=o*t+o,i=e.slice(0,e.length-a),s=e.slice(e.length-a);return this.faceFeatureExtractor.extractWeights(i),this.extractClassifierParams(s)},n}(Rn),of=["neutral","happy","sad","angry","fearful","disgusted","surprised"],m0=function(){function r(n){var e=this;if(7!==n.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+n.length);of.forEach(function(t,o){e[t]=n[o]})}return r.prototype.asSortedArray=function(){var n=this;return of.map(function(e){return{expression:e,probability:n[e]}}).sort(function(e,t){return t.probability-e.probability})},r}(),g0=function(r){function n(e){return void 0===e&&(e=new tf),r.call(this,"FaceExpressionNet",e)||this}return fe(n,r),n.prototype.forwardInput=function(e){var t=this;return Z(function(){return bn(t.runNet(e))})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.predictExpressions=function(e){return oe(this,void 0,void 0,function(){var t,o,a,i,s=this;return ae(this,function(u){switch(u.label){case 0:return[4,ut(e)];case 1:return t=u.sent(),[4,this.forwardInput(t)];case 2:return o=u.sent(),[4,Promise.all(rt(o).map(function(c){return oe(s,void 0,void 0,function(){var l;return ae(this,function(h){switch(h.label){case 0:return[4,c.data()];case 1:return l=h.sent(),c.dispose(),[2,l]}})})}))];case 3:return a=u.sent(),o.dispose(),i=a.map(function(c){return new m0(c)}),[2,t.isBatchInput?i:i[0]]}})})},n.prototype.getDefaultModelName=function(){return"face_expression_model"},n.prototype.getClassifierChannelsIn=function(){return 256},n.prototype.getClassifierChannelsOut=function(){return 7},n}(rf);function af(r,n){return Object.assign({},r,{expressions:n})}function Bs(r,n){var e=r.detection.box,t=n.shiftBy(e.x,e.y),o=t.align(),a=r.detection.imageDims,i=new sn(r.detection.score,o.rescale(a.reverse()),a);return Object.assign({},r,{landmarks:t,unshiftedLandmarks:n,alignedRect:i})}function sf(r,n,e){return we(Wt(r,n.filters,e,"same"),n.bias)}function Ls(r,n,e){void 0===e&&(e=!0);var t=e?Ge(r):r;return t=Mt(t,n.separable_conv0,[1,1]),t=Mt(Ge(t),n.separable_conv1,[1,1]),t=st(t,[3,3],[2,2],"same"),we(t,sf(r,n.expansion_conv,[2,2]))}var S0=function(r){function n(e){var t=r.call(this,"TinyXception")||this;return t._numMainBlocks=e,t}return fe(n,r),n.prototype.forwardInput=function(e){var t=this,o=this.params;if(!o)throw new Error("TinyXception - load model before inference");return Z(function(){var s=Ro(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(256)),u=Ge(sf(s,o.entry_flow.conv_in,[2,2]));return u=Ls(u,o.entry_flow.reduction_block_0,!1),u=Ls(u,o.entry_flow.reduction_block_1),Co(t._numMainBlocks,0,1).forEach(function(c){u=function R0(r,n){var e=Mt(Ge(r),n.separable_conv0,[1,1]);return e=Mt(Ge(e),n.separable_conv1,[1,1]),e=Mt(Ge(e),n.separable_conv2,[1,1]),we(e,r)}(u,o.middle_flow["main_block_"+c])}),u=Ls(u,o.exit_flow.reduction_block),u=Ge(Mt(u,o.exit_flow.separable_conv,[1,1]))})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.getDefaultModelName=function(){return"tiny_xception_model"},n.prototype.extractParamsFromWeigthMap=function(e){return function E0(r,n){var e=[],t=function C0(r,n){var e=Yn(r,n),t=Zh(e),o=Os(e);return{extractConvParams:t,extractSeparableConvParams:o,extractReductionBlockParams:function a(s){return{separable_conv0:o(s+"/separable_conv0"),separable_conv1:o(s+"/separable_conv1"),expansion_conv:t(s+"/expansion_conv")}},extractMainBlockParams:function i(s){return{separable_conv0:o(s+"/separable_conv0"),separable_conv1:o(s+"/separable_conv1"),separable_conv2:o(s+"/separable_conv2")}}}}(r,e),a=t.extractSeparableConvParams,i=t.extractReductionBlockParams,s=t.extractMainBlockParams,h={conv_in:(0,t.extractConvParams)("entry_flow/conv_in"),reduction_block_0:i("entry_flow/reduction_block_0"),reduction_block_1:i("entry_flow/reduction_block_1")},f={};Co(n,0,1).forEach(function(m){f["main_block_"+m]=s("middle_flow/main_block_"+m)});var g={reduction_block:i("exit_flow/reduction_block"),separable_conv:a("exit_flow/separable_conv")};return Sn(r,e),{params:{entry_flow:h,middle_flow:f,exit_flow:g},paramMappings:e}}(e,this._numMainBlocks)},n.prototype.extractParams=function(e){return function _0(r,n){var e=[],t=kn(r),a=t.getRemainingWeights,i=function w0(r,n){var e=Ia(r,n),t=Ms(r,n);return{extractConvParams:e,extractSeparableConvParams:t,extractReductionBlockParams:function o(i,s,u){return{separable_conv0:t(i,s,u+"/separable_conv0"),separable_conv1:t(s,s,u+"/separable_conv1"),expansion_conv:e(i,s,1,u+"/expansion_conv")}},extractMainBlockParams:function a(i,s){return{separable_conv0:t(i,i,s+"/separable_conv0"),separable_conv1:t(i,i,s+"/separable_conv1"),separable_conv2:t(i,i,s+"/separable_conv2")}}}}(t.extractWeights,e),u=i.extractSeparableConvParams,c=i.extractReductionBlockParams,l=i.extractMainBlockParams,p={conv_in:(0,i.extractConvParams)(3,32,3,"entry_flow/conv_in"),reduction_block_0:c(32,64,"entry_flow/reduction_block_0"),reduction_block_1:c(64,128,"entry_flow/reduction_block_1")},g={};Co(n,0,1).forEach(function(w){g["main_block_"+w]=l(128,"middle_flow/main_block_"+w)});var x={reduction_block:c(128,256,"exit_flow/reduction_block"),separable_conv:u(256,512,"exit_flow/separable_conv")};if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:e,params:{entry_flow:p,middle_flow:g,exit_flow:x}}}(e,this._numMainBlocks)},n}(Rn),Ws=function(r){return r.FEMALE="female",r.MALE="male",r}(Ws||{}),F0=function(r){function n(e){void 0===e&&(e=new S0(2));var t=r.call(this,"AgeGenderNet")||this;return t._faceFeatureExtractor=e,t}return fe(n,r),Object.defineProperty(n.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),n.prototype.runNet=function(e){var t=this,o=this.params;if(!o)throw new Error(this._name+" - load model before inference");return Z(function(){var a=e instanceof Ra?t.faceFeatureExtractor.forwardInput(e):e,i=bo(a,[7,7],[2,2],"valid").as2D(a.shape[0],-1);return{age:cn(i,o.fc.age).as1D(),gender:cn(i,o.fc.gender)}})},n.prototype.forwardInput=function(e){var t=this;return Z(function(){var o=t.runNet(e);return{age:o.age,gender:bn(o.gender)}})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.predictAgeAndGender=function(e){return oe(this,void 0,void 0,function(){var t,o,a,i,s,u,c=this;return ae(this,function(l){switch(l.label){case 0:return[4,ut(e)];case 1:return t=l.sent(),[4,this.forwardInput(t)];case 2:return o=l.sent(),a=rt(o.age),i=rt(o.gender),s=a.map(function(h,f){return{ageTensor:h,genderTensor:i[f]}}),[4,Promise.all(s.map(function(h){var f=h.ageTensor,d=h.genderTensor;return oe(c,void 0,void 0,function(){var p,g,m,y,x;return ae(this,function(w){switch(w.label){case 0:return[4,f.data()];case 1:return p=w.sent()[0],[4,d.data()];case 2:return g=w.sent()[0],y=(m=g>.5)?Ws.MALE:Ws.FEMALE,x=m?g:1-g,f.dispose(),d.dispose(),[2,{age:p,gender:y,genderProbability:x}]}})})}))];case 3:return u=l.sent(),o.age.dispose(),o.gender.dispose(),[2,t.isBatchInput?u:u[0]]}})})},n.prototype.getDefaultModelName=function(){return"age_gender_model"},n.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},n.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),a=t.paramMappings;this._params=t.params,this._paramMappings=a},n.prototype.extractClassifierParams=function(e){return function k0(r){var n=[],e=kn(r),o=e.getRemainingWeights,a=Ps(e.extractWeights,n),i=a(512,1,"fc/age"),s=a(512,2,"fc/gender");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:n,params:{fc:{age:i,gender:s}}}}(e)},n.prototype.extractParamsFromWeigthMap=function(e){var t=nf(e),a=t.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(t.featureExtractorMap),function I0(r){var n=[],e=Yn(r,n);function t(a){return{weights:e(a+"/weights",2),bias:e(a+"/bias",1)}}var o={fc:{age:t("fc/age"),gender:t("fc/gender")}};return Sn(r,n),{params:o,paramMappings:n}}(a)},n.prototype.extractParams=function(e){var o=e.slice(0,e.length-1539),a=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(o),this.extractClassifierParams(a)},n}(Rn),uf=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.postProcess=function(e,t,o){var a=o.map(function(s){var u=s.width,c=s.height,l=t/Math.max(c,u);return{width:u*l,height:c*l}}),i=a.length;return Z(function(){var s=function(f,d){return Nt([on([68],f),on([68],d)],1).as2D(1,136).as1D()},u=function(f,d){var p=a[f],g=p.width,m=p.height;return d(g,m)?Math.abs(g-m)/2:0};return e.mul(on([i,136],t)).sub(Nt(Array.from(Array(i),function(f,d){return s(function(f){return u(f,function(d,p){return d<p})}(d),function(f){return u(f,function(d,p){return p<d})}(d))}))).div(Nt(Array.from(Array(i),function(f,d){return s(a[d].width,a[d].height)})))})},n.prototype.forwardInput=function(e){var t=this;return Z(function(){var o=t.runNet(e);return t.postProcess(o,e.inputSize,e.inputDimensions.map(function(a){return{height:a[0],width:a[1]}}))})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.detectLandmarks=function(e){return oe(this,void 0,void 0,function(){var t,o,a,i=this;return ae(this,function(s){switch(s.label){case 0:return[4,ut(e)];case 1:return t=s.sent(),o=Z(function(){return rt(i.forwardInput(t))}),[4,Promise.all(o.map(function(u,c){return oe(i,void 0,void 0,function(){var l,h,f,d,p;return ae(this,function(g){switch(g.label){case 0:return f=(h=Array).from,[4,u.data()];case 1:return l=f.apply(h,[g.sent()]),d=l.filter(function(m,y){return Th(y)}),p=l.filter(function(m,y){return!Th(y)}),[2,new Oh(Array(68).fill(0).map(function(m,y){return new Fe(d[y],p[y])}),{height:t.getInputHeight(c),width:t.getInputWidth(c)})]}})})}))];case 2:return a=s.sent(),o.forEach(function(u){return u.dispose()}),[2,t.isBatchInput?a:a[0]]}})})},n.prototype.getClassifierChannelsOut=function(){return 136},n}(rf),cf=function(r){function n(e){return void 0===e&&(e=new tf),r.call(this,"FaceLandmark68Net",e)||this}return fe(n,r),n.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},n.prototype.getClassifierChannelsIn=function(){return 256},n}(uf),T0=function(r){function n(){return r.call(this,"TinyFaceFeatureExtractor")||this}return fe(n,r),n.prototype.forwardInput=function(e){var t=this.params;if(!t)throw new Error("TinyFaceFeatureExtractor - load model before inference");return Z(function(){var s=Ns(Ro(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(255)),t.dense0,!0);return s=Ns(s,t.dense1),s=Ns(s,t.dense2),bo(s,[14,14],[2,2],"valid")})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},n.prototype.extractParamsFromWeigthMap=function(e){return function A0(r){var n=[],e=ef(r,n).extractDenseBlock3Params,t={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2")};return Sn(r,n),{params:t,paramMappings:n}}(e)},n.prototype.extractParams=function(e){return function D0(r){var n=[],e=kn(r),o=e.getRemainingWeights,a=Qh(e.extractWeights,n).extractDenseBlock3Params,i=a(3,32,"dense0",!0),s=a(32,64,"dense1"),u=a(64,128,"dense2");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:n,params:{dense0:i,dense1:s,dense2:u}}}(e)},n}(Rn),N0=function(r){function n(e){return void 0===e&&(e=new T0),r.call(this,"FaceLandmark68TinyNet",e)||this}return fe(n,r),n.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},n.prototype.getClassifierChannelsIn=function(){return 128},n}(uf);function Us(r,n,e,t,o){void 0===o&&(o="same");var a=n.conv,s=a.bias,u=Wt(r,a.filters,e,o);return u=function P0(r,n){return we(yt(r,n.weights),n.biases)}(u=we(u,s),n.scale),t?Ge(u):u}function lf(r,n){return Us(r,n,[1,1],!1)}function hf(r,n){return Us(r,n,[2,2],!0,"valid")}function O0(r,n){function a(s,u,c,l){var h=function t(s,u,c,l){var h=function e(s,u,c){var l=r(s),h=l.length/(u*c*c);if(function Hg(r){return r%1!=0}(h))throw new Error("depth has to be an integer: "+h+", weights.length: "+l.length+", numFilters: "+u+", filterSize: "+c);return Z(function(){return jn(St(l,[u,h,c,c]),[2,3,1,0])})}(s,u,c),f=Ze(r(u));return n.push({paramPath:l+"/filters"},{paramPath:l+"/bias"}),{filters:h,bias:f}}(s,u,c,l+"/conv"),f=function o(s,u){var c=Ze(r(s)),l=Ze(r(s));return n.push({paramPath:u+"/weights"},{paramPath:u+"/biases"}),{weights:c,biases:l}}(u,l+"/scale");return{conv:h,scale:f}}return{extractConvLayerParams:a,extractResidualLayerParams:function i(s,u,c,l,h){return void 0===h&&(h=!1),{conv1:a((h?.5:1)*s,u,c,l+"/conv1"),conv2:a(s,u,c,l+"/conv2")}}}}function W0(r){var n=[],e=function L0(r,n){var e=Yn(r,n);function o(i){var s=e(i+"/conv/filters",4),u=e(i+"/conv/bias",1),c=function t(i){return{weights:e(i+"/scale/weights",1),biases:e(i+"/scale/biases",1)}}(i);return{conv:{filters:s,bias:u},scale:c}}return{extractConvLayerParams:o,extractResidualLayerParams:function a(i){return{conv1:o(i+"/conv1"),conv2:o(i+"/conv2")}}}}(r,n),o=e.extractResidualLayerParams,a=(0,e.extractConvLayerParams)("conv32_down"),i=o("conv32_1"),s=o("conv32_2"),u=o("conv32_3"),c=o("conv64_down"),l=o("conv64_1"),h=o("conv64_2"),f=o("conv64_3"),d=o("conv128_down"),p=o("conv128_1"),g=o("conv128_2"),m=o("conv256_down"),y=o("conv256_1"),x=o("conv256_2"),w=o("conv256_down_out"),b=r.fc;if(n.push({originalPath:"fc",paramPath:"fc"}),!function jg(r){return _o(r,2)}(b))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+b);var _={conv32_down:a,conv32_1:i,conv32_2:s,conv32_3:u,conv64_down:c,conv64_1:l,conv64_2:h,conv64_3:f,conv128_down:d,conv128_1:p,conv128_2:g,conv256_down:m,conv256_1:y,conv256_2:x,conv256_down_out:w,fc:b};return Sn(r,n),{params:_,paramMappings:n}}function ln(r,n){var e=function M0(r,n){return Us(r,n,[1,1],!0)}(r,n.conv1);return e=lf(e,n.conv2),e=we(e,r),Ge(e)}function Fa(r,n){var e=hf(r,n.conv1);e=lf(e,n.conv2);var t=bo(r,2,2,"valid"),o=Le(t.shape),a=t.shape[3]!==e.shape[3];if(t.shape[1]!==e.shape[1]||t.shape[2]!==e.shape[2]){var s=wo(e.shape);s[1]=1;var u=Le(s),c=wo((e=nt([e,u],1)).shape);c[2]=1;var l=Le(c);e=nt([e,l],2)}return t=a?nt([t,o],3):t,e=we(t,e),Ge(e)}!function(r){fe(function n(){return null!==r&&r.apply(this,arguments)||this},r)}(cf);var U0=function(r){function n(){return r.call(this,"FaceRecognitionNet")||this}return fe(n,r),n.prototype.forwardInput=function(e){var t=this.params;if(!t)throw new Error("FaceRecognitionNet - load model before inference");return Z(function(){var s=hf(Ro(e.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div($(256)),t.conv32_down);s=ln(s=st(s,3,2,"valid"),t.conv32_1),s=ln(s,t.conv32_2),s=ln(s,t.conv32_3),s=ln(s=Fa(s,t.conv64_down),t.conv64_1),s=ln(s,t.conv64_2),s=ln(s,t.conv64_3),s=ln(s=Fa(s,t.conv128_down),t.conv128_1),s=ln(s,t.conv128_2),s=ln(s=Fa(s,t.conv256_down),t.conv256_1);var u=(s=Fa(s=ln(s,t.conv256_2),t.conv256_down_out)).mean([1,2]);return fa(u,t.fc)})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.computeFaceDescriptor=function(e){return oe(this,void 0,void 0,function(){var t,o,a,i=this;return ae(this,function(s){switch(s.label){case 0:return[4,ut(e)];case 1:return t=s.sent(),o=Z(function(){return rt(i.forwardInput(t))}),[4,Promise.all(o.map(function(u){return u.data()}))];case 2:return a=s.sent(),o.forEach(function(u){return u.dispose()}),[2,t.isBatchInput?a:a[0]]}})})},n.prototype.getDefaultModelName=function(){return"face_recognition_model"},n.prototype.extractParamsFromWeigthMap=function(e){return W0(e)},n.prototype.extractParams=function(e){return function B0(r){var n=kn(r),e=n.extractWeights,t=n.getRemainingWeights,o=[],a=O0(e,o),s=a.extractResidualLayerParams,u=(0,a.extractConvLayerParams)(4704,32,7,"conv32_down"),c=s(9216,32,3,"conv32_1"),l=s(9216,32,3,"conv32_2"),h=s(9216,32,3,"conv32_3"),f=s(36864,64,3,"conv64_down",!0),d=s(36864,64,3,"conv64_1"),p=s(36864,64,3,"conv64_2"),g=s(36864,64,3,"conv64_3"),m=s(147456,128,3,"conv128_down",!0),y=s(147456,128,3,"conv128_1"),x=s(147456,128,3,"conv128_2"),w=s(589824,256,3,"conv256_down",!0),b=s(589824,256,3,"conv256_1"),_=s(589824,256,3,"conv256_2"),E=s(589824,256,3,"conv256_down_out"),F=Z(function(){return jn(Gn(e(32768),[128,256]),[1,0])});if(o.push({paramPath:"fc"}),0!==t().length)throw new Error("weights remaing after extract: "+t().length);return{params:{conv32_down:u,conv32_1:c,conv32_2:l,conv32_3:h,conv64_down:f,conv64_1:d,conv64_2:p,conv64_3:g,conv128_down:m,conv128_1:y,conv128_2:x,conv256_down:w,conv256_1:b,conv256_2:_,conv256_down_out:E,fc:F},paramMappings:o}}(e)},n}(Rn);function ff(r,n,e){return Object.assign({},r,{gender:n,genderProbability:e})}var df=function(){function r(n){var e=void 0===n?{}:n,t=e.minFaceSize,o=e.scaleFactor,a=e.maxNumScales,i=e.scoreThresholds,s=e.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=t||20,this._scaleFactor=o||.709,this._maxNumScales=a||10,this._scoreThresholds=i||[.6,.7,.7],this._scaleSteps=s,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(u){return"number"!=typeof u}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(u){return"number"!=typeof u})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(r.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),r}();function hn(r,n,e){return Z(function(){var t=Wt(r,n.filters,e,"same");return t=we(t,n.batch_norm_offset),ji(t,0,6)})}function $0(r,n,e){var t=r.arraySync(),o=Math.min(t[n][0],t[n][2]),a=Math.min(t[n][1],t[n][3]),i=Math.max(t[n][0],t[n][2]),s=Math.max(t[n][1],t[n][3]),u=Math.min(t[e][0],t[e][2]),c=Math.min(t[e][1],t[e][3]),l=Math.max(t[e][0],t[e][2]),h=Math.max(t[e][1],t[e][3]),f=(i-o)*(s-a),d=(l-u)*(h-c);if(f<=0||d<=0)return 0;var p=Math.max(o,u),g=Math.max(a,c),m=Math.min(i,l),y=Math.min(s,h),x=Math.max(m-p,0)*Math.max(y-g,0);return x/(f+d-x)}function Gr(r,n){return Z(function(){var e=r.shape[0];return{boxPredictionEncoding:Kt(Jt(r,n.box_encoding_predictor),[e,-1,1,4]),classPrediction:Kt(Jt(r,n.class_predictor),[e,-1,3])}})}var Aa=function(){function r(n){var e=void 0===n?{}:n,t=e.minConfidence,o=e.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=t||.5,this._maxResults=o||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(r.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),r}(),pf=function(r){function n(){return r.call(this,"SsdMobilenetv1")||this}return fe(n,r),n.prototype.forwardInput=function(e){var t=this.params;if(!t)throw new Error("SsdMobilenetv1 - load model before inference");return Z(function(){var o=e.toBatchTensor(512,!1).toFloat(),i=function K0(r,n){return Z(function(){var e=null,t=hn(r,n.conv_0,[2,2]);if([n.conv_1,n.conv_2,n.conv_3,n.conv_4,n.conv_5,n.conv_6,n.conv_7,n.conv_8,n.conv_9,n.conv_10,n.conv_11,n.conv_12,n.conv_13].forEach(function(a,i){var s=i+1,u=function X0(r){return[2,4,6,12].some(function(n){return n===r})?[2,2]:[1,1]}(s);t=function q0(r,n,e){return Z(function(){var t=ha(r,n.filters,e,"same");return t=Il(t,n.batch_norm_mean,n.batch_norm_variance,n.batch_norm_offset,n.batch_norm_scale,.0010000000474974513),ji(t,0,6)})}(t,a.depthwise_conv,u),t=hn(t,a.pointwise_conv,[1,1]),11===s&&(e=t)}),null===e)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:t,conv11:e}})}(ot(yt(o,$(.007843137718737125)),$(1)),t.mobilenetv1),s=function ey(r,n,e){return Z(function(){var t=hn(r,e.conv_0,[1,1]),o=hn(t,e.conv_1,[2,2]),a=hn(o,e.conv_2,[1,1]),i=hn(a,e.conv_3,[2,2]),s=hn(i,e.conv_4,[1,1]),u=hn(s,e.conv_5,[2,2]),c=hn(u,e.conv_6,[1,1]),l=hn(c,e.conv_7,[2,2]),h=Gr(n,e.box_predictor_0),f=Gr(r,e.box_predictor_1),d=Gr(o,e.box_predictor_2),p=Gr(i,e.box_predictor_3),g=Gr(u,e.box_predictor_4),m=Gr(l,e.box_predictor_5);return{boxPredictions:nt([h.boxPredictionEncoding,f.boxPredictionEncoding,d.boxPredictionEncoding,p.boxPredictionEncoding,g.boxPredictionEncoding,m.boxPredictionEncoding],1),classPredictions:nt([h.classPrediction,f.classPrediction,d.classPrediction,p.classPrediction,g.classPrediction,m.classPrediction],1)}})}(i.out,i.conv11,t.prediction_layer);return function Z0(r,n,e){return Z(function(){var t=r.shape[0],o=function Q0(r,n){var e=function J0(r){var n=rt(jn(r,[1,0])),e=[ot(n[2],n[0]),ot(n[3],n[1])];return{sizes:e,centers:[we(n[0],$t(e[0],$(2))),we(n[1],$t(e[1],$(2)))]}}(r),t=e.sizes,o=e.centers,a=rt(jn(n,[1,0])),i=$t(yt(Hi($t(a[2],$(5))),t[0]),$(2)),s=we(yt($t(a[0],$(10)),t[0]),o[0]),u=$t(yt(Hi($t(a[3],$(5))),t[1]),$(2)),c=we(yt($t(a[1],$(10)),t[1]),o[1]);return jn(Nt([ot(s,i),ot(c,u),we(s,i),we(c,u)]),[1,0])}(Kt(Ir(e.extra_dim,[t,1,1]),[-1,4]),Kt(r,[-1,4]));o=Kt(o,[t,o.shape[0]/t,4]);var a=El(an(n,[0,0,1],[-1,-1,-1])),i=an(a,[0,0,0],[-1,-1,1]);return i=Kt(i,[t,i.shape[1]]),{boxes:rt(o),scores:rt(i)}})}(s.boxPredictions,s.classPredictions,t.output_layer)})},n.prototype.forward=function(e){return oe(this,void 0,void 0,function(){var t;return ae(this,function(o){switch(o.label){case 0:return t=this.forwardInput,[4,ut(e)];case 1:return[2,t.apply(this,[o.sent()])]}})})},n.prototype.locateFaces=function(e,t){return void 0===t&&(t={}),oe(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,g,m,x,w,b,_,E,F,I;return ae(this,function(S){switch(S.label){case 0:return o=new Aa(t),a=o.maxResults,i=o.minConfidence,[4,ut(e)];case 1:for(s=S.sent(),u=this.forwardInput(s),h=(c=u.boxes)[0],f=(l=u.scores)[0],d=1;d<c.length;d++)c[d].dispose(),l[d].dispose();return m=(g=Array).from,[4,f.data()];case 2:return p=m.apply(g,[S.sent()]),x=function Y0(r,n,e,t,o){var i=Math.min(e,r.shape[0]),s=n.map(function(l,h){return{score:l,boxIndex:h}}).filter(function(l){return l.score>o}).sort(function(l,h){return h.score-l.score}),u=function(l){return l<=t?1:0},c=[];return s.forEach(function(l){if(!(c.length>=i)){for(var h=l.score,f=c.length-1;f>=0;--f){var d=$0(r,l.boxIndex,c[f]);if(0!==d&&(l.score*=u(d),l.score<=o))break}h===l.score&&c.push(l.boxIndex)}}),c}(h,p,a,.5,i),w=s.getReshapedInputDimensions(0),_=(b=s.inputSize)/w.width,E=b/w.height,F=h.arraySync(),I=x.map(function(k){var N=[Math.max(0,F[k][0]),Math.min(1,F[k][2])].map(function(G){return G*E}),T=N[0],W=N[1],B=[Math.max(0,F[k][1]),Math.min(1,F[k][3])].map(function(G){return G*_}),L=B[0];return new sn(p[k],new wa(L,T,B[1]-L,W-T),{height:s.getInputHeight(0),width:s.getInputWidth(0)})}),h.dispose(),f.dispose(),[2,I]}})})},n.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},n.prototype.extractParamsFromWeigthMap=function(e){return function j0(r){var n=[],e=function z0(r,n){var e=Yn(r,n);function t(c,l,h){return{filters:e(c+"/Conv2d_"+l+"_pointwise/weights",4,h+"/filters"),batch_norm_offset:e(c+"/Conv2d_"+l+"_pointwise/convolution_bn_offset",1,h+"/batch_norm_offset")}}function o(c){var l="mobilenetv1/conv_"+c,h="MobilenetV1/Conv2d_"+c+"_depthwise",f=l+"/depthwise_conv",d=l+"/pointwise_conv";return{depthwise_conv:{filters:e(h+"/depthwise_weights",4,f+"/filters"),batch_norm_scale:e(h+"/BatchNorm/gamma",1,f+"/batch_norm_scale"),batch_norm_offset:e(h+"/BatchNorm/beta",1,f+"/batch_norm_offset"),batch_norm_mean:e(h+"/BatchNorm/moving_mean",1,f+"/batch_norm_mean"),batch_norm_variance:e(h+"/BatchNorm/moving_variance",1,f+"/batch_norm_variance")},pointwise_conv:t("MobilenetV1",c,d)}}function i(c,l){return{filters:e(c+"/weights",4,l+"/filters"),bias:e(c+"/biases",1,l+"/bias")}}function s(c){return{box_encoding_predictor:i("Prediction/BoxPredictor_"+c+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+c+"/box_encoding_predictor"),class_predictor:i("Prediction/BoxPredictor_"+c+"/ClassPredictor","prediction_layer/box_predictor_"+c+"/class_predictor")}}return{extractMobilenetV1Params:function a(){return{conv_0:t("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:o(1),conv_2:o(2),conv_3:o(3),conv_4:o(4),conv_5:o(5),conv_6:o(6),conv_7:o(7),conv_8:o(8),conv_9:o(9),conv_10:o(10),conv_11:o(11),conv_12:o(12),conv_13:o(13)}},extractPredictionLayerParams:function u(){return{conv_0:t("Prediction",0,"prediction_layer/conv_0"),conv_1:t("Prediction",1,"prediction_layer/conv_1"),conv_2:t("Prediction",2,"prediction_layer/conv_2"),conv_3:t("Prediction",3,"prediction_layer/conv_3"),conv_4:t("Prediction",4,"prediction_layer/conv_4"),conv_5:t("Prediction",5,"prediction_layer/conv_5"),conv_6:t("Prediction",6,"prediction_layer/conv_6"),conv_7:t("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:s(0),box_predictor_1:s(1),box_predictor_2:s(2),box_predictor_3:s(3),box_predictor_4:s(4),box_predictor_5:s(5)}}}}(r,n),t=e.extractMobilenetV1Params,o=e.extractPredictionLayerParams,a=r["Output/extra_dim"];if(n.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!ba(a))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+a);var i={mobilenetv1:t(),prediction_layer:o(),output_layer:{extra_dim:a}};return Sn(r,n),{params:i,paramMappings:n}}(e)},n.prototype.extractParams=function(e){return function G0(r){var n=[],e=kn(r),t=e.extractWeights,o=e.getRemainingWeights,a=function V0(r,n){function t(u,c,l,h,f){var d=St(r(u*c*l*l),[l,l,u,c]),p=Ze(r(c));return n.push({paramPath:h+"/filters"},{paramPath:h+"/"+(f?"batch_norm_offset":"bias")}),{filters:d,bias:p}}function o(u,c,l,h){var f=t(u,c,l,h,!0);return{filters:f.filters,batch_norm_offset:f.bias}}function a(u,c,l){var h=function e(u,c){var l=St(r(9*u),[3,3,u,1]),h=Ze(r(u)),f=Ze(r(u)),d=Ze(r(u)),p=Ze(r(u));return n.push({paramPath:c+"/filters"},{paramPath:c+"/batch_norm_scale"},{paramPath:c+"/batch_norm_offset"},{paramPath:c+"/batch_norm_mean"},{paramPath:c+"/batch_norm_variance"}),{filters:l,batch_norm_scale:h,batch_norm_offset:f,batch_norm_mean:d,batch_norm_variance:p}}(u,l+"/depthwise_conv");return{depthwise_conv:h,pointwise_conv:o(u,c,1,l+"/pointwise_conv")}}return{extractMobilenetV1Params:function i(){return{conv_0:o(3,32,3,"mobilenetv1/conv_0"),conv_1:a(32,64,"mobilenetv1/conv_1"),conv_2:a(64,128,"mobilenetv1/conv_2"),conv_3:a(128,128,"mobilenetv1/conv_3"),conv_4:a(128,256,"mobilenetv1/conv_4"),conv_5:a(256,256,"mobilenetv1/conv_5"),conv_6:a(256,512,"mobilenetv1/conv_6"),conv_7:a(512,512,"mobilenetv1/conv_7"),conv_8:a(512,512,"mobilenetv1/conv_8"),conv_9:a(512,512,"mobilenetv1/conv_9"),conv_10:a(512,512,"mobilenetv1/conv_10"),conv_11:a(512,512,"mobilenetv1/conv_11"),conv_12:a(512,1024,"mobilenetv1/conv_12"),conv_13:a(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function s(){return{conv_0:o(1024,256,1,"prediction_layer/conv_0"),conv_1:o(256,512,3,"prediction_layer/conv_1"),conv_2:o(512,128,1,"prediction_layer/conv_2"),conv_3:o(128,256,3,"prediction_layer/conv_3"),conv_4:o(256,128,1,"prediction_layer/conv_4"),conv_5:o(128,256,3,"prediction_layer/conv_5"),conv_6:o(256,64,1,"prediction_layer/conv_6"),conv_7:o(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:t(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:t(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:t(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:t(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:t(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:t(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:t(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:t(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:t(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:t(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:t(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:t(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(t,n),s=a.extractPredictionLayerParams,u=(0,a.extractMobilenetV1Params)(),c=s(),h={extra_dim:yi(t(20472),[1,5118,4])};if(n.push({paramPath:"output_layer/extra_dim"}),0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{mobilenetv1:u,prediction_layer:c,output_layer:h},paramMappings:n}}(e)},n}(Rn);!function(r){fe(function n(){return null!==r&&r.apply(this,arguments)||this},r)}(pf);var ry=[new Fe(.738768,.874946),new Fe(2.42204,2.65704),new Fe(4.30971,7.04493),new Fe(10.246,4.59428),new Fe(12.6868,11.8741)],oy=[new Fe(1.603231,2.094468),new Fe(6.041143,7.080126),new Fe(2.882459,3.518061),new Fe(4.266906,5.178857),new Fe(9.041765,10.66308)],ay=[117.001,114.697,97.404],Da=function(r){return"number"==typeof r};function Vs(r){return Z(function(){var n=yt(r,$(.10000000149011612));return we(Ge(ot(r,n)),n)})}function $n(r,n){return Z(function(){var e=sr(r,[[0,0],[1,1],[1,1],[0,0]]);return e=Wt(e,n.conv.filters,[1,1],"valid"),e=ot(e,n.bn.sub),e=yt(e,n.bn.truediv),Vs(e=we(e,n.conv.bias))})}function Jn(r,n){return Z(function(){var e=sr(r,[[0,0],[1,1],[1,1],[0,0]]);return e=$i(e,n.depthwise_filter,n.pointwise_filter,[1,1],"valid"),Vs(e=we(e,n.bias))})}var Gs=function(){function r(n){var e=void 0===n?{}:n,t=e.inputSize,o=e.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=t||416,this._scoreThreshold=o||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),r}(),vf=function(r){function n(e){var t=r.call(this,"TinyYolov2")||this;return function uy(r){if(!r)throw new Error("invalid config: "+r);if("boolean"!=typeof r.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+r.withSeparableConvs);if(!Da(r.iouThreshold)||r.iouThreshold<0||r.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+r.iouThreshold);if(!Array.isArray(r.classes)||!r.classes.length||!r.classes.every(function(n){return"string"==typeof n}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(r.classes));if(!Array.isArray(r.anchors)||!r.anchors.length||!r.anchors.map(function(n){return n||{}}).every(function(n){return Da(n.x)&&Da(n.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(r.anchors));if(r.meanRgb&&(!Array.isArray(r.meanRgb)||3!==r.meanRgb.length||!r.meanRgb.every(Da)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(r.meanRgb))}(e),t._config=e,t}return fe(n,r),Object.defineProperty(n.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),n.prototype.runTinyYolov2=function(e,t){var o=$n(e,t.conv0);return o=$n(o=st(o,[2,2],[2,2],"same"),t.conv1),o=$n(o=st(o,[2,2],[2,2],"same"),t.conv2),o=$n(o=st(o,[2,2],[2,2],"same"),t.conv3),o=$n(o=st(o,[2,2],[2,2],"same"),t.conv4),o=$n(o=st(o,[2,2],[2,2],"same"),t.conv5),o=$n(o=st(o,[2,2],[1,1],"same"),t.conv6),Jt(o=$n(o,t.conv7),t.conv8,"valid",!1)},n.prototype.runMobilenet=function(e,t){var o=this.config.isFirstLayerConv2d?Vs(Jt(e,t.conv0,"valid",!1)):Jn(e,t.conv0);return o=Jn(o=st(o,[2,2],[2,2],"same"),t.conv1),o=Jn(o=st(o,[2,2],[2,2],"same"),t.conv2),o=Jn(o=st(o,[2,2],[2,2],"same"),t.conv3),o=Jn(o=st(o,[2,2],[2,2],"same"),t.conv4),o=Jn(o=st(o,[2,2],[2,2],"same"),t.conv5),o=st(o,[2,2],[1,1],"same"),o=t.conv6?Jn(o,t.conv6):o,Jt(o=t.conv7?Jn(o,t.conv7):o,t.conv8,"valid",!1)},n.prototype.forwardInput=function(e,t){var o=this,a=this.params;if(!a)throw new Error("TinyYolov2 - load model before inference");return Z(function(){var i=e.toBatchTensor(t,!1).toFloat();return i=(i=o.config.meanRgb?Ro(i,o.config.meanRgb):i).div($(256)),o.config.withSeparableConvs?o.runMobilenet(i,a):o.runTinyYolov2(i,a)})},n.prototype.forward=function(e,t){return oe(this,void 0,void 0,function(){var o;return ae(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,ut(e)];case 1:return[4,o.apply(this,[a.sent(),t])];case 2:return[2,a.sent()]}})})},n.prototype.detect=function(e,t){return void 0===t&&(t={}),oe(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,g,x=this;return ae(this,function(w){switch(w.label){case 0:return o=new Gs(t),a=o.inputSize,i=o.scoreThreshold,[4,ut(e)];case 1:return s=w.sent(),[4,this.forwardInput(s,a)];case 2:return u=w.sent(),c=Z(function(){return rt(u)[0].expandDims()}),l={width:s.getInputWidth(0),height:s.getInputHeight(0)},[4,this.extractBoxes(c,s.getReshapedInputDimensions(0),i)];case 3:return h=w.sent(),u.dispose(),c.dispose(),f=h.map(function(b){return b.box}),d=h.map(function(b){return b.score}),p=h.map(function(b){return b.classScore}),g=h.map(function(b){return x.config.classes[b.label]}),[2,Eo(f.map(function(b){return b.rescale(a)}),d,this.config.iouThreshold,!0).map(function(b){return new Mh(d[b],p[b],g[b],f[b],l)})]}})})},n.prototype.getDefaultModelName=function(){return""},n.prototype.extractParamsFromWeigthMap=function(e){return function fy(r,n){var s,e=[],t=function hy(r,n){var e=Yn(r,n);function o(s){return{filters:e(s+"/filters",4),bias:e(s+"/bias",1)}}return{extractConvParams:o,extractConvWithBatchNormParams:function a(s){var u=o(s+"/conv"),c=function t(s){return{sub:e(s+"/sub",1),truediv:e(s+"/truediv",1)}}(s+"/bn");return{conv:u,bn:c}},extractSeparableConvParams:Os(e)}}(r,e),o=t.extractConvParams,a=t.extractConvWithBatchNormParams,i=t.extractSeparableConvParams;if(n.withSeparableConvs){var u=n.filterSizes&&n.filterSizes.length||9;s={conv0:n.isFirstLayerConv2d?o("conv0"):i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:u>7?i("conv6"):void 0,conv7:u>8?i("conv7"):void 0,conv8:o("conv8")}}else s={conv0:a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:a("conv6"),conv7:a("conv7"),conv8:o("conv8")};return Sn(r,e),{params:s,paramMappings:e}}(e,this.config)},n.prototype.extractParams=function(e){var t=this.config.filterSizes||n.DEFAULT_FILTER_SIZES,o=t?t.length:void 0;if(7!==o&&8!==o&&9!==o)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+o+" filterSizes in config");return function ly(r,n,e,t){var f,o=kn(r),i=o.getRemainingWeights,s=[],u=function cy(r,n){var e=Ia(r,n),a=Ms(r,n);return{extractConvParams:e,extractConvWithBatchNormParams:function o(i,s,u){var c=e(i,s,3,u+"/conv"),l=function t(i,s){var u=Ze(r(i)),c=Ze(r(i));return n.push({paramPath:s+"/sub"},{paramPath:s+"/truediv"}),{sub:u,truediv:c}}(s,u+"/bn");return{conv:c,bn:l}},extractSeparableConvParams:a}}(o.extractWeights,s),c=u.extractConvParams,l=u.extractConvWithBatchNormParams,h=u.extractSeparableConvParams;if(n.withSeparableConvs){var d=t[0],p=t[1],g=t[2],m=t[3],y=t[4],x=t[5],w=t[6],b=t[7],_=t[8];f={conv0:n.isFirstLayerConv2d?c(d,p,3,"conv0"):h(d,p,"conv0"),conv1:h(p,g,"conv1"),conv2:h(g,m,"conv2"),conv3:h(m,y,"conv3"),conv4:h(y,x,"conv4"),conv5:h(x,w,"conv5"),conv6:b?h(w,b,"conv6"):void 0,conv7:_?h(b,_,"conv7"):void 0,conv8:c(_||b||w,5*e,1,"conv8")}}else g=t[2],m=t[3],y=t[4],x=t[5],w=t[6],b=t[7],_=t[8],f={conv0:l(d=t[0],p=t[1],"conv0"),conv1:l(p,g,"conv1"),conv2:l(g,m,"conv2"),conv3:l(m,y,"conv3"),conv4:l(y,x,"conv4"),conv5:l(x,w,"conv5"),conv6:l(w,b,"conv6"),conv7:l(b,_,"conv7"),conv8:c(_,5*e,1,"conv8")};if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{params:f,paramMappings:s}}(e,this.config,this.boxEncodingSize,t)},n.prototype.extractBoxes=function(e,t,o){return oe(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,g,m,y,x,w,b,_,E,F,I,S,k,N,T,W,B,L,H,G,U=this;return ae(this,function(q){switch(q.label){case 0:return a=t.width,i=t.height,s=Math.max(a,i),u=s/a,c=s/i,l=e.shape[1],h=this.config.anchors.length,f=Z(function(){var X=e.reshape([l,l,h,U.boxEncodingSize]);return[X.slice([0,0,0,0],[l,l,h,4]),X.slice([0,0,0,4],[l,l,h,1]),U.withClassScores?bn(X.slice([0,0,0,5],[l,l,h,U.config.classes.length]),3):$(0)]}),d=f[0],g=f[2],m=[],[4,(p=f[1]).array()];case 1:return y=q.sent(),[4,d.array()];case 2:x=q.sent(),w=0,q.label=3;case 3:if(!(w<l))return[3,12];b=0,q.label=4;case 4:if(!(b<l))return[3,11];_=0,q.label=5;case 5:return _<h?(E=Ss(y[w][b][_][0]),!o||E>o?(F=(b+Ss(x[w][b][_][0]))/l*u,I=(w+Ss(x[w][b][_][1]))/l*c,S=Math.exp(x[w][b][_][2])*this.config.anchors[_].x/l*u,k=Math.exp(x[w][b][_][3])*this.config.anchors[_].y/l*c,N=F-S/2,T=I-k/2,W={row:w,col:b,anchor:_},this.withClassScores?[4,this.extractPredictedClass(g,W)]:[3,7]):[3,9]):[3,10];case 6:return G=q.sent(),[3,8];case 7:G={classScore:1,label:0},q.label=8;case 8:L=(B=G).classScore,H=B.label,m.push(xt({box:new xa(N,T,N+S,T+k),score:E,classScore:E*L,label:H},W)),q.label=9;case 9:return _++,[3,5];case 10:return b++,[3,4];case 11:return w++,[3,3];case 12:return d.dispose(),p.dispose(),g.dispose(),[2,m]}})})},n.prototype.extractPredictedClass=function(e,t){return oe(this,void 0,void 0,function(){var o,a,i,s;return ae(this,function(u){switch(u.label){case 0:return o=t.row,a=t.col,i=t.anchor,[4,e.array()];case 1:return s=u.sent(),[2,Array(this.config.classes.length).fill(0).map(function(c,l){return s[o][a][i][l]}).map(function(c,l){return{classScore:c,label:l}}).reduce(function(c,l){return c.classScore>l.classScore?c:l})]}})})},n.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],n}(Rn),py=function(r){function n(e){void 0===e&&(e=!0);var o=Object.assign({},{withSeparableConvs:e,iouThreshold:.4,classes:["face"]},e?{anchors:oy,meanRgb:ay}:{anchors:ry,withClassScores:!0});return r.call(this,o)||this}return fe(n,r),Object.defineProperty(n.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),n.prototype.locateFaces=function(e,t){return oe(this,void 0,void 0,function(){return ae(this,function(a){switch(a.label){case 0:return[4,this.detect(e,t)];case 1:return[2,a.sent().map(function(i){return new sn(i.score,i.relativeBox,{width:i.imageWidth,height:i.imageHeight})})]}})})},n.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},n.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},n}(vf),vy=function(r){function n(){var e=null!==r&&r.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}return fe(n,r),n}(Gs),So=function(){function r(){}return r.prototype.then=function(n){return oe(this,void 0,void 0,function(){var e;return ae(this,function(t){switch(t.label){case 0:return e=n,[4,this.run()];case 1:return[2,e.apply(void 0,[t.sent()])]}})})},r.prototype.run=function(){return oe(this,void 0,void 0,function(){return ae(this,function(n){throw new Error("ComposableTask - run is not implemented")})})},r}();function mf(r,n){return Object.assign({},r,{descriptor:n})}function Ta(r,n,e,t,o){return void 0===o&&(o=function(a){return a.alignedRect}),oe(this,void 0,void 0,function(){var a,i,s,u,c;return ae(this,function(l){switch(l.label){case 0:return a=r.map(function(h){return function y0(r){return function t0(r){return r.detection instanceof sn}(r)&&r.landmarks instanceof _a&&r.unshiftedLandmarks instanceof _a&&r.alignedRect instanceof sn}(h)?o(h):h.detection}),(s=t)?[3,5]:n instanceof Me?[4,Ts(n,a)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,Sa(n,a)];case 3:u=l.sent(),l.label=4;case 4:s=u,l.label=5;case 5:return[4,e(i=s)];case 6:return c=l.sent(),i.forEach(function(h){return h instanceof Me&&h.dispose()}),[2,c]}})})}function zs(r,n,e,t,o){return oe(this,void 0,void 0,function(){var a=this;return ae(this,function(i){return[2,Ta([r],n,function(s){return oe(a,void 0,void 0,function(){return ae(this,function(u){return[2,e(s[0])]})})},t,o)]})})}function js(r,n){var t=n[1];return{height:Math.floor(n[0]*r),width:Math.floor(t*r)}}var Hs=function(r){function n(e,t,o,a){return r.call(this,{left:e,top:t,right:o,bottom:a},!0)||this}return fe(n,r),n}(En);function gf(r){return Z(function(){return yt(ot(r,$(127.5)),$(.0078125))})}function zr(r,n){return Z(function(){return we(Ge(r),yt(n,ia(Ge(ia(r)))))})}function qs(r,n,e){return void 0===e&&(e=!1),Z(function(){var t=Jt(r,n.conv1,"valid");return t=zr(t,n.prelu1_alpha),t=zr(t=Jt(t=st(t,e?[2,2]:[3,3],[2,2],"same"),n.conv2,"valid"),n.prelu2_alpha),zr(t=Jt(t=e?t:st(t,[3,3],[2,2],"valid"),n.conv3,"valid"),n.prelu3_alpha)})}function Ry(r,n,e,t,o){o.stage1=[];var a=n.map(function(f){return Z(function(){var d={scale:f},p=function Cy(r,n){return Z(function(){var e=js(n,r.shape.slice(1)),i=gf(ts.resizeBilinear(r,[e.height,e.width]));return jn(i,[0,2,1,3])})}(r,f),g=Date.now(),m=function _y(r,n){return Z(function(){var e=qs(r,n,!0),t=Jt(e,n.conv4_1,"valid"),o=Lt(da(t,3),3);return{prob:bn(ot(t,o),3),regions:Jt(e,n.conv4_2,"valid")}})}(p,t),y=m.prob,x=m.regions;return d.pnet=Date.now()-g,{scoresTensor:rt(rt(y,3)[1])[0],regionsTensor:rt(x)[0],scale:f,statsForScale:d}})}),i=a.map(function(f){var d=f.scoresTensor,p=f.regionsTensor,m=f.statsForScale,y=function Ey(r,n,e,t){for(var o=[],a=r.arraySync(),i=0;i<r.shape[0];i++)for(var s=0;s<r.shape[1];s++)a[i][s]>=t&&o.push(new Fe(s,i));return o.map(function(c){var l=new xa(Math.round((2*c.y+1)/e),Math.round((2*c.x+1)/e),Math.round((2*c.y+12)/e),Math.round((2*c.x+12)/e)),h=a[c.y][c.x],f=n.arraySync();return{cell:l,score:h,region:new Hs(f[c.y][c.x][0],f[c.y][c.x][1],f[c.y][c.x][2],f[c.y][c.x][3])}})}(d,p,f.scale,e);if(d.dispose(),p.dispose(),!y.length)return o.stage1.push(m),[];var x=Date.now(),w=Eo(y.map(function(b){return b.cell}),y.map(function(b){return b.score}),.5);return m.nms=Date.now()-x,m.numBoxes=w.length,o.stage1.push(m),w.map(function(b){return y[b]})}),s=i.reduce(function(f,d){return f.concat(d)},[]),u=[],c=[];if(s.length>0){var l=Date.now(),h=Eo(s.map(function(f){return f.cell}),s.map(function(f){return f.score}),.7);o.stage1_nms=Date.now()-l,c=h.map(function(f){return s[f].score}),u=h.map(function(f){return s[f]}).map(function(f){var d=f.cell,p=f.region;return new xa(d.left+p.left*d.width,d.top+p.top*d.height,d.right+p.right*d.width,d.bottom+p.bottom*d.height).toSquare().round()})}return{boxes:u,scores:c}}function yf(r,n,e){var t=e.width,o=e.height;return oe(this,void 0,void 0,function(){var a,i,s,u=this;return ae(this,function(c){switch(c.label){case 0:return a=un(r),[4,Promise.all(n.map(function(l){return oe(u,void 0,void 0,function(){var h,m,y,x;return ae(this,function(w){return h=l.padAtBorders(r.height,r.width),x=a.getImageData(m=h.x-1,y=h.y-1,h.ex-m,h.ey-y),[2,vt.isNodejs()?Ds(x):createImageBitmap(x)]})})}))];case 1:return i=c.sent(),s=[],i.forEach(function(l){var f=un(Ea({width:t,height:o}));f.drawImage(l,0,0,t,o);for(var d=f.getImageData(0,0,t,o).data,p=[],g=0;g<d.length;g+=4)p.push(d[g+2]),p.push(d[g+1]),p.push(d[g]);s.push(p)}),[2,s.map(function(l){return Z(function(){return gf(jn(St(l,[1,t,o,3]),[0,2,1,3]).toFloat())})})]}})})}function ky(r,n,e,t,o){return oe(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,g,m,y,x;return ae(this,function(w){switch(w.label){case 0:return a=Date.now(),[4,yf(r,n,{width:24,height:24})];case 1:return i=w.sent(),o.stage2_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(b){var _=function Sy(r,n){return Z(function(){var e=qs(r,n),a=zr(cn(Kt(e,[e.shape[0],n.fc1.weights.shape[0]]),n.fc1),n.prelu4_alpha),i=cn(a,n.fc2_1),s=Lt(da(i,1),1),u=bn(ot(i,s),1),c=cn(a,n.fc2_2);return{scores:rt(u,1)[1],regions:c}})}(b,t);return b.dispose(),_}),o.stage2_rnet=Date.now()-a,u=s.length>1?nt(s.map(function(b){return b.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[w.sent()]),u.dispose(),f=c.map(function(b,_){return{score:b,idx:_}}).filter(function(b){return b.score>e}).map(function(b){return b.idx}),d=f.map(function(b){return n[b]}),p=f.map(function(b){return c[b]}),g=[],m=[],d.length>0&&(a=Date.now(),y=Eo(d,p,.7),o.stage2_nms=Date.now()-a,x=y.map(function(b){var _=s[f[b]].regions.arraySync();return new Hs(_[0][0],_[0][1],_[0][2],_[0][3])}),m=y.map(function(b){return p[b]}),g=y.map(function(b,_){return d[b].calibrate(x[_])})),s.forEach(function(b){b.regions.dispose(),b.scores.dispose()}),[2,{boxes:g,scores:m}]}})})}function Fy(r,n,e,t,o){return oe(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,g,m,y,x,w;return ae(this,function(b){switch(b.label){case 0:return a=Date.now(),[4,yf(r,n,{width:48,height:48})];case 1:return i=b.sent(),o.stage3_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(_){var E=function Iy(r,n){return Z(function(){var e=qs(r,n);e=zr(e=Jt(e=st(e,[2,2],[2,2],"same"),n.conv4,"valid"),n.prelu4_alpha);var a=zr(cn(Kt(e,[e.shape[0],n.fc1.weights.shape[0]]),n.fc1),n.prelu5_alpha),i=cn(a,n.fc2_1),s=Lt(da(i,1),1),u=bn(ot(i,s),1),c=cn(a,n.fc2_2),l=cn(a,n.fc2_3);return{scores:rt(u,1)[1],regions:c,points:l}})}(_,t);return _.dispose(),E}),o.stage3_onet=Date.now()-a,u=s.length>1?nt(s.map(function(_){return _.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[b.sent()]),u.dispose(),f=c.map(function(_,E){return{score:_,idx:E}}).filter(function(_){return _.score>e}).map(function(_){return _.idx}),d=f.map(function(_){var E=s[_].regions.arraySync();return new Hs(E[0][0],E[0][1],E[0][2],E[0][3])}),p=f.map(function(_,E){return n[_].calibrate(d[E])}),g=f.map(function(_){return c[_]}),m=[],y=[],x=[],p.length>0&&(a=Date.now(),w=Eo(p,g,.7,!1),o.stage3_nms=Date.now()-a,m=w.map(function(_){return p[_]}),y=w.map(function(_){return g[_]}),x=w.map(function(_,E){return Array(5).fill(0).map(function(F,I){var S=s[_].points.arraySync();return new Fe(S[0][I]*(m[E].width+1)+m[E].left,S[0][I+5]*(m[E].height+1)+m[E].top)})})),s.forEach(function(_){_.regions.dispose(),_.scores.dispose(),_.points.dispose()}),[2,{boxes:m,scores:y,points:x}]}})})}var Ay=function(r){function n(){return r.call(this,"Mtcnn")||this}return fe(n,r),n.prototype.load=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(t){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.load.call(this,e)]})})},n.prototype.loadFromDisk=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(t){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.loadFromDisk.call(this,e)]})})},n.prototype.forwardInput=function(e,t){return void 0===t&&(t={}),oe(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,g,m,y,w,b,_,E,F,I;return ae(this,function(S){switch(S.label){case 0:if(!(o=this.params))throw new Error("Mtcnn - load model before inference");if(!(a=e.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return i={},s=Date.now(),u=Z(function(){return function my(r){return Z(function(){return Nt(rt(r,3).reverse(),3)})}(Lt(bs.fromPixels(a)).toFloat())}),c=function(k){return u.dispose(),i.total=Date.now()-s,k},l=u.shape.slice(1),h=l[0],f=l[1],d=new df(t),p=d.minFaceSize,g=d.scaleFactor,m=d.maxNumScales,y=d.scoreThresholds,w=(d.scaleSteps||function wy(r,n,e){for(var a=12/r,i=[],s=Math.min(e[0],e[1])*a,u=0;s>=12;)i.push(a*Math.pow(n,u)),s*=n,u+=1;return i}(p,g,[h,f])).filter(function(k){var N=js(k,[h,f]);return Math.min(N.width,N.height)>12}).slice(0,m),i.scales=w,i.pyramid=w.map(function(k){return js(k,[h,f])}),b=Date.now(),[4,Ry(u,w,y[0],o.pnet,i)];case 1:return _=S.sent(),i.total_stage1=Date.now()-b,_.boxes.length?(i.stage2_numInputBoxes=_.boxes.length,b=Date.now(),[4,ky(a,_.boxes,y[1],o.rnet,i)]):[2,c({results:[],stats:i})];case 2:return E=S.sent(),i.total_stage2=Date.now()-b,E.boxes.length?(i.stage3_numInputBoxes=E.boxes.length,b=Date.now(),[4,Fy(a,E.boxes,y[2],o.onet,i)]):[2,c({results:[],stats:i})];case 3:return F=S.sent(),i.total_stage3=Date.now()-b,I=F.boxes.map(function(k,N){return Bs(ks({},new sn(F.scores[N],new wa(k.left/f,k.top/h,k.width/f,k.height/h),{height:h,width:f})),new e0(F.points[N].map(function(T){return T.sub(new Fe(k.left,k.top)).div(new Fe(k.width,k.height))}),{width:k.width,height:k.height}))}),[2,c({results:I,stats:i})]}})})},n.prototype.forward=function(e,t){return void 0===t&&(t={}),oe(this,void 0,void 0,function(){var o;return ae(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,ut(e)];case 1:return[4,o.apply(this,[a.sent(),t])];case 2:return[2,a.sent().results]}})})},n.prototype.forwardWithStats=function(e,t){return void 0===t&&(t={}),oe(this,void 0,void 0,function(){var o;return ae(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,ut(e)];case 1:return[2,o.apply(this,[a.sent(),t])]}})})},n.prototype.getDefaultModelName=function(){return"mtcnn_model"},n.prototype.extractParamsFromWeigthMap=function(e){return function xy(r){var n=[],e=function by(r,n){var e=Yn(r,n);function t(l){return{filters:e(l+"/weights",4,l+"/filters"),bias:e(l+"/bias",1)}}function o(l){return{weights:e(l+"/weights",2),bias:e(l+"/bias",1)}}function a(l){return e(l,1)}function i(l){return{conv1:t(l+"/conv1"),prelu1_alpha:a(l+"/prelu1_alpha"),conv2:t(l+"/conv2"),prelu2_alpha:a(l+"/prelu2_alpha"),conv3:t(l+"/conv3"),prelu3_alpha:a(l+"/prelu3_alpha")}}return{extractPNetParams:function s(){var l=i("pnet"),h=t("pnet/conv4_1"),f=t("pnet/conv4_2");return xt(xt({},l),{conv4_1:h,conv4_2:f})},extractRNetParams:function u(){var l=i("rnet"),h=o("rnet/fc1"),f=a("rnet/prelu4_alpha"),d=o("rnet/fc2_1"),p=o("rnet/fc2_2");return xt(xt({},l),{fc1:h,prelu4_alpha:f,fc2_1:d,fc2_2:p})},extractONetParams:function c(){var l=i("onet"),h=t("onet/conv4"),f=a("onet/prelu4_alpha"),d=o("onet/fc1"),p=a("onet/prelu5_alpha"),g=o("onet/fc2_1"),m=o("onet/fc2_2"),y=o("onet/fc2_3");return xt(xt({},l),{conv4:h,prelu4_alpha:f,fc1:d,prelu5_alpha:p,fc2_1:g,fc2_2:m,fc2_3:y})}}}(r,n),o=e.extractRNetParams,a=e.extractONetParams,i=(0,e.extractPNetParams)(),s=o(),u=a();return Sn(r,n),{params:{pnet:i,rnet:s,onet:u},paramMappings:n}}(e)},n.prototype.extractParams=function(e){return function yy(r){var n=kn(r),t=n.getRemainingWeights,o=[],a=function gy(r,n){var e=Ia(r,n),t=Ps(r,n);function o(c,l){var h=Ze(r(c));return n.push({paramPath:l}),h}function a(c,l,h){return void 0===h&&(h=!1),{conv1:e(c[0],c[1],3,l+"/conv1"),prelu1_alpha:o(c[1],l+"/prelu1_alpha"),conv2:e(c[1],c[2],3,l+"/conv2"),prelu2_alpha:o(c[2],l+"/prelu2_alpha"),conv3:e(c[2],c[3],h?2:3,l+"/conv3"),prelu3_alpha:o(c[3],l+"/prelu3_alpha")}}return{extractPNetParams:function i(){var c=a([3,10,16,32],"pnet"),l=e(32,2,1,"pnet/conv4_1"),h=e(32,4,1,"pnet/conv4_2");return xt(xt({},c),{conv4_1:l,conv4_2:h})},extractRNetParams:function s(){var c=a([3,28,48,64],"rnet",!0),l=t(576,128,"rnet/fc1"),h=o(128,"rnet/prelu4_alpha"),f=t(128,2,"rnet/fc2_1"),d=t(128,4,"rnet/fc2_2");return xt(xt({},c),{fc1:l,prelu4_alpha:h,fc2_1:f,fc2_2:d})},extractONetParams:function u(){var c=a([3,32,64,64],"onet"),l=e(64,128,2,"onet/conv4"),h=o(128,"onet/prelu4_alpha"),f=t(1152,256,"onet/fc1"),d=o(256,"onet/prelu5_alpha"),p=t(256,2,"onet/fc2_1"),g=t(256,4,"onet/fc2_2"),m=t(256,10,"onet/fc2_3");return xt(xt({},c),{conv4:l,prelu4_alpha:h,fc1:f,prelu5_alpha:d,fc2_1:p,fc2_2:g,fc2_3:m})}}}(n.extractWeights,o),s=a.extractRNetParams,u=a.extractONetParams,c=(0,a.extractPNetParams)(),l=s(),h=u();if(0!==t().length)throw new Error("weights remaing after extract: "+t().length);return{params:{pnet:c,rnet:l,onet:h},paramMappings:o}}(e)},n}(Rn),Ty=[new Fe(1.603231,2.094468),new Fe(6.041143,7.080126),new Fe(2.882459,3.518061),new Fe(4.266906,5.178857),new Fe(9.041765,10.66308)],Ny=[117.001,114.697,97.404],Py=function(r){function n(){return r.call(this,{withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:Ty,meanRgb:Ny,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}return fe(n,r),Object.defineProperty(n.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),n.prototype.locateFaces=function(e,t){return oe(this,void 0,void 0,function(){return ae(this,function(a){switch(a.label){case 0:return[4,this.detect(e,t)];case 1:return[2,a.sent().map(function(i){return new sn(i.score,i.relativeBox,{width:i.imageWidth,height:i.imageHeight})})]}})})},n.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},n.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},n}(vf),Te={ssdMobilenetv1:new pf,tinyFaceDetector:new Py,tinyYolov2:new py,mtcnn:new Ay,faceLandmark68Net:new cf,faceLandmark68TinyNet:new N0,faceRecognitionNet:new U0,faceExpressionNet:new g0,ageGenderNet:new F0};function bf(r,n){return Object.assign({},r,{age:n})}var xf=function(r){function n(e,t,o){var a=r.call(this)||this;return a.parentTask=e,a.input=t,a.extractedFaces=o,a}return fe(n,r),n}(So),Xs=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o=this;return ae(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return[4,Ta(e=a.sent(),this.input,function(i){return oe(o,void 0,void 0,function(){return ae(this,function(s){switch(s.label){case 0:return[4,Promise.all(i.map(function(u){return Te.faceExpressionNet.predictExpressions(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return t=a.sent(),[2,e.map(function(i,s){return af(i,t[s])})]}})})},n.prototype.withAgeAndGender=function(){return new Js(this,this.input)},n}(xf),Ks=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t;return ae(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return(e=o.sent())?[4,zs(e,this.input,function(a){return Te.faceExpressionNet.predictExpressions(a)},this.extractedFaces)]:[2];case 2:return t=o.sent(),[2,af(e,t)]}})})},n.prototype.withAgeAndGender=function(){return new Qs(this,this.input)},n}(xf),Ys=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.withAgeAndGender=function(){return new Zs(this,this.input)},n.prototype.withFaceDescriptors=function(){return new tu(this,this.input)},n}(Xs),$s=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.withAgeAndGender=function(){return new eu(this,this.input)},n.prototype.withFaceDescriptor=function(){return new nu(this,this.input)},n}(Ks),wf=function(r){function n(e,t,o){var a=r.call(this)||this;return a.parentTask=e,a.input=t,a.extractedFaces=o,a}return fe(n,r),n}(So),Js=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o=this;return ae(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return[4,Ta(e=a.sent(),this.input,function(i){return oe(o,void 0,void 0,function(){return ae(this,function(s){switch(s.label){case 0:return[4,Promise.all(i.map(function(u){return Te.ageGenderNet.predictAgeAndGender(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return t=a.sent(),[2,e.map(function(i,s){var u=t[s],c=u.age;return bf(ff(i,u.gender,u.genderProbability),c)})]}})})},n.prototype.withFaceExpressions=function(){return new Xs(this,this.input)},n}(wf),Qs=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o;return ae(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return(e=s.sent())?[4,zs(e,this.input,function(u){return Te.ageGenderNet.predictAgeAndGender(u)},this.extractedFaces)]:[2];case 2:return t=s.sent(),o=t.age,[2,bf(ff(e,t.gender,t.genderProbability),o)]}})})},n.prototype.withFaceExpressions=function(){return new Ks(this,this.input)},n}(wf),Zs=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.withFaceExpressions=function(){return new Ys(this,this.input)},n.prototype.withFaceDescriptors=function(){return new tu(this,this.input)},n}(Js),eu=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.withFaceExpressions=function(){return new $s(this,this.input)},n.prototype.withFaceDescriptor=function(){return new nu(this,this.input)},n}(Qs),_f=function(r){function n(e,t){var o=r.call(this)||this;return o.parentTask=e,o.input=t,o}return fe(n,r),n}(So),tu=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return[4,Ta(e=o.sent(),this.input,function(a){return Promise.all(a.map(function(i){return Te.faceRecognitionNet.computeFaceDescriptor(i)}))},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,o.sent().map(function(a,i){return mf(e[i],a)})]}})})},n.prototype.withFaceExpressions=function(){return new Ys(this,this.input)},n.prototype.withAgeAndGender=function(){return new Zs(this,this.input)},n}(_f),nu=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t;return ae(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return(e=o.sent())?[4,zs(e,this.input,function(a){return Te.faceRecognitionNet.computeFaceDescriptor(a)},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return t=o.sent(),[2,mf(e,t)]}})})},n.prototype.withFaceExpressions=function(){return new $s(this,this.input)},n.prototype.withAgeAndGender=function(){return new eu(this,this.input)},n}(_f),Cf=function(r){function n(e,t,o){var a=r.call(this)||this;return a.parentTask=e,a.input=t,a.useTinyLandmarkNet=o,a}return fe(n,r),Object.defineProperty(n.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?Te.faceLandmark68TinyNet:Te.faceLandmark68Net},enumerable:!0,configurable:!0}),n}(So),Ly=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o,a,i,s=this;return ae(this,function(u){switch(u.label){case 0:return[4,this.parentTask];case 1:return e=u.sent(),t=e.map(function(c){return c.detection}),this.input instanceof Me?[4,Ts(this.input,t)]:[3,3];case 2:return a=u.sent(),[3,5];case 3:return[4,Sa(this.input,t)];case 4:a=u.sent(),u.label=5;case 5:return o=a,[4,Promise.all(o.map(function(c){return s.landmarkNet.detectLandmarks(c)}))];case 6:return i=u.sent(),o.forEach(function(c){return c instanceof Me&&c.dispose()}),[2,e.map(function(c,l){return Bs(c,i[l])})]}})})},n.prototype.withFaceExpressions=function(){return new Ys(this,this.input)},n.prototype.withAgeAndGender=function(){return new Zs(this,this.input)},n.prototype.withFaceDescriptors=function(){return new tu(this,this.input)},n}(Cf),Wy=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o,a,i;return ae(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return(e=s.sent())?(t=e.detection,this.input instanceof Me?[4,Ts(this.input,[t])]:[3,3]):[2];case 2:return a=s.sent(),[3,5];case 3:return[4,Sa(this.input,[t])];case 4:a=s.sent(),s.label=5;case 5:return[4,this.landmarkNet.detectLandmarks((o=a)[0])];case 6:return i=s.sent(),o.forEach(function(u){return u instanceof Me&&u.dispose()}),[2,Bs(e,i)]}})})},n.prototype.withFaceExpressions=function(){return new $s(this,this.input)},n.prototype.withAgeAndGender=function(){return new eu(this,this.input)},n.prototype.withFaceDescriptor=function(){return new nu(this,this.input)},n}(Cf),Ef=function(r){function n(e,t){void 0===t&&(t=new Aa);var o=r.call(this)||this;return o.input=e,o.options=t,o}return fe(n,r),n}(So),Uy=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t,o,a;return ae(this,function(i){switch(i.label){case 0:return t=(e=this).input,(o=e.options)instanceof df?[4,Te.mtcnn.forward(t,o)]:[3,2];case 1:return[2,i.sent().map(function(s){return s.detection})];case 2:if(!(a=o instanceof vy?function(s){return Te.tinyFaceDetector.locateFaces(s,o)}:o instanceof Aa?function(s){return Te.ssdMobilenetv1.locateFaces(s,o)}:o instanceof Gs?function(s){return Te.tinyYolov2.locateFaces(s,o)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,a(t)]}})})},n.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(t){return oe(e,void 0,void 0,function(){var o;return ae(this,function(a){switch(a.label){case 0:return[4,this.run()];case 1:return o=a.sent(),[2,t(o.map(function(i){return ks({},i)}))]}})})})},n.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new Ly(this.runAndExtendWithFaceDetections(),this.input,e)},n.prototype.withFaceExpressions=function(){return new Xs(this.runAndExtendWithFaceDetections(),this.input)},n.prototype.withAgeAndGender=function(){return new Js(this.runAndExtendWithFaceDetections(),this.input)},n}(Ef),Vy=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return fe(n,r),n.prototype.run=function(){return oe(this,void 0,void 0,function(){var e,t;return ae(this,function(o){switch(o.label){case 0:return[4,new Uy(this.input,this.options)];case 1:return e=o.sent(),t=e[0],e.forEach(function(a){a.score>t.score&&(t=a)}),[2,t]}})})},n.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(t){return oe(e,void 0,void 0,function(){var o;return ae(this,function(a){switch(a.label){case 0:return[4,this.run()];case 1:return o=a.sent(),[2,t(o?ks({},o):void 0)]}})})})},n.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new Wy(this.runAndExtendWithFaceDetection(),this.input,e)},n.prototype.withFaceExpressions=function(){return new Ks(this.runAndExtendWithFaceDetection(),this.input)},n.prototype.withAgeAndGender=function(){return new Qs(this.runAndExtendWithFaceDetection(),this.input)},n}(Ef);function Rf(r,n){return void 0===n&&(n=new Aa),new Vy(r,n)}function ru(r,n){if(r.length!==n.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var e=Array.from(r),t=Array.from(n);return Math.sqrt(e.map(function(o,a){return o-t[a]}).reduce(function(o,a){return o+Math.pow(a,2)},0))}!function(){function r(n,e){void 0===e&&(e=.6),this._distanceThreshold=e;var t=Array.isArray(n)?n:[n];if(!t.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var o=1,a=function(){return"person "+o++};this._labeledDescriptors=t.map(function(i){if(i instanceof Ca)return i;if(i instanceof Float32Array)return new Ca(a(),[i]);if(i.descriptor&&i.descriptor instanceof Float32Array)return new Ca(a(),[i.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}Object.defineProperty(r.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),r.prototype.computeMeanDistance=function(n,e){return e.map(function(t){return ru(t,n)}).reduce(function(t,o){return t+o},0)/(e.length||1)},r.prototype.matchDescriptor=function(n){var e=this;return this.labeledDescriptors.map(function(t){return new Bh(t.label,e.computeMeanDistance(n,t.descriptors))}).reduce(function(t,o){return t.distance<o.distance?t:o})},r.prototype.findBestMatch=function(n){var e=this.matchDescriptor(n);return e.distance<this.distanceThreshold?e:new Bh("unknown",e.distance)},r.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(n){return n.toJSON()})}},r.fromJSON=function(n){return new r(n.labeledDescriptors.map(function(t){return Ca.fromJSON(t)}),n.distanceThreshold)}}();let zy=(()=>{var r;class n{constructor(){this.cache={},console.log()}loadNets(){return(0,K.A)(function*(){console.log("loadNets"),console.log("loading");try{console.log("init load"),yield Te.ssdMobilenetv1.load("/assets/models"),yield Te.faceLandmark68Net.load("/assets/models"),yield Te.faceRecognitionNet.load("/assets/models"),console.log("end load")}catch(t){console.log({err:t})}})()}getFaceCrop(t){return(0,K.A)(function*(){return console.time("getFaceCrop"),new Promise(function(){var o=(0,K.A)(function*(a,i){console.time("fetchImage");const s=yield Yh(t);console.timeEnd("fetchImage"),console.time("detectSingleFace");const u=yield Rf(s).withFaceLandmarks().withFaceDescriptor();if(console.timeEnd("detectSingleFace"),!u)return i("N\xe3o identificamos um rosto na imagem, capture uma nova imagem");const{box:c}=u.detection,l=c.width>250?c.width:250,h=c.height>250?c.height:250,f=l>h?{x:c.x,y:c.y-(l-c.height)/2,size:l}:h>l?{x:c.x-(h-c.width)/2,y:c.y,size:h}:{x:c.x-(h-c.width)/2,y:c.y-(l-c.height)/2,size:h};console.log({coords:f,boxWidth:l,boxHeight:h},c.width,c.height);const d=new wa(f.x,f.y,f.size,f.size);console.time("extractFaces");const p=yield Sa(s,[d]);console.timeEnd("extractFaces");const g=p[0].toDataURL("image/jpeg");console.timeEnd("getFaceCrop"),a({face:g,descriptor:u.descriptor})});return function(a,i){return o.apply(this,arguments)}}())})()}canvas2gray(t){if(!t||!t.width||!t.height)return;const o=t.getContext("2d"),a=o.getImageData(0,0,t.width,t.height),i=o.createImageData(t.width,t.height),s=a.data,u=i.data,c=s.length;let h,l=0;for(;l<c;l+=4)h=.2126*s[l]+.7152*s[l+1]+.0722*s[l+2],u[l]=u[l+1]=u[l+2]=h,u[l+3]=s[l+3];o.putImageData(i,0,0)}canvas2blob(t,o="image/jpeg",a=.97){return new Promise((i,s)=>{t||s("Empty canvas"),t.toBlob(i,o,a)})}matchPictures(t,o){var a=this;return(0,K.A)(function*(){return ru(yield a.getDescriptor(t),yield a.getDescriptor(o))})()}matchDescriptors(t,o){return(0,K.A)(function*(){return console.log({descriptor1:t,descriptor2:o}),ru(t,o)})()}getDescriptor(t){var o=this;return(0,K.A)(function*(){if(void 0===o.cache[t]){console.log({img:t});const a=yield Yh(t);console.log({input:a});const i=yield Rf(a).withFaceLandmarks().withFaceDescriptor();console.log({results:i}),o.cache[t]=i.descriptor}else console.log("cached!");return console.log(o.cache[t]),o.cache[t]})()}b64ToBuf(t){return(0,K.A)(function*(){const o=atob(t),a=o.length/Float32Array.BYTES_PER_ELEMENT,i=new DataView(new ArrayBuffer(Float32Array.BYTES_PER_ELEMENT)),s=new Float32Array(a);let u=0;for(let c=0;c<a;c++)u=4*c,i.setUint8(0,o.charCodeAt(u)),i.setUint8(1,o.charCodeAt(u+1)),i.setUint8(2,o.charCodeAt(u+2)),i.setUint8(3,o.charCodeAt(u+3)),s[c]=i.getFloat32(0,!0);return s})()}bufToB64(t){return(0,K.A)(function*(){const o=new Uint8Array(t);return btoa(String.fromCharCode.apply(null,o))})()}}return(r=n).\u0275fac=function(t){return new(t||r)},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})(),jy=(()=>{var r;class n{constructor(t,o,a,i,s){this.api=t,this.cameraService=o,this.alertCtrl=a,this.faceService=i,this.loadingCtrl=s,this.fotos=[]}hashEncode(t){return btoa(String.fromCharCode(...new Uint8Array(t.buffer)))}hashDecode(t){return new Float32Array(new Uint8Array([...atob(t)].map(o=>o.charCodeAt(0))).buffer)}takePhoto(t){var o=this;return(0,K.A)(function*(){const a=yield o.loadingCtrl.create();try{const i=yield o.cameraService.getCamera(!0);yield a.present();const s=yield o.faceService.getFaceCrop(i.dataUrl);if(yield a.dismiss(),s.face){console.log("TAKE FOTO",{face:s});const c={hash:o.hashEncode(s.descriptor),funcionario:t};console.log({identificacao:c});const l=yield(0,It._)(o.api.save(c));return console.log({result:l}),!0}return!1}catch(i){console.log({error:i}),yield a.dismiss()}return!1})()}previewCamera(){var t=this;return new Promise(function(){var o=(0,K.A)(function*(a,i){try{const s={position:"front",className:"camera-preview",parent:"content"};yield On.start(s);const u=yield t.loadingCtrl.create({spinner:null,message:"Foto em: 3s",showBackdrop:!1,translucent:!0});yield u.present(),setTimeout((0,K.A)(function*(){u.message="Foto em: 2s"}),1e3),setTimeout((0,K.A)(function*(){u.message="Foto em: 1s"}),2e3),setTimeout((0,K.A)(function*(){u.dismiss();const c=yield On.captureSample({});On.stop(),a(c.value)}),3e3)}catch(s){On.stop(),i(s)}});return function(a,i){return o.apply(this,arguments)}}())}scan(){var t=this;return(0,K.A)(function*(){const o=yield t.loadingCtrl.create();try{const a=yield t.previewCamera();yield o.present();const i=yield t.faceService.getFaceCrop(`data:image/jpeg;base64,${a}`);if(yield o.dismiss(),null==i||!i.face)return On.stop(),!1;const s=yield t.loadingCtrl.create();let u;yield s.present();const l=(yield(0,It._)(t.api.getAll())).map(f=>{try{const d=t.hashDecode(null==f?void 0:f.hash);return d.length<1?{descriptor:!1,functionario:f.funcionario}:{descriptor:d,functionario:f.funcionario}}catch{return{descriptor:!1,functionario:f.funcionario}}});console.log("fotos",null==l?void 0:l.length);const h=l.filter(f=>!(null==f||!f.descriptor)&&(null==f?void 0:f.descriptor)).entries();for(const[f,d]of h){console.log("foto",f);const p=yield t.faceService.matchDescriptors(d.descriptor,i.descriptor);if(console.log({matchRatio:p}),p<.5){console.log("Match",f),u=null==d?void 0:d.functionario;break}}return s.dismiss(),!!u&&{funcionario:u,face:null==i?void 0:i.face}}catch(a){return console.log({error:a}),yield o.dismiss(),!1}})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.KVO(wr),v.KVO(Gt),v.KVO(V.hG),v.KVO(zy),v.KVO(V.Xi))},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})();function Hy(r,n){1&r&&(v.qex(0),v.j41(1,"ion-row",3)(2,"ion-col",4),v.nrm(3,"ion-spinner",5),v.j41(4,"p"),v.EFF(5,"Carregando foto da c\xe2mera..."),v.k0s()()(),v.bVm())}function qy(r,n){if(1&r&&(v.j41(0,"ion-card",9),v.nrm(1,"ion-img",10),v.j41(2,"ion-card-header")(3,"ion-card-title"),v.EFF(4),v.k0s()()()),2&r){const e=v.XpG(2);v.R7$(),v.Y8G("src",null==e.scanResult?null:e.scanResult.face),v.R7$(3),v.SpI(" ",(null==e.scanResult||null==e.scanResult.funcionario?null:e.scanResult.funcionario.name)||"Motorista n\xe3o identificado"," ")}}function Xy(r,n){if(1&r&&(v.j41(0,"ion-row",6)(1,"ion-col",7),v.DNE(2,qy,5,2,"ion-card",8),v.k0s()()),2&r){const e=v.XpG();v.R7$(2),v.Y8G("ngIf",e.scanResult)}}let Ky=(()=>{var r;class n{constructor(t,o,a){this.modalCtrl=t,this.fotos=o,this.navCtrl=a,this.options={},this.loadingCamera=!0,this.getResultLeitorFacial=new v.bkB}ionViewDidEnter(){var t=this;return(0,K.A)(function*(){yield t.iniciarCamera()})()}ionViewDidLeave(){var t=this;return(0,K.A)(function*(){yield t.pararCamera()})()}iniciarCamera(){var t=this;return(0,K.A)(function*(){yield t.scan()})()}pararCamera(){return(0,K.A)(function*(){yield On.stop()})()}scan(){var t=this;return(0,K.A)(function*(){t.loadingCamera=!0;const o=yield t.fotos.scan();if(t.loadingCamera=!1,!o){t.scanResult=!1;const a=yield t.modalCtrl.create({component:alert,componentProps:{title:"Erro",message:"N\xe3o conseguimos identificar a foto. Gostaria de tentar novamente?",okLabel:"Tentar novamente",cancelLabel:"Cancelar"}});return yield a.present(),(yield a.onDidDismiss()).data?t.scan():t.navCtrl.navigateRoot("/menu")}t.scanResult=o,t.getResultLeitorFacial.emit(o),console.log(t.scanResult)})()}recarregarCamera(){var t=this;return(0,K.A)(function*(){yield t.pararCamera(),t.scanResult=void 0,yield t.iniciarCamera()})()}stopCamera(){var t=this;return(0,K.A)(function*(){yield t.pararCamera()})()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(V.W3),v.rXU(jy),v.rXU(vn.q9))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-leitor-facial"]],outputs:{getResultLeitorFacial:"getResultLeitorFacial"},standalone:!0,features:[v.aNF],decls:5,vars:2,consts:[["scanContent",""],[1,"ion-padding"],[4,"ngIf","ngIfElse"],[1,"ion-justify-content-center","ion-align-items-center"],[1,"ion-text-center"],["name","crescent"],[1,"ion-justify-content-center"],["size","12",1,"ion-text-center"],["class","image-card",4,"ngIf"],[1,"image-card"],[3,"src"]],template:function(t,o){if(1&t&&(v.j41(0,"ion-content",1)(1,"ion-grid"),v.DNE(2,Hy,6,0,"ng-container",2)(3,Xy,3,1,"ng-template",null,0,v.C5r),v.k0s()()),2&t){const a=v.sdS(4);v.R7$(2),v.Y8G("ngIf",o.loadingCamera)("ngIfElse",a)}},dependencies:[Ne.MD,Ne.bT,V.bv,V.b_,V.ME,V.tN,V.hU,V.W9,V.lO,V.KW,V.ln,V.w2]}),n})();const Yy=r=>({"ion-hide":r});function $y(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-item",3)(1,"ion-label"),v.EFF(2,"Selecionar motorista:"),v.k0s(),v.qex(3),v.j41(4,"app-button-add-remove",4),v.bIt("buttonClick",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.isOpen=!0)}),v.k0s(),v.bVm(),v.k0s()}if(2&r){const e=v.XpG();v.R7$(4),v.Y8G("ngClass",v.eq3(1,Yy,e.isFinished))}}function Jy(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-item")(1,"div",5)(2,"ion-label",6),v.EFF(3,"Motorista:"),v.k0s(),v.j41(4,"ion-input",7),v.mxI("ngModelChange",function(o){v.eBV(e);const a=v.XpG();return v.DH7(a.motoristaSelecionado.name,o)||(a.motoristaSelecionado.name=o),v.Njj(o)}),v.k0s()(),v.j41(5,"app-button-add-remove",8),v.bIt("buttonClick",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.removerMotorista())}),v.k0s()()}if(2&r){const e=v.XpG();v.R7$(4),v.Y8G("readonly",!0),v.R50("ngModel",e.motoristaSelecionado.name)}}function Qy(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-button",16),v.bIt("click",function(){v.eBV(e);const o=v.XpG(2);return v.Njj(o.modoBuscaManual=!0)}),v.EFF(1," Busca Manual "),v.k0s()}}function Zy(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-button",16),v.bIt("click",function(){v.eBV(e);const o=v.XpG(2);return v.Njj(o.modoBuscaManual=!1)}),v.EFF(1," Busca Facial "),v.k0s()}}function eb(r,n){1&r&&(v.j41(0,"div",17),v.nrm(1,"app-leitor-facial"),v.k0s())}function tb(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-item",10),v.bIt("click",function(){const o=v.eBV(e).$implicit,a=v.XpG(4);return v.Njj(a.selecionarMotorista(o))}),v.EFF(1),v.k0s()}if(2&r){const e=n.$implicit;v.R7$(),v.SpI(" ",e.name," ")}}function nb(r,n){if(1&r&&(v.j41(0,"ion-list"),v.DNE(1,tb,2,1,"ion-item",20),v.k0s()),2&r){const e=v.XpG(3);v.R7$(),v.Y8G("ngForOf",e.motoristasFiltrados)}}function rb(r,n){1&r&&(v.j41(0,"ion-text"),v.EFF(1," Nenhum motorista encontrado. "),v.k0s())}function ob(r,n){if(1&r){const e=v.RV6();v.j41(0,"div",18)(1,"ion-item")(2,"ion-searchbar",19),v.mxI("ngModelChange",function(o){v.eBV(e);const a=v.XpG(2);return v.DH7(a.funcionarioBusca,o)||(a.funcionarioBusca=o),v.Njj(o)}),v.bIt("ionInput",function(){v.eBV(e);const o=v.XpG(2);return v.Njj(o.buscarMotoristas())}),v.k0s()(),v.DNE(3,nb,2,1,"ion-list",1)(4,rb,2,0,"ion-text",1),v.k0s()}if(2&r){const e=v.XpG(2);v.R7$(2),v.R50("ngModel",e.funcionarioBusca),v.R7$(),v.Y8G("ngIf",e.motoristasFiltrados.length>0&&e.funcionarioBusca),v.R7$(),v.Y8G("ngIf",0===e.motoristasFiltrados.length&&e.funcionarioBusca)}}function ab(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",9)(3,"ion-button",10),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.isOpen=!1)}),v.EFF(4,"Voltar"),v.k0s()(),v.j41(5,"ion-title"),v.EFF(6,"Selecionar Motorista"),v.k0s(),v.j41(7,"ion-buttons",11),v.DNE(8,Qy,2,0,"ion-button",12)(9,Zy,2,0,"ion-button",12),v.k0s()()(),v.j41(10,"ion-content",13),v.DNE(11,eb,2,0,"div",14)(12,ob,5,3,"div",15),v.k0s()}if(2&r){const e=v.XpG();v.R7$(8),v.Y8G("ngIf",!e.modoBuscaManual),v.R7$(),v.Y8G("ngIf",e.modoBuscaManual),v.R7$(),v.Y8G("fullscreen",!0),v.R7$(),v.Y8G("ngIf",!e.modoBuscaManual),v.R7$(),v.Y8G("ngIf",e.modoBuscaManual)}}let ib=(()=>{var r;class n{constructor(t){this.funcionarioService=t,this.modoBuscaManual=!1,this.modoBuscaFacial=!1,this.isOpen=!1,this.funcionarios=[],this.funcionarioBusca="",this.motoristasFiltrados=[],this.motoristaSelecionado=null,this.isFinished=!1,(0,Ut.a)({trashOutline:Dn.P1A})}ngOnInit(){var t=this;return(0,K.A)(function*(){yield t.carregarMotoristas(),t.getMotoristaIdSubscription=t.control.valueChanges.subscribe(function(){var o=(0,K.A)(function*(a){a&&(yield t.carregarMotoristaSelecionado(a))});return function(a){return o.apply(this,arguments)}}())})()}carregarMotoristas(){var t=this;return(0,K.A)(function*(){const o=t.funcionarioService.getCachedFuncionarios();if(o&&0!==o.length)t.funcionarios=o;else{const a=yield(0,It._)(t.funcionarioService.getAll());t.funcionarios=a}})()}buscarMotoristas(){const t=this.funcionarioBusca.toLowerCase();this.motoristasFiltrados=this.funcionarios.filter(o=>{var a;return null===(a=o.name)||void 0===a?void 0:a.toLowerCase().includes(t)})}selecionarMotorista(t){this.motoristaSelecionado=t,this.control.setValue(t.id),this.isOpen=!1,this.funcionarioBusca="",this.motoristasFiltrados=[]}removerMotorista(){this.motoristaSelecionado=null,this.control.setValue(null)}ngOnChanges(t){var o=this;return(0,K.A)(function*(){if(t.control){const a=t.control.currentValue;a&&a.value&&(yield o.carregarMotoristaSelecionado(a.value))}})()}carregarMotoristaSelecionado(t){var o=this;return(0,K.A)(function*(){try{yield o.carregarMotoristas(),o.motoristaSelecionado=o.funcionarios.find(i=>i.id===t)}catch(a){console.error("Erro ao carregar motorista selecionado:",a)}})()}ngOnDestroy(){this.getMotoristaIdSubscription.unsubscribe()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(br.r))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-motorista"]],inputs:{control:"control",isFinished:"isFinished"},standalone:!0,features:[v.OA$,v.aNF],decls:5,vars:3,consts:[["class","ion-justify-content-center ion-align-items-center",4,"ngIf"],[4,"ngIf"],[3,"isOpen"],[1,"ion-justify-content-center","ion-align-items-center"],["color","primary",3,"buttonClick","ngClass"],[1,"item-content"],["position","floating"],[3,"ngModelChange","readonly","ngModel"],["color","danger","slot","end",3,"buttonClick"],["slot","start"],[3,"click"],["slot","end"],["fill","clear",3,"click",4,"ngIf"],[1,"ion-padding",3,"fullscreen"],["class","busca-facial",4,"ngIf"],["class","busca-manual",4,"ngIf"],["fill","clear",3,"click"],[1,"busca-facial"],[1,"busca-manual"],["placeholder","Buscar Motorista",3,"ngModelChange","ionInput","ngModel"],[3,"click",4,"ngFor","ngForOf"]],template:function(t,o){1&t&&(v.j41(0,"ion-list"),v.DNE(1,$y,5,3,"ion-item",0)(2,Jy,6,2,"ion-item",1),v.k0s(),v.j41(3,"ion-modal",2),v.DNE(4,ab,13,5,"ng-template"),v.k0s()),2&t&&(v.R7$(),v.Y8G("ngIf",!o.motoristaSelecionado),v.R7$(),v.Y8G("ngIf",o.motoristaSelecionado),v.R7$(),v.Y8G("isOpen",o.isOpen))},dependencies:[Ne.MD,Ne.YU,Ne.Sq,Ne.bT,V.bv,V.Jm,V.QW,V.W9,V.eU,V.$w,V.uz,V.he,V.nf,V.S1,V.IO,V.BC,V.ai,V.Sb,V.Gw,ct.iI,le.YN,le.BC,le.vS,Tn,Ky],styles:["ion-item[_ngcontent-%COMP%]{display:flex;align-items:center}ion-item[_ngcontent-%COMP%]   .item-content[_ngcontent-%COMP%]{flex-grow:1;display:flex;flex-direction:column;width:100%}app-leitor-facial[_ngcontent-%COMP%]{height:400px;display:block}"]}),n})();var sb=ge(8663);function ub(r,n){if(1&r){const e=v.RV6();v.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),v.EFF(3,"Selecionar Data e Hora"),v.k0s(),v.j41(4,"ion-buttons",6)(5,"ion-button",7),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.onCloseModal())}),v.EFF(6,"Voltar"),v.k0s()(),v.j41(7,"ion-buttons",8)(8,"ion-button",9),v.bIt("click",function(){v.eBV(e);const o=v.XpG();return v.Njj(o.onConfirmSelectDate())}),v.EFF(9,"Confirmar"),v.k0s()()()(),v.j41(10,"ion-content",10),v.nrm(11,"ion-datetime",11),v.k0s()}if(2&r){const e=v.XpG();v.R7$(8),v.Y8G("disabled",!e.dataRetornoControl.value)("strong",!0),v.R7$(3),v.Y8G("formControl",e.dataRetornoControl)}}let cb=(()=>{var r;class n{constructor(t){this.datePipe=t,this.openModal=!1}ngOnInit(){this.dataRetornoControl.valueChanges.subscribe(t=>{var o;console.log(t),t&&(this.showDataRetorno=null!==(o=this.datePipe.transform(t,"dd-MM-yyyy HH:mm","pt-BR"))&&void 0!==o?o:"")}),this.dataRetornoControl.setValue(new Date)}onOpenModal(){this.openModal=!0}onCloseModal(){this.openModal=!1}onConfirmSelectDate(){this.openModal=!0}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(Ne.vh))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-frota-retorno"]],inputs:{dataCard:"dataCard",kmRetornoControl:"kmRetornoControl",dataRetornoControl:"dataRetornoControl",tipoAcompanhanteRetorno:"tipoAcompanhanteRetorno",saveAcompanhanteFrota:"saveAcompanhanteFrota"},standalone:!0,features:[v.Jv_([Ne.vh]),v.aNF],decls:15,vars:10,consts:[[3,"hideButtonActions","data"],["position","floating"],["type","number",3,"formControl"],[3,"ngModelChange","click","readonly","ngModel"],[3,"tipoAcompanhanteRetorno","saveAcompanhanteFrota","idFrota"],[1,"modal-data-time",3,"isOpen","backdropDismiss"],["slot","start"],[3,"click"],["slot","end"],[3,"click","disabled","strong"],[1,"ion-padding"],["presentation","date-time",3,"formControl"]],template:function(t,o){1&t&&(v.nrm(0,"app-card",0),v.j41(1,"ion-grid")(2,"ion-row")(3,"ion-col")(4,"ion-item")(5,"ion-label",1),v.EFF(6,"Km Retorno"),v.k0s(),v.nrm(7,"ion-input",2),v.k0s(),v.j41(8,"ion-item")(9,"ion-label",1),v.EFF(10,"Data e hora de retorno"),v.k0s(),v.j41(11,"ion-input",3),v.mxI("ngModelChange",function(i){return v.DH7(o.showDataRetorno,i)||(o.showDataRetorno=i),i}),v.bIt("click",function(){return o.onOpenModal()}),v.k0s()(),v.nrm(12,"app-frota-acompanhantes",4),v.j41(13,"ion-modal",5),v.DNE(14,ub,12,3,"ng-template"),v.k0s()()()()),2&t&&(v.Y8G("hideButtonActions",!0)("data",o.dataCard),v.R7$(7),v.Y8G("formControl",o.kmRetornoControl),v.R7$(4),v.Y8G("readonly",!0),v.R50("ngModel",o.showDataRetorno),v.R7$(),v.Y8G("tipoAcompanhanteRetorno",o.tipoAcompanhanteRetorno)("saveAcompanhanteFrota",o.saveAcompanhanteFrota)("idFrota",o.dataCard.id),v.R7$(),v.Y8G("isOpen",o.openModal)("backdropDismiss",!1))},dependencies:[V.bv,V.Jm,V.QW,V.hU,V.W9,V.A9,V.lO,V.eU,V.$w,V.uz,V.he,V.ln,V.BC,V.ai,V.Sb,V.su,V.Je,V.Gw,Ne.MD,sb.i,le.X1,le.BC,le.l_,le.YN,le.vS,ne]}),n})();var lb=ge(9457),hb=ge(2177);let fb=(()=>{var r;class n{constructor(t){this.fb=t}createSaidaFrotaForm(){return this.fb.group({dataHoraSaida:[null,le.k0.required],imobilizadoCod:[null,le.k0.required],destinoSeq:[null,le.k0.required],quilometragemNaSaida:[null,[le.k0.required,le.k0.min(0)]],motivoSeq:[null,le.k0.required],funcCod:[null,le.k0.required],obs:[""]})}addRetornoControls(t,o){t.addControl("quilometragemNoRetorno",new le.MJ(o+1,[le.k0.required,le.k0.min(null!=o?o:1)])),t.addControl("dataHoraRetorno",new le.MJ(new Date,le.k0.required))}}return(r=n).\u0275fac=function(t){return new(t||r)(v.KVO(le.ok))},r.\u0275prov=v.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),n})();function db(r,n){if(1&r&&(v.qex(0),v.nrm(1,"app-frota-retorno",11),v.bVm()),2&r){const e=v.XpG();v.R7$(),v.Y8G("dataCard",e.dataSharedCard)("kmRetornoControl",e.form.controls.quilometragemNoRetorno)("dataRetornoControl",e.form.controls.dataHoraRetorno)("tipoAcompanhanteRetorno",e.isClose)("saveAcompanhanteFrota",e.sendSaidaIdForAcompanhante)}}function pb(r,n){if(1&r&&(v.qex(0),v.nrm(1,"app-frota-veiculo",18),v.bVm()),2&r){const e=v.XpG(2);v.R7$(),v.Y8G("control",e.form.controls.imobilizadoCod)("withoutRoutesOpen",!1)}}function vb(r,n){if(1&r&&(v.qex(0),v.nrm(1,"app-frota-veiculo",13),v.bVm()),2&r){const e=v.XpG(2);v.R7$(),v.Y8G("control",e.form.controls.imobilizadoCod)}}function mb(r,n){if(1&r&&(v.qex(0),v.j41(1,"ion-grid",12)(2,"ion-row")(3,"ion-col"),v.nrm(4,"app-frota-motorista",13),v.DNE(5,pb,2,2,"ng-container",10)(6,vb,2,1,"ng-container",10),v.nrm(7,"app-frota-destino",13),v.j41(8,"ion-item")(9,"ion-label",14),v.EFF(10,"Km Sa\xedda"),v.k0s(),v.nrm(11,"ion-input",15),v.k0s(),v.nrm(12,"app-frota-motivo",13),v.j41(13,"ion-item")(14,"ion-label",14),v.EFF(15,"Observa\xe7\xf5es"),v.k0s(),v.nrm(16,"ion-textarea",16),v.k0s(),v.nrm(17,"app-frota-acompanhantes",17),v.k0s()()(),v.bVm()),2&r){const e=v.XpG();v.R7$(),v.Y8G("formGroup",e.form),v.R7$(3),v.Y8G("control",e.form.controls.funcCod),v.R7$(),v.Y8G("ngIf",e.id),v.R7$(),v.Y8G("ngIf",!e.id),v.R7$(),v.Y8G("control",e.form.controls.destinoSeq),v.R7$(5),v.Y8G("control",e.form.controls.motivoSeq),v.R7$(5),v.Y8G("tipoAcompanhanteRetorno",e.isClose)("saveAcompanhanteFrota",e.sendSaidaIdForAcompanhante)("idFrota",e.id)}}let gb=(()=>{var r;class n{constructor(t,o,a,i,s,u,c,l,h){this.fb=t,this.frotaSaidaSrv=o,this.loaddingCtrl=a,this.alertCtrl=i,this.router=s,this.route=u,this.dataSharedCardSrv=c,this.identificacaoFuncSrv=l,this.frotaSaidaForm=h,this.id=null,this.sendSaidaIdForAcompanhante=null,this.isClose=!1,this.routeSubscription=null,this.appRoutes=Fo.S,this.dataSharedCard=null,this.openModalDataTime=!1,this.changeFuncCodSubscription=null,this.srcFotoMotorista="assets/user.png",this.form=this.frotaSaidaForm.createSaidaFrotaForm()}ngOnInit(){var t=this;return(0,K.A)(function*(){t.updateRouteData(),t.changeFuncCodSubscription=t.form.controls.funcCod.valueChanges.subscribe(function(){var o=(0,K.A)(function*(a){const i=yield t.identificacaoFuncSrv.getImage(2739);a&&i&&(t.srcFotoMotorista=yield t.identificacaoFuncSrv.getImage(2739)),a||(t.srcFotoMotorista="assets/user.png")});return function(a){return o.apply(this,arguments)}}()),t.routeSubscription=t.router.events.pipe((0,qa.p)(o=>o instanceof ct.wF)).subscribe((0,K.A)(function*(){return yield t.updateRouteData()}))})()}updateRouteData(){var t=this;return(0,K.A)(function*(){if(t.id=Number(t.route.snapshot.paramMap.get("id"))||null,t.isClose=t.route.snapshot.url.some(a=>"close"===a.path),t.dataSharedCard=yield t.dataSharedCardSrv.getData(),t.isClose){var o;t.dataSharedCard||(t.dataSharedCard=yield t.dataSharedCardSrv.getData());const a=null===(o=t.dataSharedCard)||void 0===o?void 0:o.quilometragemNaSaida;t.frotaSaidaForm.addRetornoControls(t.form,null!=a?a:1)}t.id&&(t.dataSharedCard||(t.dataSharedCard=yield t.dataSharedCardSrv.getData()),t.dataSharedCard?t.form.patchValue(t.dataSharedCard):t.getDataForEditForm(t.id))})()}getDataForEditForm(t){this.frotaSaidaSrv.getById(t).subscribe(o=>{this.dataSharedCard=o,this.form.patchValue(o)})}onSubmit(){var t=this;return(0,K.A)(function*(){var o,a;t.id||t.isClose||null===(o=t.form.get("dataHoraSaida"))||void 0===o||o.setValue(new Date),t.form.valid?yield(0,ve.h)(t.loaddingCtrl,t.alertCtrl,{mainAction:(a=(0,K.A)(function*(){const i=t.form.value;if(t.isClose||t.id){const s=yield(0,It._)(t.frotaSaidaSrv.update(t.id,i));t.sendSaidaIdForAcompanhante=null==s?void 0:s.id}else{const s=yield(0,It._)(t.frotaSaidaSrv.save(i));t.sendSaidaIdForAcompanhante=null==s?void 0:s.id}}),function(){return a.apply(this,arguments)}),onAfterTryDismiss:()=>t.router.navigate([t.appRoutes.list.path]),onError:a=>console.error("Erro ao salvar:",a)}):console.log("Formul\xe1rio inv\xe1lido")})()}msgCloseForm(){var t=this;return(0,K.A)(function*(){const o=yield t.alertCtrl.create({header:"Sair do cadastro de rota",message:"Voc\xea tem certeza que quer sair do cadastro de rota? Ao sair, suas modifica\xe7\xf5es ser\xe3o perdidas!",buttons:[{text:"Continuar nesta Tela",role:"cancel"},{text:"Sair",handler:()=>t.router.navigate(["/home"])}]});t.form.dirty?yield o.present():t.router.navigate(["/home"])})()}ngOnDestroy(){var t;null===(t=this.routeSubscription)||void 0===t||t.unsubscribe()}}return(r=n).\u0275fac=function(t){return new(t||r)(v.rXU(le.ok),v.rXU(lb.g),v.rXU(V.Xi),v.rXU(V.hG),v.rXU(ct.Ix),v.rXU(ct.nX),v.rXU(hb.w),v.rXU(wr),v.rXU(fb))},r.\u0275cmp=v.VBU({type:r,selectors:[["app-form"]],standalone:!0,features:[v.aNF],decls:19,vars:6,consts:[[3,"translucent"],["color","primary"],["slot","start"],["color","light",3,"click"],["slot","end"],[3,"fullscreen"],[1,"box-content"],[1,"ion-justify-content-center","ion-align-items-center"],["size","auto"],["alt","Foto de perfil",3,"src"],[4,"ngIf"],[3,"dataCard","kmRetornoControl","dataRetornoControl","tipoAcompanhanteRetorno","saveAcompanhanteFrota"],[3,"formGroup"],[3,"control"],["position","floating"],["type","number","formControlName","quilometragemNaSaida"],["formControlName","obs"],[3,"tipoAcompanhanteRetorno","saveAcompanhanteFrota","idFrota"],[3,"control","withoutRoutesOpen"]],template:function(t,o){1&t&&(v.j41(0,"ion-header",0)(1,"ion-toolbar",1)(2,"ion-buttons",2)(3,"ion-button",3),v.bIt("click",function(){return o.msgCloseForm()}),v.EFF(4,"Sair"),v.k0s()(),v.j41(5,"ion-title"),v.EFF(6),v.k0s(),v.j41(7,"ion-buttons",4)(8,"ion-button",3),v.bIt("click",function(){return o.onSubmit()}),v.EFF(9,"Salvar"),v.k0s()()()(),v.j41(10,"ion-content",5)(11,"div",6)(12,"ion-grid")(13,"ion-row",7)(14,"ion-col",8)(15,"ion-avatar"),v.nrm(16,"img",9),v.k0s()()()(),v.DNE(17,db,2,5,"ng-container",10)(18,mb,18,9,"ng-container",10),v.k0s()()),2&t&&(v.Y8G("translucent",!0),v.R7$(6),v.JRh(o.isClose?"Finalizar percurso":o.id?"Editar percurso":"Iniciar percurso"),v.R7$(4),v.Y8G("fullscreen",!0),v.R7$(6),v.Y8G("src",o.srcFotoMotorista,v.B4B),v.R7$(),v.Y8G("ngIf",o.isClose&&!!o.dataSharedCard),v.R7$(),v.Y8G("ngIf",!o.isClose))},dependencies:[Ne.MD,Ne.bT,V.bv,V.mC,V.Jm,V.QW,V.hU,V.W9,V.lO,V.eU,V.$w,V.uz,V.he,V.ln,V.nc,V.BC,V.ai,V.su,V.Gw,ct.iI,le.X1,le.BC,le.cb,le.j4,le.JD,ne,Pn,za,Ha,ib,le.YN,cb],styles:["[_nghost-%COMP%]   ion-content[_ngcontent-%COMP%]   .box-content[_ngcontent-%COMP%]{display:block;max-width:800px;margin:0 auto}[_nghost-%COMP%]   ion-avatar[_ngcontent-%COMP%]{height:200px;width:200px}[_nghost-%COMP%]   ion-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{object-fit:contain}"]}),n})()},3207:(cu,yr,ge)=>{"use strict";ge.d(yr,{s:()=>Ne});var K=ge(9350);function Ne(le,ct){const V="object"==typeof ct;return new Promise((v,It)=>{let Ut,lt=!1;le.subscribe({next:Dn=>{Ut=Dn,lt=!0},error:It,complete:()=>{lt?v(Ut):V?v(ct.defaultValue):It(new K.G)}})})}},8082:()=>{},7318:()=>{},745:()=>{}}]);